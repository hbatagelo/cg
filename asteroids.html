<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6.2 Asteroids | MCTA008-17 Computação Gráfica</title>
  <meta name="description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="6.2 Asteroids | MCTA008-17 Computação Gráfica" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  <meta name="github-repo" content="hbatagelo/cgbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6.2 Asteroids | MCTA008-17 Computação Gráfica" />
  
  <meta name="twitter:description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="regularpolygons.html"/>
<link rel="next" href="referências.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { font-weight: bold; } /* Alert */
code span.an { font-style: italic; } /* Annotation */
code span.cf { font-weight: bold; } /* ControlFlow */
code span.co { font-style: italic; } /* Comment */
code span.cv { font-style: italic; } /* CommentVar */
code span.do { font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.er { font-weight: bold; } /* Error */
code span.in { font-style: italic; } /* Information */
code span.kw { font-weight: bold; } /* Keyword */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.wa { font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Computação Gráfica</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> | Notas de aula</a>
<ul>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html"><i class="fa fa-check"></i>Pré-requisitos</a>
<ul>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html#atividades-práticas"><i class="fa fa-check"></i>Atividades práticas</a></li>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html#visualizando-este-site"><i class="fa fa-check"></i>Visualizando este site</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="config.html"><a href="config.html"><i class="fa fa-check"></i><b>2</b> Configuração do ambiente</a>
<ul>
<li class="chapter" data-level="2.1" data-path="linux.html"><a href="linux.html"><i class="fa fa-check"></i><b>2.1</b> Linux</a>
<ul>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#verificando-o-opengl"><i class="fa fa-check"></i>Verificando o OpenGL</a></li>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#atualizando-o-gcc"><i class="fa fa-check"></i>Atualizando o GCC</a></li>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#instalando-o-emscripten"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="macos.html"><a href="macos.html"><i class="fa fa-check"></i><b>2.2</b> macOS</a>
<ul>
<li class="chapter" data-level="" data-path="macos.html"><a href="macos.html#instalando-o-emscripten-1"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="windows.html"><a href="windows.html"><i class="fa fa-check"></i><b>2.3</b> Windows</a>
<ul>
<li class="chapter" data-level="" data-path="windows.html"><a href="windows.html#verificando-o-opengl-1"><i class="fa fa-check"></i>Verificando o OpenGL</a></li>
<li class="chapter" data-level="" data-path="windows.html"><a href="windows.html#instalando-o-emscripten-2"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="vscode.html"><a href="vscode.html"><i class="fa fa-check"></i><b>2.4</b> Visual Studio Code</a></li>
<li class="chapter" data-level="2.5" data-path="abcg.html"><a href="abcg.html"><i class="fa fa-check"></i><b>2.5</b> ABCg</a>
<ul>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#instalação"><i class="fa fa-check"></i>Instalação</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-na-linha-de-comando"><i class="fa fa-check"></i>Compilando na linha de comando</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-no-vs-code"><i class="fa fa-check"></i>Compilando no VS Code</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#depurando-no-vs-code"><i class="fa fa-check"></i>Depurando no VS Code</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-para-wasm"><i class="fa fa-check"></i>Compilando para WASM</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#revisão-de-c"><i class="fa fa-check"></i>Revisão de C++</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>3</b> Introdução</a>
<ul>
<li class="chapter" data-level="3.1" data-path="áreas-correlatas.html"><a href="áreas-correlatas.html"><i class="fa fa-check"></i><b>3.1</b> Áreas correlatas</a></li>
<li class="chapter" data-level="3.2" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html"><i class="fa fa-check"></i><b>3.2</b> Linha do tempo</a>
<ul>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section"><i class="fa fa-check"></i>1950</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-1"><i class="fa fa-check"></i>1960</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-2"><i class="fa fa-check"></i>1970</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-3"><i class="fa fa-check"></i>1980</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-4"><i class="fa fa-check"></i>1990</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-5"><i class="fa fa-check"></i>2000</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-6"><i class="fa fa-check"></i>2010</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-7"><i class="fa fa-check"></i>2020</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="firstapp.html"><a href="firstapp.html"><i class="fa fa-check"></i><b>3.3</b> Primeiro programa</a>
<ul>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#configuração-inicial"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#main.cpp"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#window.hpp"><i class="fa fa-check"></i>window.hpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#window.cpp"><i class="fa fa-check"></i>window.cpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#compilando-para-webassembly"><i class="fa fa-check"></i>Compilando para WebAssembly</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="tictactoe.html"><a href="tictactoe.html"><i class="fa fa-check"></i><b>3.4</b> Jogo da Velha</a>
<ul>
<li class="chapter" data-level="" data-path="tictactoe.html"><a href="tictactoe.html#configuração-inicial-1"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="tictactoe.html"><a href="tictactoe.html#main.cpp-1"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="tictactoe.html"><a href="tictactoe.html#window.hpp-1"><i class="fa fa-check"></i>window.hpp</a></li>
<li class="chapter" data-level="" data-path="tictactoe.html"><a href="tictactoe.html#window.cpp-1"><i class="fa fa-check"></i>window.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="graphicssystem.html"><a href="graphicssystem.html"><i class="fa fa-check"></i><b>4</b> Sistemas gráficos</a>
<ul>
<li class="chapter" data-level="4.1" data-path="lightcolor.html"><a href="lightcolor.html"><i class="fa fa-check"></i><b>4.1</b> Luz e cor</a>
<ul>
<li class="chapter" data-level="" data-path="lightcolor.html"><a href="lightcolor.html#visão-tricromática"><i class="fa fa-check"></i>Visão tricromática</a></li>
<li class="chapter" data-level="" data-path="lightcolor.html"><a href="lightcolor.html#modelos-de-cor"><i class="fa fa-check"></i>Modelos de cor</a></li>
<li class="chapter" data-level="" data-path="lightcolor.html"><a href="lightcolor.html#sistema-cie-1931"><i class="fa fa-check"></i>Sistema CIE 1931</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="vectorxraster.html"><a href="vectorxraster.html"><i class="fa fa-check"></i><b>4.2</b> Vetorial <em>x</em> matricial</a>
<ul>
<li class="chapter" data-level="" data-path="vectorxraster.html"><a href="vectorxraster.html#representação-vetorial"><i class="fa fa-check"></i>Representação vetorial</a></li>
<li class="chapter" data-level="" data-path="vectorxraster.html"><a href="vectorxraster.html#representação-matricial"><i class="fa fa-check"></i>Representação matricial</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="es.html"><a href="es.html"><i class="fa fa-check"></i><b>4.3</b> Dispositivos de E/S</a>
<ul>
<li class="chapter" data-level="" data-path="es.html"><a href="es.html#dispositivos-de-entrada"><i class="fa fa-check"></i>Dispositivos de entrada</a></li>
<li class="chapter" data-level="" data-path="es.html"><a href="es.html#dispositivos-de-saída"><i class="fa fa-check"></i>Dispositivos de saída</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="framebuffer.html"><a href="framebuffer.html"><i class="fa fa-check"></i><b>4.4</b> Framebuffer</a>
<ul>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#screen-tearing"><i class="fa fa-check"></i>Screen tearing</a></li>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#vsync"><i class="fa fa-check"></i>Vsync</a></li>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#multiple-buffering"><i class="fa fa-check"></i>Multiple buffering</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="sierpinski.html"><a href="sierpinski.html"><i class="fa fa-check"></i><b>4.5</b> Triângulo de Sierpinski</a>
<ul>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#configuração-inicial-2"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#main.cpp-2"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#window.hpp-2"><i class="fa fa-check"></i>window.hpp</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#window.cpp-2"><i class="fa fa-check"></i>window.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="pipeline.html"><a href="pipeline.html"><i class="fa fa-check"></i><b>5</b> Pipeline gráfico</a>
<ul>
<li class="chapter" data-level="5.1" data-path="dados-gráficos.html"><a href="dados-gráficos.html"><i class="fa fa-check"></i><b>5.1</b> Dados gráficos</a></li>
<li class="chapter" data-level="5.2" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html"><i class="fa fa-check"></i><b>5.2</b> Ray casting <em>x</em> rasterização</a>
<ul>
<li class="chapter" data-level="" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html#ray-casting"><i class="fa fa-check"></i>Ray casting</a></li>
<li class="chapter" data-level="" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html#rasterização"><i class="fa fa-check"></i>Rasterização</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="glpipeline.html"><a href="glpipeline.html"><i class="fa fa-check"></i><b>5.3</b> Pipeline do OpenGL</a>
<ul>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#aplicação"><i class="fa fa-check"></i>Aplicação</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#vertex-shader"><i class="fa fa-check"></i>Vertex shader</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#montagem-de-primitivas"><i class="fa fa-check"></i>Montagem de primitivas</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#recorte"><i class="fa fa-check"></i>Recorte</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#rasterização-1"><i class="fa fa-check"></i>Rasterização</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#fragment-shader"><i class="fa fa-check"></i>Fragment shader</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#operações-de-fragmentos"><i class="fa fa-check"></i>Operações de fragmentos</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="coloredtriangles.html"><a href="coloredtriangles.html"><i class="fa fa-check"></i><b>5.4</b> Triângulos coloridos</a>
<ul>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#configuração-inicial-3"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#main.cpp-3"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#window.hpp-3"><i class="fa fa-check"></i>window.hpp</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#window.cpp-3"><i class="fa fa-check"></i>window.cpp</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#ajustando-a-taxa-de-atualização"><i class="fa fa-check"></i>Ajustando a taxa de atualização</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="game.html"><a href="game.html"><i class="fa fa-check"></i><b>6</b> Desenvolvendo um jogo 2D</a>
<ul>
<li class="chapter" data-level="6.1" data-path="regularpolygons.html"><a href="regularpolygons.html"><i class="fa fa-check"></i><b>6.1</b> Polígonos regulares</a>
<ul>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#configuração-inicial-4"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#main.cpp-4"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#window.hpp-4"><i class="fa fa-check"></i>window.hpp</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#window.cpp-4"><i class="fa fa-check"></i>window.cpp</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="asteroids.html"><a href="asteroids.html"><i class="fa fa-check"></i><b>6.2</b> Asteroids</a>
<ul>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#organização-do-projeto"><i class="fa fa-check"></i>Organização do projeto</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#configuração-inicial-5"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#nave"><i class="fa fa-check"></i>Nave</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#estrelas"><i class="fa fa-check"></i>Estrelas</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#asteroides"><i class="fa fa-check"></i>Asteroides</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#tiros-e-colisões"><i class="fa fa-check"></i>Tiros e colisões</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="referências.html"><a href="referências.html"><i class="fa fa-check"></i>Referências</a></li>
<li class="divider"></li>
<li>
<a href="https://github.com/hbatagelo/abcg" target="blank">ABCg no GitHub</a>
<br>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MCTA008-17 Computação Gráfica</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="asteroids" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Asteroids<a href="asteroids.html#asteroids" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>O cenário do jogo Asteroids será composto pelos seguintes objetos:</p>
<ul>
<li>Uma nave espacial, formada por <code>GL_TRIANGLES</code>;</li>
<li>Asteroides, formados por <code>GL_TRIANGLE_FAN</code>;</li>
<li>Tiros, formados por <code>GL_TRIANGLE_FAN</code>;</li>
<li>Estrelas de fundo, formadas por <code>GL_POINTS</code>.</li>
</ul>
<p>Como nas aplicações feitas até agora, trabalharemos somente com gráficos 2D. As coordenadas de todos os objetos do jogo serão especificadas no chamado NDC (espaço normalizado do dispositivo). Como vimos na seção <a href="glpipeline.html#glpipeline">5.3</a>, para que as primitivas sejam renderizadas, as coordenadas em NDC devem estar dentro do <em>volume de visão canônico</em>, que é um cubo de <span class="math inline">\((-1, -1, -1)\)</span> a <span class="math inline">\((1, 1, 1)\)</span>. Também vimos que coordenadas em NDC são mapeadas para o espaço da janela, de modo que o ponto <span class="math inline">\((-1,-1)\)</span> é mapeado para o canto inferior esquerdo do viewport, e <span class="math inline">\((1,1)\)</span> é mapeado para o canto superior direito, de acordo com o especificado em <code>glViewport</code>. A figura <a href="asteroids.html#fig:asteroids1">6.5</a> ilustra o posicionamento de objetos da cena recortados pela região visível do NDC.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:asteroids1"></span>
<img src="images/05_asteroids1.svg" alt="Objetos de cena na região visível do NDC." width="60%" />
<p class="caption">
Figura 6.5: Objetos de cena na região visível do NDC.
</p>
</div>
<p>No jogo Asteroids original, a nave se movimenta pela tela enquanto a câmera virtual permanece fixa. Quando a nave sai dos limites da tela, reaparece no lado oposto. No nosso projeto, a nave se manterá fixa no centro da tela, enquanto todo o resto se moverá ao seu redor. O espaço será finito como no Asteroids original, e terá o tamanho da região que vai de <span class="math inline">\((-1,-1)\)</span> a <span class="math inline">\((1,1)\)</span>. Se um asteroide sair do lado esquerdo da tela, reaparecerá no lado direito (observe que isso acontece na figura <a href="asteroids.html#fig:asteroids1">6.5</a>).</p>
<p>Um truque simples para obter o efeito de replicação do espaço é renderizar a cena nove vezes, uma vez para célula de uma grade 3x3 na qual apenas a célula do meio corresponde à região de <span class="math inline">\((-1,-1)\)</span> a <span class="math inline">\((1,1)\)</span>. Isso é ilustrado na figura <a href="asteroids.html#fig:asteroids2">6.6</a>:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:asteroids2"></span>
<img src="images/05_asteroids2.svg" alt="Replicando a cena em torno da região visível do NDC." width="100%" />
<p class="caption">
Figura 6.6: Replicando a cena em torno da região visível do NDC.
</p>
</div>
<p>Não é necessário replicar os objetos que não saem da tela, como a nave. No nosso caso, os tiros também não serão replicados e deixarão de existir assim que saírem da tela.</p>
<p>Embora esse truque de replicação de cena funcione bem para este jogo simples, em cenas mais complexas é recomendável fazer testes de proximidade para não desenhar os objetos que estão totalmente fora da área visível. Isso evita processamento desnecessário no pipeline gráfico.</p>
<div id="organização-do-projeto" class="section level3 unnumbered hasAnchor">
<h3>Organização do projeto<a href="asteroids.html#organização-do-projeto" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Nosso jogo possui vários objetos de cena, e portanto possui potencialmente vários VBOs, VAOs e variáveis de propriedades desses objetos. Precisamos pensar bem em como organizar tudo isso. O código pode ficar bastante confuso se definirmos tudo na classe <code>Window</code> como fizemos nos projetos anteriores.</p>
<div id="organização-das-classes" class="section level4 unnumbered hasAnchor">
<h4>Organização das classes<a href="asteroids.html#organização-das-classes" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Para organizar melhor o projeto, separaremos os elementos de cena do jogo nas seguintes classes:</p>
<ul>
<li><p><code>Ship</code>: classe que representará a nave espacial (VAO, VBO e atributos como translação, orientação e velocidade).</p></li>
<li><p><code>StarLayers</code>: classe que gerenciará as camadas de estrelas usadas para fazer o efeito de paralaxe de fundo<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. <code>StarLayers</code> conterá um arranjo de objetos do tipo <code>StarLayer</code>, sendo que cada <code>StarLayer</code> definirá o VBO de pontos de uma camada de estrelas.</p></li>
<li><p><code>Bullets</code>: classe que gerencia os tiros. A classe terá uma lista de instâncias de uma estrutura <code>Bullet</code>, sendo que cada <code>Bullet</code> representará as propriedades de um tiro (translação, velocidade, etc). Todos os tiros compartilharão um mesmo VBO definido como membro de <code>Bullets</code>.</p></li>
<li><p><code>Asteroids</code>: classe que gerenciará os asteroides. <code>Asteroids</code> conterá uma lista de instâncias de uma estrutura <code>Asteroid</code>, sendo que cada <code>Asteroid</code> definirá o VBO e as propriedades de um asteroide.</p></li>
</ul>
<p>As classes <code>Ship</code>, <code>StarLayers</code>, <code>Bullets</code> e <code>Asteroids</code> terão funções públicas <code>create</code>, <code>paint</code> e <code>destroy</code> que serão chamadas respectivamente nas funções <code>onCreate</code>, <code>onPaint</code> e <code>onDestroy</code> de <code>Window</code>.</p>
<p>Definiremos também uma classe <code>GameData</code> para permitir o compartilhamento dos dados de estado do jogo entre <code>Window</code> e as outras classes.</p>
</div>
<div id="organização-dos-arquivos" class="section level4 unnumbered hasAnchor">
<h4>Organização dos arquivos<a href="asteroids.html#organização-dos-arquivos" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O diretório de projeto <code>abcg/examples/asteroids</code> terá a seguinte estrutura:</p>
<pre><code>asteroids/
│   asteroids.cpp
│   asteroids.hpp
│   bullets.cpp
│   bullets.hpp
│   CMakeLists.txt
│   gamedata.hpp
│   main.cpp
│   window.hpp
│   window.cpp
│   ship.cpp
│   ship.hpp
│   starlayers.cpp
│   starlayers.hpp
│
└───assets/
    │   Inconsolata-Medium.ttf
    │   objects.frag
    │   objects.vert    
    │   stars.frag
    └   stars.vert    </code></pre>
<p>O subdiretório <code>assets</code> terá os seguintes arquivos de recursos utilizados no jogo:</p>
<ul>
<li><code>Inconsolata-Medium.ttf</code>: fonte <a href="https://levien.com/type/myfonts/inconsolata.html">Inconsolata</a> utilizada na mensagem “Game Over” e “You Win”. É a mesma fonte que utilizados no projeto <code>tictactoe</code> (seção <a href="tictactoe.html#tictactoe">3.4</a>).</li>
<li><code>stars.vert</code> e <code>stars.frag</code>: código-fonte do vertex shader e fragment shader utilizados para renderizar as estrelas.</li>
<li><code>objects.vert</code> e <code>objects.frag</code>: código-fonte do vertex shader e fragment shader utilizados em todos os outros objetos: nave, asteroides e tiros.</li>
</ul>
<p>Poderíamos continuar definindo os shaders através de strings, como fizemos até agora, mas o projeto fica mais organizado desta nova forma.</p>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Quando o projeto é compilado para WebAssembly, o conteúdo de <code>assets</code> é transformado em um arquivo <code>.data</code> no diretório <code>public</code>. Assim, os arquivos resultantes de um projeto chamado <code>proj</code> são:</p>
<ul>
<li><code>proj.data</code>: arquivo de recursos (assets);</li>
<li><code>proj.js</code>: arquivo JavaScript que deve ser chamado pelo html;</li>
<li><code>proj.wasm</code>: binário WebAssembly.</li>
</ul>
</div>
</div>
</div>
<div id="configuração-inicial-5" class="section level3 unnumbered hasAnchor">
<h3>Configuração inicial<a href="asteroids.html#configuração-inicial-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li><p>Em <code>abcg/examples</code>, crie o subdiretório <code>asteroids</code>.</p></li>
<li><p>No arquivo <code>abcg/examples/CMakeLists.txt</code>, inclua a linha <code>add_subdirectory(asteroids)</code>.</p></li>
<li><p>Crie o arquivo <code>abcg/examples/asteroids/CMakeLists.txt</code> com o seguinte conteúdo:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb22-1"><a href="asteroids.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">project</span>(asteroids)</span>
<span id="cb22-2"><a href="asteroids.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">add_executable</span>(<span class="dv">${PROJECT_NAME}</span> <span class="bn">main.cpp</span> window.cpp asteroids.cpp bullets.cpp</span>
<span id="cb22-3"><a href="asteroids.html#cb22-3" aria-hidden="true" tabindex="-1"></a>                               ship.cpp starlayers.cpp)</span>
<span id="cb22-4"><a href="asteroids.html#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">enable_abcg</span>(<span class="dv">${PROJECT_NAME}</span>)</span></code></pre></div></li>
<li><p>Crie todos os arquivos <code>.cpp</code> e <code>.hpp</code> (de <code>asteroids.cpp</code> até <code>starlayers.cpp</code>). Por enquanto eles ficarão vazios.</p></li>
<li><p>Crie o subdiretório <code>assets</code> e baixe/copie a fonte <code>.ttf</code>. Crie também os arquivos <code>.frag</code> e <code>.vert</code>. Vamos editá-los em seguida.</p></li>
</ol>
<div id="main.cpp-5" class="section level4 unnumbered hasAnchor">
<h4>main.cpp<a href="asteroids.html#main.cpp-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Não há nada de realmente novo no conteúdo de <code>main.cpp</code>. Apenas desativaremos o contador de FPS e o botão de tela cheia. O código ficará assim:</p>
<div class="sourceCode" id="cb23" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb23-1"><a href="asteroids.html#cb23-1"></a><span class="pp">#include </span><span class="im">&quot;window.hpp&quot;</span></span>
<span id="cb23-2"><a href="asteroids.html#cb23-2"></a></span>
<span id="cb23-3"><a href="asteroids.html#cb23-3"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-4"><a href="asteroids.html#cb23-4"></a>  <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="asteroids.html#cb23-5"></a>    abcg<span class="op">::</span>Application app<span class="op">(</span>argc<span class="op">,</span> argv<span class="op">);</span></span>
<span id="cb23-6"><a href="asteroids.html#cb23-6"></a></span>
<span id="cb23-7"><a href="asteroids.html#cb23-7"></a>    Window window<span class="op">;</span></span>
<span id="cb23-8"><a href="asteroids.html#cb23-8"></a>    window<span class="op">.</span>setOpenGLSettings<span class="op">({.</span>samples <span class="op">=</span> <span class="dv">4</span><span class="op">});</span></span>
<span id="cb23-9"><a href="asteroids.html#cb23-9"></a>    window<span class="op">.</span>setWindowSettings<span class="op">({</span></span>
<span id="cb23-10"><a href="asteroids.html#cb23-10"></a>        <span class="op">.</span>width <span class="op">=</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb23-11"><a href="asteroids.html#cb23-11"></a>        <span class="op">.</span>height <span class="op">=</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb23-12"><a href="asteroids.html#cb23-12"></a>        <span class="op">.</span>showFPS <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-13"><a href="asteroids.html#cb23-13"></a>        <span class="op">.</span>showFullscreenButton <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-14"><a href="asteroids.html#cb23-14"></a>        <span class="op">.</span>title <span class="op">=</span> <span class="st">&quot;Asteroids&quot;</span><span class="op">,</span></span>
<span id="cb23-15"><a href="asteroids.html#cb23-15"></a>    <span class="op">});</span></span>
<span id="cb23-16"><a href="asteroids.html#cb23-16"></a></span>
<span id="cb23-17"><a href="asteroids.html#cb23-17"></a>    app<span class="op">.</span>run<span class="op">(</span>window<span class="op">);</span></span>
<span id="cb23-18"><a href="asteroids.html#cb23-18"></a>  <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">std::</span>exception<span class="op"> </span><span class="at">const</span> <span class="op">&amp;</span>exception<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-19"><a href="asteroids.html#cb23-19"></a>    fmt<span class="op">::</span>print<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;</span><span class="sc">{}\n</span><span class="st">&quot;</span><span class="op">,</span> exception<span class="op">.</span>what<span class="op">());</span></span>
<span id="cb23-20"><a href="asteroids.html#cb23-20"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb23-21"><a href="asteroids.html#cb23-21"></a>  <span class="op">}</span></span>
<span id="cb23-22"><a href="asteroids.html#cb23-22"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-23"><a href="asteroids.html#cb23-23"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="gamedata.hpp" class="section level4 unnumbered hasAnchor">
<h4>gamedata.hpp<a href="asteroids.html#gamedata.hpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Neste arquivo definiremos uma estrutura <code>GameData</code> que descreve o estado atual do jogo e o estado dos dispositivos de entrada:</p>
<div class="sourceCode" id="cb24" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb24-1"><a href="asteroids.html#cb24-1"></a><span class="pp">#ifndef GAMEDATA_HPP_</span></span>
<span id="cb24-2"><a href="asteroids.html#cb24-2"></a><span class="pp">#define GAMEDATA_HPP_</span></span>
<span id="cb24-3"><a href="asteroids.html#cb24-3"></a></span>
<span id="cb24-4"><a href="asteroids.html#cb24-4"></a><span class="pp">#include </span><span class="im">&lt;bitset&gt;</span></span>
<span id="cb24-5"><a href="asteroids.html#cb24-5"></a></span>
<span id="cb24-6"><a href="asteroids.html#cb24-6"></a><span class="kw">enum</span> <span class="kw">class</span> Input <span class="op">{</span> Right<span class="op">,</span> Left<span class="op">,</span> Down<span class="op">,</span> Up<span class="op">,</span> Fire <span class="op">};</span></span>
<span id="cb24-7"><a href="asteroids.html#cb24-7"></a><span class="kw">enum</span> <span class="kw">class</span> State <span class="op">{</span> Playing<span class="op">,</span> GameOver<span class="op">,</span> Win <span class="op">};</span></span>
<span id="cb24-8"><a href="asteroids.html#cb24-8"></a></span>
<span id="cb24-9"><a href="asteroids.html#cb24-9"></a><span class="kw">struct</span> GameData <span class="op">{</span></span>
<span id="cb24-10"><a href="asteroids.html#cb24-10"></a>  State <span class="va">m_state</span><span class="op">{</span>State<span class="op">::</span>Playing<span class="op">};</span></span>
<span id="cb24-11"><a href="asteroids.html#cb24-11"></a>  <span class="bu">std::</span>bitset<span class="op">&lt;</span><span class="dv">5</span><span class="op">&gt;</span> <span class="va">m_input</span><span class="op">;</span>  <span class="co">// [fire, up, down, left, right]</span></span>
<span id="cb24-12"><a href="asteroids.html#cb24-12"></a><span class="op">};</span></span>
<span id="cb24-13"><a href="asteroids.html#cb24-13"></a></span>
<span id="cb24-14"><a href="asteroids.html#cb24-14"></a><span class="pp">#endif</span></span></code></pre></div>
<ul>
<li><code>m_state</code> pode ser:
<ul>
<li><code>State::Playing</code>: a aplicação está em modo de jogo, com a nave respondendo aos comandos do jogador;</li>
<li><code>State::GameOver</code>: o jogador perdeu. Nesse caso a nave não é exibida e não responde aos comandos do jogador;</li>
<li><code>State::Win</code>: o jogador ganhou. A nave também não é exibida neste estado.</li>
</ul></li>
<li><code>m_input</code> é uma máscara de 5 bits setados em resposta a eventos dos dispositivos de entrada. Por exemplo, o bit 0 corresponde a <code>Input::Right</code> e está setado enquanto o usuário pressiona a seta para a direita ou a tecla <code>D</code>. Esse estado é atualizado pela função membro <code>Window::onEvent</code> que veremos adiante.</li>
</ul>
<p>A classe <code>Window</code> manterá um objeto <code>GameData</code> que será compartilhado com outras classes (<code>Ship</code>, <code>Bullets</code>, <code>Asteroids</code>, etc) sempre que elas precisarem ler ou modificar o estado do jogo.</p>
</div>
<div id="objects.vert" class="section level4 unnumbered hasAnchor">
<h4>objects.vert<a href="asteroids.html#objects.vert" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Esse é o shader utilizado na renderização da nave, asteroides e tiros. O conteúdo será como a seguir:</p>
<div class="sourceCode" id="cb25" startFrom="1"><pre class="sourceCode numberSource glsl numberLines"><code class="sourceCode glsl"><span id="cb25-1"><a href="asteroids.html#cb25-1"></a><span class="pp">#version 300 es</span></span>
<span id="cb25-2"><a href="asteroids.html#cb25-2"></a></span>
<span id="cb25-3"><a href="asteroids.html#cb25-3"></a><span class="kw">layout</span><span class="op">(</span><span class="dt">location</span> <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="dt">in</span> <span class="dt">vec2</span> inPosition<span class="op">;</span></span>
<span id="cb25-4"><a href="asteroids.html#cb25-4"></a></span>
<span id="cb25-5"><a href="asteroids.html#cb25-5"></a><span class="kw">uniform</span> <span class="dt">vec4</span> color<span class="op">;</span></span>
<span id="cb25-6"><a href="asteroids.html#cb25-6"></a><span class="kw">uniform</span> <span class="dt">float</span> rotation<span class="op">;</span></span>
<span id="cb25-7"><a href="asteroids.html#cb25-7"></a><span class="kw">uniform</span> <span class="dt">float</span> scale<span class="op">;</span></span>
<span id="cb25-8"><a href="asteroids.html#cb25-8"></a><span class="kw">uniform</span> <span class="dt">vec2</span> translation<span class="op">;</span></span>
<span id="cb25-9"><a href="asteroids.html#cb25-9"></a></span>
<span id="cb25-10"><a href="asteroids.html#cb25-10"></a><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">;</span></span>
<span id="cb25-11"><a href="asteroids.html#cb25-11"></a></span>
<span id="cb25-12"><a href="asteroids.html#cb25-12"></a><span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-13"><a href="asteroids.html#cb25-13"></a>  <span class="dt">float</span> sinAngle <span class="op">=</span> <span class="bu">sin</span><span class="op">(</span>rotation<span class="op">);</span></span>
<span id="cb25-14"><a href="asteroids.html#cb25-14"></a>  <span class="dt">float</span> cosAngle <span class="op">=</span> <span class="bu">cos</span><span class="op">(</span>rotation<span class="op">);</span></span>
<span id="cb25-15"><a href="asteroids.html#cb25-15"></a>  <span class="dt">vec2</span> rotated <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span>inPosition<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> cosAngle <span class="op">-</span> inPosition<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> sinAngle<span class="op">,</span></span>
<span id="cb25-16"><a href="asteroids.html#cb25-16"></a>                      inPosition<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> sinAngle <span class="op">+</span> inPosition<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> cosAngle<span class="op">);</span></span>
<span id="cb25-17"><a href="asteroids.html#cb25-17"></a></span>
<span id="cb25-18"><a href="asteroids.html#cb25-18"></a>  <span class="dt">vec2</span> newPosition <span class="op">=</span> rotated <span class="op">*</span> scale <span class="op">+</span> translation<span class="op">;</span></span>
<span id="cb25-19"><a href="asteroids.html#cb25-19"></a>  <span class="bu">gl_Position</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>newPosition<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb25-20"><a href="asteroids.html#cb25-20"></a>  fragColor <span class="op">=</span> color<span class="op">;</span></span>
<span id="cb25-21"><a href="asteroids.html#cb25-21"></a><span class="op">}</span></span></code></pre></div>
<p>Observe que os vértices só possuem um atributo <code>inPosition</code> do tipo <code>vec2</code>. Esse atributo corresponde à posição <span class="math inline">\((x,y)\)</span> do vértice. A saída do vertex shader é uma cor RGBA definida pela variável uniforme <code>color</code>. Isso significa que, usando esse shader, todos os vértices terão a mesma cor.</p>
<p>O código de <code>main</code> é similar ao do vertex shader do projeto <code>regularpolygons</code>, mas dessa vez a posição é modificada não apenas por um fator de escala e translação, mas também por uma rotação. As linhas 13 a 16 fazem com que a posição <code>inPosition</code> seja rodada pelo ângulo <code>rotation</code> (em radianos) no sentido anti-horário. O resultado é uma nova posição <code>rotated</code> que é então transformada pela escala e translação (linha 18).</p>
<p>Em capítulos futuros, veremos a teoria das transformações geométricas e os passos necessários para se chegar à expressão das linhas 15 e 16.</p>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Todos os objetos do jogo são desenhados em tons de cinza, mas não há nada nos shaders que impeça que utilizemos cores. O aspecto preto e branco do jogo é só uma escolha estética para lembrar o antigo Asteroids do arcade.</p>
</div>
</div>
<div id="objects.frag" class="section level4 unnumbered hasAnchor">
<h4>objects.frag<a href="asteroids.html#objects.frag" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O conteúdo desse fragment shader que acompanha <code>objects.vert</code> é o mesmo dos projetos anteriores. A cor de entrada é copiada para a cor de saída:</p>
<div class="sourceCode" id="cb26" startFrom="1"><pre class="sourceCode numberSource glsl numberLines"><code class="sourceCode glsl"><span id="cb26-1"><a href="asteroids.html#cb26-1"></a><span class="pp">#version 300 es</span></span>
<span id="cb26-2"><a href="asteroids.html#cb26-2"></a></span>
<span id="cb26-3"><a href="asteroids.html#cb26-3"></a><span class="dt">precision</span> <span class="dt">mediump</span> <span class="dt">float</span><span class="op">;</span></span>
<span id="cb26-4"><a href="asteroids.html#cb26-4"></a></span>
<span id="cb26-5"><a href="asteroids.html#cb26-5"></a><span class="dt">in</span> <span class="dt">vec4</span> fragColor<span class="op">;</span></span>
<span id="cb26-6"><a href="asteroids.html#cb26-6"></a></span>
<span id="cb26-7"><a href="asteroids.html#cb26-7"></a><span class="dt">out</span> <span class="dt">vec4</span> outColor<span class="op">;</span></span>
<span id="cb26-8"><a href="asteroids.html#cb26-8"></a></span>
<span id="cb26-9"><a href="asteroids.html#cb26-9"></a><span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span> outColor <span class="op">=</span> fragColor<span class="op">;</span> <span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="nave" class="section level3 unnumbered hasAnchor">
<h3>Nave<a href="asteroids.html#nave" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Para simplificar, faremos primeiramente o código para desenhar e animar a nave. Em seguida incluiremos o código das estrelas, asteroides, e por fim os tiros e a detecção de colisões.</p>
<div id="window.hpp-5" class="section level4 unnumbered hasAnchor">
<h4>window.hpp<a href="asteroids.html#window.hpp-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O conteúdo de <code>window.hpp</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb27" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb27-1"><a href="asteroids.html#cb27-1"></a><span class="pp">#ifndef WINDOW_HPP_</span></span>
<span id="cb27-2"><a href="asteroids.html#cb27-2"></a><span class="pp">#define WINDOW_HPP_</span></span>
<span id="cb27-3"><a href="asteroids.html#cb27-3"></a></span>
<span id="cb27-4"><a href="asteroids.html#cb27-4"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb27-5"><a href="asteroids.html#cb27-5"></a></span>
<span id="cb27-6"><a href="asteroids.html#cb27-6"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb27-7"><a href="asteroids.html#cb27-7"></a></span>
<span id="cb27-8"><a href="asteroids.html#cb27-8"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb27-9"><a href="asteroids.html#cb27-9"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb27-10"><a href="asteroids.html#cb27-10"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb27-11"><a href="asteroids.html#cb27-11"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb27-12"><a href="asteroids.html#cb27-12"></a></span>
<span id="cb27-13"><a href="asteroids.html#cb27-13"></a><span class="kw">class</span> Window <span class="op">:</span> <span class="kw">public</span> abcg<span class="op">::</span>OpenGLWindow <span class="op">{</span></span>
<span id="cb27-14"><a href="asteroids.html#cb27-14"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb27-15"><a href="asteroids.html#cb27-15"></a>  <span class="dt">void</span> onEvent<span class="op">(</span>SDL_Event <span class="at">const</span> <span class="op">&amp;</span>event<span class="op">)</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-16"><a href="asteroids.html#cb27-16"></a>  <span class="dt">void</span> onCreate<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-17"><a href="asteroids.html#cb27-17"></a>  <span class="dt">void</span> onUpdate<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-18"><a href="asteroids.html#cb27-18"></a>  <span class="dt">void</span> onPaint<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-19"><a href="asteroids.html#cb27-19"></a>  <span class="dt">void</span> onPaintUI<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-20"><a href="asteroids.html#cb27-20"></a>  <span class="dt">void</span> onResize<span class="op">(</span>glm<span class="op">::</span>ivec2 <span class="at">const</span> <span class="op">&amp;</span>size<span class="op">)</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-21"><a href="asteroids.html#cb27-21"></a>  <span class="dt">void</span> onDestroy<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb27-22"><a href="asteroids.html#cb27-22"></a></span>
<span id="cb27-23"><a href="asteroids.html#cb27-23"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb27-24"><a href="asteroids.html#cb27-24"></a>  glm<span class="op">::</span>ivec2 <span class="va">m_viewportSize</span><span class="op">{};</span></span>
<span id="cb27-25"><a href="asteroids.html#cb27-25"></a></span>
<span id="cb27-26"><a href="asteroids.html#cb27-26"></a>  GLuint <span class="va">m_objectsProgram</span><span class="op">{};</span></span>
<span id="cb27-27"><a href="asteroids.html#cb27-27"></a></span>
<span id="cb27-28"><a href="asteroids.html#cb27-28"></a>  GameData <span class="va">m_gameData</span><span class="op">;</span></span>
<span id="cb27-29"><a href="asteroids.html#cb27-29"></a></span>
<span id="cb27-30"><a href="asteroids.html#cb27-30"></a>  Ship <span class="va">m_ship</span><span class="op">;</span></span>
<span id="cb27-31"><a href="asteroids.html#cb27-31"></a></span>
<span id="cb27-32"><a href="asteroids.html#cb27-32"></a>  abcg<span class="op">::</span>Timer <span class="va">m_restartWaitTimer</span><span class="op">;</span></span>
<span id="cb27-33"><a href="asteroids.html#cb27-33"></a></span>
<span id="cb27-34"><a href="asteroids.html#cb27-34"></a>  ImFont <span class="op">*</span><span class="va">m_font</span><span class="op">{};</span></span>
<span id="cb27-35"><a href="asteroids.html#cb27-35"></a></span>
<span id="cb27-36"><a href="asteroids.html#cb27-36"></a>  <span class="bu">std::</span>default_random_engine<span class="op"> </span><span class="va">m_randomEngine</span><span class="op">;</span></span>
<span id="cb27-37"><a href="asteroids.html#cb27-37"></a></span>
<span id="cb27-38"><a href="asteroids.html#cb27-38"></a>  <span class="dt">void</span> restart<span class="op">();</span></span>
<span id="cb27-39"><a href="asteroids.html#cb27-39"></a><span class="op">};</span></span>
<span id="cb27-40"><a href="asteroids.html#cb27-40"></a></span>
<span id="cb27-41"><a href="asteroids.html#cb27-41"></a><span class="pp">#endif</span></span></code></pre></div>
<ul>
<li><code>m_objectsProgram</code> é o identificador do par de shaders <code>objects.vert</code> e <code>objects.frag</code>.</li>
<li><code>m_gameData</code> é a instância de <code>GameData</code> com o estado do jogo e dos dispositivos de entrada.</li>
<li><code>m_ship</code> é a instância da classe <code>Ship</code> que gerencia a nave.</li>
<li><code>m_restartWaitTimer</code> é um temporizador utilizado para fazer com que o jogo seja reiniciado em cinco segundos após o fim de jogo.</li>
<li><code>m_font</code> representa a fonte que será utilizada pela ImGui para escrever “Game Over” e “Win” na tela.</li>
</ul>
<p>Observe que há uma nova função membro <code>onEvent</code> que substitui uma função virtual da classe base. <strong><code>onEvent</code> é chamada pela ABCg sempre que ocorre algum evento da SDL</strong>, incluindo os eventos dos dispositivos de entrada. Neste projeto, usaremos <code>onEvent</code> para atualizar a máscara de bits <code>m_input</code> de <code>m_gameData</code>.</p>
<p>Na linha 38 há a declaração de uma função membro <code>restart</code>. Essa função será chamada sempre que quisermos reiniciar o estado do jogo.</p>
<p>Há também a função membro <code>onUpdate</code> na linha 17. <strong><code>onUpdate</code> é chamada pela ABCg imediatamente antes de cada <code>onPaint</code></strong>. Nessa função incluiremos o código responsável por atualizar a posição dos objetos da cena para torná-la animada.</p>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Poderíamos ter colocado o código de <code>onUpdate</code> em <code>onPaint</code> diretamente, mas o programa fica mais organizado fazendo essa separação entre a animação e a renderização.</p>
<p><code>onPaint</code> não tem exatamente a mesma funcionalidade de <code>onUpdate</code>: <code>onPaint</code> não é chamada quando a janela está minimizada, enquanto <code>onUpdate</code> é chamada incondicionalmente.</p>
</div>
</div>
<div id="window.cpp-5" class="section level4 unnumbered hasAnchor">
<h4>window.cpp<a href="asteroids.html#window.cpp-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Em <code>window.cpp</code>, começaremos com a definição de <code>Window::onEvent</code>:</p>
<div class="sourceCode" id="cb28" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb28-1"><a href="asteroids.html#cb28-1"></a><span class="pp">#include </span><span class="im">&quot;window.hpp&quot;</span></span>
<span id="cb28-2"><a href="asteroids.html#cb28-2"></a></span>
<span id="cb28-3"><a href="asteroids.html#cb28-3"></a><span class="dt">void</span> Window<span class="op">::</span>onEvent<span class="op">(</span>SDL_Event <span class="at">const</span> <span class="op">&amp;</span>event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-4"><a href="asteroids.html#cb28-4"></a>  <span class="co">// Keyboard events</span></span>
<span id="cb28-5"><a href="asteroids.html#cb28-5"></a>  <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>type <span class="op">==</span> SDL_KEYDOWN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-6"><a href="asteroids.html#cb28-6"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_SPACE<span class="op">)</span></span>
<span id="cb28-7"><a href="asteroids.html#cb28-7"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Fire<span class="op">));</span></span>
<span id="cb28-8"><a href="asteroids.html#cb28-8"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_UP <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_w<span class="op">)</span></span>
<span id="cb28-9"><a href="asteroids.html#cb28-9"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">));</span></span>
<span id="cb28-10"><a href="asteroids.html#cb28-10"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_DOWN <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_s<span class="op">)</span></span>
<span id="cb28-11"><a href="asteroids.html#cb28-11"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Down<span class="op">));</span></span>
<span id="cb28-12"><a href="asteroids.html#cb28-12"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_LEFT <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_a<span class="op">)</span></span>
<span id="cb28-13"><a href="asteroids.html#cb28-13"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Left<span class="op">));</span></span>
<span id="cb28-14"><a href="asteroids.html#cb28-14"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_RIGHT <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_d<span class="op">)</span></span>
<span id="cb28-15"><a href="asteroids.html#cb28-15"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Right<span class="op">));</span></span>
<span id="cb28-16"><a href="asteroids.html#cb28-16"></a>  <span class="op">}</span></span>
<span id="cb28-17"><a href="asteroids.html#cb28-17"></a>  <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>type <span class="op">==</span> SDL_KEYUP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-18"><a href="asteroids.html#cb28-18"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_SPACE<span class="op">)</span></span>
<span id="cb28-19"><a href="asteroids.html#cb28-19"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Fire<span class="op">));</span></span>
<span id="cb28-20"><a href="asteroids.html#cb28-20"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_UP <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_w<span class="op">)</span></span>
<span id="cb28-21"><a href="asteroids.html#cb28-21"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">));</span></span>
<span id="cb28-22"><a href="asteroids.html#cb28-22"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_DOWN <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_s<span class="op">)</span></span>
<span id="cb28-23"><a href="asteroids.html#cb28-23"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Down<span class="op">));</span></span>
<span id="cb28-24"><a href="asteroids.html#cb28-24"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_LEFT <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_a<span class="op">)</span></span>
<span id="cb28-25"><a href="asteroids.html#cb28-25"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Left<span class="op">));</span></span>
<span id="cb28-26"><a href="asteroids.html#cb28-26"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_RIGHT <span class="op">||</span> event<span class="op">.</span>key<span class="op">.</span>keysym<span class="op">.</span>sym <span class="op">==</span> SDLK_d<span class="op">)</span></span>
<span id="cb28-27"><a href="asteroids.html#cb28-27"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Right<span class="op">));</span></span>
<span id="cb28-28"><a href="asteroids.html#cb28-28"></a>  <span class="op">}</span></span>
<span id="cb28-29"><a href="asteroids.html#cb28-29"></a></span>
<span id="cb28-30"><a href="asteroids.html#cb28-30"></a>  <span class="co">// Mouse events</span></span>
<span id="cb28-31"><a href="asteroids.html#cb28-31"></a>  <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>type <span class="op">==</span> SDL_MOUSEBUTTONDOWN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-32"><a href="asteroids.html#cb28-32"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>button<span class="op">.</span>button <span class="op">==</span> SDL_BUTTON_LEFT<span class="op">)</span></span>
<span id="cb28-33"><a href="asteroids.html#cb28-33"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Fire<span class="op">));</span></span>
<span id="cb28-34"><a href="asteroids.html#cb28-34"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>button<span class="op">.</span>button <span class="op">==</span> SDL_BUTTON_RIGHT<span class="op">)</span></span>
<span id="cb28-35"><a href="asteroids.html#cb28-35"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>set<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">));</span></span>
<span id="cb28-36"><a href="asteroids.html#cb28-36"></a>  <span class="op">}</span></span>
<span id="cb28-37"><a href="asteroids.html#cb28-37"></a>  <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>type <span class="op">==</span> SDL_MOUSEBUTTONUP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-38"><a href="asteroids.html#cb28-38"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>button<span class="op">.</span>button <span class="op">==</span> SDL_BUTTON_LEFT<span class="op">)</span></span>
<span id="cb28-39"><a href="asteroids.html#cb28-39"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Fire<span class="op">));</span></span>
<span id="cb28-40"><a href="asteroids.html#cb28-40"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>button<span class="op">.</span>button <span class="op">==</span> SDL_BUTTON_RIGHT<span class="op">)</span></span>
<span id="cb28-41"><a href="asteroids.html#cb28-41"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_input</span><span class="op">.</span>reset<span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">));</span></span>
<span id="cb28-42"><a href="asteroids.html#cb28-42"></a>  <span class="op">}</span></span>
<span id="cb28-43"><a href="asteroids.html#cb28-43"></a>  <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span>type <span class="op">==</span> SDL_MOUSEMOTION<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-44"><a href="asteroids.html#cb28-44"></a>    glm<span class="op">::</span>ivec2 mousePosition<span class="op">;</span></span>
<span id="cb28-45"><a href="asteroids.html#cb28-45"></a>    SDL_GetMouseState<span class="op">(&amp;</span>mousePosition<span class="op">.</span>x<span class="op">,</span> <span class="op">&amp;</span>mousePosition<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb28-46"><a href="asteroids.html#cb28-46"></a></span>
<span id="cb28-47"><a href="asteroids.html#cb28-47"></a>    glm<span class="op">::</span>vec2 direction<span class="op">{</span>mousePosition<span class="op">.</span>x <span class="op">-</span> <span class="va">m_viewportSize</span><span class="op">.</span>x <span class="op">/</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb28-48"><a href="asteroids.html#cb28-48"></a>                        <span class="op">-(</span>mousePosition<span class="op">.</span>y <span class="op">-</span> <span class="va">m_viewportSize</span><span class="op">.</span>y <span class="op">/</span> <span class="dv">2</span><span class="op">)};</span></span>
<span id="cb28-49"><a href="asteroids.html#cb28-49"></a></span>
<span id="cb28-50"><a href="asteroids.html#cb28-50"></a>    <span class="va">m_ship</span><span class="op">.</span><span class="va">m_rotation</span> <span class="op">=</span> <span class="bu">std::</span>atan2<span class="op">(</span>direction<span class="op">.</span>y<span class="op">,</span> direction<span class="op">.</span>x<span class="op">)</span> <span class="op">-</span> M_PI_2<span class="op">;</span></span>
<span id="cb28-51"><a href="asteroids.html#cb28-51"></a>  <span class="op">}</span></span>
<span id="cb28-52"><a href="asteroids.html#cb28-52"></a><span class="op">}</span></span></code></pre></div>
<p>Os dados do evento são descritos pelo parâmetro <code>event</code> que é uma estrutura <a href="https://wiki.libsdl.org/SDL_Event"><code>SDL_Event</code></a> da SDL.</p>
<p>Os eventos do teclado são divididos em eventos de pressionamento de teclas (<code>SDL_KEYDOWN</code>), tratados nas linhas 5 a 16, e liberação de teclas (<code>SDL_KEYUP</code>), nas linhas 17 a 28. De acordo com as teclas pressionadas/liberadas, os bits de <code>m_gameData.m_input</code> são setados/resetados.</p>
<p>Os eventos do mouse são divididos em eventos de pressionamento (<code>SDL_MOUSEBUTTONDOWN</code>) e liberação (<code>SDL_MOUSEBUTTONUP</code>) dos botões, e eventos de movimentação do mouse (<code>SDL_MOUSEMOTION</code>).</p>
<p>Quando ocorre a movimentação do mouse, as coordenadas <span class="math inline">\((x,y)\)</span> do cursor são lidas com <code>SDL_GetMouseState</code> (linha 45) e convertidas para um vetor <code>direction</code> (linhas 47 e 48) definido pelo ponto que sai do centro da janela e vai até a posição do cursor. A coordenada <span class="math inline">\(y\)</span> é invertida na linha 48 porque, no sistema de coordenadas do mouse, o eixo <span class="math inline">\(y\)</span> é positivo para baixo, enquanto que no OpenGL é positivo para cima.</p>
<p>Na linha 50, o ângulo de rotação da nave é definido como o ângulo subentendido pelo vetor <code>direction</code>. A função <a href="https://en.wikipedia.org/wiki/Atan2"><code>atan2</code></a> retorna o ângulo entre o vetor <code>direction</code> e o eixo <span class="math inline">\(x\)</span> positivo. Desse valor é subtraído <span class="math inline">\(\pi/2\)</span> (90 graus) pois a orientação inicial da nave já é de 90 graus (a nave está “olhando” na direção do eixo <span class="math inline">\(y\)</span> e não na direção do eixo <span class="math inline">\(x\)</span>).</p>
<p>Vamos agora à definição de <code>Window::onCreate</code>:</p>
<div class="sourceCode" id="cb29" startFrom="54"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 53;"><span id="cb29-54"><a href="asteroids.html#cb29-54"></a><span class="dt">void</span> Window<span class="op">::</span>onCreate<span class="op">()</span> <span class="op">{</span></span>
<span id="cb29-55"><a href="asteroids.html#cb29-55"></a>  <span class="kw">auto</span> <span class="at">const</span> assetsPath<span class="op">{</span>abcg<span class="op">::</span>Application<span class="op">::</span>getAssetsPath<span class="op">()};</span></span>
<span id="cb29-56"><a href="asteroids.html#cb29-56"></a></span>
<span id="cb29-57"><a href="asteroids.html#cb29-57"></a>  <span class="co">// Load a new font</span></span>
<span id="cb29-58"><a href="asteroids.html#cb29-58"></a>  <span class="kw">auto</span> <span class="at">const</span> filename<span class="op">{</span>assetsPath <span class="op">+</span> <span class="st">&quot;Inconsolata-Medium.ttf&quot;</span><span class="op">};</span></span>
<span id="cb29-59"><a href="asteroids.html#cb29-59"></a>  <span class="va">m_font</span> <span class="op">=</span> ImGui<span class="op">::</span>GetIO<span class="op">().</span>Fonts<span class="op">-&gt;</span>AddFontFromFileTTF<span class="op">(</span>filename<span class="op">.</span>c_str<span class="op">(),</span> <span class="fl">60.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb29-60"><a href="asteroids.html#cb29-60"></a>  <span class="cf">if</span> <span class="op">(</span><span class="va">m_font</span> <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-61"><a href="asteroids.html#cb29-61"></a>    <span class="cf">throw</span> abcg<span class="op">::</span>RuntimeError<span class="op">(</span><span class="st">&quot;Cannot load font file&quot;</span><span class="op">);</span></span>
<span id="cb29-62"><a href="asteroids.html#cb29-62"></a>  <span class="op">}</span></span>
<span id="cb29-63"><a href="asteroids.html#cb29-63"></a></span>
<span id="cb29-64"><a href="asteroids.html#cb29-64"></a>  <span class="co">// Create program to render the other objects</span></span>
<span id="cb29-65"><a href="asteroids.html#cb29-65"></a>  <span class="va">m_objectsProgram</span> <span class="op">=</span></span>
<span id="cb29-66"><a href="asteroids.html#cb29-66"></a>      abcg<span class="op">::</span>createOpenGLProgram<span class="op">({{.</span>source <span class="op">=</span> assetsPath <span class="op">+</span> <span class="st">&quot;objects.vert&quot;</span><span class="op">,</span></span>
<span id="cb29-67"><a href="asteroids.html#cb29-67"></a>                                  <span class="op">.</span>stage <span class="op">=</span> abcg<span class="op">::</span>ShaderStage<span class="op">::</span>Vertex<span class="op">},</span></span>
<span id="cb29-68"><a href="asteroids.html#cb29-68"></a>                                 <span class="op">{.</span>source <span class="op">=</span> assetsPath <span class="op">+</span> <span class="st">&quot;objects.frag&quot;</span><span class="op">,</span></span>
<span id="cb29-69"><a href="asteroids.html#cb29-69"></a>                                  <span class="op">.</span>stage <span class="op">=</span> abcg<span class="op">::</span>ShaderStage<span class="op">::</span>Fragment<span class="op">}});</span></span>
<span id="cb29-70"><a href="asteroids.html#cb29-70"></a></span>
<span id="cb29-71"><a href="asteroids.html#cb29-71"></a>  abcg<span class="op">::</span>glClearColor<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb29-72"><a href="asteroids.html#cb29-72"></a></span>
<span id="cb29-73"><a href="asteroids.html#cb29-73"></a><span class="pp">#if !defined(__EMSCRIPTEN__)</span></span>
<span id="cb29-74"><a href="asteroids.html#cb29-74"></a>  abcg<span class="op">::</span>glEnable<span class="op">(</span>GL_PROGRAM_POINT_SIZE<span class="op">);</span></span>
<span id="cb29-75"><a href="asteroids.html#cb29-75"></a><span class="pp">#endif</span></span>
<span id="cb29-76"><a href="asteroids.html#cb29-76"></a></span>
<span id="cb29-77"><a href="asteroids.html#cb29-77"></a>  <span class="co">// Start pseudo-random number generator</span></span>
<span id="cb29-78"><a href="asteroids.html#cb29-78"></a>  <span class="va">m_randomEngine</span><span class="op">.</span>seed<span class="op">(</span></span>
<span id="cb29-79"><a href="asteroids.html#cb29-79"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now<span class="op">().</span>time_since_epoch<span class="op">().</span>count<span class="op">());</span></span>
<span id="cb29-80"><a href="asteroids.html#cb29-80"></a></span>
<span id="cb29-81"><a href="asteroids.html#cb29-81"></a>  restart<span class="op">();</span></span>
<span id="cb29-82"><a href="asteroids.html#cb29-82"></a><span class="op">}</span></span></code></pre></div>
<p>Nas linhas 57 a 62 é carregada a fonte TrueType da pasta <code>assets</code>. O tamanho da fonte é definido como <code>60.0f</code> na chamada à função <code>AddFontFromFileTTF</code> da ImGui. Internamente, a ImGui renderiza cada letra em uma textura que pode ser utilizada posteriormente em <code>onPaintUI</code> para produzir texto com essa fonte e tamanho. Esses dados ficam armazenados em <code>m_font</code>.</p>
<p>Na linha 66 é chamada a função <code>createOpenGLProgram</code> da ABCg para compilar e ligar os shaders <code>objects.vert</code> e <code>objects.frag</code>.</p>
<p>O restante do código de <code>Window::onCreate</code> contém funções que já usamos em projetos anteriores.</p>
<p>Na linha 81 é chamada a função membro <code>restart</code> que reinicia o estado do jogo. A definição de <code>Window::restart</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb30" startFrom="84"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 83;"><span id="cb30-84"><a href="asteroids.html#cb30-84"></a><span class="dt">void</span> Window<span class="op">::</span>restart<span class="op">()</span> <span class="op">{</span></span>
<span id="cb30-85"><a href="asteroids.html#cb30-85"></a>  <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">=</span> State<span class="op">::</span>Playing<span class="op">;</span></span>
<span id="cb30-86"><a href="asteroids.html#cb30-86"></a></span>
<span id="cb30-87"><a href="asteroids.html#cb30-87"></a>  <span class="va">m_ship</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span>
<span id="cb30-88"><a href="asteroids.html#cb30-88"></a><span class="op">}</span></span></code></pre></div>
<p>A função <code>Window::onUpdate</code> será definida como segue:</p>
<div class="sourceCode" id="cb31" startFrom="90"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 89;"><span id="cb31-90"><a href="asteroids.html#cb31-90"></a><span class="dt">void</span> Window<span class="op">::</span>onUpdate<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-91"><a href="asteroids.html#cb31-91"></a>  <span class="kw">auto</span> <span class="at">const</span> deltaTime<span class="op">{</span>gsl<span class="op">::</span>narrow_cast<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;(</span>getDeltaTime<span class="op">())};</span></span>
<span id="cb31-92"><a href="asteroids.html#cb31-92"></a></span>
<span id="cb31-93"><a href="asteroids.html#cb31-93"></a>  <span class="co">// Wait 5 seconds before restarting</span></span>
<span id="cb31-94"><a href="asteroids.html#cb31-94"></a>  <span class="cf">if</span> <span class="op">(</span><span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">!=</span> State<span class="op">::</span>Playing <span class="op">&amp;&amp;</span></span>
<span id="cb31-95"><a href="asteroids.html#cb31-95"></a>      <span class="va">m_restartWaitTimer</span><span class="op">.</span>elapsed<span class="op">()</span> <span class="op">&gt;</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-96"><a href="asteroids.html#cb31-96"></a>    restart<span class="op">();</span></span>
<span id="cb31-97"><a href="asteroids.html#cb31-97"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-98"><a href="asteroids.html#cb31-98"></a>  <span class="op">}</span></span>
<span id="cb31-99"><a href="asteroids.html#cb31-99"></a></span>
<span id="cb31-100"><a href="asteroids.html#cb31-100"></a>  <span class="va">m_ship</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_gameData</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb31-101"><a href="asteroids.html#cb31-101"></a><span class="op">}</span></span></code></pre></div>
<p>Na linha 91, <code>getDeltaTime</code> é uma função membro de <code>abcg::OpenGLWindow</code> que retorna o tempo que se passou, em segundos, desde a última chamada a <code>onPaint</code> (é o “delta” de tempo entre os quadros de exibição). Na linha 100, esse tempo é passado para a função <code>update</code> da nave, junto com o estado do jogo em <code>m_gameData</code> para atualizar a animação da nave.</p>
<div class="notebox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#1f5386;overflow:visible;position:relative;"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>
<div class="noteboxtitle">
Importante
</div>
<p>O valor retornado por <code>abcg::OpenGLWindow::getDeltaTime</code> deve ser utilizado para fazer com que a animação dos objetos seja sincronizada pelo tempo e não pela velocidade do computador.</p>
<p>Suponha que queremos animar o deslocamento de um asteroide, de <code>x = 0</code> para a coordenada <code>x = 10</code> em dois segundos. Para fazer isso, poderíamos incluir a seguinte expressão em <code>onUpdate</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="asteroids.html#cb32-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">+=</span> <span class="op">(</span><span class="fl">10.0</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">)</span> <span class="op">*</span> getDeltaTime<span class="op">();</span></span></code></pre></div>
<p>Isso faz com que <code>x</code> cresça a uma taxa de 5 unidades <strong>por segundo</strong>, independentemente da velocidade do computador.</p>
<p>Em um computador lento, que renderiza a uma taxa de, digamos, 10 FPS, <code>getDeltaTime</code> retornará <code>0.1</code> a cada quadro. Em um computador com GPU mais rápida, que renderiza a uma taxa de 100 FPS, <code>getDeltaTime</code> retornará <code>0.01</code> a cada quadro. Nos dois casos, a acumulação de <code>getDeltaTime</code> durante um segundo será exatamante <code>1</code>.</p>
<p>Em resumo, sempre utilize <code>getDeltaTime</code> para atualizar os parâmetros de uma animação. Nunca suponha que a velocidade de renderização será fixa.</p>
</div>
<p>A definição de <code>Window::onPaint</code> ficará assim:</p>
<div class="sourceCode" id="cb33" startFrom="103"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 102;"><span id="cb33-103"><a href="asteroids.html#cb33-103"></a><span class="dt">void</span> Window<span class="op">::</span>onPaint<span class="op">()</span> <span class="op">{</span></span>
<span id="cb33-104"><a href="asteroids.html#cb33-104"></a>  abcg<span class="op">::</span>glClear<span class="op">(</span>GL_COLOR_BUFFER_BIT<span class="op">);</span></span>
<span id="cb33-105"><a href="asteroids.html#cb33-105"></a>  abcg<span class="op">::</span>glViewport<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="va">m_viewportSize</span><span class="op">.</span>x<span class="op">,</span> <span class="va">m_viewportSize</span><span class="op">.</span>y<span class="op">);</span></span>
<span id="cb33-106"><a href="asteroids.html#cb33-106"></a></span>
<span id="cb33-107"><a href="asteroids.html#cb33-107"></a>  <span class="va">m_ship</span><span class="op">.</span>paint<span class="op">(</span><span class="va">m_gameData</span><span class="op">);</span></span>
<span id="cb33-108"><a href="asteroids.html#cb33-108"></a><span class="op">}</span></span></code></pre></div>
<p>A nave é renderizada usando a função <code>paint</code> que implementaremos em <code>Ship</code>.</p>
<p>Em <code>Window::onPaintUI</code>, mostraremos o texto de “Game Over” e “Win” de acordo com o estado do jogo:</p>
<div class="sourceCode" id="cb34" startFrom="110"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 109;"><span id="cb34-110"><a href="asteroids.html#cb34-110"></a><span class="dt">void</span> Window<span class="op">::</span>onPaintUI<span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-111"><a href="asteroids.html#cb34-111"></a>  abcg<span class="op">::</span>OpenGLWindow<span class="op">::</span>onPaintUI<span class="op">();</span></span>
<span id="cb34-112"><a href="asteroids.html#cb34-112"></a></span>
<span id="cb34-113"><a href="asteroids.html#cb34-113"></a>  <span class="op">{</span></span>
<span id="cb34-114"><a href="asteroids.html#cb34-114"></a>    <span class="kw">auto</span> <span class="at">const</span> size<span class="op">{</span>ImVec2<span class="op">(</span><span class="dv">300</span><span class="op">,</span> <span class="dv">85</span><span class="op">)};</span></span>
<span id="cb34-115"><a href="asteroids.html#cb34-115"></a>    <span class="kw">auto</span> <span class="at">const</span> position<span class="op">{</span>ImVec2<span class="op">((</span><span class="va">m_viewportSize</span><span class="op">.</span>x <span class="op">-</span> size<span class="op">.</span>x<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">,</span></span>
<span id="cb34-116"><a href="asteroids.html#cb34-116"></a>                               <span class="op">(</span><span class="va">m_viewportSize</span><span class="op">.</span>y <span class="op">-</span> size<span class="op">.</span>y<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">)};</span></span>
<span id="cb34-117"><a href="asteroids.html#cb34-117"></a>    ImGui<span class="op">::</span>SetNextWindowPos<span class="op">(</span>position<span class="op">);</span></span>
<span id="cb34-118"><a href="asteroids.html#cb34-118"></a>    ImGui<span class="op">::</span>SetNextWindowSize<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb34-119"><a href="asteroids.html#cb34-119"></a>    ImGuiWindowFlags <span class="at">const</span> flags<span class="op">{</span>ImGuiWindowFlags_NoBackground <span class="op">|</span></span>
<span id="cb34-120"><a href="asteroids.html#cb34-120"></a>                                 ImGuiWindowFlags_NoTitleBar <span class="op">|</span></span>
<span id="cb34-121"><a href="asteroids.html#cb34-121"></a>                                 ImGuiWindowFlags_NoInputs<span class="op">};</span></span>
<span id="cb34-122"><a href="asteroids.html#cb34-122"></a>    ImGui<span class="op">::</span>Begin<span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">,</span> <span class="kw">nullptr</span><span class="op">,</span> flags<span class="op">);</span></span>
<span id="cb34-123"><a href="asteroids.html#cb34-123"></a>    ImGui<span class="op">::</span>PushFont<span class="op">(</span><span class="va">m_font</span><span class="op">);</span></span>
<span id="cb34-124"><a href="asteroids.html#cb34-124"></a></span>
<span id="cb34-125"><a href="asteroids.html#cb34-125"></a>    <span class="cf">if</span> <span class="op">(</span><span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">==</span> State<span class="op">::</span>GameOver<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-126"><a href="asteroids.html#cb34-126"></a>      ImGui<span class="op">::</span>Text<span class="op">(</span><span class="st">&quot;Game Over!&quot;</span><span class="op">);</span></span>
<span id="cb34-127"><a href="asteroids.html#cb34-127"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">==</span> State<span class="op">::</span>Win<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-128"><a href="asteroids.html#cb34-128"></a>      ImGui<span class="op">::</span>Text<span class="op">(</span><span class="st">&quot;*You Win!*&quot;</span><span class="op">);</span></span>
<span id="cb34-129"><a href="asteroids.html#cb34-129"></a>    <span class="op">}</span></span>
<span id="cb34-130"><a href="asteroids.html#cb34-130"></a></span>
<span id="cb34-131"><a href="asteroids.html#cb34-131"></a>    ImGui<span class="op">::</span>PopFont<span class="op">();</span></span>
<span id="cb34-132"><a href="asteroids.html#cb34-132"></a>    ImGui<span class="op">::</span>End<span class="op">();</span></span>
<span id="cb34-133"><a href="asteroids.html#cb34-133"></a>  <span class="op">}</span></span>
<span id="cb34-134"><a href="asteroids.html#cb34-134"></a><span class="op">}</span></span></code></pre></div>
<p>Nas linhas 119 a 121 definimos os flags da janela da ImGui usando <code>ImGuiWindowFlags_NoBackground</code> para a janela ficar invisível e <code>ImGuiWindowFlags_NoInputs</code> para não receber entrada do teclado. O conteúdo da janela continua visível, de modo que <code>ImGui::Text</code> mostrará o texto sobreposto na tela.</p>
<p>Todo o texto exibido entre <code>ImGui::PushFont(m_font)</code> (linha 123) e <code>ImGui::PopFont()</code> (linha 131), usa a fonte <code>m_font</code>, que é a fonte Inconsolata de tamanho 60 criada em <code>Window::onCreate</code>.</p>
<p>As funções <code>Window::onResize</code> e <code>Window::onDestroy</code> ficarão como a seguir:</p>
<div class="sourceCode" id="cb35" startFrom="136"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 135;"><span id="cb35-136"><a href="asteroids.html#cb35-136"></a><span class="dt">void</span> Window<span class="op">::</span>onResize<span class="op">(</span>glm<span class="op">::</span>ivec2 <span class="at">const</span> <span class="op">&amp;</span>size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-137"><a href="asteroids.html#cb35-137"></a>  <span class="va">m_viewportSize</span> <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb35-138"><a href="asteroids.html#cb35-138"></a></span>
<span id="cb35-139"><a href="asteroids.html#cb35-139"></a>  abcg<span class="op">::</span>glClear<span class="op">(</span>GL_COLOR_BUFFER_BIT<span class="op">);</span></span>
<span id="cb35-140"><a href="asteroids.html#cb35-140"></a><span class="op">}</span></span>
<span id="cb35-141"><a href="asteroids.html#cb35-141"></a></span>
<span id="cb35-142"><a href="asteroids.html#cb35-142"></a><span class="dt">void</span> Window<span class="op">::</span>onDestroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb35-143"><a href="asteroids.html#cb35-143"></a>  abcg<span class="op">::</span>glDeleteProgram<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span>
<span id="cb35-144"><a href="asteroids.html#cb35-144"></a></span>
<span id="cb35-145"><a href="asteroids.html#cb35-145"></a>  <span class="va">m_ship</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb35-146"><a href="asteroids.html#cb35-146"></a><span class="op">}</span></span></code></pre></div>
<p>Não há nada de novo em <code>Window::onResize</code>. É o mesmo código já utilizado em outros projetos.</p>
<p>Em <code>Window::onDestroy</code>, <code>m_objectsProgram</code> é liberado e a função <code>destroy</code> de <code>m_ship</code> é chamada para liberar os recursos da nave.</p>
</div>
<div id="ship.h" class="section level4 unnumbered hasAnchor">
<h4>ship.h<a href="asteroids.html#ship.h" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A definição da classe <code>Ship</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb36" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb36-1"><a href="asteroids.html#cb36-1"></a><span class="pp">#ifndef SHIP_HPP_</span></span>
<span id="cb36-2"><a href="asteroids.html#cb36-2"></a><span class="pp">#define SHIP_HPP_</span></span>
<span id="cb36-3"><a href="asteroids.html#cb36-3"></a></span>
<span id="cb36-4"><a href="asteroids.html#cb36-4"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb36-5"><a href="asteroids.html#cb36-5"></a></span>
<span id="cb36-6"><a href="asteroids.html#cb36-6"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb36-7"><a href="asteroids.html#cb36-7"></a></span>
<span id="cb36-8"><a href="asteroids.html#cb36-8"></a><span class="kw">class</span> Ship <span class="op">{</span></span>
<span id="cb36-9"><a href="asteroids.html#cb36-9"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb36-10"><a href="asteroids.html#cb36-10"></a>  <span class="dt">void</span> create<span class="op">(</span>GLuint program<span class="op">);</span></span>
<span id="cb36-11"><a href="asteroids.html#cb36-11"></a>  <span class="dt">void</span> paint<span class="op">(</span>GameData <span class="at">const</span> <span class="op">&amp;</span>gameData<span class="op">);</span></span>
<span id="cb36-12"><a href="asteroids.html#cb36-12"></a>  <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb36-13"><a href="asteroids.html#cb36-13"></a>  <span class="dt">void</span> update<span class="op">(</span>GameData <span class="at">const</span> <span class="op">&amp;</span>gameData<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">);</span></span>
<span id="cb36-14"><a href="asteroids.html#cb36-14"></a></span>
<span id="cb36-15"><a href="asteroids.html#cb36-15"></a>  glm<span class="op">::</span>vec4 <span class="va">m_color</span><span class="op">{</span><span class="dv">1</span><span class="op">};</span></span>
<span id="cb36-16"><a href="asteroids.html#cb36-16"></a>  <span class="dt">float</span> <span class="va">m_rotation</span><span class="op">{};</span></span>
<span id="cb36-17"><a href="asteroids.html#cb36-17"></a>  <span class="dt">float</span> <span class="va">m_scale</span><span class="op">{</span><span class="fl">0.125</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb36-18"><a href="asteroids.html#cb36-18"></a>  glm<span class="op">::</span>vec2 <span class="va">m_translation</span><span class="op">{};</span></span>
<span id="cb36-19"><a href="asteroids.html#cb36-19"></a>  glm<span class="op">::</span>vec2 <span class="va">m_velocity</span><span class="op">{};</span></span>
<span id="cb36-20"><a href="asteroids.html#cb36-20"></a></span>
<span id="cb36-21"><a href="asteroids.html#cb36-21"></a>  abcg<span class="op">::</span>Timer <span class="va">m_trailBlinkTimer</span><span class="op">;</span></span>
<span id="cb36-22"><a href="asteroids.html#cb36-22"></a>  abcg<span class="op">::</span>Timer <span class="va">m_bulletCoolDownTimer</span><span class="op">;</span></span>
<span id="cb36-23"><a href="asteroids.html#cb36-23"></a></span>
<span id="cb36-24"><a href="asteroids.html#cb36-24"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb36-25"><a href="asteroids.html#cb36-25"></a>  GLuint <span class="va">m_program</span><span class="op">{};</span></span>
<span id="cb36-26"><a href="asteroids.html#cb36-26"></a>  GLint <span class="va">m_translationLoc</span><span class="op">{};</span></span>
<span id="cb36-27"><a href="asteroids.html#cb36-27"></a>  GLint <span class="va">m_colorLoc</span><span class="op">{};</span></span>
<span id="cb36-28"><a href="asteroids.html#cb36-28"></a>  GLint <span class="va">m_scaleLoc</span><span class="op">{};</span></span>
<span id="cb36-29"><a href="asteroids.html#cb36-29"></a>  GLint <span class="va">m_rotationLoc</span><span class="op">{};</span></span>
<span id="cb36-30"><a href="asteroids.html#cb36-30"></a></span>
<span id="cb36-31"><a href="asteroids.html#cb36-31"></a>  GLuint <span class="va">m_VAO</span><span class="op">{};</span></span>
<span id="cb36-32"><a href="asteroids.html#cb36-32"></a>  GLuint <span class="va">m_VBO</span><span class="op">{};</span></span>
<span id="cb36-33"><a href="asteroids.html#cb36-33"></a>  GLuint <span class="va">m_EBO</span><span class="op">{};</span></span>
<span id="cb36-34"><a href="asteroids.html#cb36-34"></a><span class="op">};</span></span>
<span id="cb36-35"><a href="asteroids.html#cb36-35"></a><span class="pp">#endif</span></span></code></pre></div>
<p>As propriedades da nave são definidas nas linhas 15 a 19: cor, ângulo de rotação, fator de escala, translação e vetor de velocidade.</p>
<p>Os temporizadores definidos nas linhas 21 e 224 são utilizados para controlar o tempo de piscagem dos foguetes da nave em aceleração, e o tempo de espera entre um tiro e outro.</p>
<p>As variáveis nas linhas 26 a 29 receberão o resultado de <code>glGetUniformLocation</code> para as variáveis uniformes do vertex shader. Isso será feito em <code>Ship::create</code>.</p>
</div>
<div id="ship.cpp" class="section level4 unnumbered hasAnchor">
<h4>ship.cpp<a href="asteroids.html#ship.cpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Aqui definiremos <code>Ship::create</code>, <code>Ship::paint</code>, <code>Ship::destroy</code> e <code>Ship::update</code>.</p>
<p>A definição de <code>Ship::create</code> no início do arquivo contém o código que cria o VBO e o VAO da nave:</p>
<div class="sourceCode" id="cb37" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb37-1"><a href="asteroids.html#cb37-1"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb37-2"><a href="asteroids.html#cb37-2"></a></span>
<span id="cb37-3"><a href="asteroids.html#cb37-3"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/fast_trigonometry.hpp&gt;</span></span>
<span id="cb37-4"><a href="asteroids.html#cb37-4"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/rotate_vector.hpp&gt;</span></span>
<span id="cb37-5"><a href="asteroids.html#cb37-5"></a></span>
<span id="cb37-6"><a href="asteroids.html#cb37-6"></a><span class="dt">void</span> Ship<span class="op">::</span>create<span class="op">(</span>GLuint program<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-7"><a href="asteroids.html#cb37-7"></a>  destroy<span class="op">();</span></span>
<span id="cb37-8"><a href="asteroids.html#cb37-8"></a></span>
<span id="cb37-9"><a href="asteroids.html#cb37-9"></a>  <span class="va">m_program</span> <span class="op">=</span> program<span class="op">;</span></span>
<span id="cb37-10"><a href="asteroids.html#cb37-10"></a></span>
<span id="cb37-11"><a href="asteroids.html#cb37-11"></a>  <span class="co">// Get location of uniforms in the program</span></span>
<span id="cb37-12"><a href="asteroids.html#cb37-12"></a>  <span class="va">m_colorLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;color&quot;</span><span class="op">);</span></span>
<span id="cb37-13"><a href="asteroids.html#cb37-13"></a>  <span class="va">m_rotationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;rotation&quot;</span><span class="op">);</span></span>
<span id="cb37-14"><a href="asteroids.html#cb37-14"></a>  <span class="va">m_scaleLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">);</span></span>
<span id="cb37-15"><a href="asteroids.html#cb37-15"></a>  <span class="va">m_translationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;translation&quot;</span><span class="op">);</span></span>
<span id="cb37-16"><a href="asteroids.html#cb37-16"></a></span>
<span id="cb37-17"><a href="asteroids.html#cb37-17"></a>  <span class="co">// Reset ship attributes</span></span>
<span id="cb37-18"><a href="asteroids.html#cb37-18"></a>  <span class="va">m_rotation</span> <span class="op">=</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb37-19"><a href="asteroids.html#cb37-19"></a>  <span class="va">m_translation</span> <span class="op">=</span> glm<span class="op">::</span>vec2<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-20"><a href="asteroids.html#cb37-20"></a>  <span class="va">m_velocity</span> <span class="op">=</span> glm<span class="op">::</span>vec2<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-21"><a href="asteroids.html#cb37-21"></a></span>
<span id="cb37-22"><a href="asteroids.html#cb37-22"></a>  <span class="co">// clang-format off</span></span>
<span id="cb37-23"><a href="asteroids.html#cb37-23"></a>  <span class="bu">std::</span>array<span class="op"> </span>positions<span class="op">{</span></span>
<span id="cb37-24"><a href="asteroids.html#cb37-24"></a>      <span class="co">// Ship body</span></span>
<span id="cb37-25"><a href="asteroids.html#cb37-25"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">02.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">15.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">02.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-26"><a href="asteroids.html#cb37-26"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">15.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-27"><a href="asteroids.html#cb37-27"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">03.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">03.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-28"><a href="asteroids.html#cb37-28"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">15.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-29"><a href="asteroids.html#cb37-29"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">15.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">02.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">02.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-30"><a href="asteroids.html#cb37-30"></a></span>
<span id="cb37-31"><a href="asteroids.html#cb37-31"></a>      <span class="co">// Cannon (left)</span></span>
<span id="cb37-32"><a href="asteroids.html#cb37-32"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">10.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">04.0</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-33"><a href="asteroids.html#cb37-33"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">04.0</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">10.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-34"><a href="asteroids.html#cb37-34"></a></span>
<span id="cb37-35"><a href="asteroids.html#cb37-35"></a>      <span class="co">// Cannon (right)</span></span>
<span id="cb37-36"><a href="asteroids.html#cb37-36"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">10.5</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">04.0</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-37"><a href="asteroids.html#cb37-37"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">04.0</span><span class="bu">f</span><span class="op">},</span> glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">12.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">+</span><span class="fl">10.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-38"><a href="asteroids.html#cb37-38"></a>      </span>
<span id="cb37-39"><a href="asteroids.html#cb37-39"></a>      <span class="co">// Thruster trail (left)</span></span>
<span id="cb37-40"><a href="asteroids.html#cb37-40"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">12.0</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span> </span>
<span id="cb37-41"><a href="asteroids.html#cb37-41"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">18.0</span><span class="bu">f</span><span class="op">},</span> </span>
<span id="cb37-42"><a href="asteroids.html#cb37-42"></a>      glm<span class="op">::</span>vec2<span class="op">{-</span><span class="fl">07.0</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-43"><a href="asteroids.html#cb37-43"></a></span>
<span id="cb37-44"><a href="asteroids.html#cb37-44"></a>      <span class="co">// Thruster trail (right)</span></span>
<span id="cb37-45"><a href="asteroids.html#cb37-45"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">07.0</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span> </span>
<span id="cb37-46"><a href="asteroids.html#cb37-46"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">09.5</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">18.0</span><span class="bu">f</span><span class="op">},</span> </span>
<span id="cb37-47"><a href="asteroids.html#cb37-47"></a>      glm<span class="op">::</span>vec2<span class="op">{+</span><span class="fl">12.0</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">07.5</span><span class="bu">f</span><span class="op">},</span></span>
<span id="cb37-48"><a href="asteroids.html#cb37-48"></a>      <span class="op">};</span></span>
<span id="cb37-49"><a href="asteroids.html#cb37-49"></a></span>
<span id="cb37-50"><a href="asteroids.html#cb37-50"></a>  <span class="co">// Normalize</span></span>
<span id="cb37-51"><a href="asteroids.html#cb37-51"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>position <span class="op">:</span> positions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-52"><a href="asteroids.html#cb37-52"></a>    position <span class="op">/=</span> glm<span class="op">::</span>vec2<span class="op">{</span><span class="fl">15.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">15.5</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb37-53"><a href="asteroids.html#cb37-53"></a>  <span class="op">}</span></span>
<span id="cb37-54"><a href="asteroids.html#cb37-54"></a></span>
<span id="cb37-55"><a href="asteroids.html#cb37-55"></a>  <span class="bu">std::</span>array<span class="op"> </span><span class="at">const</span> indices<span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb37-56"><a href="asteroids.html#cb37-56"></a>                           <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb37-57"><a href="asteroids.html#cb37-57"></a>                           <span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb37-58"><a href="asteroids.html#cb37-58"></a>                           <span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb37-59"><a href="asteroids.html#cb37-59"></a>                           <span class="dv">9</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb37-60"><a href="asteroids.html#cb37-60"></a>                           <span class="dv">9</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb37-61"><a href="asteroids.html#cb37-61"></a>                           <span class="dv">9</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb37-62"><a href="asteroids.html#cb37-62"></a>                           <span class="dv">8</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span></span>
<span id="cb37-63"><a href="asteroids.html#cb37-63"></a>                           <span class="co">// Cannons</span></span>
<span id="cb37-64"><a href="asteroids.html#cb37-64"></a>                           <span class="dv">10</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb37-65"><a href="asteroids.html#cb37-65"></a>                           <span class="dv">10</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">13</span><span class="op">,</span></span>
<span id="cb37-66"><a href="asteroids.html#cb37-66"></a>                           <span class="dv">14</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb37-67"><a href="asteroids.html#cb37-67"></a>                           <span class="dv">14</span><span class="op">,</span> <span class="dv">16</span><span class="op">,</span> <span class="dv">17</span><span class="op">,</span></span>
<span id="cb37-68"><a href="asteroids.html#cb37-68"></a>                           <span class="co">// Thruster trails</span></span>
<span id="cb37-69"><a href="asteroids.html#cb37-69"></a>                           <span class="dv">18</span><span class="op">,</span> <span class="dv">19</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb37-70"><a href="asteroids.html#cb37-70"></a>                           <span class="dv">21</span><span class="op">,</span> <span class="dv">22</span><span class="op">,</span> <span class="dv">23</span><span class="op">};</span></span>
<span id="cb37-71"><a href="asteroids.html#cb37-71"></a>  <span class="co">// clang-format on                           </span></span>
<span id="cb37-72"><a href="asteroids.html#cb37-72"></a></span>
<span id="cb37-73"><a href="asteroids.html#cb37-73"></a>  <span class="co">// Generate VBO</span></span>
<span id="cb37-74"><a href="asteroids.html#cb37-74"></a>  abcg<span class="op">::</span>glGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb37-75"><a href="asteroids.html#cb37-75"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb37-76"><a href="asteroids.html#cb37-76"></a>  abcg<span class="op">::</span>glBufferData<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>positions<span class="op">),</span> positions<span class="op">.</span>data<span class="op">(),</span></span>
<span id="cb37-77"><a href="asteroids.html#cb37-77"></a>                     GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb37-78"><a href="asteroids.html#cb37-78"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-79"><a href="asteroids.html#cb37-79"></a></span>
<span id="cb37-80"><a href="asteroids.html#cb37-80"></a>  <span class="co">// Generate EBO</span></span>
<span id="cb37-81"><a href="asteroids.html#cb37-81"></a>  abcg<span class="op">::</span>glGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_EBO</span><span class="op">);</span></span>
<span id="cb37-82"><a href="asteroids.html#cb37-82"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_EBO</span><span class="op">);</span></span>
<span id="cb37-83"><a href="asteroids.html#cb37-83"></a>  abcg<span class="op">::</span>glBufferData<span class="op">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>indices<span class="op">),</span> indices<span class="op">.</span>data<span class="op">(),</span></span>
<span id="cb37-84"><a href="asteroids.html#cb37-84"></a>                     GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb37-85"><a href="asteroids.html#cb37-85"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-86"><a href="asteroids.html#cb37-86"></a></span>
<span id="cb37-87"><a href="asteroids.html#cb37-87"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb37-88"><a href="asteroids.html#cb37-88"></a>  GLint positionAttribute<span class="op">{</span>abcg<span class="op">::</span>glGetAttribLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;inPosition&quot;</span><span class="op">)};</span></span>
<span id="cb37-89"><a href="asteroids.html#cb37-89"></a></span>
<span id="cb37-90"><a href="asteroids.html#cb37-90"></a>  <span class="co">// Create VAO</span></span>
<span id="cb37-91"><a href="asteroids.html#cb37-91"></a>  abcg<span class="op">::</span>glGenVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb37-92"><a href="asteroids.html#cb37-92"></a></span>
<span id="cb37-93"><a href="asteroids.html#cb37-93"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb37-94"><a href="asteroids.html#cb37-94"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb37-95"><a href="asteroids.html#cb37-95"></a></span>
<span id="cb37-96"><a href="asteroids.html#cb37-96"></a>  abcg<span class="op">::</span>glEnableVertexAttribArray<span class="op">(</span>positionAttribute<span class="op">);</span></span>
<span id="cb37-97"><a href="asteroids.html#cb37-97"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb37-98"><a href="asteroids.html#cb37-98"></a>  abcg<span class="op">::</span>glVertexAttribPointer<span class="op">(</span>positionAttribute<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> GL_FALSE<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb37-99"><a href="asteroids.html#cb37-99"></a>                              <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb37-100"><a href="asteroids.html#cb37-100"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-101"><a href="asteroids.html#cb37-101"></a></span>
<span id="cb37-102"><a href="asteroids.html#cb37-102"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_EBO</span><span class="op">);</span></span>
<span id="cb37-103"><a href="asteroids.html#cb37-103"></a></span>
<span id="cb37-104"><a href="asteroids.html#cb37-104"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb37-105"><a href="asteroids.html#cb37-105"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb37-106"><a href="asteroids.html#cb37-106"></a><span class="op">}</span></span></code></pre></div>
<p>Observe que <code>destroy</code> é chamada logo no início da função para liberar o VBO e o VAO anterior, caso existam.</p>
<p>Nas linhas 12 a 15, a localização das variáveis uniformes é salva para ser utilizada posteriormente na renderização.</p>
<p>O arranjo <code>positions</code> (linhas 23 a 48) contém a posição dos vértices da nave. São 24 vértices (de 0 a 23), como mostra a figura <a href="asteroids.html#fig:ship1">6.7</a>. Esses vértices são ligados para formar 14 triângulos. A imagem foi dividida em duas para facilitar a visualização, pois há sobreposição de triângulos:</p>
<ul>
<li>Os vértices de 0 a 9 definem o corpo da nave;</li>
<li>Os vértices de índices 10 a 17 definem os canhões de tiro;</li>
<li>Os vértices de 18 a 23 definem dois triângulos que representam o fogo dos foguetes. Esses dois triângulos só serão desenhados quando a nave estiver acelerando.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ship1"></span>
<img src="images/05_ship1.svg" alt="Geometria da nave." width="100%" />
<p class="caption">
Figura 6.7: Geometria da nave.
</p>
</div>
<p>As coordenadas <span class="math inline">\(x\)</span> em <code>positions</code> estão no intervalo <span class="math inline">\([-15.5, 15.5]\)</span>. Nas linhas 51 a 53, esse intervalo é mapeado para <span class="math inline">\([-1,1]\)</span> de modo que a nave fique dentro da região visível do viewport. Após a normalização, a nave já poderá ser vista no viewport, mas ainda estará muito grande. Para chegar ao tamanho final, a escala é ajustada no shader usando <code>m_scale</code>, que é <code>0.125</code> (valor definido na linha 17 de <code>ship.h</code>).</p>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Poderíamos ter definido <code>positions</code> diretamente com os valores normalizados. Não há um motivo especial para as coordenadas originais da nave variarem de -15.5 a 15.5. Só é assim porque esse foi o tamanho utilizado quando a nave foi modelada pela primeira vez em um software de edição de gráficos vetoriais.</p>
</div>
<p>Na figura <a href="asteroids.html#fig:ship1">6.7</a>, todos os vértices ligados por linhas pontilhadas fazem parte de mais de um triângulo. Por exemplo, o vértice de índice 0 é compartilhado por quatro triângulos. Para evitar ter de criar quatro vértices na mesma posição, um para cada triângulo, vamos usar o conceito de <em>geometria indexada</em>. Nas linhas 55 a 70 é definido um arranjo de índices aos vértices. Cada grupo de três índices define um triângulo (compare com a figura <a href="asteroids.html#fig:ship1">6.7</a>).</p>
<p>O VBO que contém os dados de <code>positions</code> é criado nas linhas 74 a 78. Nas linhas 81 a 85 é criado um <em>element buffer object</em> (EBO), que é o buffer de índices do VBO. O EBO armazena os dados de <code>indices</code>. Quando o comando de renderização é chamado com <code>GL_TRIANGLES</code>, cada sequência de três índices do EBO é utilizada para criar um triângulo.</p>
<p>No restante do código de <code>create</code>, o VAO é criado para salvar a vinculação do VBO e o mapeamento do VBO para o atributo de entrada do vertex shader. Note que o VAO também salva a vinculação do EBO na linha 102. Quando o VAO for utilizado em <code>paint</code>, toda a configuração entre as linhas 94 a 105 será aplicada ao pipeline.</p>
<p>O código de <code>Ship::paint</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb38" startFrom="108"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 107;"><span id="cb38-108"><a href="asteroids.html#cb38-108"></a><span class="dt">void</span> Ship<span class="op">::</span>paint<span class="op">(</span><span class="at">const</span> GameData <span class="op">&amp;</span>gameData<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-109"><a href="asteroids.html#cb38-109"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_state</span> <span class="op">!=</span> State<span class="op">::</span>Playing<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb38-110"><a href="asteroids.html#cb38-110"></a></span>
<span id="cb38-111"><a href="asteroids.html#cb38-111"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="va">m_program</span><span class="op">);</span></span>
<span id="cb38-112"><a href="asteroids.html#cb38-112"></a></span>
<span id="cb38-113"><a href="asteroids.html#cb38-113"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb38-114"><a href="asteroids.html#cb38-114"></a></span>
<span id="cb38-115"><a href="asteroids.html#cb38-115"></a>  abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_scaleLoc</span><span class="op">,</span> <span class="va">m_scale</span><span class="op">);</span></span>
<span id="cb38-116"><a href="asteroids.html#cb38-116"></a>  abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_rotationLoc</span><span class="op">,</span> <span class="va">m_rotation</span><span class="op">);</span></span>
<span id="cb38-117"><a href="asteroids.html#cb38-117"></a>  abcg<span class="op">::</span>glUniform2fv<span class="op">(</span><span class="va">m_translationLoc</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_translation</span><span class="op">.</span>x<span class="op">);</span></span>
<span id="cb38-118"><a href="asteroids.html#cb38-118"></a></span>
<span id="cb38-119"><a href="asteroids.html#cb38-119"></a>  <span class="co">// Restart thruster blink timer every 100 ms</span></span>
<span id="cb38-120"><a href="asteroids.html#cb38-120"></a>  <span class="cf">if</span> <span class="op">(</span><span class="va">m_trailBlinkTimer</span><span class="op">.</span>elapsed<span class="op">()</span> <span class="op">&gt;</span> <span class="fl">100.0</span> <span class="op">/</span> <span class="fl">1000.0</span><span class="op">)</span> <span class="va">m_trailBlinkTimer</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb38-121"><a href="asteroids.html#cb38-121"></a></span>
<span id="cb38-122"><a href="asteroids.html#cb38-122"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_input</span><span class="op">[</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">)])</span> <span class="op">{</span></span>
<span id="cb38-123"><a href="asteroids.html#cb38-123"></a>    <span class="co">// Show thruster trail during 50 ms</span></span>
<span id="cb38-124"><a href="asteroids.html#cb38-124"></a>    <span class="cf">if</span> <span class="op">(</span><span class="va">m_trailBlinkTimer</span><span class="op">.</span>elapsed<span class="op">()</span> <span class="op">&lt;</span> <span class="fl">50.0</span> <span class="op">/</span> <span class="fl">1000.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-125"><a href="asteroids.html#cb38-125"></a>      abcg<span class="op">::</span>glEnable<span class="op">(</span>GL_BLEND<span class="op">);</span></span>
<span id="cb38-126"><a href="asteroids.html#cb38-126"></a>      abcg<span class="op">::</span>glBlendFunc<span class="op">(</span>GL_SRC_ALPHA<span class="op">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="op">);</span></span>
<span id="cb38-127"><a href="asteroids.html#cb38-127"></a></span>
<span id="cb38-128"><a href="asteroids.html#cb38-128"></a>      <span class="co">// 50% transparent</span></span>
<span id="cb38-129"><a href="asteroids.html#cb38-129"></a>      abcg<span class="op">::</span>glUniform4f<span class="op">(</span><span class="va">m_colorLoc</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.5</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb38-130"><a href="asteroids.html#cb38-130"></a></span>
<span id="cb38-131"><a href="asteroids.html#cb38-131"></a>      abcg<span class="op">::</span>glDrawElements<span class="op">(</span>GL_TRIANGLES<span class="op">,</span> <span class="dv">14</span> <span class="op">*</span> <span class="dv">3</span><span class="op">,</span> GL_UNSIGNED_INT<span class="op">,</span> <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb38-132"><a href="asteroids.html#cb38-132"></a></span>
<span id="cb38-133"><a href="asteroids.html#cb38-133"></a>      abcg<span class="op">::</span>glDisable<span class="op">(</span>GL_BLEND<span class="op">);</span></span>
<span id="cb38-134"><a href="asteroids.html#cb38-134"></a>    <span class="op">}</span></span>
<span id="cb38-135"><a href="asteroids.html#cb38-135"></a>  <span class="op">}</span></span>
<span id="cb38-136"><a href="asteroids.html#cb38-136"></a></span>
<span id="cb38-137"><a href="asteroids.html#cb38-137"></a>  abcg<span class="op">::</span>glUniform4fv<span class="op">(</span><span class="va">m_colorLoc</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_color</span><span class="op">.</span>r<span class="op">);</span></span>
<span id="cb38-138"><a href="asteroids.html#cb38-138"></a>  abcg<span class="op">::</span>glDrawElements<span class="op">(</span>GL_TRIANGLES<span class="op">,</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">3</span><span class="op">,</span> GL_UNSIGNED_INT<span class="op">,</span> <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb38-139"><a href="asteroids.html#cb38-139"></a></span>
<span id="cb38-140"><a href="asteroids.html#cb38-140"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb38-141"><a href="asteroids.html#cb38-141"></a></span>
<span id="cb38-142"><a href="asteroids.html#cb38-142"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb38-143"><a href="asteroids.html#cb38-143"></a><span class="op">}</span></span></code></pre></div>
<p>Note que <code>paint</code> retorna imediatamente caso o jogo não esteja no estado <code>State::Playing</code>.</p>
<p>A escala, ângulo de rotação e translação da nave são enviadas às variáveis uniformes nas linhas 115 a 117.</p>
<p>Na linha 120, o temporizador <code>m_trailBlinkTimer</code> é reiniciado a cada 100 milissegundos. Ele é utilizado quando a nave está acelerando, de modo a mostrar o rastro de fogo do foguete durante 50 milissegundos, intercalado com uma pausa também de 50 milissegundos. Para desenhar o rastro de fogo, todos os 14 triângulos da geometria da nave são exibidos usando transparência de 50% (linhas 125 a 133). Isso é necessário pois não é possível desenhar só os dois triângulos finais. Para isso precisaríamos ter de criar um outro VBO, o que daria mais trabalho.</p>
<p>Na linha 138 é renderizado o corpo da nave sem o rastro do foguete, isto é, só são renderizados os primeiros 12 triângulos. Nessa renderização, a nave é renderizada com cor opaca, sobrepondo a renderização anterior da nave 50% transparente.</p>
<p>Note que a função de renderização é <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDrawElements.xhtml"><code>glDrawElements</code></a>. Essa função deve ser utilizada no lugar de <code>glDrawArrays</code> sempre que quisermos desenhar geometria indexada.</p>
<p>A função <code>Ship::destroy</code> contém apenas a liberação do VBO, EBO e VAO:</p>
<div class="sourceCode" id="cb39" startFrom="145"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 144;"><span id="cb39-145"><a href="asteroids.html#cb39-145"></a><span class="dt">void</span> Ship<span class="op">::</span>destroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb39-146"><a href="asteroids.html#cb39-146"></a>  abcg<span class="op">::</span>glDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb39-147"><a href="asteroids.html#cb39-147"></a>  abcg<span class="op">::</span>glDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_EBO</span><span class="op">);</span></span>
<span id="cb39-148"><a href="asteroids.html#cb39-148"></a>  abcg<span class="op">::</span>glDeleteVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb39-149"><a href="asteroids.html#cb39-149"></a><span class="op">}</span></span></code></pre></div>
<p>Na função <code>Ship::update</code> é onde são atualizados os atributos de orientação e velocidade da nave de acordo com o estado de <code>GameData::m_input</code>:</p>
<div class="sourceCode" id="cb40" startFrom="151"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 150;"><span id="cb40-151"><a href="asteroids.html#cb40-151"></a><span class="dt">void</span> Ship<span class="op">::</span>update<span class="op">(</span>GameData <span class="at">const</span> <span class="op">&amp;</span>gameData<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-152"><a href="asteroids.html#cb40-152"></a>  <span class="co">// Rotate</span></span>
<span id="cb40-153"><a href="asteroids.html#cb40-153"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_input</span><span class="op">[</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Left<span class="op">)])</span></span>
<span id="cb40-154"><a href="asteroids.html#cb40-154"></a>    <span class="va">m_rotation</span> <span class="op">=</span> glm<span class="op">::</span>wrapAngle<span class="op">(</span><span class="va">m_rotation</span> <span class="op">+</span> <span class="fl">4.0</span><span class="bu">f</span> <span class="op">*</span> deltaTime<span class="op">);</span></span>
<span id="cb40-155"><a href="asteroids.html#cb40-155"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_input</span><span class="op">[</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Right<span class="op">)])</span></span>
<span id="cb40-156"><a href="asteroids.html#cb40-156"></a>    <span class="va">m_rotation</span> <span class="op">=</span> glm<span class="op">::</span>wrapAngle<span class="op">(</span><span class="va">m_rotation</span> <span class="op">-</span> <span class="fl">4.0</span><span class="bu">f</span> <span class="op">*</span> deltaTime<span class="op">);</span></span>
<span id="cb40-157"><a href="asteroids.html#cb40-157"></a></span>
<span id="cb40-158"><a href="asteroids.html#cb40-158"></a>  <span class="co">// Apply thrust</span></span>
<span id="cb40-159"><a href="asteroids.html#cb40-159"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_input</span><span class="op">[</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Up<span class="op">)]</span> <span class="op">&amp;&amp;</span></span>
<span id="cb40-160"><a href="asteroids.html#cb40-160"></a>      gameData<span class="op">.</span><span class="va">m_state</span> <span class="op">==</span> State<span class="op">::</span>Playing<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-161"><a href="asteroids.html#cb40-161"></a>    <span class="co">// Thrust in the forward vector</span></span>
<span id="cb40-162"><a href="asteroids.html#cb40-162"></a>    <span class="kw">auto</span> <span class="at">const</span> forward<span class="op">{</span>glm<span class="op">::</span>rotate<span class="op">(</span>glm<span class="op">::</span>vec2<span class="op">{</span><span class="fl">0.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">},</span> <span class="va">m_rotation</span><span class="op">)};</span></span>
<span id="cb40-163"><a href="asteroids.html#cb40-163"></a>    <span class="va">m_velocity</span> <span class="op">+=</span> forward <span class="op">*</span> deltaTime<span class="op">;</span></span>
<span id="cb40-164"><a href="asteroids.html#cb40-164"></a>  <span class="op">}</span></span>
<span id="cb40-165"><a href="asteroids.html#cb40-165"></a><span class="op">}</span></span></code></pre></div>
<p>A rotação (linhas 153 a 156) é feita a uma taxa de 4 radianos por segundo (note o uso do <code>deltaTime</code>). A função <code>glm::wrapAngle</code> é utilizada para fazer com que o valor sempre fique no intervalo circular <span class="math inline">\([0,2\pi]\)</span>. O <code>#include &lt;glm/gtx/fast_trigonometry.hpp&gt;</code> na linha 3 de <code>ship.cpp</code> serve para incluir essa função da biblioteca GLM.</p>
<p>A aceleração é atualizada no <code>if</code> da linha 159. Na linha 162 é calculado um vetor que indica a direção para onde a nave está apontando (vetor <code>forward</code>). Isso é obtido aplicando uma rotação no vetor <span class="math inline">\((0, 1)\)</span><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a> usando o ângulo atual da nave. Uma vez calculado o vetor <code>forward</code>, ele é adicionado ao vetor de velocidade <code>m_velocity</code> na linha 163. Observe novamente o uso do <code>deltaTime</code>. Como <code>forward</code> é um vetor unitário, a velocidade será incrementada em uma unidade por segundo.</p>
<p>Observe que o <code>#include</code> na linha 4 de <code>ship.cpp</code> (<code>#include &lt;glm/gtx/rotate_vector.hpp&gt;</code>) inclui a função <code>glm::rotate</code> da biblioteca GLM.</p>
<p>Visualmente, a nave ficará presa no centro do viewport, mas os outros objetos da cena (asteroides, estrelas e tiros) usarão <code>m_velocity</code> (na verdade, <code>-m_velocity</code>) para serem deslocados.</p>
<p>Se o código for construído neste momento, o resultado será como mostrado a seguir (use o <a href="https://hbatagelo.github.io/abcgapps/asteroids1/index.html">link original</a> caso queria controlar a nave pelo teclado):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids1/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código do projeto pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids1.zip">deste link</a>.</p>
</div>
</div>
<div id="estrelas" class="section level3 unnumbered hasAnchor">
<h3>Estrelas<a href="asteroids.html#estrelas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As estrelas serão desenhadas como pontos (<code>GL_POINTS</code>) e usarão os shaders <code>stars.vert</code> e <code>stars.frag</code> definidos a seguir.</p>
<div id="stars.vert" class="section level4 unnumbered hasAnchor">
<h4>stars.vert<a href="asteroids.html#stars.vert" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb41"><pre class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb41-1"><a href="asteroids.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#version 300 es</span></span>
<span id="cb41-2"><a href="asteroids.html#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="asteroids.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">layout</span><span class="op">(</span><span class="dt">location</span> <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="dt">in</span> <span class="dt">vec2</span> inPosition<span class="op">;</span></span>
<span id="cb41-4"><a href="asteroids.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">layout</span><span class="op">(</span><span class="dt">location</span> <span class="op">=</span> <span class="dv">1</span><span class="op">)</span> <span class="dt">in</span> <span class="dt">vec3</span> inColor<span class="op">;</span></span>
<span id="cb41-5"><a href="asteroids.html#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="asteroids.html#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">uniform</span> <span class="dt">vec2</span> translation<span class="op">;</span></span>
<span id="cb41-7"><a href="asteroids.html#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">uniform</span> <span class="dt">float</span> pointSize<span class="op">;</span></span>
<span id="cb41-8"><a href="asteroids.html#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="asteroids.html#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">;</span></span>
<span id="cb41-10"><a href="asteroids.html#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="asteroids.html#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb41-12"><a href="asteroids.html#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">gl_PointSize</span> <span class="op">=</span> pointSize<span class="op">;</span></span>
<span id="cb41-13"><a href="asteroids.html#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">gl_Position</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>inPosition<span class="op">.</span><span class="fu">xy</span> <span class="op">+</span> translation<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-14"><a href="asteroids.html#cb41-14" aria-hidden="true" tabindex="-1"></a>  fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>inColor<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-15"><a href="asteroids.html#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Os atributos de entrada são uma posição <span class="math inline">\((x,y)\)</span> (<code>inPosition</code>) e uma cor RGB (<code>inColor</code>). Em <code>main</code>, a cor de entrada é copiada para o atributo de saída (<code>fragColor</code>) como uma cor RGBA onde A é 1. A posição do ponto é deslocada por <code>translation</code>, e o tamanho do ponto é definido por <code>pointSize</code>.</p>
</div>
<div id="stars.frag" class="section level4 unnumbered hasAnchor">
<h4>stars.frag<a href="asteroids.html#stars.frag" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb42"><pre class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb42-1"><a href="asteroids.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#version 300 es</span></span>
<span id="cb42-2"><a href="asteroids.html#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="asteroids.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="dt">precision</span> <span class="dt">mediump</span> <span class="dt">float</span><span class="op">;</span></span>
<span id="cb42-4"><a href="asteroids.html#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="asteroids.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="dt">in</span> <span class="dt">vec4</span> fragColor<span class="op">;</span></span>
<span id="cb42-6"><a href="asteroids.html#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="asteroids.html#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="dt">out</span> <span class="dt">vec4</span> outColor<span class="op">;</span></span>
<span id="cb42-8"><a href="asteroids.html#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="asteroids.html#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb42-10"><a href="asteroids.html#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> intensity <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">length</span><span class="op">(</span><span class="bu">gl_PointCoord</span> <span class="op">-</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">0.5</span><span class="op">))</span> <span class="op">*</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb42-11"><a href="asteroids.html#cb42-11" aria-hidden="true" tabindex="-1"></a>  outColor <span class="op">=</span> fragColor <span class="op">*</span> intensity<span class="op">;</span></span>
<span id="cb42-12"><a href="asteroids.html#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>O processamento principal deste shader ocorre na definição da variável <code>intensity</code>. Para compreendermos o que está acontecendo, lembre-se primeiro que o tamanho de um ponto (<code>gl_PointSize</code>) é dado em pixels. O ponto é na verdade um quadrado centralizado na posição de cada ponto. O fragment shader explora esse fato para exibir um gradiente radial no quadrado de modo a simular o formato circular de uma estrela. A variável embutida <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/gl_PointCoord.xhtml"><code>gl_PointCoord</code></a> contém as coordenadas do fragmento dentro do quadrado. Na configuração padrão, <span class="math inline">\((0,0)\)</span> é o canto superior esquerdo, e <span class="math inline">\((1,1)\)</span> é o canto inferior direito (figura <a href="asteroids.html#fig:stars1">6.8</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:stars1"></span>
<img src="images/05_stars1.svg" alt="Quadrado gerado em torno de um ponto de `GL_POINTS`, e coordenadas de `gl_PointCoord` dentro do quadrado formado." width="70%" />
<p class="caption">
Figura 6.8: Quadrado gerado em torno de um ponto de <code>GL_POINTS</code>, e coordenadas de <code>gl_PointCoord</code> dentro do quadrado formado.
</p>
</div>
<p>A expressão <code>length(gl_PointCoord - vec2(0.5))</code> calcula a distância euclidiana até o centro do quadrado. Na direção em <span class="math inline">\(x\)</span> e <span class="math inline">\(y\)</span>, essa distância está no intervalo <span class="math inline">\([0,0.5]\)</span>. A distância é convertida em uma intensidade de luz armazenada em <code>intensity</code>, sendo que a intensidade é máxima (1) no centro do quadrado. A cor de saída é multiplicada por essa intensidade. Se o quadrado for branco, o resultado será como o mostrado na figura <a href="asteroids.html#fig:stars2">6.9</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:stars2"></span>
<img src="images/05_stars2.svg" alt="Gradiente radial produzido por `stars.frag` no quadrado de um ponto definido com `GL_POINTS`." width="60%" />
<p class="caption">
Figura 6.9: Gradiente radial produzido por <code>stars.frag</code> no quadrado de um ponto definido com <code>GL_POINTS</code>.
</p>
</div>
</div>
<div id="atualizando-window.hpp" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.hpp<a href="asteroids.html#atualizando-window.hpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Para a implementação das estrelas, precisamos definir em <code>Window</code> o identificador dos shaders <code>m_starsProgram</code> e a instância de <code>StarLayers</code>. O código atualizado ficará como a seguir:</p>
<div class="sourceCode" id="cb43" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb43-1"><a href="asteroids.html#cb43-1"></a><span class="pp">#ifndef WINDOW_HPP_</span></span>
<span id="cb43-2"><a href="asteroids.html#cb43-2"></a><span class="pp">#define WINDOW_HPP_</span></span>
<span id="cb43-3"><a href="asteroids.html#cb43-3"></a></span>
<span id="cb43-4"><a href="asteroids.html#cb43-4"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb43-5"><a href="asteroids.html#cb43-5"></a></span>
<span id="cb43-6"><a href="asteroids.html#cb43-6"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb43-7"><a href="asteroids.html#cb43-7"></a></span>
<span id="cb43-8"><a href="asteroids.html#cb43-8"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb43-9"><a href="asteroids.html#cb43-9"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb43-10"><a href="asteroids.html#cb43-10"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb43-11"><a href="asteroids.html#cb43-11"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb43-12"><a href="asteroids.html#cb43-12"></a></span>
<span id="cb43-13"><a href="asteroids.html#cb43-13"></a><span class="kw">class</span> Window <span class="op">:</span> <span class="kw">public</span> abcg<span class="op">::</span>OpenGLWindow <span class="op">{</span></span>
<span id="cb43-14"><a href="asteroids.html#cb43-14"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb43-15"><a href="asteroids.html#cb43-15"></a>  <span class="dt">void</span> onEvent<span class="op">(</span>SDL_Event <span class="at">const</span> <span class="op">&amp;</span>event<span class="op">)</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-16"><a href="asteroids.html#cb43-16"></a>  <span class="dt">void</span> onCreate<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-17"><a href="asteroids.html#cb43-17"></a>  <span class="dt">void</span> onUpdate<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-18"><a href="asteroids.html#cb43-18"></a>  <span class="dt">void</span> onPaint<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-19"><a href="asteroids.html#cb43-19"></a>  <span class="dt">void</span> onPaintUI<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-20"><a href="asteroids.html#cb43-20"></a>  <span class="dt">void</span> onResize<span class="op">(</span>glm<span class="op">::</span>ivec2 <span class="at">const</span> <span class="op">&amp;</span>size<span class="op">)</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-21"><a href="asteroids.html#cb43-21"></a>  <span class="dt">void</span> onDestroy<span class="op">()</span> <span class="kw">override</span><span class="op">;</span></span>
<span id="cb43-22"><a href="asteroids.html#cb43-22"></a></span>
<span id="cb43-23"><a href="asteroids.html#cb43-23"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb43-24"><a href="asteroids.html#cb43-24"></a>  glm<span class="op">::</span>ivec2 <span class="va">m_viewportSize</span><span class="op">{};</span></span>
<span id="cb43-25"><a href="asteroids.html#cb43-25"></a></span>
<span id="cb43-26"><a href="asteroids.html#cb43-26"></a>  GLuint <span class="va">m_starsProgram</span><span class="op">{};</span></span>
<span id="cb43-27"><a href="asteroids.html#cb43-27"></a>  GLuint <span class="va">m_objectsProgram</span><span class="op">{};</span></span>
<span id="cb43-28"><a href="asteroids.html#cb43-28"></a></span>
<span id="cb43-29"><a href="asteroids.html#cb43-29"></a>  GameData <span class="va">m_gameData</span><span class="op">;</span></span>
<span id="cb43-30"><a href="asteroids.html#cb43-30"></a></span>
<span id="cb43-31"><a href="asteroids.html#cb43-31"></a>  Ship <span class="va">m_ship</span><span class="op">;</span></span>
<span id="cb43-32"><a href="asteroids.html#cb43-32"></a>  StarLayers <span class="va">m_starLayers</span><span class="op">;</span></span>
<span id="cb43-33"><a href="asteroids.html#cb43-33"></a></span>
<span id="cb43-34"><a href="asteroids.html#cb43-34"></a>  abcg<span class="op">::</span>Timer <span class="va">m_restartWaitTimer</span><span class="op">;</span></span>
<span id="cb43-35"><a href="asteroids.html#cb43-35"></a></span>
<span id="cb43-36"><a href="asteroids.html#cb43-36"></a>  ImFont <span class="op">*</span><span class="va">m_font</span><span class="op">{};</span></span>
<span id="cb43-37"><a href="asteroids.html#cb43-37"></a></span>
<span id="cb43-38"><a href="asteroids.html#cb43-38"></a>  <span class="bu">std::</span>default_random_engine<span class="op"> </span><span class="va">m_randomEngine</span><span class="op">;</span></span>
<span id="cb43-39"><a href="asteroids.html#cb43-39"></a></span>
<span id="cb43-40"><a href="asteroids.html#cb43-40"></a>  <span class="dt">void</span> restart<span class="op">();</span></span>
<span id="cb43-41"><a href="asteroids.html#cb43-41"></a><span class="op">};</span></span>
<span id="cb43-42"><a href="asteroids.html#cb43-42"></a></span>
<span id="cb43-43"><a href="asteroids.html#cb43-43"></a><span class="pp">#endif</span></span></code></pre></div>
</div>
<div id="atualizando-window.cpp" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.cpp<a href="asteroids.html#atualizando-window.cpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Precisamos atualizar também as funções membro de <code>Window</code>:</p>
<ul>
<li><p>Em <code>Window::onCreate</code>, inclua o seguinte código para compilar os novos shaders:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="asteroids.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create program to render the stars</span></span>
<span id="cb44-2"><a href="asteroids.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starsProgram</span> <span class="op">=</span></span>
<span id="cb44-3"><a href="asteroids.html#cb44-3" aria-hidden="true" tabindex="-1"></a>    abcg<span class="op">::</span>createOpenGLProgram<span class="op">({{.</span>source <span class="op">=</span> assetsPath <span class="op">+</span> <span class="st">&quot;stars.vert&quot;</span><span class="op">,</span></span>
<span id="cb44-4"><a href="asteroids.html#cb44-4" aria-hidden="true" tabindex="-1"></a>                                <span class="op">.</span>stage <span class="op">=</span> abcg<span class="op">::</span>ShaderStage<span class="op">::</span>Vertex<span class="op">},</span></span>
<span id="cb44-5"><a href="asteroids.html#cb44-5" aria-hidden="true" tabindex="-1"></a>                               <span class="op">{.</span>source <span class="op">=</span> assetsPath <span class="op">+</span> <span class="st">&quot;stars.frag&quot;</span><span class="op">,</span></span>
<span id="cb44-6"><a href="asteroids.html#cb44-6" aria-hidden="true" tabindex="-1"></a>                                <span class="op">.</span>stage <span class="op">=</span> abcg<span class="op">::</span>ShaderStage<span class="op">::</span>Fragment<span class="op">}});</span></span></code></pre></div></li>
<li><p>Em <code>Window::restart</code>, inclua a chamada a <code>StarLayers::create</code> junto com a chamada a <code>Ship::create</code> feita anteriormente:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="asteroids.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_starsProgram</span><span class="op">,</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb45-2"><a href="asteroids.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onUpdate</code>, chame a função <code>StarLayers::update</code> <strong>depois</strong> de <code>Ship::update</code>, assim:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="asteroids.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_gameData</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb46-2"><a href="asteroids.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> deltaTime<span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onPaint</code>, chame <code>StarLayers::paint</code> <strong>antes</strong> de <code>Ship::paint</code>, assim:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="asteroids.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb47-2"><a href="asteroids.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>paint<span class="op">(</span><span class="va">m_gameData</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Por fim, modifique <code>Window::onDestroy</code> da seguinte forma:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb48-1"><a href="asteroids.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Window<span class="op">::</span>onDestroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb48-2"><a href="asteroids.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  abcg<span class="op">::</span>glDeleteProgram<span class="op">(</span><span class="va">m_starsProgram</span><span class="op">);</span></span>
<span id="cb48-3"><a href="asteroids.html#cb48-3" aria-hidden="true" tabindex="-1"></a>  abcg<span class="op">::</span>glDeleteProgram<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span>
<span id="cb48-4"><a href="asteroids.html#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="asteroids.html#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">m_ship</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb48-6"><a href="asteroids.html#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">m_starLayers</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb48-7"><a href="asteroids.html#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
</ul>
</div>
<div id="starlayers.hpp" class="section level4 unnumbered hasAnchor">
<h4>starlayers.hpp<a href="asteroids.html#starlayers.hpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A definição da classe <code>StarLayers</code> ficará assim:</p>
<div class="sourceCode" id="cb49" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb49-1"><a href="asteroids.html#cb49-1"></a><span class="pp">#ifndef STARLAYERS_HPP_</span></span>
<span id="cb49-2"><a href="asteroids.html#cb49-2"></a><span class="pp">#define STARLAYERS_HPP_</span></span>
<span id="cb49-3"><a href="asteroids.html#cb49-3"></a></span>
<span id="cb49-4"><a href="asteroids.html#cb49-4"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb49-5"><a href="asteroids.html#cb49-5"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb49-6"><a href="asteroids.html#cb49-6"></a></span>
<span id="cb49-7"><a href="asteroids.html#cb49-7"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb49-8"><a href="asteroids.html#cb49-8"></a></span>
<span id="cb49-9"><a href="asteroids.html#cb49-9"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb49-10"><a href="asteroids.html#cb49-10"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb49-11"><a href="asteroids.html#cb49-11"></a></span>
<span id="cb49-12"><a href="asteroids.html#cb49-12"></a><span class="kw">class</span> StarLayers <span class="op">{</span></span>
<span id="cb49-13"><a href="asteroids.html#cb49-13"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb49-14"><a href="asteroids.html#cb49-14"></a>  <span class="dt">void</span> create<span class="op">(</span>GLuint program<span class="op">,</span> <span class="dt">int</span> quantity<span class="op">);</span></span>
<span id="cb49-15"><a href="asteroids.html#cb49-15"></a>  <span class="dt">void</span> paint<span class="op">();</span></span>
<span id="cb49-16"><a href="asteroids.html#cb49-16"></a>  <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb49-17"><a href="asteroids.html#cb49-17"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="at">const</span> Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">);</span></span>
<span id="cb49-18"><a href="asteroids.html#cb49-18"></a></span>
<span id="cb49-19"><a href="asteroids.html#cb49-19"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb49-20"><a href="asteroids.html#cb49-20"></a>  GLuint <span class="va">m_program</span><span class="op">{};</span></span>
<span id="cb49-21"><a href="asteroids.html#cb49-21"></a>  GLint <span class="va">m_pointSizeLoc</span><span class="op">{};</span></span>
<span id="cb49-22"><a href="asteroids.html#cb49-22"></a>  GLint <span class="va">m_translationLoc</span><span class="op">{};</span></span>
<span id="cb49-23"><a href="asteroids.html#cb49-23"></a></span>
<span id="cb49-24"><a href="asteroids.html#cb49-24"></a>  <span class="kw">struct</span> StarLayer <span class="op">{</span></span>
<span id="cb49-25"><a href="asteroids.html#cb49-25"></a>    GLuint <span class="va">m_VAO</span><span class="op">{};</span></span>
<span id="cb49-26"><a href="asteroids.html#cb49-26"></a>    GLuint <span class="va">m_VBO</span><span class="op">{};</span></span>
<span id="cb49-27"><a href="asteroids.html#cb49-27"></a></span>
<span id="cb49-28"><a href="asteroids.html#cb49-28"></a>    <span class="dt">float</span> <span class="va">m_pointSize</span><span class="op">{};</span></span>
<span id="cb49-29"><a href="asteroids.html#cb49-29"></a>    <span class="dt">int</span> <span class="va">m_quantity</span><span class="op">{};</span></span>
<span id="cb49-30"><a href="asteroids.html#cb49-30"></a>    glm<span class="op">::</span>vec2 <span class="va">m_translation</span><span class="op">{};</span></span>
<span id="cb49-31"><a href="asteroids.html#cb49-31"></a>  <span class="op">};</span></span>
<span id="cb49-32"><a href="asteroids.html#cb49-32"></a></span>
<span id="cb49-33"><a href="asteroids.html#cb49-33"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span>StarLayer<span class="op">,</span> <span class="dv">5</span><span class="op">&gt;</span> <span class="va">m_starLayers</span><span class="op">;</span></span>
<span id="cb49-34"><a href="asteroids.html#cb49-34"></a></span>
<span id="cb49-35"><a href="asteroids.html#cb49-35"></a>  <span class="bu">std::</span>default_random_engine<span class="op"> </span><span class="va">m_randomEngine</span><span class="op">;</span></span>
<span id="cb49-36"><a href="asteroids.html#cb49-36"></a><span class="op">};</span></span>
<span id="cb49-37"><a href="asteroids.html#cb49-37"></a></span>
<span id="cb49-38"><a href="asteroids.html#cb49-38"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Nas linhas 24 a 31 é definida a estrutura <code>StarLayer</code>. Ela contém o VBO e VAO dos pontos que formam uma “camada” de estrelas. Além disso contém o tamanho (<code>m_pointSize</code>) e quantidade (<code>m_quantity</code>) dos pontos, e um fator de translação (<code>m_translation</code>) utilizado para deslocar todos os pontos da camada (isto é, todos os vértices do VBO).</p>
<p>Na linha 33 é definido um arranjo de cinco objetos <code>StarLayer</code>, pois renderizaremos cinco camadas sobrepostas de estrelas.</p>
</div>
<div id="starlayers.cpp" class="section level4 unnumbered hasAnchor">
<h4>starlayers.cpp<a href="asteroids.html#starlayers.cpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O arquivo começa com a definição de <code>StarLayers::create</code>:</p>
<div class="sourceCode" id="cb50" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb50-1"><a href="asteroids.html#cb50-1"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb50-2"><a href="asteroids.html#cb50-2"></a></span>
<span id="cb50-3"><a href="asteroids.html#cb50-3"></a><span class="dt">void</span> StarLayers<span class="op">::</span>create<span class="op">(</span>GLuint program<span class="op">,</span> <span class="dt">int</span> quantity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-4"><a href="asteroids.html#cb50-4"></a>  destroy<span class="op">();</span></span>
<span id="cb50-5"><a href="asteroids.html#cb50-5"></a></span>
<span id="cb50-6"><a href="asteroids.html#cb50-6"></a>  <span class="co">// Initialize pseudorandom number generator and distributions</span></span>
<span id="cb50-7"><a href="asteroids.html#cb50-7"></a>  <span class="va">m_randomEngine</span><span class="op">.</span>seed<span class="op">(</span></span>
<span id="cb50-8"><a href="asteroids.html#cb50-8"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now<span class="op">().</span>time_since_epoch<span class="op">().</span>count<span class="op">());</span></span>
<span id="cb50-9"><a href="asteroids.html#cb50-9"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>distPos<span class="op">(-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb50-10"><a href="asteroids.html#cb50-10"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>distIntensity<span class="op">(</span><span class="fl">0.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb50-11"><a href="asteroids.html#cb50-11"></a>  <span class="kw">auto</span> <span class="op">&amp;</span>re<span class="op">{</span><span class="va">m_randomEngine</span><span class="op">};</span> <span class="co">// Shortcut</span></span>
<span id="cb50-12"><a href="asteroids.html#cb50-12"></a></span>
<span id="cb50-13"><a href="asteroids.html#cb50-13"></a>  <span class="va">m_program</span> <span class="op">=</span> program<span class="op">;</span></span>
<span id="cb50-14"><a href="asteroids.html#cb50-14"></a></span>
<span id="cb50-15"><a href="asteroids.html#cb50-15"></a>  <span class="co">// Get location of uniforms in the program</span></span>
<span id="cb50-16"><a href="asteroids.html#cb50-16"></a>  <span class="va">m_pointSizeLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;pointSize&quot;</span><span class="op">);</span></span>
<span id="cb50-17"><a href="asteroids.html#cb50-17"></a>  <span class="va">m_translationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;translation&quot;</span><span class="op">);</span></span>
<span id="cb50-18"><a href="asteroids.html#cb50-18"></a></span>
<span id="cb50-19"><a href="asteroids.html#cb50-19"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb50-20"><a href="asteroids.html#cb50-20"></a>  <span class="kw">auto</span> <span class="at">const</span> positionAttribute<span class="op">{</span></span>
<span id="cb50-21"><a href="asteroids.html#cb50-21"></a>      abcg<span class="op">::</span>glGetAttribLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;inPosition&quot;</span><span class="op">)};</span></span>
<span id="cb50-22"><a href="asteroids.html#cb50-22"></a>  <span class="kw">auto</span> <span class="at">const</span> colorAttribute<span class="op">{</span>abcg<span class="op">::</span>glGetAttribLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;inColor&quot;</span><span class="op">)};</span></span>
<span id="cb50-23"><a href="asteroids.html#cb50-23"></a></span>
<span id="cb50-24"><a href="asteroids.html#cb50-24"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;&amp;[</span>index<span class="op">,</span> layer<span class="op">]</span> <span class="op">:</span> iter<span class="op">::</span>enumerate<span class="op">(</span><span class="va">m_starLayers</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb50-25"><a href="asteroids.html#cb50-25"></a>    <span class="co">// Create data for the stars of this layer</span></span>
<span id="cb50-26"><a href="asteroids.html#cb50-26"></a>    layer<span class="op">.</span><span class="va">m_pointSize</span> <span class="op">=</span> <span class="fl">10.0</span><span class="bu">f</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span><span class="bu">f</span> <span class="op">+</span> index<span class="op">);</span></span>
<span id="cb50-27"><a href="asteroids.html#cb50-27"></a>    layer<span class="op">.</span><span class="va">m_quantity</span> <span class="op">=</span> quantity <span class="op">*</span> <span class="op">(</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>index<span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb50-28"><a href="asteroids.html#cb50-28"></a>    layer<span class="op">.</span><span class="va">m_translation</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb50-29"><a href="asteroids.html#cb50-29"></a></span>
<span id="cb50-30"><a href="asteroids.html#cb50-30"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span>glm<span class="op">::</span>vec3<span class="op">&gt;</span> data<span class="op">;</span></span>
<span id="cb50-31"><a href="asteroids.html#cb50-31"></a>    <span class="cf">for</span> <span class="op">([[</span><span class="at">maybe_unused</span><span class="op">]]</span> <span class="kw">auto</span> _ <span class="op">:</span> iter<span class="op">::</span>range<span class="op">(</span><span class="dv">0</span><span class="op">,</span> layer<span class="op">.</span><span class="va">m_quantity</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb50-32"><a href="asteroids.html#cb50-32"></a>      data<span class="op">.</span>emplace_back<span class="op">(</span>distPos<span class="op">(</span>re<span class="op">),</span> distPos<span class="op">(</span>re<span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb50-33"><a href="asteroids.html#cb50-33"></a>      data<span class="op">.</span>push_back<span class="op">(</span>glm<span class="op">::</span>vec3<span class="op">(</span>distIntensity<span class="op">(</span>re<span class="op">)));</span></span>
<span id="cb50-34"><a href="asteroids.html#cb50-34"></a>    <span class="op">}</span></span>
<span id="cb50-35"><a href="asteroids.html#cb50-35"></a></span>
<span id="cb50-36"><a href="asteroids.html#cb50-36"></a>    <span class="co">// Generate VBO</span></span>
<span id="cb50-37"><a href="asteroids.html#cb50-37"></a>    abcg<span class="op">::</span>glGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>layer<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb50-38"><a href="asteroids.html#cb50-38"></a>    abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> layer<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb50-39"><a href="asteroids.html#cb50-39"></a>    abcg<span class="op">::</span>glBufferData<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> data<span class="op">.</span>size<span class="op">()</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec3<span class="op">),</span></span>
<span id="cb50-40"><a href="asteroids.html#cb50-40"></a>                       data<span class="op">.</span>data<span class="op">(),</span> GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb50-41"><a href="asteroids.html#cb50-41"></a>    abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb50-42"><a href="asteroids.html#cb50-42"></a></span>
<span id="cb50-43"><a href="asteroids.html#cb50-43"></a>    <span class="co">// Create VAO</span></span>
<span id="cb50-44"><a href="asteroids.html#cb50-44"></a>    abcg<span class="op">::</span>glGenVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>layer<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb50-45"><a href="asteroids.html#cb50-45"></a></span>
<span id="cb50-46"><a href="asteroids.html#cb50-46"></a>    <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb50-47"><a href="asteroids.html#cb50-47"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span>layer<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb50-48"><a href="asteroids.html#cb50-48"></a></span>
<span id="cb50-49"><a href="asteroids.html#cb50-49"></a>    abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> layer<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb50-50"><a href="asteroids.html#cb50-50"></a>    abcg<span class="op">::</span>glEnableVertexAttribArray<span class="op">(</span>positionAttribute<span class="op">);</span></span>
<span id="cb50-51"><a href="asteroids.html#cb50-51"></a>    abcg<span class="op">::</span>glVertexAttribPointer<span class="op">(</span>positionAttribute<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> GL_FALSE<span class="op">,</span></span>
<span id="cb50-52"><a href="asteroids.html#cb50-52"></a>                                <span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec3<span class="op">)</span> <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb50-53"><a href="asteroids.html#cb50-53"></a>    abcg<span class="op">::</span>glEnableVertexAttribArray<span class="op">(</span>colorAttribute<span class="op">);</span></span>
<span id="cb50-54"><a href="asteroids.html#cb50-54"></a>    abcg<span class="op">::</span>glVertexAttribPointer<span class="op">(</span>colorAttribute<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> GL_FALSE<span class="op">,</span></span>
<span id="cb50-55"><a href="asteroids.html#cb50-55"></a>                                <span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec3<span class="op">)</span> <span class="op">*</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb50-56"><a href="asteroids.html#cb50-56"></a>                                <span class="kw">reinterpret_cast</span><span class="op">&lt;</span><span class="dt">void</span> <span class="op">*&gt;(</span><span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec3<span class="op">)));</span></span>
<span id="cb50-57"><a href="asteroids.html#cb50-57"></a>    abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb50-58"><a href="asteroids.html#cb50-58"></a></span>
<span id="cb50-59"><a href="asteroids.html#cb50-59"></a>    <span class="co">// End of binding to current VAO</span></span>
<span id="cb50-60"><a href="asteroids.html#cb50-60"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb50-61"><a href="asteroids.html#cb50-61"></a>  <span class="op">}</span></span>
<span id="cb50-62"><a href="asteroids.html#cb50-62"></a><span class="op">}</span></span></code></pre></div>
<p>O laço da linha 24 itera sobre cada elemento de <code>m_starLayers</code>. A expressão na linha 26 faz com que os pontos tenham tamanho <code>10</code> na 1ª camada, <code>5</code> na 2ª camada, <code>2.5</code> na 3ª camada, e assim sucessivamente. Na linha 27, a quantidade de pontos é dobrada a cada camada.</p>
<p>Na linha 30 é criado um arranjo <code>data</code> com dados dos pontos da camada. Os dados ficarão intercalados no formato <span class="math display">\[[\underline{x,y,0,r,g,b},x,y,0,r,g,b,\dots],\]</span> onde <span class="math inline">\((x,y,0)\)</span> é a posição do ponto, e <span class="math inline">\((r,g,b)\)</span> é a cor do ponto. Dentro do laço, as coordenadas <span class="math inline">\(x\)</span> e <span class="math inline">\(y\)</span> são escolhidas de forma aleatória dentro do intervalo <span class="math inline">\([-1,1)\)</span>. A cor é um tom de cinza escolhido aleatoriamente do intervalo <span class="math inline">\([0.5,1)\)</span>.</p>
<p>Os dados de <code>data</code> são copiados para o VBO através de <code>glBufferData</code> na linha 39.</p>
<p>Observe nas linhas 49 a 57 como é feito o mapeamento do VBO com os atributos <code>inPosition</code> (do tipo <code>vec2</code>) e <code>inColor</code> (do tipo <code>vec4</code>) do vertex shader. O stride do VBO é <code>sizeof(glm::vec3) * 2</code> (isto é, dois <code>vec3</code>). Na linha 56, o deslocamento no início do VBO é <code>sizeof(glm::vec3)</code> (isto é, apenas um <code>vec3</code>). A conversão de tipo é necessária porque o parâmetro de deslocamento é do tipo <code>void const *</code> ao invés de um inteiro (é assim por razões históricas).</p>
<p>A definição de <code>StarLayers::paint</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb51" startFrom="64"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb51-64"><a href="asteroids.html#cb51-64"></a><span class="dt">void</span> StarLayers<span class="op">::</span>paint<span class="op">()</span> <span class="op">{</span></span>
<span id="cb51-65"><a href="asteroids.html#cb51-65"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="va">m_program</span><span class="op">);</span></span>
<span id="cb51-66"><a href="asteroids.html#cb51-66"></a></span>
<span id="cb51-67"><a href="asteroids.html#cb51-67"></a>  abcg<span class="op">::</span>glEnable<span class="op">(</span>GL_BLEND<span class="op">);</span></span>
<span id="cb51-68"><a href="asteroids.html#cb51-68"></a>  abcg<span class="op">::</span>glBlendFunc<span class="op">(</span>GL_ONE<span class="op">,</span> GL_ONE<span class="op">);</span></span>
<span id="cb51-69"><a href="asteroids.html#cb51-69"></a></span>
<span id="cb51-70"><a href="asteroids.html#cb51-70"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>layer <span class="op">:</span> <span class="va">m_starLayers</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-71"><a href="asteroids.html#cb51-71"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span>layer<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb51-72"><a href="asteroids.html#cb51-72"></a>    abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_pointSizeLoc</span><span class="op">,</span> layer<span class="op">.</span><span class="va">m_pointSize</span><span class="op">);</span></span>
<span id="cb51-73"><a href="asteroids.html#cb51-73"></a></span>
<span id="cb51-74"><a href="asteroids.html#cb51-74"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> i <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb51-75"><a href="asteroids.html#cb51-75"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> j <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb51-76"><a href="asteroids.html#cb51-76"></a>        abcg<span class="op">::</span>glUniform2f<span class="op">(</span><span class="va">m_translationLoc</span><span class="op">,</span> layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">+</span> j<span class="op">,</span></span>
<span id="cb51-77"><a href="asteroids.html#cb51-77"></a>                          layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb51-78"><a href="asteroids.html#cb51-78"></a></span>
<span id="cb51-79"><a href="asteroids.html#cb51-79"></a>        abcg<span class="op">::</span>glDrawArrays<span class="op">(</span>GL_POINTS<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> layer<span class="op">.</span><span class="va">m_quantity</span><span class="op">);</span></span>
<span id="cb51-80"><a href="asteroids.html#cb51-80"></a>      <span class="op">}</span></span>
<span id="cb51-81"><a href="asteroids.html#cb51-81"></a>    <span class="op">}</span></span>
<span id="cb51-82"><a href="asteroids.html#cb51-82"></a></span>
<span id="cb51-83"><a href="asteroids.html#cb51-83"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb51-84"><a href="asteroids.html#cb51-84"></a>  <span class="op">}</span></span>
<span id="cb51-85"><a href="asteroids.html#cb51-85"></a></span>
<span id="cb51-86"><a href="asteroids.html#cb51-86"></a>  abcg<span class="op">::</span>glDisable<span class="op">(</span>GL_BLEND<span class="op">);</span></span>
<span id="cb51-87"><a href="asteroids.html#cb51-87"></a></span>
<span id="cb51-88"><a href="asteroids.html#cb51-88"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb51-89"><a href="asteroids.html#cb51-89"></a><span class="op">}</span></span></code></pre></div>
<p>Observe que os pontos são desenhados com o modo de mistura de cor habilitado. Na linha 68, a definição da função de mistura com fatores <code>GL_ONE</code> faz com que as cores produzidas pelo fragment shader sejam somadas com as cores atuais do framebuffer. Isso produz um efeito cumulativo de intensidade da luz quando estrelas de camadas diferentes são renderizadas na mesma posição.</p>
<p>Os laços aninhados nas linhas 74 e 75 produzem índices <code>i</code> e <code>j</code> que são usados em <code>layer.m_translation</code> para replicar o desenho das estrelas em uma grade 3x3 em torno da região visível do NDC, como vimos no início da seção.</p>
<p>Na linha 86, o modo de mistura de cor é desabilitado para não afetar a renderização dos outros objetos de cena que são totalmente opacos.</p>
<p>Em <code>StarLayers::destroy</code> são liberados os VBOs e VAOs de todas as instâncias de <code>StarLayer</code>:</p>
<div class="sourceCode" id="cb52" startFrom="91"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 90;"><span id="cb52-91"><a href="asteroids.html#cb52-91"></a><span class="dt">void</span> StarLayers<span class="op">::</span>destroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb52-92"><a href="asteroids.html#cb52-92"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>layer <span class="op">:</span> <span class="va">m_starLayers</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-93"><a href="asteroids.html#cb52-93"></a>    abcg<span class="op">::</span>glDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>layer<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb52-94"><a href="asteroids.html#cb52-94"></a>    abcg<span class="op">::</span>glDeleteVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>layer<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb52-95"><a href="asteroids.html#cb52-95"></a>  <span class="op">}</span></span>
<span id="cb52-96"><a href="asteroids.html#cb52-96"></a><span class="op">}</span></span></code></pre></div>
<p>Vamos agora à definição de <code>StarLayers::update</code>:</p>
<div class="sourceCode" id="cb53" startFrom="98"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 97;"><span id="cb53-98"><a href="asteroids.html#cb53-98"></a><span class="dt">void</span> StarLayers<span class="op">::</span>update<span class="op">(</span><span class="at">const</span> Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-99"><a href="asteroids.html#cb53-99"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;&amp;[</span>index<span class="op">,</span> layer<span class="op">]</span> <span class="op">:</span> iter<span class="op">::</span>enumerate<span class="op">(</span><span class="va">m_starLayers</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb53-100"><a href="asteroids.html#cb53-100"></a>    <span class="kw">auto</span> <span class="at">const</span> layerSpeedScale<span class="op">{</span><span class="fl">1.0</span><span class="bu">f</span> <span class="op">/</span> <span class="op">(</span>index <span class="op">+</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">)};</span></span>
<span id="cb53-101"><a href="asteroids.html#cb53-101"></a>    layer<span class="op">.</span><span class="va">m_translation</span> <span class="op">-=</span> ship<span class="op">.</span><span class="va">m_velocity</span> <span class="op">*</span> deltaTime <span class="op">*</span> layerSpeedScale<span class="op">;</span></span>
<span id="cb53-102"><a href="asteroids.html#cb53-102"></a></span>
<span id="cb53-103"><a href="asteroids.html#cb53-103"></a>    <span class="co">// Wrap-around</span></span>
<span id="cb53-104"><a href="asteroids.html#cb53-104"></a>    <span class="cf">if</span> <span class="op">(</span>layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb53-105"><a href="asteroids.html#cb53-105"></a>      layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">+=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb53-106"><a href="asteroids.html#cb53-106"></a>    <span class="cf">if</span> <span class="op">(</span>layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb53-107"><a href="asteroids.html#cb53-107"></a>      layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">-=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb53-108"><a href="asteroids.html#cb53-108"></a>    <span class="cf">if</span> <span class="op">(</span>layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb53-109"><a href="asteroids.html#cb53-109"></a>      layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">+=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb53-110"><a href="asteroids.html#cb53-110"></a>    <span class="cf">if</span> <span class="op">(</span>layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb53-111"><a href="asteroids.html#cb53-111"></a>      layer<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">-=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb53-112"><a href="asteroids.html#cb53-112"></a>  <span class="op">}</span></span>
<span id="cb53-113"><a href="asteroids.html#cb53-113"></a><span class="op">}</span></span></code></pre></div>
<p>A translação (<code>m_translation</code>) de cada camada é atualizada na linha 101 de acordo com a velocidade da nave. Se a nave está indo para a frente, então a camada de estrelas deve ir para trás: por isso a subtração. A velocidade é multiplicada por um fator de escala <code>layerSpeedScale</code> para fazer com que a primeira camada seja mais rápida que a segunda, e assim sucessivamente para produzir o efeito de paralaxe.</p>
<p>Nas linhas 104 a 111 há uma série de condicionais que testam se os pontos saíram dos limites da região visível do NDC. Se saíram, são deslocados para o lado oposto.</p>
<p>Nesse momento, o jogo ficará como a seguir (<a href="https://hbatagelo.github.io/abcgapps/asteroids2/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids2/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids2.zip">deste link</a>.</p>
</div>
</div>
<div id="asteroides" class="section level3 unnumbered hasAnchor">
<h3>Asteroides<a href="asteroids.html#asteroides" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Para incluir a implementação dos asteroides, vamos primeiramente atualizar <code>OpenGLWindow</code>.</p>
<div id="atualizando-window.hpp-1" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.hpp<a href="asteroids.html#atualizando-window.hpp-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Adicione a definição de <code>m_asteroids</code> junto às definições dos outros objetos (<code>m_ship</code> e <code>m_starLayers</code>), assim:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="asteroids.html#cb54-1" aria-hidden="true" tabindex="-1"></a>Asteroids <span class="va">m_asteroids</span><span class="op">;</span></span>
<span id="cb54-2"><a href="asteroids.html#cb54-2" aria-hidden="true" tabindex="-1"></a>Ship <span class="va">m_ship</span><span class="op">;</span></span>
<span id="cb54-3"><a href="asteroids.html#cb54-3" aria-hidden="true" tabindex="-1"></a>StarLayers <span class="va">m_starLayers</span><span class="op">;</span></span></code></pre></div>
</div>
<div id="atualizando-window.cpp-1" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.cpp<a href="asteroids.html#atualizando-window.cpp-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><p>Em <code>Window::restart</code>, chame <code>create</code> de <code>m_asteroids</code> junto com a chamada a <code>create</code> dos objetos anteriores:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="asteroids.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_starsProgram</span><span class="op">,</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb55-2"><a href="asteroids.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span>
<span id="cb55-3"><a href="asteroids.html#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onUpdate</code>, chame <code>update</code> de <code>m_asteroids</code> após <code>update</code> de <code>m_ship</code>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb56-1"><a href="asteroids.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_gameData</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb56-2"><a href="asteroids.html#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb56-3"><a href="asteroids.html#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> deltaTime<span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onPaint</code>, chame <code>paint</code> de <code>m_asteroids</code> logo após <code>paint</code> de <code>m_starLayers</code>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb57-1"><a href="asteroids.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb57-2"><a href="asteroids.html#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb57-3"><a href="asteroids.html#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>paint<span class="op">(</span><span class="va">m_gameData</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onDestroy</code>, chame <code>destroy</code> de <code>m_asteroids</code> junto com a chamada a <code>destroy</code> dos outros objetos:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb58-1"><a href="asteroids.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb58-2"><a href="asteroids.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb58-3"><a href="asteroids.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>destroy<span class="op">();</span></span></code></pre></div></li>
</ul>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>A ordem em que a função <code>paint</code> de cada objeto é chamada é importante porque o objeto renderizado por último será desenhado sobre os anteriores que já estão no framebuffer.</p>
<p>Essa forma de renderizar os objetos na ordem do mais distante para o mais próximo é chamada de “algoritmo do pintor” pois é similar ao modo como um pintor desenha sobre uma tela: os elementos mais ao fundo são desenhados antes dos elementos mais à frente.</p>
</div>
</div>
<div id="asteroids.hpp" class="section level4 unnumbered hasAnchor">
<h4>asteroids.hpp<a href="asteroids.html#asteroids.hpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A definição da classe <code>Asteroids</code> ficará assim:</p>
<div class="sourceCode" id="cb59" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb59-1"><a href="asteroids.html#cb59-1"></a><span class="pp">#ifndef ASTEROIDS_HPP_</span></span>
<span id="cb59-2"><a href="asteroids.html#cb59-2"></a><span class="pp">#define ASTEROIDS_HPP_</span></span>
<span id="cb59-3"><a href="asteroids.html#cb59-3"></a></span>
<span id="cb59-4"><a href="asteroids.html#cb59-4"></a><span class="pp">#include </span><span class="im">&lt;list&gt;</span></span>
<span id="cb59-5"><a href="asteroids.html#cb59-5"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb59-6"><a href="asteroids.html#cb59-6"></a></span>
<span id="cb59-7"><a href="asteroids.html#cb59-7"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb59-8"><a href="asteroids.html#cb59-8"></a></span>
<span id="cb59-9"><a href="asteroids.html#cb59-9"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb59-10"><a href="asteroids.html#cb59-10"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb59-11"><a href="asteroids.html#cb59-11"></a></span>
<span id="cb59-12"><a href="asteroids.html#cb59-12"></a><span class="kw">class</span> Asteroids <span class="op">{</span></span>
<span id="cb59-13"><a href="asteroids.html#cb59-13"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb59-14"><a href="asteroids.html#cb59-14"></a>  <span class="dt">void</span> create<span class="op">(</span>GLuint program<span class="op">,</span> <span class="dt">int</span> quantity<span class="op">);</span></span>
<span id="cb59-15"><a href="asteroids.html#cb59-15"></a>  <span class="dt">void</span> paint<span class="op">();</span></span>
<span id="cb59-16"><a href="asteroids.html#cb59-16"></a>  <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb59-17"><a href="asteroids.html#cb59-17"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="at">const</span> Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">);</span></span>
<span id="cb59-18"><a href="asteroids.html#cb59-18"></a></span>
<span id="cb59-19"><a href="asteroids.html#cb59-19"></a>  <span class="kw">struct</span> Asteroid <span class="op">{</span></span>
<span id="cb59-20"><a href="asteroids.html#cb59-20"></a>    GLuint <span class="va">m_VAO</span><span class="op">{};</span></span>
<span id="cb59-21"><a href="asteroids.html#cb59-21"></a>    GLuint <span class="va">m_VBO</span><span class="op">{};</span></span>
<span id="cb59-22"><a href="asteroids.html#cb59-22"></a></span>
<span id="cb59-23"><a href="asteroids.html#cb59-23"></a>    <span class="dt">float</span> <span class="va">m_angularVelocity</span><span class="op">{};</span></span>
<span id="cb59-24"><a href="asteroids.html#cb59-24"></a>    glm<span class="op">::</span>vec4 <span class="va">m_color</span><span class="op">{</span><span class="dv">1</span><span class="op">};</span></span>
<span id="cb59-25"><a href="asteroids.html#cb59-25"></a>    <span class="dt">bool</span> <span class="va">m_hit</span><span class="op">{};</span></span>
<span id="cb59-26"><a href="asteroids.html#cb59-26"></a>    <span class="dt">int</span> <span class="va">m_polygonSides</span><span class="op">{};</span></span>
<span id="cb59-27"><a href="asteroids.html#cb59-27"></a>    <span class="dt">float</span> <span class="va">m_rotation</span><span class="op">{};</span></span>
<span id="cb59-28"><a href="asteroids.html#cb59-28"></a>    <span class="dt">float</span> <span class="va">m_scale</span><span class="op">{};</span></span>
<span id="cb59-29"><a href="asteroids.html#cb59-29"></a>    glm<span class="op">::</span>vec2 <span class="va">m_translation</span><span class="op">{};</span></span>
<span id="cb59-30"><a href="asteroids.html#cb59-30"></a>    glm<span class="op">::</span>vec2 <span class="va">m_velocity</span><span class="op">{};</span></span>
<span id="cb59-31"><a href="asteroids.html#cb59-31"></a>  <span class="op">};</span></span>
<span id="cb59-32"><a href="asteroids.html#cb59-32"></a></span>
<span id="cb59-33"><a href="asteroids.html#cb59-33"></a>  <span class="bu">std::</span>list<span class="op">&lt;</span>Asteroid<span class="op">&gt;</span> <span class="va">m_asteroids</span><span class="op">;</span></span>
<span id="cb59-34"><a href="asteroids.html#cb59-34"></a></span>
<span id="cb59-35"><a href="asteroids.html#cb59-35"></a>  Asteroid makeAsteroid<span class="op">(</span>glm<span class="op">::</span>vec2 translation <span class="op">=</span> <span class="op">{},</span> <span class="dt">float</span> scale <span class="op">=</span> <span class="fl">0.25</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb59-36"><a href="asteroids.html#cb59-36"></a></span>
<span id="cb59-37"><a href="asteroids.html#cb59-37"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb59-38"><a href="asteroids.html#cb59-38"></a>  GLuint <span class="va">m_program</span><span class="op">{};</span></span>
<span id="cb59-39"><a href="asteroids.html#cb59-39"></a>  GLint <span class="va">m_colorLoc</span><span class="op">{};</span></span>
<span id="cb59-40"><a href="asteroids.html#cb59-40"></a>  GLint <span class="va">m_rotationLoc</span><span class="op">{};</span></span>
<span id="cb59-41"><a href="asteroids.html#cb59-41"></a>  GLint <span class="va">m_translationLoc</span><span class="op">{};</span></span>
<span id="cb59-42"><a href="asteroids.html#cb59-42"></a>  GLint <span class="va">m_scaleLoc</span><span class="op">{};</span></span>
<span id="cb59-43"><a href="asteroids.html#cb59-43"></a></span>
<span id="cb59-44"><a href="asteroids.html#cb59-44"></a>  <span class="bu">std::</span>default_random_engine<span class="op"> </span><span class="va">m_randomEngine</span><span class="op">;</span></span>
<span id="cb59-45"><a href="asteroids.html#cb59-45"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> <span class="va">m_randomDist</span><span class="op">{-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb59-46"><a href="asteroids.html#cb59-46"></a><span class="op">};</span></span>
<span id="cb59-47"><a href="asteroids.html#cb59-47"></a></span>
<span id="cb59-48"><a href="asteroids.html#cb59-48"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Entre as linhas 19 a 31 é definida a estrutura <code>Asteroid</code>. Cada asteroide tem seu próprio VAO e VBO. Além disso, <code>Asteroid</code> possui uma velocidade angular, uma cor, número de lados, ângulo de rotação, escala, translação, vetor de velocidade, e um flag <code>m_hit</code> que indica se o asteroide foi acertado por um tiro.</p>
<p>Na linha 33 é definida uma lista de objetos <code>Asteroid</code>. O número de elementos dessa lista será modificado de acordo com os asteroides que forem acertados pelos tiros. Cada vez que um asteroide for acertado, ele será retirado da lista. Entretanto, se o asteroide for grande, simularemos que ele foi quebrado em vários pedaços fazendo com asteroides menores sejam inseridos na lista.</p>
<p>A função <code>makeAsteroid</code> declarada na linha 35 será utilizada para criar um novo asteroide para ser inserido na lista <code>m_asteroids</code>. Os parâmetros <code>translation</code> e <code>scale</code> permitirão configurar a posição e o fator de escala do novo asteroide.</p>
</div>
<div id="asteroids.cpp" class="section level4 unnumbered hasAnchor">
<h4>asteroids.cpp<a href="asteroids.html#asteroids.cpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O arquivo começa com a definição de <code>Asteroids::create</code>:</p>
<div class="sourceCode" id="cb60" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb60-1"><a href="asteroids.html#cb60-1"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb60-2"><a href="asteroids.html#cb60-2"></a></span>
<span id="cb60-3"><a href="asteroids.html#cb60-3"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/fast_trigonometry.hpp&gt;</span></span>
<span id="cb60-4"><a href="asteroids.html#cb60-4"></a></span>
<span id="cb60-5"><a href="asteroids.html#cb60-5"></a><span class="dt">void</span> Asteroids<span class="op">::</span>create<span class="op">(</span>GLuint program<span class="op">,</span> <span class="dt">int</span> quantity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-6"><a href="asteroids.html#cb60-6"></a>  destroy<span class="op">();</span></span>
<span id="cb60-7"><a href="asteroids.html#cb60-7"></a></span>
<span id="cb60-8"><a href="asteroids.html#cb60-8"></a>  <span class="va">m_randomEngine</span><span class="op">.</span>seed<span class="op">(</span></span>
<span id="cb60-9"><a href="asteroids.html#cb60-9"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now<span class="op">().</span>time_since_epoch<span class="op">().</span>count<span class="op">());</span></span>
<span id="cb60-10"><a href="asteroids.html#cb60-10"></a></span>
<span id="cb60-11"><a href="asteroids.html#cb60-11"></a>  <span class="va">m_program</span> <span class="op">=</span> program<span class="op">;</span></span>
<span id="cb60-12"><a href="asteroids.html#cb60-12"></a></span>
<span id="cb60-13"><a href="asteroids.html#cb60-13"></a>  <span class="co">// Get location of uniforms in the program</span></span>
<span id="cb60-14"><a href="asteroids.html#cb60-14"></a>  <span class="va">m_colorLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;color&quot;</span><span class="op">);</span></span>
<span id="cb60-15"><a href="asteroids.html#cb60-15"></a>  <span class="va">m_rotationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;rotation&quot;</span><span class="op">);</span></span>
<span id="cb60-16"><a href="asteroids.html#cb60-16"></a>  <span class="va">m_scaleLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">);</span></span>
<span id="cb60-17"><a href="asteroids.html#cb60-17"></a>  <span class="va">m_translationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;translation&quot;</span><span class="op">);</span></span>
<span id="cb60-18"><a href="asteroids.html#cb60-18"></a></span>
<span id="cb60-19"><a href="asteroids.html#cb60-19"></a>  <span class="co">// Create asteroids</span></span>
<span id="cb60-20"><a href="asteroids.html#cb60-20"></a>  <span class="va">m_asteroids</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb60-21"><a href="asteroids.html#cb60-21"></a>  <span class="va">m_asteroids</span><span class="op">.</span>resize<span class="op">(</span>quantity<span class="op">);</span></span>
<span id="cb60-22"><a href="asteroids.html#cb60-22"></a></span>
<span id="cb60-23"><a href="asteroids.html#cb60-23"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-24"><a href="asteroids.html#cb60-24"></a>    asteroid <span class="op">=</span> makeAsteroid<span class="op">();</span></span>
<span id="cb60-25"><a href="asteroids.html#cb60-25"></a></span>
<span id="cb60-26"><a href="asteroids.html#cb60-26"></a>    <span class="co">// Make sure the asteroid won&#39;t collide with the ship</span></span>
<span id="cb60-27"><a href="asteroids.html#cb60-27"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb60-28"><a href="asteroids.html#cb60-28"></a>      asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">=</span> <span class="op">{</span><span class="va">m_randomDist</span><span class="op">(</span><span class="va">m_randomEngine</span><span class="op">),</span></span>
<span id="cb60-29"><a href="asteroids.html#cb60-29"></a>                                <span class="va">m_randomDist</span><span class="op">(</span><span class="va">m_randomEngine</span><span class="op">)};</span></span>
<span id="cb60-30"><a href="asteroids.html#cb60-30"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>glm<span class="op">::</span>length<span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb60-31"><a href="asteroids.html#cb60-31"></a>  <span class="op">}</span></span>
<span id="cb60-32"><a href="asteroids.html#cb60-32"></a><span class="op">}</span></span></code></pre></div>
<p>Na linha 21, a lista de asteroides é iniciada com uma quantidade <code>quantity</code> de objetos do tipo <code>Asteroid</code>. Essa lista é então iterada no laço da linha 23 e o conteúdo de cada asteroide é substituído por <code>Asteroids::makeAsteroid</code>. No laço das linhas 27 a 30 é escolhida uma posição aleatória para o asteroide, mas uma posição longe o suficiente da nave: não queremos que o jogo comece com o asteroide colidindo com a nave!</p>
<p>A definição de <code>Asteroids::paint</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb61" startFrom="34"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 33;"><span id="cb61-34"><a href="asteroids.html#cb61-34"></a><span class="dt">void</span> Asteroids<span class="op">::</span>paint<span class="op">()</span> <span class="op">{</span></span>
<span id="cb61-35"><a href="asteroids.html#cb61-35"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="va">m_program</span><span class="op">);</span></span>
<span id="cb61-36"><a href="asteroids.html#cb61-36"></a></span>
<span id="cb61-37"><a href="asteroids.html#cb61-37"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-38"><a href="asteroids.html#cb61-38"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb61-39"><a href="asteroids.html#cb61-39"></a></span>
<span id="cb61-40"><a href="asteroids.html#cb61-40"></a>    abcg<span class="op">::</span>glUniform4fv<span class="op">(</span><span class="va">m_colorLoc</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>asteroid<span class="op">.</span><span class="va">m_color</span><span class="op">.</span>r<span class="op">);</span></span>
<span id="cb61-41"><a href="asteroids.html#cb61-41"></a>    abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_scaleLoc</span><span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_scale</span><span class="op">);</span></span>
<span id="cb61-42"><a href="asteroids.html#cb61-42"></a>    abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_rotationLoc</span><span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_rotation</span><span class="op">);</span></span>
<span id="cb61-43"><a href="asteroids.html#cb61-43"></a></span>
<span id="cb61-44"><a href="asteroids.html#cb61-44"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> i <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb61-45"><a href="asteroids.html#cb61-45"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> j <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb61-46"><a href="asteroids.html#cb61-46"></a>        abcg<span class="op">::</span>glUniform2f<span class="op">(</span><span class="va">m_translationLoc</span><span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">+</span> j<span class="op">,</span></span>
<span id="cb61-47"><a href="asteroids.html#cb61-47"></a>                          asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb61-48"><a href="asteroids.html#cb61-48"></a></span>
<span id="cb61-49"><a href="asteroids.html#cb61-49"></a>        abcg<span class="op">::</span>glDrawArrays<span class="op">(</span>GL_TRIANGLE_FAN<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_polygonSides</span> <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb61-50"><a href="asteroids.html#cb61-50"></a>      <span class="op">}</span></span>
<span id="cb61-51"><a href="asteroids.html#cb61-51"></a>    <span class="op">}</span></span>
<span id="cb61-52"><a href="asteroids.html#cb61-52"></a></span>
<span id="cb61-53"><a href="asteroids.html#cb61-53"></a>    abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb61-54"><a href="asteroids.html#cb61-54"></a>  <span class="op">}</span></span>
<span id="cb61-55"><a href="asteroids.html#cb61-55"></a></span>
<span id="cb61-56"><a href="asteroids.html#cb61-56"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb61-57"><a href="asteroids.html#cb61-57"></a><span class="op">}</span></span></code></pre></div>
<p>A lista <code>m_asteroids</code> é iterada e cada asteroide é renderizado 9 vezes (em uma grade 3x3), como fizemos com as estrelas.</p>
<p>Em <code>Asteroids::destroy</code> são liberados os VBOs e VAOs dos asteroides:</p>
<div class="sourceCode" id="cb62" startFrom="59"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 58;"><span id="cb62-59"><a href="asteroids.html#cb62-59"></a><span class="dt">void</span> Asteroids<span class="op">::</span>destroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb62-60"><a href="asteroids.html#cb62-60"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-61"><a href="asteroids.html#cb62-61"></a>    abcg<span class="op">::</span>glDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>asteroid<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb62-62"><a href="asteroids.html#cb62-62"></a>    abcg<span class="op">::</span>glDeleteVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>asteroid<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb62-63"><a href="asteroids.html#cb62-63"></a>  <span class="op">}</span></span>
<span id="cb62-64"><a href="asteroids.html#cb62-64"></a><span class="op">}</span></span></code></pre></div>
<p>Vamos agora à definição de <code>Asteroids::update</code>:</p>
<div class="sourceCode" id="cb63" startFrom="66"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 65;"><span id="cb63-66"><a href="asteroids.html#cb63-66"></a><span class="dt">void</span> Asteroids<span class="op">::</span>update<span class="op">(</span><span class="at">const</span> Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-67"><a href="asteroids.html#cb63-67"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-68"><a href="asteroids.html#cb63-68"></a>    asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">-=</span> ship<span class="op">.</span><span class="va">m_velocity</span> <span class="op">*</span> deltaTime<span class="op">;</span></span>
<span id="cb63-69"><a href="asteroids.html#cb63-69"></a>    asteroid<span class="op">.</span><span class="va">m_rotation</span> <span class="op">=</span> glm<span class="op">::</span>wrapAngle<span class="op">(</span></span>
<span id="cb63-70"><a href="asteroids.html#cb63-70"></a>        asteroid<span class="op">.</span><span class="va">m_rotation</span> <span class="op">+</span> asteroid<span class="op">.</span><span class="va">m_angularVelocity</span> <span class="op">*</span> deltaTime<span class="op">);</span></span>
<span id="cb63-71"><a href="asteroids.html#cb63-71"></a>    asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">+=</span> asteroid<span class="op">.</span><span class="va">m_velocity</span> <span class="op">*</span> deltaTime<span class="op">;</span></span>
<span id="cb63-72"><a href="asteroids.html#cb63-72"></a></span>
<span id="cb63-73"><a href="asteroids.html#cb63-73"></a>    <span class="co">// Wrap-around</span></span>
<span id="cb63-74"><a href="asteroids.html#cb63-74"></a>    <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb63-75"><a href="asteroids.html#cb63-75"></a>      asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">+=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb63-76"><a href="asteroids.html#cb63-76"></a>    <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb63-77"><a href="asteroids.html#cb63-77"></a>      asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">-=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb63-78"><a href="asteroids.html#cb63-78"></a>    <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb63-79"><a href="asteroids.html#cb63-79"></a>      asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">+=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb63-80"><a href="asteroids.html#cb63-80"></a>    <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb63-81"><a href="asteroids.html#cb63-81"></a>      asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">-=</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb63-82"><a href="asteroids.html#cb63-82"></a>  <span class="op">}</span></span>
<span id="cb63-83"><a href="asteroids.html#cb63-83"></a><span class="op">}</span></span></code></pre></div>
<p>Na linha 68, a translação (<code>m_translation</code>) de cada asteroide é modificada pelo vetor de velocidade da nave, como fizemos com as estrelas. Na linha 69, a rotação é atualizada de acordo com a velocidade angular. Na linha 71, a translação do asteroide é modificada novamente, mas agora considerando a velocidade do próprio asteroide.</p>
<p>As condicionais das linhas 74 a 80 fazem com que as coordenadas de <code>m_translation</code> permaneçam no intervalo circular de -1 a 1.</p>
<p>A definição de <code>Asteroids::makeAsteroid</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb64" startFrom="85"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 84;"><span id="cb64-85"><a href="asteroids.html#cb64-85"></a>Asteroids<span class="op">::</span>Asteroid Asteroids<span class="op">::</span>makeAsteroid<span class="op">(</span>glm<span class="op">::</span>vec2 translation<span class="op">,</span></span>
<span id="cb64-86"><a href="asteroids.html#cb64-86"></a>                                            <span class="dt">float</span> scale<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-87"><a href="asteroids.html#cb64-87"></a>  Asteroid asteroid<span class="op">;</span></span>
<span id="cb64-88"><a href="asteroids.html#cb64-88"></a></span>
<span id="cb64-89"><a href="asteroids.html#cb64-89"></a>  <span class="kw">auto</span> <span class="op">&amp;</span>re<span class="op">{</span><span class="va">m_randomEngine</span><span class="op">};</span> <span class="co">// Shortcut</span></span>
<span id="cb64-90"><a href="asteroids.html#cb64-90"></a></span>
<span id="cb64-91"><a href="asteroids.html#cb64-91"></a>  <span class="co">// Randomly pick the number of sides</span></span>
<span id="cb64-92"><a href="asteroids.html#cb64-92"></a>  <span class="bu">std::</span>uniform_int_distribution<span class="op"> </span>randomSides<span class="op">(</span><span class="dv">6</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb64-93"><a href="asteroids.html#cb64-93"></a>  asteroid<span class="op">.</span><span class="va">m_polygonSides</span> <span class="op">=</span> randomSides<span class="op">(</span>re<span class="op">);</span></span>
<span id="cb64-94"><a href="asteroids.html#cb64-94"></a></span>
<span id="cb64-95"><a href="asteroids.html#cb64-95"></a>  <span class="co">// Get a random color (actually, a grayscale)</span></span>
<span id="cb64-96"><a href="asteroids.html#cb64-96"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>randomIntensity<span class="op">(</span><span class="fl">0.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb64-97"><a href="asteroids.html#cb64-97"></a>  asteroid<span class="op">.</span><span class="va">m_color</span> <span class="op">=</span> glm<span class="op">::</span>vec4<span class="op">(</span>randomIntensity<span class="op">(</span>re<span class="op">));</span></span>
<span id="cb64-98"><a href="asteroids.html#cb64-98"></a></span>
<span id="cb64-99"><a href="asteroids.html#cb64-99"></a>  asteroid<span class="op">.</span><span class="va">m_color</span><span class="op">.</span>a <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb64-100"><a href="asteroids.html#cb64-100"></a>  asteroid<span class="op">.</span><span class="va">m_rotation</span> <span class="op">=</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb64-101"><a href="asteroids.html#cb64-101"></a>  asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb64-102"><a href="asteroids.html#cb64-102"></a>  asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">=</span> translation<span class="op">;</span></span>
<span id="cb64-103"><a href="asteroids.html#cb64-103"></a></span>
<span id="cb64-104"><a href="asteroids.html#cb64-104"></a>  <span class="co">// Get a random angular velocity</span></span>
<span id="cb64-105"><a href="asteroids.html#cb64-105"></a>  asteroid<span class="op">.</span><span class="va">m_angularVelocity</span> <span class="op">=</span> <span class="va">m_randomDist</span><span class="op">(</span>re<span class="op">);</span></span>
<span id="cb64-106"><a href="asteroids.html#cb64-106"></a></span>
<span id="cb64-107"><a href="asteroids.html#cb64-107"></a>  <span class="co">// Get a random direction</span></span>
<span id="cb64-108"><a href="asteroids.html#cb64-108"></a>  glm<span class="op">::</span>vec2 <span class="at">const</span> direction<span class="op">{</span><span class="va">m_randomDist</span><span class="op">(</span>re<span class="op">),</span> <span class="va">m_randomDist</span><span class="op">(</span>re<span class="op">)};</span></span>
<span id="cb64-109"><a href="asteroids.html#cb64-109"></a>  asteroid<span class="op">.</span><span class="va">m_velocity</span> <span class="op">=</span> glm<span class="op">::</span>normalize<span class="op">(</span>direction<span class="op">)</span> <span class="op">/</span> <span class="fl">7.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb64-110"><a href="asteroids.html#cb64-110"></a></span>
<span id="cb64-111"><a href="asteroids.html#cb64-111"></a>  <span class="co">// Create geometry data</span></span>
<span id="cb64-112"><a href="asteroids.html#cb64-112"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span>glm<span class="op">::</span>vec2<span class="op">&gt;</span> positions<span class="op">{{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">}};</span></span>
<span id="cb64-113"><a href="asteroids.html#cb64-113"></a>  <span class="kw">auto</span> <span class="at">const</span> step<span class="op">{</span>M_PI <span class="op">*</span> <span class="dv">2</span> <span class="op">/</span> asteroid<span class="op">.</span><span class="va">m_polygonSides</span><span class="op">};</span></span>
<span id="cb64-114"><a href="asteroids.html#cb64-114"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>randomRadius<span class="op">(</span><span class="fl">0.8</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb64-115"><a href="asteroids.html#cb64-115"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> angle <span class="op">:</span> iter<span class="op">::</span>range<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> M_PI <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> step<span class="op">))</span> <span class="op">{</span></span>
<span id="cb64-116"><a href="asteroids.html#cb64-116"></a>    <span class="kw">auto</span> <span class="at">const</span> radius<span class="op">{</span>randomRadius<span class="op">(</span>re<span class="op">)};</span></span>
<span id="cb64-117"><a href="asteroids.html#cb64-117"></a>    positions<span class="op">.</span>emplace_back<span class="op">(</span>radius <span class="op">*</span> <span class="bu">std::</span>cos<span class="op">(</span>angle<span class="op">),</span> radius <span class="op">*</span> <span class="bu">std::</span>sin<span class="op">(</span>angle<span class="op">));</span></span>
<span id="cb64-118"><a href="asteroids.html#cb64-118"></a>  <span class="op">}</span></span>
<span id="cb64-119"><a href="asteroids.html#cb64-119"></a>  positions<span class="op">.</span>push_back<span class="op">(</span>positions<span class="op">.</span>at<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb64-120"><a href="asteroids.html#cb64-120"></a></span>
<span id="cb64-121"><a href="asteroids.html#cb64-121"></a>  <span class="co">// Generate VBO</span></span>
<span id="cb64-122"><a href="asteroids.html#cb64-122"></a>  abcg<span class="op">::</span>glGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>asteroid<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb64-123"><a href="asteroids.html#cb64-123"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb64-124"><a href="asteroids.html#cb64-124"></a>  abcg<span class="op">::</span>glBufferData<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> positions<span class="op">.</span>size<span class="op">()</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec2<span class="op">),</span></span>
<span id="cb64-125"><a href="asteroids.html#cb64-125"></a>                     positions<span class="op">.</span>data<span class="op">(),</span> GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb64-126"><a href="asteroids.html#cb64-126"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb64-127"><a href="asteroids.html#cb64-127"></a></span>
<span id="cb64-128"><a href="asteroids.html#cb64-128"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb64-129"><a href="asteroids.html#cb64-129"></a>  <span class="kw">auto</span> <span class="at">const</span> positionAttribute<span class="op">{</span></span>
<span id="cb64-130"><a href="asteroids.html#cb64-130"></a>      abcg<span class="op">::</span>glGetAttribLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;inPosition&quot;</span><span class="op">)};</span></span>
<span id="cb64-131"><a href="asteroids.html#cb64-131"></a></span>
<span id="cb64-132"><a href="asteroids.html#cb64-132"></a>  <span class="co">// Create VAO</span></span>
<span id="cb64-133"><a href="asteroids.html#cb64-133"></a>  abcg<span class="op">::</span>glGenVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>asteroid<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb64-134"><a href="asteroids.html#cb64-134"></a></span>
<span id="cb64-135"><a href="asteroids.html#cb64-135"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb64-136"><a href="asteroids.html#cb64-136"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb64-137"><a href="asteroids.html#cb64-137"></a></span>
<span id="cb64-138"><a href="asteroids.html#cb64-138"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> asteroid<span class="op">.</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb64-139"><a href="asteroids.html#cb64-139"></a>  abcg<span class="op">::</span>glEnableVertexAttribArray<span class="op">(</span>positionAttribute<span class="op">);</span></span>
<span id="cb64-140"><a href="asteroids.html#cb64-140"></a>  abcg<span class="op">::</span>glVertexAttribPointer<span class="op">(</span>positionAttribute<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> GL_FALSE<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb64-141"><a href="asteroids.html#cb64-141"></a>                              <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb64-142"><a href="asteroids.html#cb64-142"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb64-143"><a href="asteroids.html#cb64-143"></a></span>
<span id="cb64-144"><a href="asteroids.html#cb64-144"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb64-145"><a href="asteroids.html#cb64-145"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb64-146"><a href="asteroids.html#cb64-146"></a></span>
<span id="cb64-147"><a href="asteroids.html#cb64-147"></a>  <span class="cf">return</span> asteroid<span class="op">;</span></span>
<span id="cb64-148"><a href="asteroids.html#cb64-148"></a><span class="op">}</span></span></code></pre></div>
<p>Na linha 105 é escolhida uma velocidade angular aleatória no intervalo <span class="math inline">\([-1, 1)\)</span>. Essa velocidade será interpretada como sendo em radianos por segundo.</p>
<p>Na linha 109 é escolhido um vetor unitário aleatório para definir a velocidade do asteroide. As componentes do vetor são divididas por 7 de modo que cada asteroide inicie com uma velocidade de 1/7 unidades de espaço por segundo.</p>
<p>O restante do código cria a geometria do asteroide. O código é bem parecido com o que foi utilizado para criar o polígono regular no projeto <code>regularpolygons</code>. A diferença é que agora usamos a equação paramétrica do círculo com raio <span class="math inline">\(r\)</span></p>
<p><span class="math display">\[
\begin{eqnarray}
x&amp;=&amp;r cos(t),\\
y&amp;=&amp;r sin(t),
\end{eqnarray}
\]</span></p>
<p>e selecionamos um <span class="math inline">\(r\)</span> aleatório do intervalo <span class="math inline">\([0.8, 1)\)</span> para cada vértice do polígono.</p>
<p>Nesse momento, o jogo ficará como a seguir (<a href="https://hbatagelo.github.io/abcgapps/asteroids3/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids3/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids3.zip">deste link</a>.</p>
</div>
</div>
<div id="tiros-e-colisões" class="section level3 unnumbered hasAnchor">
<h3>Tiros e colisões<a href="asteroids.html#tiros-e-colisões" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Até agora o jogo ainda não tem detecção de colisão com os asteroides. Faremos isso a seguir.</p>
<div id="atualizando-window.hpp-2" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.hpp<a href="asteroids.html#atualizando-window.hpp-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Adicione a definição de <code>m_bullets</code> junto à definição dos outros objetos:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb65-1"><a href="asteroids.html#cb65-1" aria-hidden="true" tabindex="-1"></a>Asteroids <span class="va">m_asteroids</span><span class="op">;</span></span>
<span id="cb65-2"><a href="asteroids.html#cb65-2" aria-hidden="true" tabindex="-1"></a>Bullets <span class="va">m_bullets</span><span class="op">;</span></span>
<span id="cb65-3"><a href="asteroids.html#cb65-3" aria-hidden="true" tabindex="-1"></a>Ship <span class="va">m_ship</span><span class="op">;</span></span>
<span id="cb65-4"><a href="asteroids.html#cb65-4" aria-hidden="true" tabindex="-1"></a>StarLayers <span class="va">m_starLayers</span><span class="op">;</span></span></code></pre></div>
<p>Adicione também a declaração das seguintes funções adicionais de <code>Window</code>:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb66-1"><a href="asteroids.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> checkCollisions<span class="op">();</span></span>
<span id="cb66-2"><a href="asteroids.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> checkWinCondition<span class="op">();</span></span></code></pre></div>
<ul>
<li><code>checkCollisions</code> será utilizada para verificar as colisões;</li>
<li><code>checkWinCondition</code> será utilizada para verificar se o jogador ganhou (isto é, se não há mais asteroides).</li>
</ul>
</div>
<div id="atualizando-window.cpp-2" class="section level4 unnumbered hasAnchor">
<h4>Atualizando window.cpp<a href="asteroids.html#atualizando-window.cpp-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><p>Em <code>Window::restart</code>, inclua a chamada à função <code>create</code> de <code>m_bullets</code> junto com <code>create</code> dos objetos anteriores, assim:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb67-1"><a href="asteroids.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_starsProgram</span><span class="op">,</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb67-2"><a href="asteroids.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span>
<span id="cb67-3"><a href="asteroids.html#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb67-4"><a href="asteroids.html#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span><span class="op">.</span>create<span class="op">(</span><span class="va">m_objectsProgram</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onUpdate</code>, chame <code>update</code> de <code>m_bullets</code> em qualquer lugar após a chamada de <code>update</code> de <code>m_ship</code>. Por exemplo:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb68-1"><a href="asteroids.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_gameData</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb68-2"><a href="asteroids.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb68-3"><a href="asteroids.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> deltaTime<span class="op">);</span></span>
<span id="cb68-4"><a href="asteroids.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span><span class="op">.</span>update<span class="op">(</span><span class="va">m_ship</span><span class="op">,</span> <span class="va">m_gameData</span><span class="op">,</span> deltaTime<span class="op">);</span></span></code></pre></div>
<p>Após esses <code>update</code>s, inclua a seguinte condicional que chama as funções de detecção de colisão e verificação da condição de vitória se o jogo está no estado <code>State::Playing</code>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb69-1"><a href="asteroids.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">==</span> State<span class="op">::</span>Playing<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-2"><a href="asteroids.html#cb69-2" aria-hidden="true" tabindex="-1"></a>  checkCollisions<span class="op">();</span></span>
<span id="cb69-3"><a href="asteroids.html#cb69-3" aria-hidden="true" tabindex="-1"></a>  checkWinCondition<span class="op">();</span></span>
<span id="cb69-4"><a href="asteroids.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>Em <code>Window::onPaint</code>, chame <code>paint</code> de <code>m_bullets</code> logo após a chamada de <code>paint</code> de <code>m_asteroids</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb70-1"><a href="asteroids.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb70-2"><a href="asteroids.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb70-3"><a href="asteroids.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span><span class="op">.</span>paint<span class="op">();</span></span>
<span id="cb70-4"><a href="asteroids.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>paint<span class="op">(</span><span class="va">m_gameData</span><span class="op">);</span></span></code></pre></div></li>
<li><p>Em <code>Window::onDestroy</code>, chame <code>destroy</code> de <code>m_bullets</code> junto com <code>destroy</code> dos outros objetos:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb71-1"><a href="asteroids.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb71-2"><a href="asteroids.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb71-3"><a href="asteroids.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span><span class="op">.</span>destroy<span class="op">();</span></span>
<span id="cb71-4"><a href="asteroids.html#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span><span class="op">.</span>destroy<span class="op">();</span></span></code></pre></div></li>
</ul>
<p>Vamos agora definir <code>Window::checkCollisions</code> como a seguir:</p>
<div class="sourceCode" id="cb72" startFrom="173"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 172;"><span id="cb72-173"><a href="asteroids.html#cb72-173"></a><span class="dt">void</span> Window<span class="op">::</span>checkCollisions<span class="op">()</span> <span class="op">{</span></span>
<span id="cb72-174"><a href="asteroids.html#cb72-174"></a>  <span class="co">// Check collision between ship and asteroids</span></span>
<span id="cb72-175"><a href="asteroids.html#cb72-175"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-176"><a href="asteroids.html#cb72-176"></a>    <span class="kw">auto</span> <span class="at">const</span> asteroidTranslation<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">};</span></span>
<span id="cb72-177"><a href="asteroids.html#cb72-177"></a>    <span class="kw">auto</span> <span class="at">const</span> distance<span class="op">{</span></span>
<span id="cb72-178"><a href="asteroids.html#cb72-178"></a>        glm<span class="op">::</span>distance<span class="op">(</span><span class="va">m_ship</span><span class="op">.</span><span class="va">m_translation</span><span class="op">,</span> asteroidTranslation<span class="op">)};</span></span>
<span id="cb72-179"><a href="asteroids.html#cb72-179"></a></span>
<span id="cb72-180"><a href="asteroids.html#cb72-180"></a>    <span class="cf">if</span> <span class="op">(</span>distance <span class="op">&lt;</span> <span class="va">m_ship</span><span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.9</span><span class="bu">f</span> <span class="op">+</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.85</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-181"><a href="asteroids.html#cb72-181"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">=</span> State<span class="op">::</span>GameOver<span class="op">;</span></span>
<span id="cb72-182"><a href="asteroids.html#cb72-182"></a>      <span class="va">m_restartWaitTimer</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb72-183"><a href="asteroids.html#cb72-183"></a>    <span class="op">}</span></span>
<span id="cb72-184"><a href="asteroids.html#cb72-184"></a>  <span class="op">}</span></span>
<span id="cb72-185"><a href="asteroids.html#cb72-185"></a></span>
<span id="cb72-186"><a href="asteroids.html#cb72-186"></a>  <span class="co">// Check collision between bullets and asteroids</span></span>
<span id="cb72-187"><a href="asteroids.html#cb72-187"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>bullet <span class="op">:</span> <span class="va">m_bullets</span><span class="op">.</span><span class="va">m_bullets</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-188"><a href="asteroids.html#cb72-188"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_dead</span><span class="op">)</span></span>
<span id="cb72-189"><a href="asteroids.html#cb72-189"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb72-190"><a href="asteroids.html#cb72-190"></a></span>
<span id="cb72-191"><a href="asteroids.html#cb72-191"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-192"><a href="asteroids.html#cb72-192"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> i <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb72-193"><a href="asteroids.html#cb72-193"></a>        <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> j <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb72-194"><a href="asteroids.html#cb72-194"></a>          <span class="kw">auto</span> <span class="at">const</span> asteroidTranslation<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">+</span></span>
<span id="cb72-195"><a href="asteroids.html#cb72-195"></a>                                         glm<span class="op">::</span>vec2<span class="op">(</span>i<span class="op">,</span> j<span class="op">)};</span></span>
<span id="cb72-196"><a href="asteroids.html#cb72-196"></a>          <span class="kw">auto</span> <span class="at">const</span> distance<span class="op">{</span></span>
<span id="cb72-197"><a href="asteroids.html#cb72-197"></a>              glm<span class="op">::</span>distance<span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">,</span> asteroidTranslation<span class="op">)};</span></span>
<span id="cb72-198"><a href="asteroids.html#cb72-198"></a></span>
<span id="cb72-199"><a href="asteroids.html#cb72-199"></a>          <span class="cf">if</span> <span class="op">(</span>distance <span class="op">&lt;</span> <span class="va">m_bullets</span><span class="op">.</span><span class="va">m_scale</span> <span class="op">+</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.85</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-200"><a href="asteroids.html#cb72-200"></a>            asteroid<span class="op">.</span><span class="va">m_hit</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb72-201"><a href="asteroids.html#cb72-201"></a>            bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb72-202"><a href="asteroids.html#cb72-202"></a>          <span class="op">}</span></span>
<span id="cb72-203"><a href="asteroids.html#cb72-203"></a>        <span class="op">}</span></span>
<span id="cb72-204"><a href="asteroids.html#cb72-204"></a>      <span class="op">}</span></span>
<span id="cb72-205"><a href="asteroids.html#cb72-205"></a>    <span class="op">}</span></span>
<span id="cb72-206"><a href="asteroids.html#cb72-206"></a></span>
<span id="cb72-207"><a href="asteroids.html#cb72-207"></a>    <span class="co">// Break asteroids marked as hit</span></span>
<span id="cb72-208"><a href="asteroids.html#cb72-208"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-209"><a href="asteroids.html#cb72-209"></a>      <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_hit</span> <span class="op">&amp;&amp;</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">&gt;</span> <span class="fl">0.10</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-210"><a href="asteroids.html#cb72-210"></a>        <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>randomDist<span class="op">{-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb72-211"><a href="asteroids.html#cb72-211"></a>        <span class="bu">std::</span>generate_n<span class="op">(</span><span class="bu">std::</span>back_inserter<span class="op">(</span><span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">),</span> <span class="dv">3</span><span class="op">,</span> <span class="op">[&amp;]()</span> <span class="op">{</span></span>
<span id="cb72-212"><a href="asteroids.html#cb72-212"></a>          glm<span class="op">::</span>vec2 <span class="at">const</span> offset<span class="op">{</span>randomDist<span class="op">(</span><span class="va">m_randomEngine</span><span class="op">),</span></span>
<span id="cb72-213"><a href="asteroids.html#cb72-213"></a>                                 randomDist<span class="op">(</span><span class="va">m_randomEngine</span><span class="op">)};</span></span>
<span id="cb72-214"><a href="asteroids.html#cb72-214"></a>          <span class="kw">auto</span> <span class="at">const</span> newScale<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.5</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb72-215"><a href="asteroids.html#cb72-215"></a>          <span class="cf">return</span> <span class="va">m_asteroids</span><span class="op">.</span>makeAsteroid<span class="op">(</span></span>
<span id="cb72-216"><a href="asteroids.html#cb72-216"></a>              asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">+</span> offset <span class="op">*</span> newScale<span class="op">,</span> newScale<span class="op">);</span></span>
<span id="cb72-217"><a href="asteroids.html#cb72-217"></a>        <span class="op">});</span></span>
<span id="cb72-218"><a href="asteroids.html#cb72-218"></a>      <span class="op">}</span></span>
<span id="cb72-219"><a href="asteroids.html#cb72-219"></a>    <span class="op">}</span></span>
<span id="cb72-220"><a href="asteroids.html#cb72-220"></a></span>
<span id="cb72-221"><a href="asteroids.html#cb72-221"></a>    <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">.</span>remove_if<span class="op">([](</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>a<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> a<span class="op">.</span><span class="va">m_hit</span><span class="op">;</span> <span class="op">});</span></span>
<span id="cb72-222"><a href="asteroids.html#cb72-222"></a>  <span class="op">}</span></span>
<span id="cb72-223"><a href="asteroids.html#cb72-223"></a><span class="op">}</span></span></code></pre></div>
<p>Nas linhas 174 a 184 é feita a detecção de colisão entre a nave e cada asteroide:</p>
<div class="sourceCode" id="cb73" startFrom="174"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 173;"><span id="cb73-174"><a href="asteroids.html#cb73-174"></a>  <span class="co">// Check collision between ship and asteroids</span></span>
<span id="cb73-175"><a href="asteroids.html#cb73-175"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-176"><a href="asteroids.html#cb73-176"></a>    <span class="kw">auto</span> <span class="at">const</span> asteroidTranslation<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_translation</span><span class="op">};</span></span>
<span id="cb73-177"><a href="asteroids.html#cb73-177"></a>    <span class="kw">auto</span> <span class="at">const</span> distance<span class="op">{</span></span>
<span id="cb73-178"><a href="asteroids.html#cb73-178"></a>        glm<span class="op">::</span>distance<span class="op">(</span><span class="va">m_ship</span><span class="op">.</span><span class="va">m_translation</span><span class="op">,</span> asteroidTranslation<span class="op">)};</span></span>
<span id="cb73-179"><a href="asteroids.html#cb73-179"></a></span>
<span id="cb73-180"><a href="asteroids.html#cb73-180"></a>    <span class="cf">if</span> <span class="op">(</span>distance <span class="op">&lt;</span> <span class="va">m_ship</span><span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.9</span><span class="bu">f</span> <span class="op">+</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.85</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-181"><a href="asteroids.html#cb73-181"></a>      <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">=</span> State<span class="op">::</span>GameOver<span class="op">;</span></span>
<span id="cb73-182"><a href="asteroids.html#cb73-182"></a>      <span class="va">m_restartWaitTimer</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb73-183"><a href="asteroids.html#cb73-183"></a>    <span class="op">}</span></span>
<span id="cb73-184"><a href="asteroids.html#cb73-184"></a>  <span class="op">}</span></span></code></pre></div>
<p>A detecção de colisão é feita através da comparação da distância euclidiana (<code>glm::distance</code>) entre as coordenadas de translação dos objetos. Essas coordenadas podem ser consideradas como a posição do centro dos objetos na cena (como ilustrado pelos pontos <span class="math inline">\(P_s\)</span> e <span class="math inline">\(P_a\)</span> na figura <a href="asteroids.html#fig:collision1">6.10</a>:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:collision1"></span>
<img src="images/05_collision1.svg" alt="Detecção de colisão entre nave e asteroide através da comparação de distância entre círculos." width="60%" />
<p class="caption">
Figura 6.10: Detecção de colisão entre nave e asteroide através da comparação de distância entre círculos.
</p>
</div>
<p><span class="math inline">\(P_s\)</span> e <span class="math inline">\(P_a\)</span> também podem ser considerados como centros de círculos. O fator de escala de cada objeto corresponde ao raio do círculo (<span class="math inline">\(r_s\)</span> e <span class="math inline">\(r_a\)</span>). Assim, podemos detectar a colisão através de uma simples comparação da distância <span class="math inline">\(|P_s-P_a|\)</span> com a soma dos fatores de escala. Só há colisão se a distância for menor ou igual a <span class="math inline">\(r_s+r_a\)</span>. Esse tipo de teste é bem mais simples e eficiente (embora menos preciso) do que comparar a interseção entre os triângulos que formam os objetos.</p>
<p>Note, na linha 180, que <span class="math inline">\(r_s\)</span> e <span class="math inline">\(r_a\)</span> são de fato os fatores <code>m_scale</code> de cada objeto, mas multiplicados por <code>0.9f</code> (para a nave) e <code>0.85f</code> (para o asteroide). Isso é feito para diminuir um pouco o raio dos círculos e fazer com que exista uma tolerância de sobreposição antes de ocorrer a colisão. Veja, na figura <a href="asteroids.html#fig:collision1">6.10</a>, que dessa forma os objetos não ficam inscritos nos círculos. Os valores <code>0.9</code> e <code>0.85</code> foram determinados empiricamente.</p>
<p>O laço <code>for</code> da linha 187 itera sobre os tiros. Dentro desse laço há outro (linha 191) que itera sobre os asteroides para verificar se há colisão entre cada tiro e os asteroides:</p>
<div class="sourceCode" id="cb74" startFrom="186"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 185;"><span id="cb74-186"><a href="asteroids.html#cb74-186"></a>  <span class="co">// Check collision between bullets and asteroids</span></span>
<span id="cb74-187"><a href="asteroids.html#cb74-187"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>bullet <span class="op">:</span> <span class="va">m_bullets</span><span class="op">.</span><span class="va">m_bullets</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-188"><a href="asteroids.html#cb74-188"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_dead</span><span class="op">)</span></span>
<span id="cb74-189"><a href="asteroids.html#cb74-189"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb74-190"><a href="asteroids.html#cb74-190"></a></span>
<span id="cb74-191"><a href="asteroids.html#cb74-191"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-192"><a href="asteroids.html#cb74-192"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> i <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb74-193"><a href="asteroids.html#cb74-193"></a>        <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> j <span class="op">:</span> <span class="op">{-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">})</span> <span class="op">{</span></span>
<span id="cb74-194"><a href="asteroids.html#cb74-194"></a>          <span class="kw">auto</span> <span class="at">const</span> asteroidTranslation<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">+</span></span>
<span id="cb74-195"><a href="asteroids.html#cb74-195"></a>                                         glm<span class="op">::</span>vec2<span class="op">(</span>i<span class="op">,</span> j<span class="op">)};</span></span>
<span id="cb74-196"><a href="asteroids.html#cb74-196"></a>          <span class="kw">auto</span> <span class="at">const</span> distance<span class="op">{</span></span>
<span id="cb74-197"><a href="asteroids.html#cb74-197"></a>              glm<span class="op">::</span>distance<span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">,</span> asteroidTranslation<span class="op">)};</span></span>
<span id="cb74-198"><a href="asteroids.html#cb74-198"></a></span>
<span id="cb74-199"><a href="asteroids.html#cb74-199"></a>          <span class="cf">if</span> <span class="op">(</span>distance <span class="op">&lt;</span> <span class="va">m_bullets</span><span class="op">.</span><span class="va">m_scale</span> <span class="op">+</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.85</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-200"><a href="asteroids.html#cb74-200"></a>            asteroid<span class="op">.</span><span class="va">m_hit</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb74-201"><a href="asteroids.html#cb74-201"></a>            bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb74-202"><a href="asteroids.html#cb74-202"></a>          <span class="op">}</span></span>
<span id="cb74-203"><a href="asteroids.html#cb74-203"></a>        <span class="op">}</span></span>
<span id="cb74-204"><a href="asteroids.html#cb74-204"></a>      <span class="op">}</span></span>
<span id="cb74-205"><a href="asteroids.html#cb74-205"></a>    <span class="op">}</span></span></code></pre></div>
<p>A verificação da interseção é calculada novamente através da comparação da distância entre círculos. Note que os testes de distância são feitos dentro de laços aninhados parecidos com os que foram utilizados para replicar a renderização dos asteroides na grade 3x3 em torno da região visível do viewport. De fato, o teste de colisão de um tiro com um asteroide precisa considerar essa replicação, pois um asteroide que está saindo à esquerda do viewport pode ser atingido por um tiro no lado oposto, à direita.</p>
<p>Se um tiro acertou um asteroide, o <code>m_hit</code> do asteroide e o <code>m_dead</code> do tiro tornam-se <code>true</code>.</p>
<p>Observe agora as linhas 207 a 219:</p>
<div class="sourceCode" id="cb75" startFrom="207"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 206;"><span id="cb75-207"><a href="asteroids.html#cb75-207"></a>    <span class="co">// Break asteroids marked as hit</span></span>
<span id="cb75-208"><a href="asteroids.html#cb75-208"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>asteroid <span class="op">:</span> <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-209"><a href="asteroids.html#cb75-209"></a>      <span class="cf">if</span> <span class="op">(</span>asteroid<span class="op">.</span><span class="va">m_hit</span> <span class="op">&amp;&amp;</span> asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">&gt;</span> <span class="fl">0.10</span><span class="bu">f</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-210"><a href="asteroids.html#cb75-210"></a>        <span class="bu">std::</span>uniform_real_distribution<span class="op"> </span>randomDist<span class="op">{-</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb75-211"><a href="asteroids.html#cb75-211"></a>        <span class="bu">std::</span>generate_n<span class="op">(</span><span class="bu">std::</span>back_inserter<span class="op">(</span><span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">),</span> <span class="dv">3</span><span class="op">,</span> <span class="op">[&amp;]()</span> <span class="op">{</span></span>
<span id="cb75-212"><a href="asteroids.html#cb75-212"></a>          glm<span class="op">::</span>vec2 <span class="at">const</span> offset<span class="op">{</span>randomDist<span class="op">(</span><span class="va">m_randomEngine</span><span class="op">),</span></span>
<span id="cb75-213"><a href="asteroids.html#cb75-213"></a>                                 randomDist<span class="op">(</span><span class="va">m_randomEngine</span><span class="op">)};</span></span>
<span id="cb75-214"><a href="asteroids.html#cb75-214"></a>          <span class="kw">auto</span> <span class="at">const</span> newScale<span class="op">{</span>asteroid<span class="op">.</span><span class="va">m_scale</span> <span class="op">*</span> <span class="fl">0.5</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb75-215"><a href="asteroids.html#cb75-215"></a>          <span class="cf">return</span> <span class="va">m_asteroids</span><span class="op">.</span>makeAsteroid<span class="op">(</span></span>
<span id="cb75-216"><a href="asteroids.html#cb75-216"></a>              asteroid<span class="op">.</span><span class="va">m_translation</span> <span class="op">+</span> offset <span class="op">*</span> newScale<span class="op">,</span> newScale<span class="op">);</span></span>
<span id="cb75-217"><a href="asteroids.html#cb75-217"></a>        <span class="op">});</span></span>
<span id="cb75-218"><a href="asteroids.html#cb75-218"></a>      <span class="op">}</span></span>
<span id="cb75-219"><a href="asteroids.html#cb75-219"></a>    <span class="op">}</span></span></code></pre></div>
<p>Neste código, os asteroides com <code>m_hit == true</code> são testados para verificar se são suficientemente grandes (<code>m_scale &gt; 0.10f</code>). Se sim, três novos asteroides menores são criados e inseridos na lista <code>m_asteroids.m_asteroids</code>. <a href="https://en.cppreference.com/w/cpp/algorithm/generate"><code>std::generate</code></a> é uma função da biblioteca padrão do C++. Ela chama um número de vezes (nesse caso 3 vezes) a expressão lambda passada como último argumento. O valor de retorno da expressão lambda é inserido no fim de <code>m_asteroids.m_asteroids</code> usando a função auxiliar <a href="https://en.cppreference.com/w/cpp/iterator/back_inserter"><code>std::back_inserter</code></a>.</p>
<p>Na linha 221, os asteroides que estavam com <code>m_hit == true</code> são removidos da lista usando <a href="https://en.cppreference.com/w/cpp/algorithm/remove"><code>std::remove_if</code></a>:</p>
<div class="sourceCode" id="cb76" startFrom="219"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 218;"><span id="cb76-219"><a href="asteroids.html#cb76-219"></a>    <span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">.</span>remove_if<span class="op">(</span></span>
<span id="cb76-220"><a href="asteroids.html#cb76-220"></a>        <span class="op">[](</span><span class="at">const</span> Asteroids<span class="op">::</span>Asteroid <span class="op">&amp;</span>a<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> a<span class="op">.</span><span class="va">m_hit</span><span class="op">;</span> <span class="op">});</span></span></code></pre></div>
<p>Isso é tudo para a detecção de colisão. Vamos agora à definição de <code>Window::checkWinCondition</code>, que ficará como a seguir:</p>
<div class="sourceCode" id="cb77" startFrom="225"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 224;"><span id="cb77-225"><a href="asteroids.html#cb77-225"></a><span class="dt">void</span> Window<span class="op">::</span>checkWinCondition<span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-226"><a href="asteroids.html#cb77-226"></a>  <span class="cf">if</span> <span class="op">(</span><span class="va">m_asteroids</span><span class="op">.</span><span class="va">m_asteroids</span><span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb77-227"><a href="asteroids.html#cb77-227"></a>    <span class="va">m_gameData</span><span class="op">.</span><span class="va">m_state</span> <span class="op">=</span> State<span class="op">::</span>Win<span class="op">;</span></span>
<span id="cb77-228"><a href="asteroids.html#cb77-228"></a>    <span class="va">m_restartWaitTimer</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb77-229"><a href="asteroids.html#cb77-229"></a>  <span class="op">}</span></span>
<span id="cb77-230"><a href="asteroids.html#cb77-230"></a><span class="op">}</span></span></code></pre></div>
<p>A vitória ocorre quando a lista de asteroides está vazia. Nesse caso, o estado do jogo é modificado para <code>State::Win</code> e o temporizador <code>m_restartWaitTimer</code> é reiniciado. Como resultado, o jogo será reiniciado após cinco segundos (essa verificação é feita em <code>Window::onUpdate</code>). Enquanto isso, o texto de vitória será exibido em <code>Window::onPaintUI</code>.</p>
</div>
<div id="bullets.hpp" class="section level4 unnumbered hasAnchor">
<h4>bullets.hpp<a href="asteroids.html#bullets.hpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A definição da classe <code>Bullets</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb78" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb78-1"><a href="asteroids.html#cb78-1"></a><span class="pp">#ifndef BULLETS_HPP_</span></span>
<span id="cb78-2"><a href="asteroids.html#cb78-2"></a><span class="pp">#define BULLETS_HPP_</span></span>
<span id="cb78-3"><a href="asteroids.html#cb78-3"></a></span>
<span id="cb78-4"><a href="asteroids.html#cb78-4"></a><span class="pp">#include </span><span class="im">&lt;list&gt;</span></span>
<span id="cb78-5"><a href="asteroids.html#cb78-5"></a></span>
<span id="cb78-6"><a href="asteroids.html#cb78-6"></a><span class="pp">#include </span><span class="im">&quot;abcgOpenGL.hpp&quot;</span></span>
<span id="cb78-7"><a href="asteroids.html#cb78-7"></a></span>
<span id="cb78-8"><a href="asteroids.html#cb78-8"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb78-9"><a href="asteroids.html#cb78-9"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb78-10"><a href="asteroids.html#cb78-10"></a></span>
<span id="cb78-11"><a href="asteroids.html#cb78-11"></a><span class="kw">class</span> OpenGLWindow<span class="op">;</span></span>
<span id="cb78-12"><a href="asteroids.html#cb78-12"></a></span>
<span id="cb78-13"><a href="asteroids.html#cb78-13"></a><span class="kw">class</span> Bullets <span class="op">{</span></span>
<span id="cb78-14"><a href="asteroids.html#cb78-14"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb78-15"><a href="asteroids.html#cb78-15"></a>  <span class="dt">void</span> create<span class="op">(</span>GLuint program<span class="op">);</span></span>
<span id="cb78-16"><a href="asteroids.html#cb78-16"></a>  <span class="dt">void</span> paint<span class="op">();</span></span>
<span id="cb78-17"><a href="asteroids.html#cb78-17"></a>  <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb78-18"><a href="asteroids.html#cb78-18"></a>  <span class="dt">void</span> update<span class="op">(</span>Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="at">const</span> GameData <span class="op">&amp;</span>gameData<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">);</span></span>
<span id="cb78-19"><a href="asteroids.html#cb78-19"></a></span>
<span id="cb78-20"><a href="asteroids.html#cb78-20"></a>  <span class="kw">struct</span> Bullet <span class="op">{</span></span>
<span id="cb78-21"><a href="asteroids.html#cb78-21"></a>    <span class="dt">bool</span> <span class="va">m_dead</span><span class="op">{};</span></span>
<span id="cb78-22"><a href="asteroids.html#cb78-22"></a>    glm<span class="op">::</span>vec2 <span class="va">m_translation</span><span class="op">{};</span></span>
<span id="cb78-23"><a href="asteroids.html#cb78-23"></a>    glm<span class="op">::</span>vec2 <span class="va">m_velocity</span><span class="op">{};</span></span>
<span id="cb78-24"><a href="asteroids.html#cb78-24"></a>  <span class="op">};</span></span>
<span id="cb78-25"><a href="asteroids.html#cb78-25"></a></span>
<span id="cb78-26"><a href="asteroids.html#cb78-26"></a>  <span class="bu">std::</span>list<span class="op">&lt;</span>Bullet<span class="op">&gt;</span> <span class="va">m_bullets</span><span class="op">;</span></span>
<span id="cb78-27"><a href="asteroids.html#cb78-27"></a></span>
<span id="cb78-28"><a href="asteroids.html#cb78-28"></a>  <span class="dt">float</span> <span class="va">m_scale</span><span class="op">{</span><span class="fl">0.015</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb78-29"><a href="asteroids.html#cb78-29"></a></span>
<span id="cb78-30"><a href="asteroids.html#cb78-30"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb78-31"><a href="asteroids.html#cb78-31"></a>  GLuint <span class="va">m_program</span><span class="op">{};</span></span>
<span id="cb78-32"><a href="asteroids.html#cb78-32"></a>  GLint <span class="va">m_colorLoc</span><span class="op">{};</span></span>
<span id="cb78-33"><a href="asteroids.html#cb78-33"></a>  GLint <span class="va">m_rotationLoc</span><span class="op">{};</span></span>
<span id="cb78-34"><a href="asteroids.html#cb78-34"></a>  GLint <span class="va">m_translationLoc</span><span class="op">{};</span></span>
<span id="cb78-35"><a href="asteroids.html#cb78-35"></a>  GLint <span class="va">m_scaleLoc</span><span class="op">{};</span></span>
<span id="cb78-36"><a href="asteroids.html#cb78-36"></a></span>
<span id="cb78-37"><a href="asteroids.html#cb78-37"></a>  GLuint <span class="va">m_VAO</span><span class="op">{};</span></span>
<span id="cb78-38"><a href="asteroids.html#cb78-38"></a>  GLuint <span class="va">m_VBO</span><span class="op">{};</span></span>
<span id="cb78-39"><a href="asteroids.html#cb78-39"></a><span class="op">};</span></span>
<span id="cb78-40"><a href="asteroids.html#cb78-40"></a></span>
<span id="cb78-41"><a href="asteroids.html#cb78-41"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Nas linhas 20 a 24 é definida a estrutura <code>Bullet</code>. Observe que o VAO e VBO não está em <code>Bullet</code>, mas em <code>Bullets</code>, pois todos os tiros utilizam o mesmo VBO.</p>
<p>Na linha 26 é definida a lista de tiros atualmente na cena. O número de elementos desta lista será alterado de acordo com a quantidade de tiros visíveis.</p>
<p>Na linha 28 é definido o fator de escala comum a todos os tiros.</p>
</div>
<div id="bullets.cpp" class="section level4 unnumbered hasAnchor">
<h4>bullets.cpp<a href="asteroids.html#bullets.cpp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>O arquivo começa com a definição de <code>Bullets::create</code>:</p>
<div class="sourceCode" id="cb79" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb79-1"><a href="asteroids.html#cb79-1"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb79-2"><a href="asteroids.html#cb79-2"></a></span>
<span id="cb79-3"><a href="asteroids.html#cb79-3"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/rotate_vector.hpp&gt;</span></span>
<span id="cb79-4"><a href="asteroids.html#cb79-4"></a></span>
<span id="cb79-5"><a href="asteroids.html#cb79-5"></a><span class="dt">void</span> Bullets<span class="op">::</span>create<span class="op">(</span>GLuint program<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-6"><a href="asteroids.html#cb79-6"></a>  destroy<span class="op">();</span></span>
<span id="cb79-7"><a href="asteroids.html#cb79-7"></a></span>
<span id="cb79-8"><a href="asteroids.html#cb79-8"></a>  <span class="va">m_program</span> <span class="op">=</span> program<span class="op">;</span></span>
<span id="cb79-9"><a href="asteroids.html#cb79-9"></a></span>
<span id="cb79-10"><a href="asteroids.html#cb79-10"></a>  <span class="co">// Get location of uniforms in the program</span></span>
<span id="cb79-11"><a href="asteroids.html#cb79-11"></a>  <span class="va">m_colorLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;color&quot;</span><span class="op">);</span></span>
<span id="cb79-12"><a href="asteroids.html#cb79-12"></a>  <span class="va">m_rotationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;rotation&quot;</span><span class="op">);</span></span>
<span id="cb79-13"><a href="asteroids.html#cb79-13"></a>  <span class="va">m_scaleLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">);</span></span>
<span id="cb79-14"><a href="asteroids.html#cb79-14"></a>  <span class="va">m_translationLoc</span> <span class="op">=</span> abcg<span class="op">::</span>glGetUniformLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;translation&quot;</span><span class="op">);</span></span>
<span id="cb79-15"><a href="asteroids.html#cb79-15"></a></span>
<span id="cb79-16"><a href="asteroids.html#cb79-16"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb79-17"><a href="asteroids.html#cb79-17"></a>  <span class="kw">auto</span> <span class="at">const</span> positionAttribute<span class="op">{</span></span>
<span id="cb79-18"><a href="asteroids.html#cb79-18"></a>      abcg<span class="op">::</span>glGetAttribLocation<span class="op">(</span><span class="va">m_program</span><span class="op">,</span> <span class="st">&quot;inPosition&quot;</span><span class="op">)};</span></span>
<span id="cb79-19"><a href="asteroids.html#cb79-19"></a></span>
<span id="cb79-20"><a href="asteroids.html#cb79-20"></a>  <span class="va">m_bullets</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb79-21"><a href="asteroids.html#cb79-21"></a></span>
<span id="cb79-22"><a href="asteroids.html#cb79-22"></a>  <span class="co">// Create geometry data</span></span>
<span id="cb79-23"><a href="asteroids.html#cb79-23"></a>  <span class="kw">auto</span> <span class="at">const</span> sides<span class="op">{</span><span class="dv">10</span><span class="op">};</span></span>
<span id="cb79-24"><a href="asteroids.html#cb79-24"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span>glm<span class="op">::</span>vec2<span class="op">&gt;</span> positions<span class="op">{{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">}};</span></span>
<span id="cb79-25"><a href="asteroids.html#cb79-25"></a>  <span class="kw">auto</span> <span class="at">const</span> step<span class="op">{</span>M_PI <span class="op">*</span> <span class="dv">2</span> <span class="op">/</span> sides<span class="op">};</span></span>
<span id="cb79-26"><a href="asteroids.html#cb79-26"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> angle <span class="op">:</span> iter<span class="op">::</span>range<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> M_PI <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> step<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-27"><a href="asteroids.html#cb79-27"></a>    positions<span class="op">.</span>emplace_back<span class="op">(</span><span class="bu">std::</span>cos<span class="op">(</span>angle<span class="op">),</span> <span class="bu">std::</span>sin<span class="op">(</span>angle<span class="op">));</span></span>
<span id="cb79-28"><a href="asteroids.html#cb79-28"></a>  <span class="op">}</span></span>
<span id="cb79-29"><a href="asteroids.html#cb79-29"></a>  positions<span class="op">.</span>push_back<span class="op">(</span>positions<span class="op">.</span>at<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb79-30"><a href="asteroids.html#cb79-30"></a></span>
<span id="cb79-31"><a href="asteroids.html#cb79-31"></a>  <span class="co">// Generate VBO of positions</span></span>
<span id="cb79-32"><a href="asteroids.html#cb79-32"></a>  abcg<span class="op">::</span>glGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb79-33"><a href="asteroids.html#cb79-33"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb79-34"><a href="asteroids.html#cb79-34"></a>  abcg<span class="op">::</span>glBufferData<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> positions<span class="op">.</span>size<span class="op">()</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>glm<span class="op">::</span>vec2<span class="op">),</span></span>
<span id="cb79-35"><a href="asteroids.html#cb79-35"></a>                     positions<span class="op">.</span>data<span class="op">(),</span> GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb79-36"><a href="asteroids.html#cb79-36"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb79-37"><a href="asteroids.html#cb79-37"></a></span>
<span id="cb79-38"><a href="asteroids.html#cb79-38"></a>  <span class="co">// Create VAO</span></span>
<span id="cb79-39"><a href="asteroids.html#cb79-39"></a>  abcg<span class="op">::</span>glGenVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb79-40"><a href="asteroids.html#cb79-40"></a></span>
<span id="cb79-41"><a href="asteroids.html#cb79-41"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb79-42"><a href="asteroids.html#cb79-42"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb79-43"><a href="asteroids.html#cb79-43"></a></span>
<span id="cb79-44"><a href="asteroids.html#cb79-44"></a>  abcg<span class="op">::</span>glEnableVertexAttribArray<span class="op">(</span>positionAttribute<span class="op">);</span></span>
<span id="cb79-45"><a href="asteroids.html#cb79-45"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb79-46"><a href="asteroids.html#cb79-46"></a>  abcg<span class="op">::</span>glVertexAttribPointer<span class="op">(</span>positionAttribute<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> GL_FALSE<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb79-47"><a href="asteroids.html#cb79-47"></a>                              <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb79-48"><a href="asteroids.html#cb79-48"></a>  abcg<span class="op">::</span>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb79-49"><a href="asteroids.html#cb79-49"></a></span>
<span id="cb79-50"><a href="asteroids.html#cb79-50"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb79-51"><a href="asteroids.html#cb79-51"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb79-52"><a href="asteroids.html#cb79-52"></a><span class="op">}</span></span></code></pre></div>
<p>A lista de tiros é inicializada como vazia na linha 20. O restante do código é para criar o VBO que será compartilhado por todos os tiros. O VBO contém vértices de um polígono regular de 10 lados e usa o mesmo código que utilizamos no projeto <code>regularpolygons</code>.</p>
<p>A definição de <code>Bullets::paint</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb80" startFrom="54"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 53;"><span id="cb80-54"><a href="asteroids.html#cb80-54"></a><span class="dt">void</span> Bullets<span class="op">::</span>paint<span class="op">()</span> <span class="op">{</span></span>
<span id="cb80-55"><a href="asteroids.html#cb80-55"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="va">m_program</span><span class="op">);</span></span>
<span id="cb80-56"><a href="asteroids.html#cb80-56"></a></span>
<span id="cb80-57"><a href="asteroids.html#cb80-57"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb80-58"><a href="asteroids.html#cb80-58"></a>  abcg<span class="op">::</span>glUniform4f<span class="op">(</span><span class="va">m_colorLoc</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb80-59"><a href="asteroids.html#cb80-59"></a>  abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_rotationLoc</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb80-60"><a href="asteroids.html#cb80-60"></a>  abcg<span class="op">::</span>glUniform1f<span class="op">(</span><span class="va">m_scaleLoc</span><span class="op">,</span> <span class="va">m_scale</span><span class="op">);</span></span>
<span id="cb80-61"><a href="asteroids.html#cb80-61"></a></span>
<span id="cb80-62"><a href="asteroids.html#cb80-62"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>bullet <span class="op">:</span> <span class="va">m_bullets</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-63"><a href="asteroids.html#cb80-63"></a>    abcg<span class="op">::</span>glUniform2f<span class="op">(</span><span class="va">m_translationLoc</span><span class="op">,</span> bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x<span class="op">,</span></span>
<span id="cb80-64"><a href="asteroids.html#cb80-64"></a>                      bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y<span class="op">);</span></span>
<span id="cb80-65"><a href="asteroids.html#cb80-65"></a></span>
<span id="cb80-66"><a href="asteroids.html#cb80-66"></a>    abcg<span class="op">::</span>glDrawArrays<span class="op">(</span>GL_TRIANGLE_FAN<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb80-67"><a href="asteroids.html#cb80-67"></a>  <span class="op">}</span></span>
<span id="cb80-68"><a href="asteroids.html#cb80-68"></a></span>
<span id="cb80-69"><a href="asteroids.html#cb80-69"></a>  abcg<span class="op">::</span>glBindVertexArray<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb80-70"><a href="asteroids.html#cb80-70"></a></span>
<span id="cb80-71"><a href="asteroids.html#cb80-71"></a>  abcg<span class="op">::</span>glUseProgram<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb80-72"><a href="asteroids.html#cb80-72"></a><span class="op">}</span></span></code></pre></div>
<p>Todos os tiros têm a mesma cor (linha 58), ângulo de rotação (linha 59) e fator de escala (linha 60). A lista de tiros é iterada no laço das linhas 62 a 67. Cada tiro é renderizado como um <code>GL_TRIANGLE_FAN</code>.</p>
<p>Em <code>Bullets::destroy</code> é liberado o VBO e VAO:</p>
<div class="sourceCode" id="cb81" startFrom="74"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 73;"><span id="cb81-74"><a href="asteroids.html#cb81-74"></a><span class="dt">void</span> Bullets<span class="op">::</span>destroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb81-75"><a href="asteroids.html#cb81-75"></a>  abcg<span class="op">::</span>glDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VBO</span><span class="op">);</span></span>
<span id="cb81-76"><a href="asteroids.html#cb81-76"></a>  abcg<span class="op">::</span>glDeleteVertexArrays<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span><span class="va">m_VAO</span><span class="op">);</span></span>
<span id="cb81-77"><a href="asteroids.html#cb81-77"></a><span class="op">}</span></span></code></pre></div>
<p>Vamos agora à definição de <code>Bullets::update</code>:</p>
<div class="sourceCode" id="cb82" startFrom="79"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 78;"><span id="cb82-79"><a href="asteroids.html#cb82-79"></a><span class="dt">void</span> Bullets<span class="op">::</span>update<span class="op">(</span>Ship <span class="op">&amp;</span>ship<span class="op">,</span> <span class="at">const</span> GameData <span class="op">&amp;</span>gameData<span class="op">,</span> <span class="dt">float</span> deltaTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-80"><a href="asteroids.html#cb82-80"></a>  <span class="co">// Create a pair of bullets</span></span>
<span id="cb82-81"><a href="asteroids.html#cb82-81"></a>  <span class="cf">if</span> <span class="op">(</span>gameData<span class="op">.</span><span class="va">m_input</span><span class="op">[</span>gsl<span class="op">::</span>narrow<span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>Input<span class="op">::</span>Fire<span class="op">)]</span> <span class="op">&amp;&amp;</span></span>
<span id="cb82-82"><a href="asteroids.html#cb82-82"></a>      gameData<span class="op">.</span><span class="va">m_state</span> <span class="op">==</span> State<span class="op">::</span>Playing<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-83"><a href="asteroids.html#cb82-83"></a>    <span class="co">// At least 250 ms must have passed since the last bullets</span></span>
<span id="cb82-84"><a href="asteroids.html#cb82-84"></a>    <span class="cf">if</span> <span class="op">(</span>ship<span class="op">.</span><span class="va">m_bulletCoolDownTimer</span><span class="op">.</span>elapsed<span class="op">()</span> <span class="op">&gt;</span> <span class="fl">250.0</span> <span class="op">/</span> <span class="fl">1000.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-85"><a href="asteroids.html#cb82-85"></a>      ship<span class="op">.</span><span class="va">m_bulletCoolDownTimer</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb82-86"><a href="asteroids.html#cb82-86"></a></span>
<span id="cb82-87"><a href="asteroids.html#cb82-87"></a>      <span class="co">// Bullets are shot in the direction of the ship&#39;s forward vector</span></span>
<span id="cb82-88"><a href="asteroids.html#cb82-88"></a>      <span class="kw">auto</span> <span class="at">const</span> forward<span class="op">{</span>glm<span class="op">::</span>rotate<span class="op">(</span>glm<span class="op">::</span>vec2<span class="op">{</span><span class="fl">0.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">},</span> ship<span class="op">.</span><span class="va">m_rotation</span><span class="op">)};</span></span>
<span id="cb82-89"><a href="asteroids.html#cb82-89"></a>      <span class="kw">auto</span> <span class="at">const</span> right<span class="op">{</span>glm<span class="op">::</span>rotate<span class="op">(</span>glm<span class="op">::</span>vec2<span class="op">{</span><span class="fl">1.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">},</span> ship<span class="op">.</span><span class="va">m_rotation</span><span class="op">)};</span></span>
<span id="cb82-90"><a href="asteroids.html#cb82-90"></a>      <span class="kw">auto</span> <span class="at">const</span> cannonOffset<span class="op">{(</span><span class="fl">11.0</span><span class="bu">f</span> <span class="op">/</span> <span class="fl">15.5</span><span class="bu">f</span><span class="op">)</span> <span class="op">*</span> ship<span class="op">.</span><span class="va">m_scale</span><span class="op">};</span></span>
<span id="cb82-91"><a href="asteroids.html#cb82-91"></a>      <span class="kw">auto</span> <span class="at">const</span> bulletSpeed<span class="op">{</span><span class="fl">2.0</span><span class="bu">f</span><span class="op">};</span></span>
<span id="cb82-92"><a href="asteroids.html#cb82-92"></a></span>
<span id="cb82-93"><a href="asteroids.html#cb82-93"></a>      Bullet bullet<span class="op">{.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb82-94"><a href="asteroids.html#cb82-94"></a>                    <span class="op">.</span><span class="va">m_translation</span> <span class="op">=</span> ship<span class="op">.</span><span class="va">m_translation</span> <span class="op">+</span> right <span class="op">*</span> cannonOffset<span class="op">,</span></span>
<span id="cb82-95"><a href="asteroids.html#cb82-95"></a>                    <span class="op">.</span><span class="va">m_velocity</span> <span class="op">=</span> ship<span class="op">.</span><span class="va">m_velocity</span> <span class="op">+</span> forward <span class="op">*</span> bulletSpeed<span class="op">};</span></span>
<span id="cb82-96"><a href="asteroids.html#cb82-96"></a>      <span class="va">m_bullets</span><span class="op">.</span>push_back<span class="op">(</span>bullet<span class="op">);</span></span>
<span id="cb82-97"><a href="asteroids.html#cb82-97"></a></span>
<span id="cb82-98"><a href="asteroids.html#cb82-98"></a>      bullet<span class="op">.</span><span class="va">m_translation</span> <span class="op">=</span> ship<span class="op">.</span><span class="va">m_translation</span> <span class="op">-</span> right <span class="op">*</span> cannonOffset<span class="op">;</span></span>
<span id="cb82-99"><a href="asteroids.html#cb82-99"></a>      <span class="va">m_bullets</span><span class="op">.</span>push_back<span class="op">(</span>bullet<span class="op">);</span></span>
<span id="cb82-100"><a href="asteroids.html#cb82-100"></a></span>
<span id="cb82-101"><a href="asteroids.html#cb82-101"></a>      <span class="co">// Moves ship in the opposite direction</span></span>
<span id="cb82-102"><a href="asteroids.html#cb82-102"></a>      ship<span class="op">.</span><span class="va">m_velocity</span> <span class="op">-=</span> forward <span class="op">*</span> <span class="fl">0.1</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb82-103"><a href="asteroids.html#cb82-103"></a>    <span class="op">}</span></span>
<span id="cb82-104"><a href="asteroids.html#cb82-104"></a>  <span class="op">}</span></span>
<span id="cb82-105"><a href="asteroids.html#cb82-105"></a></span>
<span id="cb82-106"><a href="asteroids.html#cb82-106"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>bullet <span class="op">:</span> <span class="va">m_bullets</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-107"><a href="asteroids.html#cb82-107"></a>    bullet<span class="op">.</span><span class="va">m_translation</span> <span class="op">-=</span> ship<span class="op">.</span><span class="va">m_velocity</span> <span class="op">*</span> deltaTime<span class="op">;</span></span>
<span id="cb82-108"><a href="asteroids.html#cb82-108"></a>    bullet<span class="op">.</span><span class="va">m_translation</span> <span class="op">+=</span> bullet<span class="op">.</span><span class="va">m_velocity</span> <span class="op">*</span> deltaTime<span class="op">;</span></span>
<span id="cb82-109"><a href="asteroids.html#cb82-109"></a></span>
<span id="cb82-110"><a href="asteroids.html#cb82-110"></a>    <span class="co">// Kill bullet if it goes off screen</span></span>
<span id="cb82-111"><a href="asteroids.html#cb82-111"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.1</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb82-112"><a href="asteroids.html#cb82-112"></a>      bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-113"><a href="asteroids.html#cb82-113"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>x <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.1</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb82-114"><a href="asteroids.html#cb82-114"></a>      bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-115"><a href="asteroids.html#cb82-115"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.1</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb82-116"><a href="asteroids.html#cb82-116"></a>      bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-117"><a href="asteroids.html#cb82-117"></a>    <span class="cf">if</span> <span class="op">(</span>bullet<span class="op">.</span><span class="va">m_translation</span><span class="op">.</span>y <span class="op">&gt;</span> <span class="op">+</span><span class="fl">1.1</span><span class="bu">f</span><span class="op">)</span></span>
<span id="cb82-118"><a href="asteroids.html#cb82-118"></a>      bullet<span class="op">.</span><span class="va">m_dead</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-119"><a href="asteroids.html#cb82-119"></a>  <span class="op">}</span></span>
<span id="cb82-120"><a href="asteroids.html#cb82-120"></a></span>
<span id="cb82-121"><a href="asteroids.html#cb82-121"></a>  <span class="co">// Remove dead bullets</span></span>
<span id="cb82-122"><a href="asteroids.html#cb82-122"></a>  <span class="va">m_bullets</span><span class="op">.</span>remove_if<span class="op">([](</span><span class="kw">auto</span> <span class="at">const</span> <span class="op">&amp;</span>p<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> p<span class="op">.</span><span class="va">m_dead</span><span class="op">;</span> <span class="op">});</span></span>
<span id="cb82-123"><a href="asteroids.html#cb82-123"></a><span class="op">}</span></span></code></pre></div>
<p>Um par de tiros é criado a cada disparo. O temporizador <code>m_bulletCoolDownTimer</code> é utilizado para fazer com que os disparos ocorram em intervalos de no mínimo 250 milissegundos.</p>
<p>Observe, na linha 102, que subtraímos da velocidade da nave o vetor de direção dos tiros. Isso produz um efeito de recuo da nave. Quanto mais tiros são disparados, mais a nave será deslocada para trás.</p>
<p>Nas linhas 106 a 119 são atualizadas as coordenadas de translação de cada tiro.</p>
<p>Nas linhas 107 e 108, os tiros são atualizados de acordo com a velocidade da nave e a velocidade do próprio tiro.</p>
<p>Nas linhas 110 a 118, verificamos se o tiro saiu da tela. Se sim, o flag <code>m_dead</code> torna-se <code>true</code>. A comparação é feita com <code>-1.1f</code>/<code>+1.1f</code> no lugar de <code>-1.0f</code>/<code>+1.0f</code> para ter certeza que todo o polígono do tiro (e não só seu centro) saiu da tela.</p>
<p>Na linha 122, todos os tiros com <code>m_dead == true</code> são removidos da lista.</p>
<p>Isso é tudo! Eis o jogo completo (<a href="https://hbatagelo.github.io/abcgapps/asteroids/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="740"
  ></iframe>
<p>O código do projeto completo pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids4.zip">deste link</a>.</p>

</div>
</div>
</div>
<!-- </div> -->
<div class="footnotes">
<hr />
<ol start="5">
<li id="fn5"><p>As estrelas das camadas superiores se moverão mais rapidamente do que as estrelas das camadas inferiores, dando a sensação de profundidade do espaço.<a href="asteroids.html#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>O vetor é <span class="math inline">\((0, 1)\)</span> pois a nave está alinhada ao eixo <span class="math inline">\(y\)</span> positivo em sua orientação original.<a href="asteroids.html#fnref6" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="regularpolygons.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="referências.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toc_float": true,
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
