<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5.2 Asteroids | MCTA008-17 Computação Gráfica</title>
  <meta name="description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="5.2 Asteroids | MCTA008-17 Computação Gráfica" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  <meta name="github-repo" content="hbatagelo/cgbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5.2 Asteroids | MCTA008-17 Computação Gráfica" />
  
  <meta name="twitter:description" content="Notas de aula de MCTA008-17 Computação Gráfica da Universidade Federal do ABC" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="regularpolygons.html"/>
<link rel="next" href="geometry.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { font-weight: bold; } /* Alert */
code span.an { font-style: italic; } /* Annotation */
code span.cf { font-weight: bold; } /* ControlFlow */
code span.co { font-style: italic; } /* Comment */
code span.cv { font-style: italic; } /* CommentVar */
code span.do { font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.er { font-weight: bold; } /* Error */
code span.in { font-style: italic; } /* Information */
code span.kw { font-weight: bold; } /* Keyword */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.wa { font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Computação Gráfica</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Apresentação</a>
<ul>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html"><i class="fa fa-check"></i>Pré-requisitos</a>
<ul>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html#atividades-práticas"><i class="fa fa-check"></i>Atividades práticas</a></li>
<li class="chapter" data-level="" data-path="pré-requisitos.html"><a href="pré-requisitos.html#visualizando-este-site"><i class="fa fa-check"></i>Visualizando este site</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="config.html"><a href="config.html"><i class="fa fa-check"></i><b>1</b> Configuração do ambiente</a>
<ul>
<li class="chapter" data-level="1.1" data-path="linux.html"><a href="linux.html"><i class="fa fa-check"></i><b>1.1</b> Linux</a>
<ul>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#habilitando-o-opengl"><i class="fa fa-check"></i>Habilitando o OpenGL</a></li>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#atualizando-o-gcc"><i class="fa fa-check"></i>Atualizando o GCC</a></li>
<li class="chapter" data-level="" data-path="linux.html"><a href="linux.html#instalando-o-emscripten"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="macos.html"><a href="macos.html"><i class="fa fa-check"></i><b>1.2</b> macOS</a>
<ul>
<li class="chapter" data-level="" data-path="macos.html"><a href="macos.html#instalando-o-emscripten-1"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="windows.html"><a href="windows.html"><i class="fa fa-check"></i><b>1.3</b> Windows</a>
<ul>
<li class="chapter" data-level="" data-path="windows.html"><a href="windows.html#habilitando-o-opengl-1"><i class="fa fa-check"></i>Habilitando o OpenGL</a></li>
<li class="chapter" data-level="" data-path="windows.html"><a href="windows.html#instalando-o-emscripten-2"><i class="fa fa-check"></i>Instalando o Emscripten</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="vscode.html"><a href="vscode.html"><i class="fa fa-check"></i><b>1.4</b> Visual Studio Code</a></li>
<li class="chapter" data-level="1.5" data-path="abcg.html"><a href="abcg.html"><i class="fa fa-check"></i><b>1.5</b> ABCg</a>
<ul>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#instalação"><i class="fa fa-check"></i>Instalação</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-em-linha-de-comando"><i class="fa fa-check"></i>Compilando em linha de comando</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-no-visual-studio-code"><i class="fa fa-check"></i>Compilando no Visual Studio Code</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#depurando-no-visual-studio-code"><i class="fa fa-check"></i>Depurando no Visual Studio Code</a></li>
<li class="chapter" data-level="" data-path="abcg.html"><a href="abcg.html#compilando-para-webassembly"><i class="fa fa-check"></i>Compilando para WebAssembly</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introdução</a>
<ul>
<li class="chapter" data-level="2.1" data-path="áreas-correlatas.html"><a href="áreas-correlatas.html"><i class="fa fa-check"></i><b>2.1</b> Áreas correlatas</a></li>
<li class="chapter" data-level="2.2" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html"><i class="fa fa-check"></i><b>2.2</b> Linha do tempo</a>
<ul>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section"><i class="fa fa-check"></i>1950</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-1"><i class="fa fa-check"></i>1960</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-2"><i class="fa fa-check"></i>1970</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-3"><i class="fa fa-check"></i>1980</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-4"><i class="fa fa-check"></i>1990</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-5"><i class="fa fa-check"></i>2000</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-6"><i class="fa fa-check"></i>2010</a></li>
<li class="chapter" data-level="" data-path="linha-do-tempo.html"><a href="linha-do-tempo.html#section-7"><i class="fa fa-check"></i>2020</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="firstapp.html"><a href="firstapp.html"><i class="fa fa-check"></i><b>2.3</b> Primeiro programa</a>
<ul>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#configuração-inicial"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#main.cpp"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#openglwindow.hpp"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#openglwindow.cpp"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
<li class="chapter" data-level="" data-path="firstapp.html"><a href="firstapp.html#compilando-para-webassembly-1"><i class="fa fa-check"></i>Compilando para WebAssembly</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="graphicssystem.html"><a href="graphicssystem.html"><i class="fa fa-check"></i><b>3</b> Sistemas gráficos</a>
<ul>
<li class="chapter" data-level="3.1" data-path="vectorxraster.html"><a href="vectorxraster.html"><i class="fa fa-check"></i><b>3.1</b> Vetorial <em>x</em> matricial</a>
<ul>
<li class="chapter" data-level="" data-path="vectorxraster.html"><a href="vectorxraster.html#representação-vetorial"><i class="fa fa-check"></i>Representação vetorial</a></li>
<li class="chapter" data-level="" data-path="vectorxraster.html"><a href="vectorxraster.html#representação-matricial"><i class="fa fa-check"></i>Representação matricial</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="es.html"><a href="es.html"><i class="fa fa-check"></i><b>3.2</b> Dispositivos de E/S</a>
<ul>
<li class="chapter" data-level="" data-path="es.html"><a href="es.html#dispositivos-de-entrada"><i class="fa fa-check"></i>Dispositivos de entrada</a></li>
<li class="chapter" data-level="" data-path="es.html"><a href="es.html#dispositivos-de-saída"><i class="fa fa-check"></i>Dispositivos de saída</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="framebuffer.html"><a href="framebuffer.html"><i class="fa fa-check"></i><b>3.3</b> Framebuffer</a>
<ul>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#screen-tearing"><i class="fa fa-check"></i>Screen tearing</a></li>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#vsync"><i class="fa fa-check"></i>Vsync</a></li>
<li class="chapter" data-level="" data-path="framebuffer.html"><a href="framebuffer.html#backbuffering"><i class="fa fa-check"></i>Backbuffering</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sierpinski.html"><a href="sierpinski.html"><i class="fa fa-check"></i><b>3.4</b> Triângulo de Sierpinski</a>
<ul>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#configuração-inicial-1"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#main.cpp-1"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#openglwindow.hpp-1"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="sierpinski.html"><a href="sierpinski.html#openglwindow.cpp-1"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pipeline.html"><a href="pipeline.html"><i class="fa fa-check"></i><b>4</b> Pipeline gráfico</a>
<ul>
<li class="chapter" data-level="4.1" data-path="dados-gráficos.html"><a href="dados-gráficos.html"><i class="fa fa-check"></i><b>4.1</b> Dados gráficos</a></li>
<li class="chapter" data-level="4.2" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html"><i class="fa fa-check"></i><b>4.2</b> Ray casting <em>x</em> rasterização</a>
<ul>
<li class="chapter" data-level="" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html#ray-casting"><i class="fa fa-check"></i>Ray casting</a></li>
<li class="chapter" data-level="" data-path="ray-casting-x-rasterização.html"><a href="ray-casting-x-rasterização.html#rasterização"><i class="fa fa-check"></i>Rasterização</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="glpipeline.html"><a href="glpipeline.html"><i class="fa fa-check"></i><b>4.3</b> Pipeline do OpenGL</a>
<ul>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#aplicação"><i class="fa fa-check"></i>Aplicação</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#vertex-shader"><i class="fa fa-check"></i>Vertex shader</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#montagem-de-primitivas"><i class="fa fa-check"></i>Montagem de primitivas</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#recorte"><i class="fa fa-check"></i>Recorte</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#rasterização-1"><i class="fa fa-check"></i>Rasterização</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#fragment-shader"><i class="fa fa-check"></i>Fragment shader</a></li>
<li class="chapter" data-level="" data-path="glpipeline.html"><a href="glpipeline.html#operações-de-fragmentos"><i class="fa fa-check"></i>Operações de fragmentos</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="coloredtriangles.html"><a href="coloredtriangles.html"><i class="fa fa-check"></i><b>4.4</b> Triângulos coloridos</a>
<ul>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#configuração-inicial-2"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#main.cpp-2"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#openglwindow.hpp-2"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="coloredtriangles.html"><a href="coloredtriangles.html#openglwindow.cpp-2"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="game.html"><a href="game.html"><i class="fa fa-check"></i><b>5</b> Desenvolvendo um jogo 2D</a>
<ul>
<li class="chapter" data-level="5.1" data-path="regularpolygons.html"><a href="regularpolygons.html"><i class="fa fa-check"></i><b>5.1</b> Polígonos regulares</a>
<ul>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#configuração-inicial-3"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#main.cpp-3"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#openglwindow.hpp-3"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="regularpolygons.html"><a href="regularpolygons.html#openglwindow.cpp-3"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="asteroids.html"><a href="asteroids.html"><i class="fa fa-check"></i><b>5.2</b> Asteroids</a>
<ul>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#organização-do-projeto"><i class="fa fa-check"></i>Organização do projeto</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#configuração-inicial-4"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#nave"><i class="fa fa-check"></i>Nave</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#estrelas"><i class="fa fa-check"></i>Estrelas</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#asteroides"><i class="fa fa-check"></i>Asteroides</a></li>
<li class="chapter" data-level="" data-path="asteroids.html"><a href="asteroids.html#tiros-e-colisões"><i class="fa fa-check"></i>Tiros e colisões</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="geometry.html"><a href="geometry.html"><i class="fa fa-check"></i><b>6</b> Espaços e geometria</a>
<ul>
<li class="chapter" data-level="6.1" data-path="vector.html"><a href="vector.html"><i class="fa fa-check"></i><b>6.1</b> Espaço vetorial</a>
<ul>
<li class="chapter" data-level="" data-path="vector.html"><a href="vector.html#combinação-e-independência-linear"><i class="fa fa-check"></i>Combinação e independência linear</a></li>
<li class="chapter" data-level="" data-path="vector.html"><a href="vector.html#dimensão-e-base"><i class="fa fa-check"></i>Dimensão e base</a></li>
<li class="chapter" data-level="" data-path="vector.html"><a href="vector.html#vetores-geométricos"><i class="fa fa-check"></i>Vetores geométricos</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="affine.html"><a href="affine.html"><i class="fa fa-check"></i><b>6.2</b> Espaço afim</a>
<ul>
<li class="chapter" data-level="" data-path="affine.html"><a href="affine.html#combinação-afim"><i class="fa fa-check"></i>Combinação afim</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="euclidean.html"><a href="euclidean.html"><i class="fa fa-check"></i><b>6.3</b> Espaço euclidiano</a>
<ul>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#frames"><i class="fa fa-check"></i>Frames</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#produto-escalar"><i class="fa fa-check"></i>Produto escalar</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#ortogonalidade"><i class="fa fa-check"></i>Ortogonalidade</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#comprimento-e-distância"><i class="fa fa-check"></i>Comprimento e distância</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#normalização"><i class="fa fa-check"></i>Normalização</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#ângulo-entre-vetores"><i class="fa fa-check"></i>Ângulo entre vetores</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#projeção-ortogonal"><i class="fa fa-check"></i>Projeção ortogonal</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#produto-vetorial"><i class="fa fa-check"></i>Produto vetorial</a></li>
<li class="chapter" data-level="" data-path="euclidean.html"><a href="euclidean.html#vetor-normal"><i class="fa fa-check"></i>Vetor normal</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="objmodel.html"><a href="objmodel.html"><i class="fa fa-check"></i><b>6.4</b> Lendo um modelo 3D</a>
<ul>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#orientação-e-face-culling"><i class="fa fa-check"></i>Orientação e face culling</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#configuração-inicial-5"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#main.cpp-5"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#loadmodel.vert"><i class="fa fa-check"></i>loadmodel.vert</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#loadmodel.frag"><i class="fa fa-check"></i>loadmodel.frag</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#openglwindow.hpp-5"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="objmodel.html"><a href="objmodel.html#openglwindow.cpp-5"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="transformations.html"><a href="transformations.html"><i class="fa fa-check"></i><b>7</b> Matrizes e transformações</a>
<ul>
<li class="chapter" data-level="7.1" data-path="matrix.html"><a href="matrix.html"><i class="fa fa-check"></i><b>7.1</b> Matrizes</a>
<ul>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-transposta"><i class="fa fa-check"></i>Matriz transposta</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-quadrada"><i class="fa fa-check"></i>Matriz quadrada</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-linhacoluna"><i class="fa fa-check"></i>Matriz linha/coluna</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-identidade"><i class="fa fa-check"></i>Matriz identidade</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#operações"><i class="fa fa-check"></i>Operações</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-inversa"><i class="fa fa-check"></i>Matriz inversa</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#matriz-ortogonal"><i class="fa fa-check"></i>Matriz ortogonal</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#propriedades"><i class="fa fa-check"></i>Propriedades</a></li>
<li class="chapter" data-level="" data-path="matrix.html"><a href="matrix.html#transformação"><i class="fa fa-check"></i>Transformação</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="homogeneous.html"><a href="homogeneous.html"><i class="fa fa-check"></i><b>7.2</b> Coordenadas homogêneas</a></li>
<li class="chapter" data-level="7.3" data-path="concat.html"><a href="concat.html"><i class="fa fa-check"></i><b>7.3</b> Concatenação de transformações</a></li>
<li class="chapter" data-level="7.4" data-path="transforms.html"><a href="transforms.html"><i class="fa fa-check"></i><b>7.4</b> Transformações</a>
<ul>
<li class="chapter" data-level="" data-path="transforms.html"><a href="transforms.html#identidade"><i class="fa fa-check"></i>Identidade</a></li>
<li class="chapter" data-level="" data-path="transforms.html"><a href="transforms.html#translação"><i class="fa fa-check"></i>Translação</a></li>
<li class="chapter" data-level="" data-path="transforms.html"><a href="transforms.html#escala"><i class="fa fa-check"></i>Escala</a></li>
<li class="chapter" data-level="" data-path="transforms.html"><a href="transforms.html#rotação"><i class="fa fa-check"></i>Rotação</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="glspaces.html"><a href="glspaces.html"><i class="fa fa-check"></i><b>7.5</b> Espaços do OpenGL</a>
<ul>
<li class="chapter" data-level="" data-path="glspaces.html"><a href="glspaces.html#espaço-do-objeto"><i class="fa fa-check"></i>Espaço do objeto</a></li>
<li class="chapter" data-level="" data-path="glspaces.html"><a href="glspaces.html#espaço-do-mundo"><i class="fa fa-check"></i>Espaço do mundo</a></li>
<li class="chapter" data-level="" data-path="glspaces.html"><a href="glspaces.html#espaço-da-câmera"><i class="fa fa-check"></i>Espaço da câmera</a></li>
<li class="chapter" data-level="" data-path="glspaces.html"><a href="glspaces.html#concatenação-das-matrizes-de-modelo-e-visão"><i class="fa fa-check"></i>Concatenação das matrizes de modelo e visão</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="lookat.html"><a href="lookat.html"><i class="fa fa-check"></i><b>7.6</b> Câmera LookAt</a>
<ul>
<li class="chapter" data-level="" data-path="lookat.html"><a href="lookat.html#construindo-o-vetor-n"><i class="fa fa-check"></i>Construindo o vetor n</a></li>
<li class="chapter" data-level="" data-path="lookat.html"><a href="lookat.html#construindo-o-vetor-u"><i class="fa fa-check"></i>Construindo o vetor u</a></li>
<li class="chapter" data-level="" data-path="lookat.html"><a href="lookat.html#construindo-o-vetor-v"><i class="fa fa-check"></i>Construindo o vetor v</a></li>
<li class="chapter" data-level="" data-path="lookat.html"><a href="lookat.html#construindo-a-matriz-de-visão"><i class="fa fa-check"></i>Construindo a matriz de visão</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="lookatproject.html"><a href="lookatproject.html"><i class="fa fa-check"></i><b>7.7</b> LookAt na prática</a>
<ul>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#configuração-inicial-6"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#main.cpp-6"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#lookat.vert"><i class="fa fa-check"></i>lookat.vert</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#lookat.frag"><i class="fa fa-check"></i>lookat.frag</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#camera.hpp"><i class="fa fa-check"></i>camera.hpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#camera.cpp"><i class="fa fa-check"></i>camera.cpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#openglwindow.hpp-6"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#openglwindow.cpp-6"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#ground.hpp"><i class="fa fa-check"></i>ground.hpp</a></li>
<li class="chapter" data-level="" data-path="lookatproject.html"><a href="lookatproject.html#ground.cpp"><i class="fa fa-check"></i>ground.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="projections.html"><a href="projections.html"><i class="fa fa-check"></i><b>8</b> Projeções e trackball virtual</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ortho.html"><a href="ortho.html"><i class="fa fa-check"></i><b>8.1</b> Projeção ortográfica</a>
<ul>
<li class="chapter" data-level="" data-path="ortho.html"><a href="ortho.html#translação-1"><i class="fa fa-check"></i>Translação</a></li>
<li class="chapter" data-level="" data-path="ortho.html"><a href="ortho.html#escala-e-reflexão"><i class="fa fa-check"></i>Escala e reflexão</a></li>
<li class="chapter" data-level="" data-path="ortho.html"><a href="ortho.html#matriz-de-projeção"><i class="fa fa-check"></i>Matriz de projeção</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="perspective.html"><a href="perspective.html"><i class="fa fa-check"></i><b>8.2</b> Projeção perspectiva</a>
<ul>
<li class="chapter" data-level="" data-path="perspective.html"><a href="perspective.html#matriz-de-projeção-1"><i class="fa fa-check"></i>Matriz de projeção</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="vtrackball1.html"><a href="vtrackball1.html"><i class="fa fa-check"></i><b>8.3</b> Trackball virtual</a>
<ul>
<li class="chapter" data-level="" data-path="vtrackball1.html"><a href="vtrackball1.html#rotação-em-torno-de-um-eixo-arbitrário"><i class="fa fa-check"></i>Rotação em torno de um eixo arbitrário</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="viewer1.html"><a href="viewer1.html"><i class="fa fa-check"></i><b>8.4</b> Visualizador 3D</a>
<ul>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#configuração-inicial-7"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#main.cpp-7"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#depth.vert"><i class="fa fa-check"></i>depth.vert</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#depth.frag"><i class="fa fa-check"></i>depth.frag</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#model.hpp"><i class="fa fa-check"></i>model.hpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#model.cpp"><i class="fa fa-check"></i>model.cpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#trackball.hpp"><i class="fa fa-check"></i>trackball.hpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#trackball.cpp"><i class="fa fa-check"></i>trackball.cpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#openglwindow.hpp-7"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="viewer1.html"><a href="viewer1.html#openglwindow.cpp-7"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="starfield.html"><a href="starfield.html"><i class="fa fa-check"></i><b>8.5</b> Efeito starfield</a>
<ul>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#configuração-inicial-8"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#main.cpp-8"><i class="fa fa-check"></i>main.cpp</a></li>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#depth.vert-1"><i class="fa fa-check"></i>depth.vert</a></li>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#depth.frag-1"><i class="fa fa-check"></i>depth.frag</a></li>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#openglwindow.hpp-8"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="starfield.html"><a href="starfield.html#openglwindow.cpp-8"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="lighting.html"><a href="lighting.html"><i class="fa fa-check"></i><b>9</b> Iluminação</a>
<ul>
<li class="chapter" data-level="9.1" data-path="renderingequation.html"><a href="renderingequation.html"><i class="fa fa-check"></i><b>9.1</b> Equação de renderização</a></li>
<li class="chapter" data-level="9.2" data-path="phongmodel.html"><a href="phongmodel.html"><i class="fa fa-check"></i><b>9.2</b> Modelo de reflexão de Phong</a>
<ul>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#reflexão-ambiente"><i class="fa fa-check"></i>Reflexão ambiente</a></li>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#reflexão-difusa"><i class="fa fa-check"></i>Reflexão difusa</a></li>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#reflexão-especular"><i class="fa fa-check"></i>Reflexão especular</a></li>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#modelo-completo"><i class="fa fa-check"></i>Modelo completo</a></li>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#iluminação-colorida"><i class="fa fa-check"></i>Iluminação colorida</a></li>
<li class="chapter" data-level="" data-path="phongmodel.html"><a href="phongmodel.html#fontes-de-luz"><i class="fa fa-check"></i>Fontes de luz</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="blinnphongmodel.html"><a href="blinnphongmodel.html"><i class="fa fa-check"></i><b>9.3</b> Modelo de Blinn–Phong</a></li>
<li class="chapter" data-level="9.4" data-path="shading.html"><a href="shading.html"><i class="fa fa-check"></i><b>9.4</b> Sombreamento</a>
<ul>
<li class="chapter" data-level="" data-path="shading.html"><a href="shading.html#flat"><i class="fa fa-check"></i>Flat</a></li>
<li class="chapter" data-level="" data-path="shading.html"><a href="shading.html#gouraud"><i class="fa fa-check"></i>Gouraud</a></li>
<li class="chapter" data-level="" data-path="shading.html"><a href="shading.html#phong"><i class="fa fa-check"></i>Phong</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="viewer2.html"><a href="viewer2.html"><i class="fa fa-check"></i><b>9.5</b> Normais como cores</a>
<ul>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#configuração-inicial-9"><i class="fa fa-check"></i>Configuração inicial</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#model.hpp-1"><i class="fa fa-check"></i>model.hpp</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#model.cpp-1"><i class="fa fa-check"></i>model.cpp</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#openglwindow.hpp-9"><i class="fa fa-check"></i>openglwindow.hpp</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#openglwindow.cpp-9"><i class="fa fa-check"></i>openglwindow.cpp</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#normal.frag"><i class="fa fa-check"></i>normal.frag</a></li>
<li class="chapter" data-level="" data-path="viewer2.html"><a href="viewer2.html#normal.vert"><i class="fa fa-check"></i>normal.vert</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="viewer3.html"><a href="viewer3.html"><i class="fa fa-check"></i><b>9.6</b> Iluminação na prática</a>
<ul>
<li class="chapter" data-level="" data-path="viewer3.html"><a href="viewer3.html#phong-com-sombreamento-de-gouraud"><i class="fa fa-check"></i>Phong com sombreamento de Gouraud</a></li>
<li class="chapter" data-level="" data-path="viewer3.html"><a href="viewer3.html#phong-com-sombreamento-de-phong"><i class="fa fa-check"></i>Phong com sombreamento de Phong</a></li>
<li class="chapter" data-level="" data-path="viewer3.html"><a href="viewer3.html#blinn-phong-com-sombreamento-de-phong"><i class="fa fa-check"></i>Blinn-Phong com sombreamento de Phong</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="texturing.html"><a href="texturing.html"><i class="fa fa-check"></i><b>10</b> Texturização</a>
<ul>
<li class="chapter" data-level="10.1" data-path="texmapping.html"><a href="texmapping.html"><i class="fa fa-check"></i><b>10.1</b> Mapeamento</a>
<ul>
<li class="chapter" data-level="" data-path="texmapping.html"><a href="texmapping.html#mapeamento-planar"><i class="fa fa-check"></i>Mapeamento planar</a></li>
<li class="chapter" data-level="" data-path="texmapping.html"><a href="texmapping.html#mapeamento-cilíndrico"><i class="fa fa-check"></i>Mapeamento cilíndrico</a></li>
<li class="chapter" data-level="" data-path="texmapping.html"><a href="texmapping.html#mapeamento-esférico"><i class="fa fa-check"></i>Mapeamento esférico</a></li>
<li class="chapter" data-level="" data-path="texmapping.html"><a href="texmapping.html#mapeamento-uv-unwrap"><i class="fa fa-check"></i>Mapeamento UV unwrap</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="texwrapping.html"><a href="texwrapping.html"><i class="fa fa-check"></i><b>10.2</b> Empacotamento</a></li>
<li class="chapter" data-level="10.3" data-path="texfiltering.html"><a href="texfiltering.html"><i class="fa fa-check"></i><b>10.3</b> Filtragem</a>
<ul>
<li class="chapter" data-level="" data-path="texfiltering.html"><a href="texfiltering.html#magnificação"><i class="fa fa-check"></i>Magnificação</a></li>
<li class="chapter" data-level="" data-path="texfiltering.html"><a href="texfiltering.html#minificação"><i class="fa fa-check"></i>Minificação</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="viewer4.html"><a href="viewer4.html"><i class="fa fa-check"></i><b>10.4</b> Texturização na prática</a>
<ul>
<li class="chapter" data-level="" data-path="viewer4.html"><a href="viewer4.html#carregando-texturas"><i class="fa fa-check"></i>Carregando texturas</a></li>
<li class="chapter" data-level="" data-path="viewer4.html"><a href="viewer4.html#carregando-modelos-com-textura"><i class="fa fa-check"></i>Carregando modelos com textura</a></li>
<li class="chapter" data-level="" data-path="viewer4.html"><a href="viewer4.html#renderizando"><i class="fa fa-check"></i>Renderizando</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="normalmapping.html"><a href="normalmapping.html"><i class="fa fa-check"></i><b>10.5</b> Mapeamento de normais</a>
<ul>
<li class="chapter" data-level="" data-path="normalmapping.html"><a href="normalmapping.html#espaço-tangente"><i class="fa fa-check"></i>Espaço tangente</a></li>
<li class="chapter" data-level="" data-path="normalmapping.html"><a href="normalmapping.html#transformação-para-o-espaço-tangente"><i class="fa fa-check"></i>Transformação para o espaço tangente</a></li>
<li class="chapter" data-level="" data-path="normalmapping.html"><a href="normalmapping.html#vetor-tangente-e-bitangente"><i class="fa fa-check"></i>Vetor tangente e bitangente</a></li>
<li class="chapter" data-level="" data-path="normalmapping.html"><a href="normalmapping.html#mapeamento-de-normais-na-prática"><i class="fa fa-check"></i>Mapeamento de normais na prática</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="referências.html"><a href="referências.html"><i class="fa fa-check"></i>Referências</a></li>
<li class="divider"></li>
<li>
<a href="mailto:harlen.batagelo@ufabc.edu.br" target="blank">Harlen Batagelo</a>
<a href="mailto:bruno.marques@ufabc.edu.br" target="blank">Bruno Marques</a>
<br>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MCTA008-17 Computação Gráfica</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="asteroids" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Asteroids</h2>
<p>A cena de nosso Asteroids será composta pelos seguintes objetos:</p>
<ul>
<li>Uma nave espacial, formada por <code>GL_TRIANGLES</code>;</li>
<li>Asteroides, formados por <code>GL_TRIANGLE_FAN</code>;</li>
<li>Tiros, formados por <code>GL_TRIANGLE_FAN</code>;</li>
<li>Estrelas de fundo, formadas por <code>GL_POINTS</code>.</li>
</ul>
<p>Como nas aplicações feitas até agora, trabalharemos somente com gráficos 2D. As coordenadas de todos os objetos do jogo serão especificadas no chamado NDC (espaço normalizado do dispositivo). Como vimos na seção <a href="glpipeline.html#glpipeline">4.3</a>, para que as primitivas sejam renderizadas, as coordenadas em NDC devem estar dentro do <em>volume de visão canônico</em>, que é um cubo de <span class="math inline">\((-1, -1, -1)\)</span> a <span class="math inline">\((1, 1, 1)\)</span>. Também vimos que coordenadas em NDC são mapeadas para o espaço da janela, de modo que o ponto <span class="math inline">\((-1,-1)\)</span> é mapeado para o canto inferior esquerdo do viewport, e <span class="math inline">\((1,1)\)</span> é mapeado para o canto superior direito, de acordo com o especificado em <code>glViewport</code>. A figura <a href="asteroids.html#fig:asteroids1">5.5</a> ilustra o posicionamento de objetos da cena recortados pela região visível do NDC.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:asteroids1"></span>
<img src="images/05_asteroids1.svg" alt="Objetos de cena na região visível do NDC." width="60%" />
<p class="caption">
Figura 5.5: Objetos de cena na região visível do NDC.
</p>
</div>
<p>No jogo Asteroids original, a nave se movimenta pela tela enquanto a câmera virtual permanece fixa. Quando a nave sai dos limites da tela, reaparece no lado oposto. No nosso projeto, a nave se manterá fixa no centro da tela, enquanto todo o resto se moverá ao seu redor. O espaço será finito como no Asteroids original, e terá o tamanho da região que vai de <span class="math inline">\((-1,-1)\)</span> a <span class="math inline">\((1,1)\)</span>. Se um asteroide sair do lado esquerdo da tela, reaparecerá no lado direito (observe que isso acontece na figura <a href="asteroids.html#fig:asteroids1">5.5</a>).</p>
<p>Um truque simples para obter o efeito de replicação do espaço é renderizar a cena nove vezes, uma vez para célula de uma grade 3x3 na qual apenas a célula do meio corresponde à região de <span class="math inline">\((-1,-1)\)</span> a <span class="math inline">\((1,1)\)</span>. Isso é ilustrado na figura <a href="asteroids.html#fig:asteroids2">5.6</a>:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:asteroids2"></span>
<img src="images/05_asteroids2.svg" alt="Replicando a cena em torno da região visível do NDC." width="100%" />
<p class="caption">
Figura 5.6: Replicando a cena em torno da região visível do NDC.
</p>
</div>
<p>Não é necessário replicar os objetos que não saem da tela, como a nave. No nosso caso, os tiros também não serão replicados e deixarão de existir assim que saírem da tela.</p>
<p>Embora esse truque de replicação de cena funcione bem para este jogo simples, em cenas mais complexas é recomendável fazer testes de proximidade para descartar os objetos que estão fora da área visível. Isso evita processamento desnecessário no pipeline gráfico.</p>
<div id="organização-do-projeto" class="section level3 unnumbered">
<h3>Organização do projeto</h3>
<p>Nosso jogo possui vários objetos de cena, e portanto possui vários VBOs, VAOs e variáveis de propriedades desses objetos. Precisamos pensar bem em como organizar tudo isso. O código pode ficar bastante confuso se definirmos tudo na classe <code>OpenGLWindow</code> como fizemos nos projetos anteriores.</p>
<div id="classes" class="section level4 unnumbered">
<h4>Classes</h4>
<p>Para organizar melhor o projeto, separaremos os elementos de cena do jogo nas seguintes classes:</p>
<ul>
<li><p><code>Ship</code>: classe que representa a nave espacial (VAO, VBO e atributos como translação, orientação e velocidade).</p></li>
<li><p><code>StarLayers</code>: classe que gerencia as camadas de estrelas usadas para fazer o efeito de paralaxe<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a> de fundo. <code>StarLayers</code> contém um arranjo de objetos do tipo <code>StarLayer</code>, sendo que cada <code>StarLayer</code> define o VBO de pontos de uma camada de estrelas.</p></li>
<li><p><code>Bullets</code>: classe que gerencia os tiros. A classe contém uma lista de instâncias de uma estrutura <code>Bullet</code>, sendo que cada <code>Bullet</code> representa as propriedades de um tiro (translação, velocidade, etc). Todos os tiros compartilham um mesmo VBO definido em <code>Bullets</code>.</p></li>
<li><p><code>Asteroids</code>: classe que gerencia os asteroides. <code>Asteroids</code> contém uma lista de instâncias de uma estrutura <code>Asteroid</code>, sendo que cada <code>Asteroid</code> define o VBO e propriedades de um asteroide.</p></li>
</ul>
<p>As classes <code>Ship</code>, <code>StarLayers</code>, <code>Bullets</code> e <code>Asteroids</code> contêm suas próprias funções membro <code>initializeGL</code>, <code>paintGL</code> e <code>terminateGL</code> que serão chamadas nas funções membro respectivas de <code>OpenGLWindow</code>.</p>
<p>Definiremos também uma classe <code>GameData</code> para permitir o compartilhamento de dados de estado do jogo entre <code>OpenGLWindow</code> e as outras classes.</p>
</div>
<div id="arquivos" class="section level4 unnumbered">
<h4>Arquivos</h4>
<p>O diretório de projeto <code>abcg/examples/asteroids</code> terá a seguinte estrutura:</p>
<pre><code>asteroids/
│   asteroids.cpp
│   asteroids.hpp
│   bullets.cpp
│   bullets.hpp
│   CMakeLists.txt
│   gamedata.hpp
│   main.cpp
│   openglwindow.hpp
│   openglwindow.cpp
│   ship.cpp
│   ship.hpp
│   starlayers.cpp
│   starlayers.hpp
│
└───assets/
    │   Inconsolata-Medium.ttf
    │   objects.frag
    │   objects.vert    
    │   stars.frag
    └   stars.vert    </code></pre>
<p>O subdiretório <code>assets</code> contém arquivos de recursos utilizados no jogo:</p>
<ul>
<li>O arquivo <code>Inconsolata-Medium.ttf</code> é a fonte <a href="https://levien.com/type/myfonts/inconsolata.html">Inconsolata</a> utilizada na mensagem “Game Over” e “You Win.” O arquivo pode ser <a href="https://github.com/google/fonts/tree/main/ofl/inconsolata">baixado</a> ou copiado de <code>abcg/abcg/assets</code> (ou substitua por sua fonte favorita!).</li>
<li>Os arquivos <code>stars.vert</code> e <code>stars.frag</code> contêm o código-fonte do vertex shader e fragment shader utilizados para renderizar as estrelas.</li>
<li>Os arquivos <code>objects.vert</code> e <code>objects.frag</code> contêm o código-fonte do vertex shader e fragment shader utilizados em todos os outros objetos: nave, asteroides e tiros.</li>
</ul>
<p>Poderíamos continuar definindo os shaders através de strings, mas o projeto fica mais organizado desta nova forma.</p>
<div class="notebox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#1f5386;overflow:visible;position:relative;"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>
<div class="noteboxtitle">
Importante
</div>
<p>Sempre que um projeto da ABCg é configurado pelo CMake, o diretório <code>assets</code> (se existir) é copiado para <code>build/bin/proj</code>, onde <code>proj</code> é o nome do projeto.</p>
<p>Em todas as vezes que um arquivo de <code>assets</code> for modificado, é necessário limpar o diretório <code>build</code> para forçar a cópia de <code>assets</code> para <code>build/bin/proj</code> na próxima compilação. Isso pode ser feito das seguintes maneiras:</p>
<ul>
<li>Removendo o diretório <code>build</code> antes da compilação;</li>
<li>No Visual Studio Code, usando o comando “CMake: Clean Rebuild” da paleta de comandos (<code>Ctrl+Shift+P</code>) antes da compilação;</li>
<li>Construindo o projeto através de <code>build.sh</code>/<code>build.bat</code>.</li>
</ul>
<p>Se você precisar editar um shader várias vezes, deixe-o como uma string como fizemos nos projetos anteriores. Transforme-o em um asset apenas quando o shader estiver pronto e não for mais editado.</p>
</div>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Quando o projeto é compilado para WebAssembly, o conteúdo de <code>assets</code> é transformado em um arquivo <code>.data</code> no diretório <code>public</code>. Assim, os arquivos resultantes de um projeto chamado <code>proj</code> serão:</p>
<ul>
<li><code>proj.data</code>: arquivo de recursos (assets);</li>
<li><code>proj.js</code>: arquivo JavaScript que deve ser chamado pelo html;</li>
<li><code>proj.wasm</code>: binário WebAssembly.</li>
</ul>
</div>
</div>
</div>
<div id="configuração-inicial-4" class="section level3 unnumbered">
<h3>Configuração inicial</h3>
<ol style="list-style-type: decimal">
<li><p>Em <code>abcg/examples</code>, crie o subdiretório <code>asteroids</code>.</p></li>
<li><p>No arquivo <code>abcg/examples/CMakeLists.txt</code>, inclua a linha <code>add_subdirectory(asteroids)</code>.</p></li>
<li><p>Crie o arquivo <code>abcg/examples/asteroids/CMakeLists.txt</code> com o seguinte conteúdo:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb155-1"><a href="asteroids.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">project</span>(asteroids)</span>
<span id="cb155-2"><a href="asteroids.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="kw">add_executable</span>(<span class="dv">${PROJECT_NAME}</span> main.cpp openglwindow.cpp asteroids.cpp</span>
<span id="cb155-3"><a href="asteroids.html#cb155-3" aria-hidden="true" tabindex="-1"></a>                               bullets.cpp ship.cpp starlayers.cpp)</span>
<span id="cb155-4"><a href="asteroids.html#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="fu">enable_abcg</span>(<span class="dv">${PROJECT_NAME}</span>)</span></code></pre></div></li>
<li><p>Crie todos os arquivos <code>.cpp</code> e <code>.hpp</code> (de <code>asteroids.cpp</code> até <code>starlayers.cpp</code>). Por enquanto os arquivos ficarão vazios.</p></li>
<li><p>Crie o subdiretório <code>assets</code> e baixe/copie a fonte <code>.ttf</code>. Crie também os arquivos <code>.frag</code> e <code>.vert</code>. Vamos editá-los em seguida.</p></li>
</ol>
<div id="main.cpp-4" class="section level4 unnumbered">
<h4>main.cpp</h4>
<p>Não há nada de realmente novo no conteúdo de <code>main.cpp</code>. Apenas desativaremos o contador de FPS e o botão de tela cheia. O código ficará assim:</p>
<div class="sourceCode" id="cb156" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb156-1"><a href="asteroids.html#cb156-1"></a><span class="pp">#include </span><span class="im">&lt;fmt/core.h&gt;</span></span>
<span id="cb156-2"><a href="asteroids.html#cb156-2"></a></span>
<span id="cb156-3"><a href="asteroids.html#cb156-3"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb156-4"><a href="asteroids.html#cb156-4"></a><span class="pp">#include </span><span class="im">&quot;openglwindow.hpp&quot;</span></span>
<span id="cb156-5"><a href="asteroids.html#cb156-5"></a></span>
<span id="cb156-6"><a href="asteroids.html#cb156-6"></a><span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">char</span> **argv) {</span>
<span id="cb156-7"><a href="asteroids.html#cb156-7"></a>  <span class="cf">try</span> {</span>
<span id="cb156-8"><a href="asteroids.html#cb156-8"></a>    abcg::Application app(argc, argv);</span>
<span id="cb156-9"><a href="asteroids.html#cb156-9"></a></span>
<span id="cb156-10"><a href="asteroids.html#cb156-10"></a>    <span class="kw">auto</span> window{<span class="bu">std::</span>make_unique&lt;OpenGLWindow&gt;()};</span>
<span id="cb156-11"><a href="asteroids.html#cb156-11"></a>    window-&gt;setOpenGLSettings({.samples = <span class="dv">4</span>});</span>
<span id="cb156-12"><a href="asteroids.html#cb156-12"></a>    window-&gt;setWindowSettings({.width = <span class="dv">600</span>,</span>
<span id="cb156-13"><a href="asteroids.html#cb156-13"></a>                               .height = <span class="dv">600</span>,</span>
<span id="cb156-14"><a href="asteroids.html#cb156-14"></a>                               .showFPS = <span class="kw">false</span>,</span>
<span id="cb156-15"><a href="asteroids.html#cb156-15"></a>                               .showFullscreenButton = <span class="kw">false</span>,</span>
<span id="cb156-16"><a href="asteroids.html#cb156-16"></a>                               .title = <span class="st">&quot;Asteroids&quot;</span>});</span>
<span id="cb156-17"><a href="asteroids.html#cb156-17"></a>    app.run(<span class="bu">std::</span>move(window));</span>
<span id="cb156-18"><a href="asteroids.html#cb156-18"></a>  } <span class="cf">catch</span> (<span class="at">const</span> abcg::Exception &amp;exception) {</span>
<span id="cb156-19"><a href="asteroids.html#cb156-19"></a>    fmt::print(stderr, <span class="st">&quot;</span><span class="sc">{}\n</span><span class="st">&quot;</span>, exception.what());</span>
<span id="cb156-20"><a href="asteroids.html#cb156-20"></a>    <span class="cf">return</span> -<span class="dv">1</span>;</span>
<span id="cb156-21"><a href="asteroids.html#cb156-21"></a>  }</span>
<span id="cb156-22"><a href="asteroids.html#cb156-22"></a>  <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb156-23"><a href="asteroids.html#cb156-23"></a>}</span></code></pre></div>
</div>
<div id="gamedata.hpp" class="section level4 unnumbered">
<h4>gamedata.hpp</h4>
<p>Neste arquivo definiremos uma estrutura <code>GameData</code> que descreve o estado atual do jogo e o estado dos dispositivos de entrada:</p>
<div class="sourceCode" id="cb157" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb157-1"><a href="asteroids.html#cb157-1"></a><span class="pp">#ifndef GAMEDATA_HPP_</span></span>
<span id="cb157-2"><a href="asteroids.html#cb157-2"></a><span class="pp">#define GAMEDATA_HPP_</span></span>
<span id="cb157-3"><a href="asteroids.html#cb157-3"></a></span>
<span id="cb157-4"><a href="asteroids.html#cb157-4"></a><span class="pp">#include </span><span class="im">&lt;bitset&gt;</span></span>
<span id="cb157-5"><a href="asteroids.html#cb157-5"></a></span>
<span id="cb157-6"><a href="asteroids.html#cb157-6"></a><span class="kw">enum</span> <span class="kw">class</span> Input { Right, Left, Down, Up, Fire };</span>
<span id="cb157-7"><a href="asteroids.html#cb157-7"></a><span class="kw">enum</span> <span class="kw">class</span> State { Playing, GameOver, Win };</span>
<span id="cb157-8"><a href="asteroids.html#cb157-8"></a></span>
<span id="cb157-9"><a href="asteroids.html#cb157-9"></a><span class="kw">struct</span> GameData {</span>
<span id="cb157-10"><a href="asteroids.html#cb157-10"></a>  State <span class="va">m_state</span>{State::Playing};</span>
<span id="cb157-11"><a href="asteroids.html#cb157-11"></a>  <span class="bu">std::</span>bitset&lt;<span class="dv">5</span>&gt; <span class="va">m_input</span>;  <span class="co">// [fire, up, down, left, right]</span></span>
<span id="cb157-12"><a href="asteroids.html#cb157-12"></a>};</span>
<span id="cb157-13"><a href="asteroids.html#cb157-13"></a></span>
<span id="cb157-14"><a href="asteroids.html#cb157-14"></a><span class="pp">#endif</span></span></code></pre></div>
<ul>
<li><code>m_state</code> pode ser:
<ul>
<li><code>State::Playing</code>: quando a aplicação está em modo de jogo, com a nave respondendo aos comandos do jogador;</li>
<li><code>State::GameOver</code>: quando o jogador perdeu. Nesse caso a nave não é exibida e não responde aos comandos do jogador;</li>
<li><code>State::Win</code>: quando o jogador ganhou. A nave também não é exibida nesse estado.</li>
</ul></li>
<li><code>m_input</code> é uma máscara de bits de eventos de estado dos dispositivos de entrada. Por exemplo, o bit 0 corresponde a <code>Input::Right</code> e está setado enquando o usuário pressiona a seta para a direita, ou a tecla <code>D</code>. Esse estado é atualizado pela função membro <code>OpenGLWindow::handleEvent</code> que veremos adiante.</li>
</ul>
<p>A classe <code>OpenGLWindow</code> manterá uma instância de <code>GameData</code> que será compartilhada com outras classes (<code>Ship</code>, <code>Bullets</code>, <code>Asteroids</code>, etc) sempre que elas precisarem ler ou modificar o estado do jogo.</p>
</div>
<div id="objects.vert" class="section level4 unnumbered">
<h4>objects.vert</h4>
<p>Esse é o shader utilizado na renderização da nave, asteroides e tiros. O conteúdo será como a seguir:</p>
<div class="sourceCode" id="cb158" startFrom="1"><pre class="sourceCode numberSource glsl numberLines"><code class="sourceCode glsl"><span id="cb158-1"><a href="asteroids.html#cb158-1"></a><span class="pp">#version 410</span></span>
<span id="cb158-2"><a href="asteroids.html#cb158-2"></a></span>
<span id="cb158-3"><a href="asteroids.html#cb158-3"></a><span class="kw">layout</span>(<span class="dt">location</span> = <span class="dv">0</span>) <span class="dt">in</span> <span class="dt">vec2</span> inPosition;</span>
<span id="cb158-4"><a href="asteroids.html#cb158-4"></a></span>
<span id="cb158-5"><a href="asteroids.html#cb158-5"></a><span class="kw">uniform</span> <span class="dt">vec4</span> color;</span>
<span id="cb158-6"><a href="asteroids.html#cb158-6"></a><span class="kw">uniform</span> <span class="dt">float</span> rotation;</span>
<span id="cb158-7"><a href="asteroids.html#cb158-7"></a><span class="kw">uniform</span> <span class="dt">float</span> scale;</span>
<span id="cb158-8"><a href="asteroids.html#cb158-8"></a><span class="kw">uniform</span> <span class="dt">vec2</span> translation;</span>
<span id="cb158-9"><a href="asteroids.html#cb158-9"></a></span>
<span id="cb158-10"><a href="asteroids.html#cb158-10"></a><span class="dt">out</span> <span class="dt">vec4</span> fragColor;</span>
<span id="cb158-11"><a href="asteroids.html#cb158-11"></a></span>
<span id="cb158-12"><a href="asteroids.html#cb158-12"></a><span class="dt">void</span> <span class="fu">main</span>() {</span>
<span id="cb158-13"><a href="asteroids.html#cb158-13"></a>  <span class="dt">float</span> sinAngle = <span class="bu">sin</span>(rotation);</span>
<span id="cb158-14"><a href="asteroids.html#cb158-14"></a>  <span class="dt">float</span> cosAngle = <span class="bu">cos</span>(rotation);</span>
<span id="cb158-15"><a href="asteroids.html#cb158-15"></a>  <span class="dt">vec2</span> rotated = <span class="dt">vec2</span>(inPosition.<span class="fu">x</span> * cosAngle - inPosition.<span class="fu">y</span> * sinAngle,</span>
<span id="cb158-16"><a href="asteroids.html#cb158-16"></a>                      inPosition.<span class="fu">x</span> * sinAngle + inPosition.<span class="fu">y</span> * cosAngle);</span>
<span id="cb158-17"><a href="asteroids.html#cb158-17"></a></span>
<span id="cb158-18"><a href="asteroids.html#cb158-18"></a>  <span class="dt">vec2</span> newPosition = rotated * scale + translation;</span>
<span id="cb158-19"><a href="asteroids.html#cb158-19"></a>  <span class="bu">gl_Position</span> = <span class="dt">vec4</span>(newPosition, <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb158-20"><a href="asteroids.html#cb158-20"></a>  fragColor = color;</span>
<span id="cb158-21"><a href="asteroids.html#cb158-21"></a>}</span></code></pre></div>
<p>Observe que os vértices só possuem um atributo <code>inPosition</code> do tipo <code>vec2</code>. Esse atributo corresponde à posição <span class="math inline">\((x,y)\)</span> do vértice. A saída do vertex shader é uma cor RGBA definida pela variável uniforme <code>color</code>. Isso significa que, usando esse shader, todos os vértices terão a mesma cor.</p>
<p>O código de <code>main</code> é similar ao do vertex shader do projeto <code>regularpolygons</code>, mas dessa vez a posição é modificada não apenas por um fator de escala e translação, mas também por uma rotação. As linhas 13 a 16 fazem com que a posição <code>inPosition</code> seja rodada pelo ângulo <code>rotation</code> (em radianos) no sentido anti-horário. O resultado é uma nova posição <code>rotated</code> que é então transformada pela escala e translação.</p>
<p>Em capítulos futuros, veremos a teoria das transformações geométricas e os passos necessários para se chegar à expressão das linhas 15 e 16.</p>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>Todos os objetos do jogo são desenhados em tons de cinza, mas não há nada nos shaders que impeça que utilizemos cores. O aspecto preto e branco do jogo é só uma escolha artística para lembrar o antigo Asteroids do arcade.</p>
</div>
</div>
<div id="objects.frag" class="section level4 unnumbered">
<h4>objects.frag</h4>
<p>O conteúdo desse fragment shader que acompanha <code>objects.vert</code> é o mesmo dos projetos anteriores. A cor de entrada é copiada para a cor de saída:</p>
<div class="sourceCode" id="cb159" startFrom="1"><pre class="sourceCode numberSource glsl numberLines"><code class="sourceCode glsl"><span id="cb159-1"><a href="asteroids.html#cb159-1"></a><span class="pp">#version 410</span></span>
<span id="cb159-2"><a href="asteroids.html#cb159-2"></a></span>
<span id="cb159-3"><a href="asteroids.html#cb159-3"></a><span class="dt">in</span> <span class="dt">vec4</span> fragColor;</span>
<span id="cb159-4"><a href="asteroids.html#cb159-4"></a></span>
<span id="cb159-5"><a href="asteroids.html#cb159-5"></a><span class="dt">out</span> <span class="dt">vec4</span> outColor;</span>
<span id="cb159-6"><a href="asteroids.html#cb159-6"></a></span>
<span id="cb159-7"><a href="asteroids.html#cb159-7"></a><span class="dt">void</span> <span class="fu">main</span>() { outColor = fragColor; }</span></code></pre></div>
</div>
</div>
<div id="nave" class="section level3 unnumbered">
<h3>Nave</h3>
<p>Para simplificar, faremos primeiramente o código para renderizar e animar a nave. Em seguida incluiremos o código das estrelas, asteroides, e por fim os tiros e a detecção de colisões.</p>
<div id="openglwindow.hpp-4" class="section level4 unnumbered">
<h4>openglwindow.hpp</h4>
<p>O conteúdo de <code>openglwindow.hpp</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb160" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb160-1"><a href="asteroids.html#cb160-1"></a><span class="pp">#ifndef OPENGLWINDOW_HPP_</span></span>
<span id="cb160-2"><a href="asteroids.html#cb160-2"></a><span class="pp">#define OPENGLWINDOW_HPP_</span></span>
<span id="cb160-3"><a href="asteroids.html#cb160-3"></a></span>
<span id="cb160-4"><a href="asteroids.html#cb160-4"></a><span class="pp">#include </span><span class="im">&lt;imgui.h&gt;</span></span>
<span id="cb160-5"><a href="asteroids.html#cb160-5"></a></span>
<span id="cb160-6"><a href="asteroids.html#cb160-6"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb160-7"><a href="asteroids.html#cb160-7"></a></span>
<span id="cb160-8"><a href="asteroids.html#cb160-8"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb160-9"><a href="asteroids.html#cb160-9"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb160-10"><a href="asteroids.html#cb160-10"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb160-11"><a href="asteroids.html#cb160-11"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb160-12"><a href="asteroids.html#cb160-12"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb160-13"><a href="asteroids.html#cb160-13"></a></span>
<span id="cb160-14"><a href="asteroids.html#cb160-14"></a><span class="kw">class</span> OpenGLWindow : <span class="kw">public</span> abcg::OpenGLWindow {</span>
<span id="cb160-15"><a href="asteroids.html#cb160-15"></a> <span class="kw">protected</span>:</span>
<span id="cb160-16"><a href="asteroids.html#cb160-16"></a>  <span class="dt">void</span> handleEvent(SDL_Event&amp; event) <span class="kw">override</span>;</span>
<span id="cb160-17"><a href="asteroids.html#cb160-17"></a>  <span class="dt">void</span> initializeGL() <span class="kw">override</span>;</span>
<span id="cb160-18"><a href="asteroids.html#cb160-18"></a>  <span class="dt">void</span> paintGL() <span class="kw">override</span>;</span>
<span id="cb160-19"><a href="asteroids.html#cb160-19"></a>  <span class="dt">void</span> paintUI() <span class="kw">override</span>;</span>
<span id="cb160-20"><a href="asteroids.html#cb160-20"></a>  <span class="dt">void</span> resizeGL(<span class="dt">int</span> width, <span class="dt">int</span> height) <span class="kw">override</span>;</span>
<span id="cb160-21"><a href="asteroids.html#cb160-21"></a>  <span class="dt">void</span> terminateGL() <span class="kw">override</span>;</span>
<span id="cb160-22"><a href="asteroids.html#cb160-22"></a></span>
<span id="cb160-23"><a href="asteroids.html#cb160-23"></a> <span class="kw">private</span>:</span>
<span id="cb160-24"><a href="asteroids.html#cb160-24"></a>  GLuint <span class="va">m_objectsProgram</span>{};</span>
<span id="cb160-25"><a href="asteroids.html#cb160-25"></a></span>
<span id="cb160-26"><a href="asteroids.html#cb160-26"></a>  <span class="dt">int</span> <span class="va">m_viewportWidth</span>{};</span>
<span id="cb160-27"><a href="asteroids.html#cb160-27"></a>  <span class="dt">int</span> <span class="va">m_viewportHeight</span>{};</span>
<span id="cb160-28"><a href="asteroids.html#cb160-28"></a></span>
<span id="cb160-29"><a href="asteroids.html#cb160-29"></a>  GameData <span class="va">m_gameData</span>;</span>
<span id="cb160-30"><a href="asteroids.html#cb160-30"></a></span>
<span id="cb160-31"><a href="asteroids.html#cb160-31"></a>  Ship <span class="va">m_ship</span>;</span>
<span id="cb160-32"><a href="asteroids.html#cb160-32"></a></span>
<span id="cb160-33"><a href="asteroids.html#cb160-33"></a>  abcg::ElapsedTimer <span class="va">m_restartWaitTimer</span>;</span>
<span id="cb160-34"><a href="asteroids.html#cb160-34"></a></span>
<span id="cb160-35"><a href="asteroids.html#cb160-35"></a>  ImFont* <span class="va">m_font</span>{};</span>
<span id="cb160-36"><a href="asteroids.html#cb160-36"></a></span>
<span id="cb160-37"><a href="asteroids.html#cb160-37"></a>  <span class="bu">std::</span>default_random_engine <span class="va">m_randomEngine</span>;</span>
<span id="cb160-38"><a href="asteroids.html#cb160-38"></a></span>
<span id="cb160-39"><a href="asteroids.html#cb160-39"></a>  <span class="dt">void</span> restart();</span>
<span id="cb160-40"><a href="asteroids.html#cb160-40"></a>  <span class="dt">void</span> update();</span>
<span id="cb160-41"><a href="asteroids.html#cb160-41"></a>};</span>
<span id="cb160-42"><a href="asteroids.html#cb160-42"></a></span>
<span id="cb160-43"><a href="asteroids.html#cb160-43"></a><span class="pp">#endif</span></span></code></pre></div>
<ul>
<li><code>m_objectsProgram</code> é o identificador do par de shaders <code>objects.vert</code> e <code>objects.frag</code>.</li>
<li><code>m_gameData</code> é a instância de <code>GameData</code> com o estado do jogo e dos dispositivos de entrada.</li>
<li><code>m_ship</code> é a instância da classe <code>Ship</code> que gerencia a nave.</li>
<li><code>m_restartWaitTimer</code> é um temporizador utilizado para fazer com que o jogo seja reiniciado em cinco segundos após o fim de jogo.</li>
<li><code>m_font</code> representa a fonte que será utilizada pela ImGui para escrever “Game Over” e “Win” na tela.</li>
</ul>
<p>Observe que há uma nova função membro <code>handleEvent</code> que substitui uma função virtual da classe base. <strong><code>handleEvent</code> é chamada pela ABCg sempre que ocorre algum evento da SDL</strong>, incluindo os eventos dos dispositivos de entrada. Neste projeto, vamos usar <code>handleEvent</code> para atualizar o bitset <code>m_input</code> de <code>m_gameData</code>.</p>
<p>Na linha 39 há a declaração de uma função membro <code>restart</code>. Essa função será chamada sempre que quisermos reiniciar o estado do jogo.</p>
<p>Na linha 40 é declarada a função membro <code>update</code>. Essa função será chamada em <code>paintGL</code> antes de cada renderização e atualizará a posição dos objetos da cena para torná-la animada.</p>
</div>
<div id="openglwindow.cpp-4" class="section level4 unnumbered">
<h4>openglwindow.cpp</h4>
<p>Em <code>openglwindow.cpp</code>, começaremos com a definição de <code>OpenGLWindow::handleEvent</code>:</p>
<div class="sourceCode" id="cb161" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb161-1"><a href="asteroids.html#cb161-1"></a><span class="pp">#include </span><span class="im">&quot;openglwindow.hpp&quot;</span></span>
<span id="cb161-2"><a href="asteroids.html#cb161-2"></a></span>
<span id="cb161-3"><a href="asteroids.html#cb161-3"></a><span class="pp">#include </span><span class="im">&lt;imgui.h&gt;</span></span>
<span id="cb161-4"><a href="asteroids.html#cb161-4"></a></span>
<span id="cb161-5"><a href="asteroids.html#cb161-5"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb161-6"><a href="asteroids.html#cb161-6"></a></span>
<span id="cb161-7"><a href="asteroids.html#cb161-7"></a><span class="dt">void</span> OpenGLWindow::handleEvent(SDL_Event &amp;event) {</span>
<span id="cb161-8"><a href="asteroids.html#cb161-8"></a>  <span class="co">// Keyboard events</span></span>
<span id="cb161-9"><a href="asteroids.html#cb161-9"></a>  <span class="cf">if</span> (event.type == SDL_KEYDOWN) {</span>
<span id="cb161-10"><a href="asteroids.html#cb161-10"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_SPACE)</span>
<span id="cb161-11"><a href="asteroids.html#cb161-11"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Fire));</span>
<span id="cb161-12"><a href="asteroids.html#cb161-12"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_UP || event.key.keysym.sym == SDLK_w)</span>
<span id="cb161-13"><a href="asteroids.html#cb161-13"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up));</span>
<span id="cb161-14"><a href="asteroids.html#cb161-14"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_DOWN || event.key.keysym.sym == SDLK_s)</span>
<span id="cb161-15"><a href="asteroids.html#cb161-15"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Down));</span>
<span id="cb161-16"><a href="asteroids.html#cb161-16"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_LEFT || event.key.keysym.sym == SDLK_a)</span>
<span id="cb161-17"><a href="asteroids.html#cb161-17"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Left));</span>
<span id="cb161-18"><a href="asteroids.html#cb161-18"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_RIGHT || event.key.keysym.sym == SDLK_d)</span>
<span id="cb161-19"><a href="asteroids.html#cb161-19"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Right));</span>
<span id="cb161-20"><a href="asteroids.html#cb161-20"></a>  }</span>
<span id="cb161-21"><a href="asteroids.html#cb161-21"></a>  <span class="cf">if</span> (event.type == SDL_KEYUP) {</span>
<span id="cb161-22"><a href="asteroids.html#cb161-22"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_SPACE)</span>
<span id="cb161-23"><a href="asteroids.html#cb161-23"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Fire));</span>
<span id="cb161-24"><a href="asteroids.html#cb161-24"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_UP || event.key.keysym.sym == SDLK_w)</span>
<span id="cb161-25"><a href="asteroids.html#cb161-25"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up));</span>
<span id="cb161-26"><a href="asteroids.html#cb161-26"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_DOWN || event.key.keysym.sym == SDLK_s)</span>
<span id="cb161-27"><a href="asteroids.html#cb161-27"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Down));</span>
<span id="cb161-28"><a href="asteroids.html#cb161-28"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_LEFT || event.key.keysym.sym == SDLK_a)</span>
<span id="cb161-29"><a href="asteroids.html#cb161-29"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Left));</span>
<span id="cb161-30"><a href="asteroids.html#cb161-30"></a>    <span class="cf">if</span> (event.key.keysym.sym == SDLK_RIGHT || event.key.keysym.sym == SDLK_d)</span>
<span id="cb161-31"><a href="asteroids.html#cb161-31"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Right));</span>
<span id="cb161-32"><a href="asteroids.html#cb161-32"></a>  }</span>
<span id="cb161-33"><a href="asteroids.html#cb161-33"></a></span>
<span id="cb161-34"><a href="asteroids.html#cb161-34"></a>  <span class="co">// Mouse events</span></span>
<span id="cb161-35"><a href="asteroids.html#cb161-35"></a>  <span class="cf">if</span> (event.type == SDL_MOUSEBUTTONDOWN) {</span>
<span id="cb161-36"><a href="asteroids.html#cb161-36"></a>    <span class="cf">if</span> (event.button.button == SDL_BUTTON_LEFT)</span>
<span id="cb161-37"><a href="asteroids.html#cb161-37"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Fire));</span>
<span id="cb161-38"><a href="asteroids.html#cb161-38"></a>    <span class="cf">if</span> (event.button.button == SDL_BUTTON_RIGHT)</span>
<span id="cb161-39"><a href="asteroids.html#cb161-39"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.set(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up));</span>
<span id="cb161-40"><a href="asteroids.html#cb161-40"></a>  }</span>
<span id="cb161-41"><a href="asteroids.html#cb161-41"></a>  <span class="cf">if</span> (event.type == SDL_MOUSEBUTTONUP) {</span>
<span id="cb161-42"><a href="asteroids.html#cb161-42"></a>    <span class="cf">if</span> (event.button.button == SDL_BUTTON_LEFT)</span>
<span id="cb161-43"><a href="asteroids.html#cb161-43"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Fire));</span>
<span id="cb161-44"><a href="asteroids.html#cb161-44"></a>    <span class="cf">if</span> (event.button.button == SDL_BUTTON_RIGHT)</span>
<span id="cb161-45"><a href="asteroids.html#cb161-45"></a>      <span class="va">m_gameData</span>.<span class="va">m_input</span>.reset(<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up));</span>
<span id="cb161-46"><a href="asteroids.html#cb161-46"></a>  }</span>
<span id="cb161-47"><a href="asteroids.html#cb161-47"></a>  <span class="cf">if</span> (event.type == SDL_MOUSEMOTION) {</span>
<span id="cb161-48"><a href="asteroids.html#cb161-48"></a>    glm::ivec2 mousePosition;</span>
<span id="cb161-49"><a href="asteroids.html#cb161-49"></a>    SDL_GetMouseState(&amp;mousePosition.x, &amp;mousePosition.y);</span>
<span id="cb161-50"><a href="asteroids.html#cb161-50"></a></span>
<span id="cb161-51"><a href="asteroids.html#cb161-51"></a>    glm::vec2 direction{glm::vec2{mousePosition.x - <span class="va">m_viewportWidth</span> / <span class="dv">2</span>,</span>
<span id="cb161-52"><a href="asteroids.html#cb161-52"></a>                                  mousePosition.y - <span class="va">m_viewportHeight</span> / <span class="dv">2</span>}};</span>
<span id="cb161-53"><a href="asteroids.html#cb161-53"></a>    direction.y = -direction.y;</span>
<span id="cb161-54"><a href="asteroids.html#cb161-54"></a>    <span class="va">m_ship</span>.setRotation(<span class="bu">std::</span>atan2(direction.y, direction.x) - M_PI_2);</span>
<span id="cb161-55"><a href="asteroids.html#cb161-55"></a>  }</span>
<span id="cb161-56"><a href="asteroids.html#cb161-56"></a>}</span></code></pre></div>
<p>Os dados do evento são descritos pelo parâmetro <code>event</code> que é uma estrutura <a href="https://wiki.libsdl.org/SDL_Event"><code>SDL_Event</code></a> da SDL.</p>
<p>Os eventos do teclado são divididos em eventos de pressionamento de teclas (<code>SDL_KEYDOWN</code>), tratados nas linhas 9 a 20, e liberação de teclas (<code>SDL_KEYUP</code>), nas linhas 21 a 32. De acordo com as teclas pressionadas/liberadas, os bits de <code>m_gameData.m_input</code> são setados/resetados.</p>
<p>Os eventos do mouse são divididos em pressionamento (<code>SDL_MOUSEBUTTONDOWN</code>) e liberação (<code>SDL_MOUSEBUTTONUP</code>) dos botões, e movimentação do mouse (<code>SDL_MOUSEMOTION</code>).</p>
<p>Quando ocorre a movimentação do mouse, as coordenadas <span class="math inline">\((x,y)\)</span> do cursor são lidas com <code>SDL_GetMouseState</code> (linha 49) e convertidas para um vetor <code>direction</code> (linhas 51 e 52) definido pelo ponto que sai do centro da janela e vai até a posição do cursor. A coordenada <span class="math inline">\(y\)</span> é invertida na linha 53 porque, no sistema de coordenadas do mouse, o eixo <span class="math inline">\(y\)</span> é positivo para baixo, enquanto que no OpenGL é positivo para cima.</p>
<p>Na linha 54, o ângulo de rotação da nave é definido como o ângulo subentendido pelo vetor <code>direction</code>. A função <a href="https://en.wikipedia.org/wiki/Atan2"><code>atan2</code></a> retorna o ângulo entre o vetor <code>direction</code> e o eixo <span class="math inline">\(x\)</span> positivo. Desse valor é subtraído <span class="math inline">\(\pi/2\)</span> (90 graus) pois a orientação inicial da nave já é de 90 graus (a nave está “olhando” na direção do eixo <span class="math inline">\(y\)</span> e não na direção do eixo <span class="math inline">\(x\)</span>).</p>
<p>Vamos agora à definição de <code>OpenGLWindow::initializeGL</code>:</p>
<div class="sourceCode" id="cb162" startFrom="58"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 57;"><span id="cb162-58"><a href="asteroids.html#cb162-58"></a><span class="dt">void</span> OpenGLWindow::initializeGL() {</span>
<span id="cb162-59"><a href="asteroids.html#cb162-59"></a>  <span class="co">// Load a new font</span></span>
<span id="cb162-60"><a href="asteroids.html#cb162-60"></a>  ImGuiIO &amp;io{ImGui::GetIO()};</span>
<span id="cb162-61"><a href="asteroids.html#cb162-61"></a>  <span class="kw">auto</span> filename{getAssetsPath() + <span class="st">&quot;Inconsolata-Medium.ttf&quot;</span>};</span>
<span id="cb162-62"><a href="asteroids.html#cb162-62"></a>  <span class="va">m_font</span> = io.Fonts-&gt;AddFontFromFileTTF(filename.c_str(), <span class="fl">60.0</span><span class="bu">f</span>);</span>
<span id="cb162-63"><a href="asteroids.html#cb162-63"></a>  <span class="cf">if</span> (<span class="va">m_font</span> == <span class="kw">nullptr</span>) {</span>
<span id="cb162-64"><a href="asteroids.html#cb162-64"></a>    <span class="cf">throw</span> abcg::Exception{abcg::Exception::Runtime(<span class="st">&quot;Cannot load font file&quot;</span>)};</span>
<span id="cb162-65"><a href="asteroids.html#cb162-65"></a>  }</span>
<span id="cb162-66"><a href="asteroids.html#cb162-66"></a></span>
<span id="cb162-67"><a href="asteroids.html#cb162-67"></a>  <span class="co">// Create program to render the other objects</span></span>
<span id="cb162-68"><a href="asteroids.html#cb162-68"></a>  <span class="va">m_objectsProgram</span> = createProgramFromFile(getAssetsPath() + <span class="st">&quot;objects.vert&quot;</span>,</span>
<span id="cb162-69"><a href="asteroids.html#cb162-69"></a>                                           getAssetsPath() + <span class="st">&quot;objects.frag&quot;</span>);</span>
<span id="cb162-70"><a href="asteroids.html#cb162-70"></a></span>
<span id="cb162-71"><a href="asteroids.html#cb162-71"></a>  abcg::glClearColor(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb162-72"><a href="asteroids.html#cb162-72"></a></span>
<span id="cb162-73"><a href="asteroids.html#cb162-73"></a><span class="pp">#if !defined(__EMSCRIPTEN__)</span></span>
<span id="cb162-74"><a href="asteroids.html#cb162-74"></a>  abcg::glEnable(GL_PROGRAM_POINT_SIZE);</span>
<span id="cb162-75"><a href="asteroids.html#cb162-75"></a><span class="pp">#endif</span></span>
<span id="cb162-76"><a href="asteroids.html#cb162-76"></a></span>
<span id="cb162-77"><a href="asteroids.html#cb162-77"></a>  <span class="co">// Start pseudo-random number generator</span></span>
<span id="cb162-78"><a href="asteroids.html#cb162-78"></a>  <span class="va">m_randomEngine</span>.seed(</span>
<span id="cb162-79"><a href="asteroids.html#cb162-79"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now().time_since_epoch().count());</span>
<span id="cb162-80"><a href="asteroids.html#cb162-80"></a></span>
<span id="cb162-81"><a href="asteroids.html#cb162-81"></a>  restart();</span>
<span id="cb162-82"><a href="asteroids.html#cb162-82"></a>}</span></code></pre></div>
<p>Nas linhas 59 a 65 é carregada a fonte TrueType da pasta <code>assets</code>. O tamanho da fonte é definido como <code>60.0f</code> na chamada à função <code>AddFontFromFileTTF</code> da ImGui. Internamente, a ImGui renderiza cada letra em uma textura que pode ser utilizada posteriormente em <code>paintUI</code> para produzir texto com essa fonte e tamanho. Esses dados ficam armazenados em <code>m_font</code>.</p>
<p>Na linha 68 é chamada a função <code>createProgramFromFile</code> da ABCg para compilar e ligar os shaders <code>objects.vert</code> e <code>objects.frag</code>.</p>
<p>O restante do código de <code>OpenGLWindow::initializeGL</code> contém funções que já usamos em projetos anteriores.</p>
<p>Na linha 81 é chamada a função membro <code>restart</code> que reinicia o estado do jogo. A definição de <code>OpenGLWindow::restart</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb163" startFrom="84"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 83;"><span id="cb163-84"><a href="asteroids.html#cb163-84"></a><span class="dt">void</span> OpenGLWindow::restart() {</span>
<span id="cb163-85"><a href="asteroids.html#cb163-85"></a>  <span class="va">m_gameData</span>.<span class="va">m_state</span> = State::Playing;</span>
<span id="cb163-86"><a href="asteroids.html#cb163-86"></a></span>
<span id="cb163-87"><a href="asteroids.html#cb163-87"></a>  <span class="va">m_ship</span>.initializeGL(<span class="va">m_objectsProgram</span>);</span>
<span id="cb163-88"><a href="asteroids.html#cb163-88"></a>}</span></code></pre></div>
<p>A função membro <code>OpenGLWindow::update</code> será definida como segue:</p>
<div class="sourceCode" id="cb164" startFrom="90"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 89;"><span id="cb164-90"><a href="asteroids.html#cb164-90"></a><span class="dt">void</span> OpenGLWindow::update() {</span>
<span id="cb164-91"><a href="asteroids.html#cb164-91"></a>  <span class="dt">float</span> deltaTime{<span class="kw">static_cast</span>&lt;<span class="dt">float</span>&gt;(getDeltaTime())};</span>
<span id="cb164-92"><a href="asteroids.html#cb164-92"></a></span>
<span id="cb164-93"><a href="asteroids.html#cb164-93"></a>  <span class="co">// Wait 5 seconds before restarting</span></span>
<span id="cb164-94"><a href="asteroids.html#cb164-94"></a>  <span class="cf">if</span> (<span class="va">m_gameData</span>.<span class="va">m_state</span> != State::Playing &amp;&amp;</span>
<span id="cb164-95"><a href="asteroids.html#cb164-95"></a>      <span class="va">m_restartWaitTimer</span>.elapsed() &gt; <span class="dv">5</span>) {</span>
<span id="cb164-96"><a href="asteroids.html#cb164-96"></a>    restart();</span>
<span id="cb164-97"><a href="asteroids.html#cb164-97"></a>    <span class="cf">return</span>;</span>
<span id="cb164-98"><a href="asteroids.html#cb164-98"></a>  }</span>
<span id="cb164-99"><a href="asteroids.html#cb164-99"></a></span>
<span id="cb164-100"><a href="asteroids.html#cb164-100"></a>  <span class="va">m_ship</span>.update(<span class="va">m_gameData</span>, deltaTime);</span>
<span id="cb164-101"><a href="asteroids.html#cb164-101"></a>}</span></code></pre></div>
<p>Na linha 91, <code>getDeltaTime</code> é uma função membro de <code>abcg::OpenGLWindow</code> que retorna o tempo que se passou, em segundos, desde a última chamada a <code>paintGL</code> (é o “delta” de tempo entre os quadros de exibição). Na linha 100, esse tempo é passado para a função <code>update</code> da nave, junto com o estado do jogo em <code>m_gameData</code> para atualizar a animação da nave.</p>
<div class="notebox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#1f5386;overflow:visible;position:relative;"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>
<div class="noteboxtitle">
Importante
</div>
<p>O valor retornado por <code>abcg::OpenGLWindow::getDeltaTime</code> deve ser utilizado para fazer com que a animação dos objetos seja sincronizada pelo tempo e não pela velocidade do computador.</p>
<p>Suponha que queremos animar o deslocamento de um asteroide, de <code>x = 0</code> para a coordenada <code>x = 10</code> em dois segundos. Para fazer isso, poderíamos incluir a seguinte expressão em <code>update</code>:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb165-1"><a href="asteroids.html#cb165-1" aria-hidden="true" tabindex="-1"></a>x += (<span class="fl">10.0</span> / <span class="fl">2.0</span>) * getDeltaTime();</span></code></pre></div>
<p>Isso faz com que <code>x</code> cresça a uma taxa de 5 unidades <strong>por segundo</strong>, independentemente da velocidade do computador.</p>
<p>Em um computador lento, que renderiza a uma taxa de, digamos, 10 FPS, <code>getDeltaTime</code> retornará <code>0.1</code> a cada quadro. Em um computador com GPU mais rápida, que renderiza a uma taxa de 100 FPS, <code>getDeltaTime</code> retornará <code>0.01</code> a cada quadro. Nos dois casos, a integração de <code>getDeltaTime</code> durante um segundo será exatamante <code>1</code>.</p>
<p>Em resumo, sempre utilize <code>getDeltaTime</code> para atualizar os parâmetros de uma animação. Nunca suponha que a velocidade de renderização será fixa.</p>
</div>
<p>A definição de <code>OpenGLWindow::paintGL</code> ficará assim:</p>
<div class="sourceCode" id="cb166" startFrom="103"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 102;"><span id="cb166-103"><a href="asteroids.html#cb166-103"></a><span class="dt">void</span> OpenGLWindow::paintGL() {</span>
<span id="cb166-104"><a href="asteroids.html#cb166-104"></a>  update();</span>
<span id="cb166-105"><a href="asteroids.html#cb166-105"></a></span>
<span id="cb166-106"><a href="asteroids.html#cb166-106"></a>  abcg::glClear(GL_COLOR_BUFFER_BIT);</span>
<span id="cb166-107"><a href="asteroids.html#cb166-107"></a>  abcg::glViewport(<span class="dv">0</span>, <span class="dv">0</span>, <span class="va">m_viewportWidth</span>, <span class="va">m_viewportHeight</span>);</span>
<span id="cb166-108"><a href="asteroids.html#cb166-108"></a></span>
<span id="cb166-109"><a href="asteroids.html#cb166-109"></a>  <span class="va">m_ship</span>.paintGL(<span class="va">m_gameData</span>);</span>
<span id="cb166-110"><a href="asteroids.html#cb166-110"></a>}</span></code></pre></div>
<p>Observe que a função <code>update</code> é chamada logo no início. Em seguida o buffer de cor é limpo com <code>glClear</code> e a nave é renderizada usando a função <code>paintGL</code> que implementaremos em <code>Ship</code>.</p>
<p>Em <code>OpenGLWindow::paintUI</code>, mostraremos o texto de “Game Over” e “Win” de acordo com o estado do jogo:</p>
<div class="sourceCode" id="cb167" startFrom="112"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 111;"><span id="cb167-112"><a href="asteroids.html#cb167-112"></a><span class="dt">void</span> OpenGLWindow::paintUI() {</span>
<span id="cb167-113"><a href="asteroids.html#cb167-113"></a>  abcg::OpenGLWindow::paintUI();</span>
<span id="cb167-114"><a href="asteroids.html#cb167-114"></a></span>
<span id="cb167-115"><a href="asteroids.html#cb167-115"></a>  {</span>
<span id="cb167-116"><a href="asteroids.html#cb167-116"></a>    <span class="at">const</span> <span class="kw">auto</span> size{ImVec2(<span class="dv">300</span>, <span class="dv">85</span>)};</span>
<span id="cb167-117"><a href="asteroids.html#cb167-117"></a>    <span class="at">const</span> <span class="kw">auto</span> position{ImVec2((<span class="va">m_viewportWidth</span> - size.x) / <span class="fl">2.0</span><span class="bu">f</span>,</span>
<span id="cb167-118"><a href="asteroids.html#cb167-118"></a>                               (<span class="va">m_viewportHeight</span> - size.y) / <span class="fl">2.0</span><span class="bu">f</span>)};</span>
<span id="cb167-119"><a href="asteroids.html#cb167-119"></a>    ImGui::SetNextWindowPos(position);</span>
<span id="cb167-120"><a href="asteroids.html#cb167-120"></a>    ImGui::SetNextWindowSize(size);</span>
<span id="cb167-121"><a href="asteroids.html#cb167-121"></a>    ImGuiWindowFlags flags{ImGuiWindowFlags_NoBackground |</span>
<span id="cb167-122"><a href="asteroids.html#cb167-122"></a>                           ImGuiWindowFlags_NoTitleBar |</span>
<span id="cb167-123"><a href="asteroids.html#cb167-123"></a>                           ImGuiWindowFlags_NoInputs};</span>
<span id="cb167-124"><a href="asteroids.html#cb167-124"></a>    ImGui::Begin(<span class="st">&quot; &quot;</span>, <span class="kw">nullptr</span>, flags);</span>
<span id="cb167-125"><a href="asteroids.html#cb167-125"></a>    ImGui::PushFont(<span class="va">m_font</span>);</span>
<span id="cb167-126"><a href="asteroids.html#cb167-126"></a></span>
<span id="cb167-127"><a href="asteroids.html#cb167-127"></a>    <span class="cf">if</span> (<span class="va">m_gameData</span>.<span class="va">m_state</span> == State::GameOver) {</span>
<span id="cb167-128"><a href="asteroids.html#cb167-128"></a>      ImGui::Text(<span class="st">&quot;Game Over!&quot;</span>);</span>
<span id="cb167-129"><a href="asteroids.html#cb167-129"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="va">m_gameData</span>.<span class="va">m_state</span> == State::Win) {</span>
<span id="cb167-130"><a href="asteroids.html#cb167-130"></a>      ImGui::Text(<span class="st">&quot;*You Win!*&quot;</span>);</span>
<span id="cb167-131"><a href="asteroids.html#cb167-131"></a>    }</span>
<span id="cb167-132"><a href="asteroids.html#cb167-132"></a></span>
<span id="cb167-133"><a href="asteroids.html#cb167-133"></a>    ImGui::PopFont();</span>
<span id="cb167-134"><a href="asteroids.html#cb167-134"></a>    ImGui::End();</span>
<span id="cb167-135"><a href="asteroids.html#cb167-135"></a>  }</span>
<span id="cb167-136"><a href="asteroids.html#cb167-136"></a>}</span></code></pre></div>
<p>Nas linhas 121 a 123, definimos os flags da janela da ImGui, usando <code>ImGuiWindowFlags_NoBackground</code> para a janela ficar invisível e <code>ImGuiWindowFlags_NoInputs</code> para não receber entrada do teclado. O conteúdo da janela continua visível, de modo que <code>ImGui::Text</code> mostrada o texto sobreposto na tela.</p>
<p>Todo o texto exibido entre <code>ImGui::PushFont(m_font)</code> (linha 125) e <code>ImGui::PopFont()</code> (linha 133), usa a fonte <code>m_font</code>, que é a fonte Inconsolata de tamanho 60 criada em <code>OpenGLWindow::initializeGL</code>.</p>
<p>As funções membro <code>OpenGLWindow::resizeGL</code> e <code>OpenGLWindow::terminateGL</code> ficarão como a seguir:</p>
<div class="sourceCode" id="cb168" startFrom="138"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 137;"><span id="cb168-138"><a href="asteroids.html#cb168-138"></a><span class="dt">void</span> OpenGLWindow::resizeGL(<span class="dt">int</span> width, <span class="dt">int</span> height) {</span>
<span id="cb168-139"><a href="asteroids.html#cb168-139"></a>  <span class="va">m_viewportWidth</span> = width;</span>
<span id="cb168-140"><a href="asteroids.html#cb168-140"></a>  <span class="va">m_viewportHeight</span> = height;</span>
<span id="cb168-141"><a href="asteroids.html#cb168-141"></a></span>
<span id="cb168-142"><a href="asteroids.html#cb168-142"></a>  abcg::glClear(GL_COLOR_BUFFER_BIT);</span>
<span id="cb168-143"><a href="asteroids.html#cb168-143"></a>}</span>
<span id="cb168-144"><a href="asteroids.html#cb168-144"></a></span>
<span id="cb168-145"><a href="asteroids.html#cb168-145"></a><span class="dt">void</span> OpenGLWindow::terminateGL() {</span>
<span id="cb168-146"><a href="asteroids.html#cb168-146"></a>  abcg::glDeleteProgram(<span class="va">m_objectsProgram</span>);</span>
<span id="cb168-147"><a href="asteroids.html#cb168-147"></a></span>
<span id="cb168-148"><a href="asteroids.html#cb168-148"></a>  <span class="va">m_ship</span>.terminateGL();</span>
<span id="cb168-149"><a href="asteroids.html#cb168-149"></a>}</span></code></pre></div>
<p>Não há nada de novo em <code>OpenGLWindow::resizeGL</code>. É o mesmo código já utilizado em outros projetos.</p>
<p>Em <code>OpenGLWindow::terminateGL</code>, <code>m_objectsProgram</code> é liberado e a função membro <code>terminateGL</code> de <code>m_ship</code> é chamada para liberar os recursos da nave.</p>
</div>
<div id="ship.h" class="section level4 unnumbered">
<h4>ship.h</h4>
<p>A definição da classe <code>Ship</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb169" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb169-1"><a href="asteroids.html#cb169-1"></a><span class="pp">#ifndef SHIP_HPP_</span></span>
<span id="cb169-2"><a href="asteroids.html#cb169-2"></a><span class="pp">#define SHIP_HPP_</span></span>
<span id="cb169-3"><a href="asteroids.html#cb169-3"></a></span>
<span id="cb169-4"><a href="asteroids.html#cb169-4"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb169-5"><a href="asteroids.html#cb169-5"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb169-6"><a href="asteroids.html#cb169-6"></a></span>
<span id="cb169-7"><a href="asteroids.html#cb169-7"></a><span class="kw">class</span> Asteroids;</span>
<span id="cb169-8"><a href="asteroids.html#cb169-8"></a><span class="kw">class</span> Bullets;</span>
<span id="cb169-9"><a href="asteroids.html#cb169-9"></a><span class="kw">class</span> OpenGLWindow;</span>
<span id="cb169-10"><a href="asteroids.html#cb169-10"></a><span class="kw">class</span> StarLayers;</span>
<span id="cb169-11"><a href="asteroids.html#cb169-11"></a></span>
<span id="cb169-12"><a href="asteroids.html#cb169-12"></a><span class="kw">class</span> Ship {</span>
<span id="cb169-13"><a href="asteroids.html#cb169-13"></a> <span class="kw">public</span>:</span>
<span id="cb169-14"><a href="asteroids.html#cb169-14"></a>  <span class="dt">void</span> initializeGL(GLuint program);</span>
<span id="cb169-15"><a href="asteroids.html#cb169-15"></a>  <span class="dt">void</span> paintGL(<span class="at">const</span> GameData &amp;gameData);</span>
<span id="cb169-16"><a href="asteroids.html#cb169-16"></a>  <span class="dt">void</span> terminateGL();</span>
<span id="cb169-17"><a href="asteroids.html#cb169-17"></a></span>
<span id="cb169-18"><a href="asteroids.html#cb169-18"></a>  <span class="dt">void</span> update(<span class="at">const</span> GameData &amp;gameData, <span class="dt">float</span> deltaTime);</span>
<span id="cb169-19"><a href="asteroids.html#cb169-19"></a>  <span class="dt">void</span> setRotation(<span class="dt">float</span> rotation) { <span class="va">m_rotation</span> = rotation; }</span>
<span id="cb169-20"><a href="asteroids.html#cb169-20"></a></span>
<span id="cb169-21"><a href="asteroids.html#cb169-21"></a> <span class="kw">private</span>:</span>
<span id="cb169-22"><a href="asteroids.html#cb169-22"></a>  <span class="kw">friend</span> Asteroids;</span>
<span id="cb169-23"><a href="asteroids.html#cb169-23"></a>  <span class="kw">friend</span> Bullets;</span>
<span id="cb169-24"><a href="asteroids.html#cb169-24"></a>  <span class="kw">friend</span> OpenGLWindow;</span>
<span id="cb169-25"><a href="asteroids.html#cb169-25"></a>  <span class="kw">friend</span> StarLayers;</span>
<span id="cb169-26"><a href="asteroids.html#cb169-26"></a></span>
<span id="cb169-27"><a href="asteroids.html#cb169-27"></a>  GLuint <span class="va">m_program</span>{};</span>
<span id="cb169-28"><a href="asteroids.html#cb169-28"></a>  GLint <span class="va">m_translationLoc</span>{};</span>
<span id="cb169-29"><a href="asteroids.html#cb169-29"></a>  GLint <span class="va">m_colorLoc</span>{};</span>
<span id="cb169-30"><a href="asteroids.html#cb169-30"></a>  GLint <span class="va">m_scaleLoc</span>{};</span>
<span id="cb169-31"><a href="asteroids.html#cb169-31"></a>  GLint <span class="va">m_rotationLoc</span>{};</span>
<span id="cb169-32"><a href="asteroids.html#cb169-32"></a></span>
<span id="cb169-33"><a href="asteroids.html#cb169-33"></a>  GLuint <span class="va">m_vao</span>{};</span>
<span id="cb169-34"><a href="asteroids.html#cb169-34"></a>  GLuint <span class="va">m_vbo</span>{};</span>
<span id="cb169-35"><a href="asteroids.html#cb169-35"></a>  GLuint <span class="va">m_ebo</span>{};</span>
<span id="cb169-36"><a href="asteroids.html#cb169-36"></a></span>
<span id="cb169-37"><a href="asteroids.html#cb169-37"></a>  glm::vec4 <span class="va">m_color</span>{<span class="dv">1</span>};</span>
<span id="cb169-38"><a href="asteroids.html#cb169-38"></a>  <span class="dt">float</span> <span class="va">m_rotation</span>{};</span>
<span id="cb169-39"><a href="asteroids.html#cb169-39"></a>  <span class="dt">float</span> <span class="va">m_scale</span>{<span class="fl">0.125</span><span class="bu">f</span>};</span>
<span id="cb169-40"><a href="asteroids.html#cb169-40"></a>  glm::vec2 <span class="va">m_translation</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb169-41"><a href="asteroids.html#cb169-41"></a>  glm::vec2 <span class="va">m_velocity</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb169-42"><a href="asteroids.html#cb169-42"></a></span>
<span id="cb169-43"><a href="asteroids.html#cb169-43"></a>  abcg::ElapsedTimer <span class="va">m_trailBlinkTimer</span>;</span>
<span id="cb169-44"><a href="asteroids.html#cb169-44"></a>  abcg::ElapsedTimer <span class="va">m_bulletCoolDownTimer</span>;</span>
<span id="cb169-45"><a href="asteroids.html#cb169-45"></a>};</span>
<span id="cb169-46"><a href="asteroids.html#cb169-46"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Nas linhas 7 a 10 há declarações antecipadas de classes<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a> que são especificadas como <em>friend</em> de <code>Ship</code> (linhas 22 a 25), isto é, elas podem acessar membros privados de <code>Ship</code>.</p>
<p>As variáveis nas linhas 28 a 31 receberão o resultado de <code>glGetUniformLocation</code> para as variáveis uniformes do vertex shader. Isso será feito em <code>Ship::initializeGL</code>.</p>
<p>As propriedades da nave são definidas nas linhas 37 a 38: cor, ângulo de rotação, fator de escala, translação e vetor de velocidade.</p>
<p>Os temporizadores definidos nas linhas 43 e 44 são utilizados para controlar o tempo de piscagem do fogo do foguete (quando a nave está acelerando), e o tempo de espera entre um tiro e outro.</p>
</div>
<div id="ship.cpp" class="section level4 unnumbered">
<h4>ship.cpp</h4>
<p>Aqui definiremos <code>Ship::initializeGL</code>, <code>Ship::paintGL</code>, <code>Ship::terminateGL</code> e <code>Ship::update</code>.</p>
<p>A definição de <code>Ship::initializeGL</code> contém o código que cria o VBO e VAO da nave:</p>
<div class="sourceCode" id="cb170" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb170-1"><a href="asteroids.html#cb170-1"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb170-2"><a href="asteroids.html#cb170-2"></a></span>
<span id="cb170-3"><a href="asteroids.html#cb170-3"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/fast_trigonometry.hpp&gt;</span></span>
<span id="cb170-4"><a href="asteroids.html#cb170-4"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/rotate_vector.hpp&gt;</span></span>
<span id="cb170-5"><a href="asteroids.html#cb170-5"></a></span>
<span id="cb170-6"><a href="asteroids.html#cb170-6"></a><span class="dt">void</span> Ship::initializeGL(GLuint program) {</span>
<span id="cb170-7"><a href="asteroids.html#cb170-7"></a>  terminateGL();</span>
<span id="cb170-8"><a href="asteroids.html#cb170-8"></a></span>
<span id="cb170-9"><a href="asteroids.html#cb170-9"></a>  <span class="va">m_program</span> = program;</span>
<span id="cb170-10"><a href="asteroids.html#cb170-10"></a>  <span class="va">m_colorLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;color&quot;</span>);</span>
<span id="cb170-11"><a href="asteroids.html#cb170-11"></a>  <span class="va">m_rotationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;rotation&quot;</span>);</span>
<span id="cb170-12"><a href="asteroids.html#cb170-12"></a>  <span class="va">m_scaleLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;scale&quot;</span>);</span>
<span id="cb170-13"><a href="asteroids.html#cb170-13"></a>  <span class="va">m_translationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;translation&quot;</span>);</span>
<span id="cb170-14"><a href="asteroids.html#cb170-14"></a></span>
<span id="cb170-15"><a href="asteroids.html#cb170-15"></a>  <span class="va">m_rotation</span> = <span class="fl">0.0</span><span class="bu">f</span>;</span>
<span id="cb170-16"><a href="asteroids.html#cb170-16"></a>  <span class="va">m_translation</span> = glm::vec2(<span class="dv">0</span>);</span>
<span id="cb170-17"><a href="asteroids.html#cb170-17"></a>  <span class="va">m_velocity</span> = glm::vec2(<span class="dv">0</span>);</span>
<span id="cb170-18"><a href="asteroids.html#cb170-18"></a></span>
<span id="cb170-19"><a href="asteroids.html#cb170-19"></a>  <span class="bu">std::</span>array&lt;glm::vec2, <span class="dv">24</span>&gt; positions{</span>
<span id="cb170-20"><a href="asteroids.html#cb170-20"></a>      <span class="co">// Ship body</span></span>
<span id="cb170-21"><a href="asteroids.html#cb170-21"></a>      glm::vec2{-<span class="fl">02.5</span><span class="bu">f</span>, +<span class="fl">12.5</span><span class="bu">f</span>}, glm::vec2{-<span class="fl">15.5</span><span class="bu">f</span>, +<span class="fl">02.5</span><span class="bu">f</span>},</span>
<span id="cb170-22"><a href="asteroids.html#cb170-22"></a>      glm::vec2{-<span class="fl">15.5</span><span class="bu">f</span>, -<span class="fl">12.5</span><span class="bu">f</span>}, glm::vec2{-<span class="fl">09.5</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>},</span>
<span id="cb170-23"><a href="asteroids.html#cb170-23"></a>      glm::vec2{-<span class="fl">03.5</span><span class="bu">f</span>, -<span class="fl">12.5</span><span class="bu">f</span>}, glm::vec2{+<span class="fl">03.5</span><span class="bu">f</span>, -<span class="fl">12.5</span><span class="bu">f</span>},</span>
<span id="cb170-24"><a href="asteroids.html#cb170-24"></a>      glm::vec2{+<span class="fl">09.5</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>}, glm::vec2{+<span class="fl">15.5</span><span class="bu">f</span>, -<span class="fl">12.5</span><span class="bu">f</span>},</span>
<span id="cb170-25"><a href="asteroids.html#cb170-25"></a>      glm::vec2{+<span class="fl">15.5</span><span class="bu">f</span>, +<span class="fl">02.5</span><span class="bu">f</span>}, glm::vec2{+<span class="fl">02.5</span><span class="bu">f</span>, +<span class="fl">12.5</span><span class="bu">f</span>},</span>
<span id="cb170-26"><a href="asteroids.html#cb170-26"></a></span>
<span id="cb170-27"><a href="asteroids.html#cb170-27"></a>      <span class="co">// Cannon left</span></span>
<span id="cb170-28"><a href="asteroids.html#cb170-28"></a>      glm::vec2{-<span class="fl">12.5</span><span class="bu">f</span>, +<span class="fl">10.5</span><span class="bu">f</span>}, glm::vec2{-<span class="fl">12.5</span><span class="bu">f</span>, +<span class="fl">04.0</span><span class="bu">f</span>},</span>
<span id="cb170-29"><a href="asteroids.html#cb170-29"></a>      glm::vec2{-<span class="fl">09.5</span><span class="bu">f</span>, +<span class="fl">04.0</span><span class="bu">f</span>}, glm::vec2{-<span class="fl">09.5</span><span class="bu">f</span>, +<span class="fl">10.5</span><span class="bu">f</span>},</span>
<span id="cb170-30"><a href="asteroids.html#cb170-30"></a></span>
<span id="cb170-31"><a href="asteroids.html#cb170-31"></a>      <span class="co">// Cannon right</span></span>
<span id="cb170-32"><a href="asteroids.html#cb170-32"></a>      glm::vec2{+<span class="fl">09.5</span><span class="bu">f</span>, +<span class="fl">10.5</span><span class="bu">f</span>}, glm::vec2{+<span class="fl">09.5</span><span class="bu">f</span>, +<span class="fl">04.0</span><span class="bu">f</span>},</span>
<span id="cb170-33"><a href="asteroids.html#cb170-33"></a>      glm::vec2{+<span class="fl">12.5</span><span class="bu">f</span>, +<span class="fl">04.0</span><span class="bu">f</span>}, glm::vec2{+<span class="fl">12.5</span><span class="bu">f</span>, +<span class="fl">10.5</span><span class="bu">f</span>},</span>
<span id="cb170-34"><a href="asteroids.html#cb170-34"></a>      </span>
<span id="cb170-35"><a href="asteroids.html#cb170-35"></a>      <span class="co">// Thruster trail (left)</span></span>
<span id="cb170-36"><a href="asteroids.html#cb170-36"></a>      glm::vec2{-<span class="fl">12.0</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>}, </span>
<span id="cb170-37"><a href="asteroids.html#cb170-37"></a>      glm::vec2{-<span class="fl">09.5</span><span class="bu">f</span>, -<span class="fl">18.0</span><span class="bu">f</span>}, </span>
<span id="cb170-38"><a href="asteroids.html#cb170-38"></a>      glm::vec2{-<span class="fl">07.0</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>},</span>
<span id="cb170-39"><a href="asteroids.html#cb170-39"></a></span>
<span id="cb170-40"><a href="asteroids.html#cb170-40"></a>      <span class="co">// Thruster trail (right)</span></span>
<span id="cb170-41"><a href="asteroids.html#cb170-41"></a>      glm::vec2{+<span class="fl">07.0</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>}, </span>
<span id="cb170-42"><a href="asteroids.html#cb170-42"></a>      glm::vec2{+<span class="fl">09.5</span><span class="bu">f</span>, -<span class="fl">18.0</span><span class="bu">f</span>}, </span>
<span id="cb170-43"><a href="asteroids.html#cb170-43"></a>      glm::vec2{+<span class="fl">12.0</span><span class="bu">f</span>, -<span class="fl">07.5</span><span class="bu">f</span>},</span>
<span id="cb170-44"><a href="asteroids.html#cb170-44"></a>      };</span>
<span id="cb170-45"><a href="asteroids.html#cb170-45"></a></span>
<span id="cb170-46"><a href="asteroids.html#cb170-46"></a>  <span class="co">// Normalize</span></span>
<span id="cb170-47"><a href="asteroids.html#cb170-47"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;position : positions) {</span>
<span id="cb170-48"><a href="asteroids.html#cb170-48"></a>    position /= glm::vec2{<span class="fl">15.5</span><span class="bu">f</span>, <span class="fl">15.5</span><span class="bu">f</span>};</span>
<span id="cb170-49"><a href="asteroids.html#cb170-49"></a>  }</span>
<span id="cb170-50"><a href="asteroids.html#cb170-50"></a></span>
<span id="cb170-51"><a href="asteroids.html#cb170-51"></a>  <span class="at">const</span> <span class="bu">std::</span>array indices{<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>,</span>
<span id="cb170-52"><a href="asteroids.html#cb170-52"></a>                           <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>,</span>
<span id="cb170-53"><a href="asteroids.html#cb170-53"></a>                           <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>,</span>
<span id="cb170-54"><a href="asteroids.html#cb170-54"></a>                           <span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">5</span>,</span>
<span id="cb170-55"><a href="asteroids.html#cb170-55"></a>                           <span class="dv">9</span>, <span class="dv">0</span>, <span class="dv">5</span>,</span>
<span id="cb170-56"><a href="asteroids.html#cb170-56"></a>                           <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">6</span>,</span>
<span id="cb170-57"><a href="asteroids.html#cb170-57"></a>                           <span class="dv">9</span>, <span class="dv">6</span>, <span class="dv">8</span>,</span>
<span id="cb170-58"><a href="asteroids.html#cb170-58"></a>                           <span class="dv">8</span>, <span class="dv">6</span>, <span class="dv">7</span>,</span>
<span id="cb170-59"><a href="asteroids.html#cb170-59"></a>                           <span class="co">// Cannons</span></span>
<span id="cb170-60"><a href="asteroids.html#cb170-60"></a>                           <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>,</span>
<span id="cb170-61"><a href="asteroids.html#cb170-61"></a>                           <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">13</span>,</span>
<span id="cb170-62"><a href="asteroids.html#cb170-62"></a>                           <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">16</span>,</span>
<span id="cb170-63"><a href="asteroids.html#cb170-63"></a>                           <span class="dv">14</span>, <span class="dv">16</span>, <span class="dv">17</span>,</span>
<span id="cb170-64"><a href="asteroids.html#cb170-64"></a>                           <span class="co">// Thruster trails</span></span>
<span id="cb170-65"><a href="asteroids.html#cb170-65"></a>                           <span class="dv">18</span>, <span class="dv">19</span>, <span class="dv">20</span>,</span>
<span id="cb170-66"><a href="asteroids.html#cb170-66"></a>                           <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>};</span>
<span id="cb170-67"><a href="asteroids.html#cb170-67"></a></span>
<span id="cb170-68"><a href="asteroids.html#cb170-68"></a>  <span class="co">// Generate VBO</span></span>
<span id="cb170-69"><a href="asteroids.html#cb170-69"></a>  abcg::glGenBuffers(<span class="dv">1</span>, &amp;<span class="va">m_vbo</span>);</span>
<span id="cb170-70"><a href="asteroids.html#cb170-70"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="va">m_vbo</span>);</span>
<span id="cb170-71"><a href="asteroids.html#cb170-71"></a>  abcg::glBufferData(GL_ARRAY_BUFFER, <span class="kw">sizeof</span>(positions), positions.data(),</span>
<span id="cb170-72"><a href="asteroids.html#cb170-72"></a>                     GL_STATIC_DRAW);</span>
<span id="cb170-73"><a href="asteroids.html#cb170-73"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb170-74"><a href="asteroids.html#cb170-74"></a></span>
<span id="cb170-75"><a href="asteroids.html#cb170-75"></a>  <span class="co">// Generate EBO</span></span>
<span id="cb170-76"><a href="asteroids.html#cb170-76"></a>  abcg::glGenBuffers(<span class="dv">1</span>, &amp;<span class="va">m_ebo</span>);</span>
<span id="cb170-77"><a href="asteroids.html#cb170-77"></a>  abcg::glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, <span class="va">m_ebo</span>);</span>
<span id="cb170-78"><a href="asteroids.html#cb170-78"></a>  abcg::glBufferData(GL_ELEMENT_ARRAY_BUFFER, <span class="kw">sizeof</span>(indices), indices.data(),</span>
<span id="cb170-79"><a href="asteroids.html#cb170-79"></a>                     GL_STATIC_DRAW);</span>
<span id="cb170-80"><a href="asteroids.html#cb170-80"></a>  abcg::glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb170-81"><a href="asteroids.html#cb170-81"></a></span>
<span id="cb170-82"><a href="asteroids.html#cb170-82"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb170-83"><a href="asteroids.html#cb170-83"></a>  GLint positionAttribute{abcg::glGetAttribLocation(<span class="va">m_program</span>, <span class="st">&quot;inPosition&quot;</span>)};</span>
<span id="cb170-84"><a href="asteroids.html#cb170-84"></a></span>
<span id="cb170-85"><a href="asteroids.html#cb170-85"></a>  <span class="co">// Create VAO</span></span>
<span id="cb170-86"><a href="asteroids.html#cb170-86"></a>  abcg::glGenVertexArrays(<span class="dv">1</span>, &amp;<span class="va">m_vao</span>);</span>
<span id="cb170-87"><a href="asteroids.html#cb170-87"></a></span>
<span id="cb170-88"><a href="asteroids.html#cb170-88"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb170-89"><a href="asteroids.html#cb170-89"></a>  abcg::glBindVertexArray(<span class="va">m_vao</span>);</span>
<span id="cb170-90"><a href="asteroids.html#cb170-90"></a></span>
<span id="cb170-91"><a href="asteroids.html#cb170-91"></a>  abcg::glEnableVertexAttribArray(positionAttribute);</span>
<span id="cb170-92"><a href="asteroids.html#cb170-92"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="va">m_vbo</span>);</span>
<span id="cb170-93"><a href="asteroids.html#cb170-93"></a>  abcg::glVertexAttribPointer(positionAttribute, <span class="dv">2</span>, GL_FLOAT, GL_FALSE, <span class="dv">0</span>,</span>
<span id="cb170-94"><a href="asteroids.html#cb170-94"></a>                              <span class="kw">nullptr</span>);</span>
<span id="cb170-95"><a href="asteroids.html#cb170-95"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb170-96"><a href="asteroids.html#cb170-96"></a></span>
<span id="cb170-97"><a href="asteroids.html#cb170-97"></a>  abcg::glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, <span class="va">m_ebo</span>);</span>
<span id="cb170-98"><a href="asteroids.html#cb170-98"></a></span>
<span id="cb170-99"><a href="asteroids.html#cb170-99"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb170-100"><a href="asteroids.html#cb170-100"></a>  abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb170-101"><a href="asteroids.html#cb170-101"></a>}</span></code></pre></div>
<p>Observe que <code>terminateGL</code> é chamada logo no início da função para liberar o VBO e VAO anterior, caso exista.</p>
<p>Nas linhas 10 a 13, a localização das variáveis uniformes é salva para ser utilizada posteriormente na renderização.</p>
<p>O arranjo <code>positions</code> (linhas 19 a 44) contém a posição dos vértices da nave. São 24 vértices (de 0 a 23), como mostra a figura <a href="asteroids.html#fig:ship1">5.7</a>. Esses vértices são ligados para formar 14 triângulos. A imagem foi dividida em duas para facilitar a visualização, pois há sobreposição de triângulos:</p>
<ul>
<li>Os vértices de 0 a 9 definem o corpo da nave;</li>
<li>Os vértices de índices 10 a 17 definem os canhões de tiro;</li>
<li>Os vértices de 18 a 23 definem dois triângulos que representam o fogo dos foguetes. Esses dois triângulos só serão desenhados quando a nave estiver acelerando.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ship1"></span>
<img src="images/05_ship1.svg" alt="Geometria da nave." width="100%" />
<p class="caption">
Figura 5.7: Geometria da nave.
</p>
</div>
<p>As coordenadas <span class="math inline">\(x\)</span> em <code>positions</code> estão no intervalo <span class="math inline">\([-15.5, 15.5]\)</span>. Nas linhas 46 a 49, esse intervalo é mapeado para <span class="math inline">\([-1,1]\)</span> de modo que a nave fique dentro da região visível do viewport. Após a normalização, a nave já poderá ser vista no viewport, mas ainda está muito grande. Para chegar ao tamanho final, a escala é ajustada no shader usando <code>m_scale</code>, que é <code>0.125</code> (valor definido na linha 39 de <code>ship.h</code>).</p>
<p>Na figura <a href="asteroids.html#fig:ship1">5.7</a>, todos os vértices ligados por linhas pontilhadas fazem parte de mais de um triângulo. Por exemplo, o vértice de índice 0 é compartilhado por quatro triângulos. Para evitar ter de criar quatro vértices na mesma posição, um para cada triângulo, vamos usar o conceito de <em>geometria indexada</em>. Nas linhas 51 a 56 é definido um arranjo de índices aos vértices. Cada grupo de três índices define um triângulo (compare com a figura <a href="asteroids.html#fig:ship1">5.7</a>).</p>
<p>O VBO que contém os dados de <code>positions</code> é criado nas linhas 68 a 73. Nas linhas 75 a 80 é criado um <em>element buffer object</em> (EBO), que é o buffer de índices do VBO. O EBO armazena os dados de <code>indices</code>. Quando o comando de renderização for chamado com <code>GL_TRIANGLES</code>, cada sequência de três índices do EBO será utilizada para criar um triângulo.</p>
<p>No restante do código de <code>initializeGL</code>, o VAO é criado para salvar a vinculação do VBO e o mapeamento do VBO para o atributo de entrada do vertex shader. Note que o VAO também salva a vinculação do EBO na linha 97. Quando o VAO for utilizado no <code>paintGL</code>, toda a configuração entre as linhas 89 a 100 do <code>initializeGL</code> será aplicada ao pipeline.</p>
<p>O código de <code>Ship::paintGL</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb171" startFrom="103"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 102;"><span id="cb171-103"><a href="asteroids.html#cb171-103"></a><span class="dt">void</span> Ship::paintGL(<span class="at">const</span> GameData &amp;gameData) {</span>
<span id="cb171-104"><a href="asteroids.html#cb171-104"></a>  <span class="cf">if</span> (gameData.<span class="va">m_state</span> != State::Playing) <span class="cf">return</span>;</span>
<span id="cb171-105"><a href="asteroids.html#cb171-105"></a></span>
<span id="cb171-106"><a href="asteroids.html#cb171-106"></a>  abcg::glUseProgram(<span class="va">m_program</span>);</span>
<span id="cb171-107"><a href="asteroids.html#cb171-107"></a></span>
<span id="cb171-108"><a href="asteroids.html#cb171-108"></a>  abcg::glBindVertexArray(<span class="va">m_vao</span>);</span>
<span id="cb171-109"><a href="asteroids.html#cb171-109"></a></span>
<span id="cb171-110"><a href="asteroids.html#cb171-110"></a>  abcg::glUniform1f(<span class="va">m_scaleLoc</span>, <span class="va">m_scale</span>);</span>
<span id="cb171-111"><a href="asteroids.html#cb171-111"></a>  abcg::glUniform1f(<span class="va">m_rotationLoc</span>, <span class="va">m_rotation</span>);</span>
<span id="cb171-112"><a href="asteroids.html#cb171-112"></a>  abcg::glUniform2fv(<span class="va">m_translationLoc</span>, <span class="dv">1</span>, &amp;<span class="va">m_translation</span>.x);</span>
<span id="cb171-113"><a href="asteroids.html#cb171-113"></a></span>
<span id="cb171-114"><a href="asteroids.html#cb171-114"></a>  <span class="co">// Restart thruster blink timer every 100 ms</span></span>
<span id="cb171-115"><a href="asteroids.html#cb171-115"></a>  <span class="cf">if</span> (<span class="va">m_trailBlinkTimer</span>.elapsed() &gt; <span class="fl">100.0</span> / <span class="fl">1000.0</span>) <span class="va">m_trailBlinkTimer</span>.restart();</span>
<span id="cb171-116"><a href="asteroids.html#cb171-116"></a></span>
<span id="cb171-117"><a href="asteroids.html#cb171-117"></a>  <span class="cf">if</span> (gameData.<span class="va">m_input</span>[<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up)]) {</span>
<span id="cb171-118"><a href="asteroids.html#cb171-118"></a>    <span class="co">// Show thruster trail during 50 ms</span></span>
<span id="cb171-119"><a href="asteroids.html#cb171-119"></a>    <span class="cf">if</span> (<span class="va">m_trailBlinkTimer</span>.elapsed() &lt; <span class="fl">50.0</span> / <span class="fl">1000.0</span>) {</span>
<span id="cb171-120"><a href="asteroids.html#cb171-120"></a>      abcg::glEnable(GL_BLEND);</span>
<span id="cb171-121"><a href="asteroids.html#cb171-121"></a>      abcg::glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span>
<span id="cb171-122"><a href="asteroids.html#cb171-122"></a></span>
<span id="cb171-123"><a href="asteroids.html#cb171-123"></a>      <span class="co">// 50% transparent</span></span>
<span id="cb171-124"><a href="asteroids.html#cb171-124"></a>      abcg::glUniform4f(<span class="va">m_colorLoc</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span><span class="bu">f</span>);</span>
<span id="cb171-125"><a href="asteroids.html#cb171-125"></a></span>
<span id="cb171-126"><a href="asteroids.html#cb171-126"></a>      abcg::glDrawElements(GL_TRIANGLES, <span class="dv">14</span> * <span class="dv">3</span>, GL_UNSIGNED_INT, <span class="kw">nullptr</span>);</span>
<span id="cb171-127"><a href="asteroids.html#cb171-127"></a></span>
<span id="cb171-128"><a href="asteroids.html#cb171-128"></a>      abcg::glDisable(GL_BLEND);</span>
<span id="cb171-129"><a href="asteroids.html#cb171-129"></a>    }</span>
<span id="cb171-130"><a href="asteroids.html#cb171-130"></a>  }</span>
<span id="cb171-131"><a href="asteroids.html#cb171-131"></a></span>
<span id="cb171-132"><a href="asteroids.html#cb171-132"></a>  abcg::glUniform4fv(<span class="va">m_colorLoc</span>, <span class="dv">1</span>, &amp;<span class="va">m_color</span>.r);</span>
<span id="cb171-133"><a href="asteroids.html#cb171-133"></a>  abcg::glDrawElements(GL_TRIANGLES, <span class="dv">12</span> * <span class="dv">3</span>, GL_UNSIGNED_INT, <span class="kw">nullptr</span>);</span>
<span id="cb171-134"><a href="asteroids.html#cb171-134"></a></span>
<span id="cb171-135"><a href="asteroids.html#cb171-135"></a>  abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb171-136"><a href="asteroids.html#cb171-136"></a></span>
<span id="cb171-137"><a href="asteroids.html#cb171-137"></a>  abcg::glUseProgram(<span class="dv">0</span>);</span>
<span id="cb171-138"><a href="asteroids.html#cb171-138"></a>}</span></code></pre></div>
<p>Note que <code>paintGL</code> retorna imediatamente caso o jogo não esteja no estado <code>State::Playing</code>.</p>
<p>A escala, ângulo de rotação e translação da nave são enviadas às variáveis uniformes nas linhas 110 a 112.</p>
<p>Na linha 115, o temporizador <code>m_trailBlinkTimer</code> é reiniciado a cada 100 milissegundos. Ele é utilizado quando a nave está acelerando, de modo a mostrar o rastro de fogo do foguete durante 50 milissegundos, intercalado com uma pausa também de 50 milissegundos. Para desenhar o rastro de fogo, todos os 14 triângulos da geometria da nave são exibidos usando transparência de 50% (linhas 120 a 128). Isso é necessário pois não é possível desenhar só os dois triângulos finais. Para isso precisaríamos ter de criar um outro VBO, o que daria mais trabalho.</p>
<p>Na linha 133 é renderizado o corpo da nave sem o rastro de fogo, isto é, só são renderizados os primeiros 12 triângulos. Nessa renderização, a nave é renderizada com cor opaca, sobrepondo a renderização anterior da nave 50% transparente.</p>
<p>Note que a função de renderização é <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDrawElements.xhtml"><code>glDrawElements</code></a>. Essa função deve ser utilizada no lugar de <code>glDrawArrays</code> sempre que quisermos renderizar geometria indexada.</p>
<p>A função membro <code>OpenGLWindow::terminateGL</code> contém apenas a liberação do VBO, EBO e VAO:</p>
<div class="sourceCode" id="cb172" startFrom="140"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 139;"><span id="cb172-140"><a href="asteroids.html#cb172-140"></a><span class="dt">void</span> Ship::terminateGL() {</span>
<span id="cb172-141"><a href="asteroids.html#cb172-141"></a>  abcg::glDeleteBuffers(<span class="dv">1</span>, &amp;<span class="va">m_vbo</span>);</span>
<span id="cb172-142"><a href="asteroids.html#cb172-142"></a>  abcg::glDeleteBuffers(<span class="dv">1</span>, &amp;<span class="va">m_ebo</span>);</span>
<span id="cb172-143"><a href="asteroids.html#cb172-143"></a>  abcg::glDeleteVertexArrays(<span class="dv">1</span>, &amp;<span class="va">m_vao</span>);</span>
<span id="cb172-144"><a href="asteroids.html#cb172-144"></a>}</span></code></pre></div>
<p>Na função membro <code>OpenGLWindow::update</code> é onde são atualizados os atributos de orientação e velocidade da nave de acordo com o estado de <code>GameData::m_input</code>:</p>
<div class="sourceCode" id="cb173" startFrom="146"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 145;"><span id="cb173-146"><a href="asteroids.html#cb173-146"></a><span class="dt">void</span> Ship::update(<span class="at">const</span> GameData &amp;gameData, <span class="dt">float</span> deltaTime) {</span>
<span id="cb173-147"><a href="asteroids.html#cb173-147"></a>  <span class="co">// Rotate</span></span>
<span id="cb173-148"><a href="asteroids.html#cb173-148"></a>  <span class="cf">if</span> (gameData.<span class="va">m_input</span>[<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Left)])</span>
<span id="cb173-149"><a href="asteroids.html#cb173-149"></a>    <span class="va">m_rotation</span> = glm::wrapAngle(<span class="va">m_rotation</span> + <span class="fl">4.0</span><span class="bu">f</span> * deltaTime);</span>
<span id="cb173-150"><a href="asteroids.html#cb173-150"></a>  <span class="cf">if</span> (gameData.<span class="va">m_input</span>[<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Right)])</span>
<span id="cb173-151"><a href="asteroids.html#cb173-151"></a>    <span class="va">m_rotation</span> = glm::wrapAngle(<span class="va">m_rotation</span> - <span class="fl">4.0</span><span class="bu">f</span> * deltaTime);</span>
<span id="cb173-152"><a href="asteroids.html#cb173-152"></a></span>
<span id="cb173-153"><a href="asteroids.html#cb173-153"></a>  <span class="co">// Apply thrust</span></span>
<span id="cb173-154"><a href="asteroids.html#cb173-154"></a>  <span class="cf">if</span> (gameData.<span class="va">m_input</span>[<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Up)] &amp;&amp;</span>
<span id="cb173-155"><a href="asteroids.html#cb173-155"></a>      gameData.<span class="va">m_state</span> == State::Playing) {</span>
<span id="cb173-156"><a href="asteroids.html#cb173-156"></a>    <span class="co">// Thrust in the forward vector</span></span>
<span id="cb173-157"><a href="asteroids.html#cb173-157"></a>    glm::vec2 forward = glm::rotate(glm::vec2{<span class="fl">0.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>}, <span class="va">m_rotation</span>);</span>
<span id="cb173-158"><a href="asteroids.html#cb173-158"></a>    <span class="va">m_velocity</span> += forward * deltaTime;</span>
<span id="cb173-159"><a href="asteroids.html#cb173-159"></a>  }</span>
<span id="cb173-160"><a href="asteroids.html#cb173-160"></a>}</span></code></pre></div>
<p>A rotação (linhas 147 a 151) é feita a uma taxa de 4 radianos por segundo (note o uso do <code>deltaTime</code>). A função <code>glm::wrapAngle</code> é utilizada para fazer com que o valor sempre fique no intervalo <span class="math inline">\([0,2\pi]\)</span>.</p>
<p>A aceleração é atualizada no <code>if</code> da linha 154. Na linha 157 é calculado um vetor que indica a direção para onde a nave está apontando (vetor <code>forward</code>). Isso é obtido aplicando uma rotação no vetor <span class="math inline">\([0\; 1]\)</span><a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a> usando o ângulo atual da nave. Uma vez calculado o vetor <code>forward</code>, ele é adicionado ao vetor de velocidade <code>m_velocity</code> na linha 158. Observe novamente o uso do <code>deltaTime</code>. Como <code>forward</code> é um vetor unitário, a velocidade será incrementada em uma unidade por segundo.</p>
<p>Visualmente, a nave ficará presa no centro do viewport, mas os outros objetos da cena (asteroides, estrelas e tiros) usarão <code>m_velocity</code> (na verdade, <code>-m_velocity</code>) para serem deslocados.</p>
<p>Se o código for construído neste momento, o resultado será como mostrado a seguir (use o <a href="https://hbatagelo.github.io/abcgapps/asteroids1/index.html">link original</a> caso queria controlar a nave pelo teclado):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids1/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código do projeto pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids1.zip">deste link</a>.</p>
</div>
</div>
<div id="estrelas" class="section level3 unnumbered">
<h3>Estrelas</h3>
<p>As estrelas serão desenhadas como pontos (<code>GL_POINTS</code>) e usarão os shaders <code>stars.vert</code> e <code>stars.frag</code> definidos a seguir.</p>
<div id="stars.vert" class="section level4 unnumbered">
<h4>stars.vert</h4>
<div class="sourceCode" id="cb174"><pre class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb174-1"><a href="asteroids.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#version 410</span></span>
<span id="cb174-2"><a href="asteroids.html#cb174-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-3"><a href="asteroids.html#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="kw">layout</span>(<span class="dt">location</span> = <span class="dv">0</span>) <span class="dt">in</span> <span class="dt">vec2</span> inPosition;</span>
<span id="cb174-4"><a href="asteroids.html#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="kw">layout</span>(<span class="dt">location</span> = <span class="dv">1</span>) <span class="dt">in</span> <span class="dt">vec3</span> inColor;</span>
<span id="cb174-5"><a href="asteroids.html#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="asteroids.html#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="kw">uniform</span> <span class="dt">vec2</span> translation;</span>
<span id="cb174-7"><a href="asteroids.html#cb174-7" aria-hidden="true" tabindex="-1"></a><span class="kw">uniform</span> <span class="dt">float</span> pointSize;</span>
<span id="cb174-8"><a href="asteroids.html#cb174-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-9"><a href="asteroids.html#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="dt">out</span> <span class="dt">vec4</span> fragColor;</span>
<span id="cb174-10"><a href="asteroids.html#cb174-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-11"><a href="asteroids.html#cb174-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span>() {</span>
<span id="cb174-12"><a href="asteroids.html#cb174-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">gl_PointSize</span> = pointSize;</span>
<span id="cb174-13"><a href="asteroids.html#cb174-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">gl_Position</span> = <span class="dt">vec4</span>(inPosition.<span class="fu">xy</span> + translation, <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb174-14"><a href="asteroids.html#cb174-14" aria-hidden="true" tabindex="-1"></a>  fragColor = <span class="dt">vec4</span>(inColor, <span class="dv">1</span>);</span>
<span id="cb174-15"><a href="asteroids.html#cb174-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Os atributos de entrada são uma posição <span class="math inline">\((x,y)\)</span> (<code>inPosition</code>) e uma cor RGB (<code>inColor</code>). Em <code>main</code>, a cor de entrada é copiada para o atributo de saída (<code>fragColor</code>) como uma cor RGBA onde A é 1. A posição do ponto é deslocada por <code>translation</code>, e o tamanho do ponto é definido por <code>pointSize</code>.</p>
</div>
<div id="stars.frag" class="section level4 unnumbered">
<h4>stars.frag</h4>
<div class="sourceCode" id="cb175"><pre class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb175-1"><a href="asteroids.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#version 410</span></span>
<span id="cb175-2"><a href="asteroids.html#cb175-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-3"><a href="asteroids.html#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="dt">in</span> <span class="dt">vec4</span> fragColor;</span>
<span id="cb175-4"><a href="asteroids.html#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="asteroids.html#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="dt">out</span> <span class="dt">vec4</span> outColor;</span>
<span id="cb175-6"><a href="asteroids.html#cb175-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-7"><a href="asteroids.html#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span>() {</span>
<span id="cb175-8"><a href="asteroids.html#cb175-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> intensity = <span class="fl">1.0</span> - <span class="bu">length</span>(<span class="bu">gl_PointCoord</span> - <span class="dt">vec2</span>(<span class="fl">0.5</span>)) * <span class="fl">2.0</span>;</span>
<span id="cb175-9"><a href="asteroids.html#cb175-9" aria-hidden="true" tabindex="-1"></a>  outColor = fragColor * intensity;</span>
<span id="cb175-10"><a href="asteroids.html#cb175-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>O processamento principal deste shader ocorre na definição da variável <code>intensity</code>. Para compreendermos o que está acontecendo, lembre-se primeiro que o tamanho de um ponto (<code>gl_PointSize</code>) é dado em pixels, e tamanhos maiores que 1 fazem com que o pipeline renderize um quadrado centralizado na posição de cada ponto. O fragment shader explora esse fato para exibir um gradiente radial no quadrado de modo a simular o formato circular de uma estrela. A variável embutida <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/gl_PointCoord.xhtml"><code>gl_PointCoord</code></a> contém as coordenadas do fragmento dentro do quadrado. Na configuração padrão, <span class="math inline">\((0,0)\)</span> é o canto superior esquerdo, e <span class="math inline">\((1,1)\)</span> é o canto inferior direito (figura <a href="asteroids.html#fig:stars1">5.8</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:stars1"></span>
<img src="images/05_stars1.svg" alt="Quadrado gerado em torno de um ponto de `GL_POINTS`, e coordenadas de `gl_PointCoord` dentro do quadrado formado." width="70%" />
<p class="caption">
Figura 5.8: Quadrado gerado em torno de um ponto de <code>GL_POINTS</code>, e coordenadas de <code>gl_PointCoord</code> dentro do quadrado formado.
</p>
</div>
<p>A expressão <code>length(gl_PointCoord - vec2(0.5))</code> calcula a distância euclidiana até o centro do quadrado. Na direção em <span class="math inline">\(x\)</span> e <span class="math inline">\(y\)</span>, essa distância está no intervalo <span class="math inline">\([0,0.5]\)</span>. A distância é convertida em uma intensidade de luz armazenada em <code>intensity</code>, sendo que a intensidade é máxima (1) no centro do quadrado. A cor de saída é multiplicada por essa intensidade. Se o quadrado for branco, o resultado será como o mostrado na figura <a href="asteroids.html#fig:stars2">5.9</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:stars2"></span>
<img src="images/05_stars2.svg" alt="Gradiente radial produzido por `stars.frag` no quadrado de um ponto definido com `GL_POINTS`." width="60%" />
<p class="caption">
Figura 5.9: Gradiente radial produzido por <code>stars.frag</code> no quadrado de um ponto definido com <code>GL_POINTS</code>.
</p>
</div>
</div>
<div id="atualizando-openglwindow.hpp" class="section level4 unnumbered">
<h4>Atualizando openglwindow.hpp</h4>
<p>Para a implementação das estrelas, precisamos definir em <code>OpenGLWindow</code> o identificador dos shaders <code>m_starsProgram</code> e a instância de <code>StarLayers</code>. O código atualizado ficará como a seguir:</p>
<div class="sourceCode" id="cb176" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb176-1"><a href="asteroids.html#cb176-1"></a><span class="pp">#ifndef OPENGLWINDOW_HPP_</span></span>
<span id="cb176-2"><a href="asteroids.html#cb176-2"></a><span class="pp">#define OPENGLWINDOW_HPP_</span></span>
<span id="cb176-3"><a href="asteroids.html#cb176-3"></a></span>
<span id="cb176-4"><a href="asteroids.html#cb176-4"></a><span class="pp">#include </span><span class="im">&lt;imgui.h&gt;</span></span>
<span id="cb176-5"><a href="asteroids.html#cb176-5"></a></span>
<span id="cb176-6"><a href="asteroids.html#cb176-6"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb176-7"><a href="asteroids.html#cb176-7"></a></span>
<span id="cb176-8"><a href="asteroids.html#cb176-8"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb176-9"><a href="asteroids.html#cb176-9"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb176-10"><a href="asteroids.html#cb176-10"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb176-11"><a href="asteroids.html#cb176-11"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb176-12"><a href="asteroids.html#cb176-12"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb176-13"><a href="asteroids.html#cb176-13"></a></span>
<span id="cb176-14"><a href="asteroids.html#cb176-14"></a><span class="kw">class</span> OpenGLWindow : <span class="kw">public</span> abcg::OpenGLWindow {</span>
<span id="cb176-15"><a href="asteroids.html#cb176-15"></a> <span class="kw">protected</span>:</span>
<span id="cb176-16"><a href="asteroids.html#cb176-16"></a>  <span class="dt">void</span> handleEvent(SDL_Event&amp; event) <span class="kw">override</span>;</span>
<span id="cb176-17"><a href="asteroids.html#cb176-17"></a>  <span class="dt">void</span> initializeGL() <span class="kw">override</span>;</span>
<span id="cb176-18"><a href="asteroids.html#cb176-18"></a>  <span class="dt">void</span> paintGL() <span class="kw">override</span>;</span>
<span id="cb176-19"><a href="asteroids.html#cb176-19"></a>  <span class="dt">void</span> paintUI() <span class="kw">override</span>;</span>
<span id="cb176-20"><a href="asteroids.html#cb176-20"></a>  <span class="dt">void</span> resizeGL(<span class="dt">int</span> width, <span class="dt">int</span> height) <span class="kw">override</span>;</span>
<span id="cb176-21"><a href="asteroids.html#cb176-21"></a>  <span class="dt">void</span> terminateGL() <span class="kw">override</span>;</span>
<span id="cb176-22"><a href="asteroids.html#cb176-22"></a></span>
<span id="cb176-23"><a href="asteroids.html#cb176-23"></a> <span class="kw">private</span>:</span>
<span id="cb176-24"><a href="asteroids.html#cb176-24"></a>  GLuint <span class="va">m_starsProgram</span>{};</span>
<span id="cb176-25"><a href="asteroids.html#cb176-25"></a>  GLuint <span class="va">m_objectsProgram</span>{};</span>
<span id="cb176-26"><a href="asteroids.html#cb176-26"></a></span>
<span id="cb176-27"><a href="asteroids.html#cb176-27"></a>  <span class="dt">int</span> <span class="va">m_viewportWidth</span>{};</span>
<span id="cb176-28"><a href="asteroids.html#cb176-28"></a>  <span class="dt">int</span> <span class="va">m_viewportHeight</span>{};</span>
<span id="cb176-29"><a href="asteroids.html#cb176-29"></a></span>
<span id="cb176-30"><a href="asteroids.html#cb176-30"></a>  GameData <span class="va">m_gameData</span>;</span>
<span id="cb176-31"><a href="asteroids.html#cb176-31"></a></span>
<span id="cb176-32"><a href="asteroids.html#cb176-32"></a>  Ship <span class="va">m_ship</span>;</span>
<span id="cb176-33"><a href="asteroids.html#cb176-33"></a>  StarLayers <span class="va">m_starLayers</span>;</span>
<span id="cb176-34"><a href="asteroids.html#cb176-34"></a></span>
<span id="cb176-35"><a href="asteroids.html#cb176-35"></a>  abcg::ElapsedTimer <span class="va">m_restartWaitTimer</span>;</span>
<span id="cb176-36"><a href="asteroids.html#cb176-36"></a></span>
<span id="cb176-37"><a href="asteroids.html#cb176-37"></a>  ImFont* <span class="va">m_font</span>{};</span>
<span id="cb176-38"><a href="asteroids.html#cb176-38"></a></span>
<span id="cb176-39"><a href="asteroids.html#cb176-39"></a>  <span class="bu">std::</span>default_random_engine <span class="va">m_randomEngine</span>;</span>
<span id="cb176-40"><a href="asteroids.html#cb176-40"></a></span>
<span id="cb176-41"><a href="asteroids.html#cb176-41"></a>  <span class="dt">void</span> restart();</span>
<span id="cb176-42"><a href="asteroids.html#cb176-42"></a>  <span class="dt">void</span> update();</span>
<span id="cb176-43"><a href="asteroids.html#cb176-43"></a>};</span>
<span id="cb176-44"><a href="asteroids.html#cb176-44"></a></span>
<span id="cb176-45"><a href="asteroids.html#cb176-45"></a><span class="pp">#endif</span></span></code></pre></div>
</div>
<div id="atualizando-openglwindow.cpp" class="section level4 unnumbered">
<h4>Atualizando openglwindow.cpp</h4>
<p>Precisamos atualizar também as funções membro de <code>OpenGLWindow</code>:</p>
<ul>
<li><p>Em <code>OpenGLWindow::initializeGL</code>, inclua o seguinte código para compilar os novos shaders:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb177-1"><a href="asteroids.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create program to render the stars</span></span>
<span id="cb177-2"><a href="asteroids.html#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starsProgram</span> = createProgramFromFile(getAssetsPath() + <span class="st">&quot;stars.vert&quot;</span>,</span>
<span id="cb177-3"><a href="asteroids.html#cb177-3" aria-hidden="true" tabindex="-1"></a>                                       getAssetsPath() + <span class="st">&quot;stars.frag&quot;</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::restart</code>, inclua a chamada a <code>initializeGL</code> de <code>StarLayers</code> junto com a chamada de <code>initializeGL</code> de <code>Ship</code>:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb178-1"><a href="asteroids.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.initializeGL(<span class="va">m_starsProgram</span>, <span class="dv">25</span>);</span>
<span id="cb178-2"><a href="asteroids.html#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.initializeGL(<span class="va">m_objectsProgram</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::update</code>, chame a função <code>update</code> de <code>StarLayers</code> <strong>depois</strong> da chamada de <code>update</code> de <code>Ship</code>, assim:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb179-1"><a href="asteroids.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.update(<span class="va">m_gameData</span>, deltaTime);</span>
<span id="cb179-2"><a href="asteroids.html#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.update(<span class="va">m_ship</span>, deltaTime);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::paintGL</code>, chame <code>paintGL</code> de <code>StarLayers</code> <strong>antes</strong> de <code>paintGL</code> de <code>Ship</code>, assim:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb180-1"><a href="asteroids.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.paintGL();</span>
<span id="cb180-2"><a href="asteroids.html#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.paintGL(<span class="va">m_gameData</span>);</span></code></pre></div></li>
<li><p>Por fim, modifique <code>OpenGLWindow::terminateGL</code> da seguinte forma:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb181-1"><a href="asteroids.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> OpenGLWindow::terminateGL() {</span>
<span id="cb181-2"><a href="asteroids.html#cb181-2" aria-hidden="true" tabindex="-1"></a>  abcg::glDeleteProgram(<span class="va">m_starsProgram</span>);</span>
<span id="cb181-3"><a href="asteroids.html#cb181-3" aria-hidden="true" tabindex="-1"></a>  abcg::glDeleteProgram(<span class="va">m_objectsProgram</span>);</span>
<span id="cb181-4"><a href="asteroids.html#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="asteroids.html#cb181-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">m_ship</span>.terminateGL();</span>
<span id="cb181-6"><a href="asteroids.html#cb181-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">m_starLayers</span>.terminateGL();</span>
<span id="cb181-7"><a href="asteroids.html#cb181-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ul>
</div>
<div id="starlayers.hpp" class="section level4 unnumbered">
<h4>starlayers.hpp</h4>
<p>A definição da classe <code>StarLayers</code> ficará assim:</p>
<div class="sourceCode" id="cb182" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb182-1"><a href="asteroids.html#cb182-1"></a><span class="pp">#ifndef STARLAYERS_HPP_</span></span>
<span id="cb182-2"><a href="asteroids.html#cb182-2"></a><span class="pp">#define STARLAYERS_HPP_</span></span>
<span id="cb182-3"><a href="asteroids.html#cb182-3"></a></span>
<span id="cb182-4"><a href="asteroids.html#cb182-4"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb182-5"><a href="asteroids.html#cb182-5"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb182-6"><a href="asteroids.html#cb182-6"></a></span>
<span id="cb182-7"><a href="asteroids.html#cb182-7"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb182-8"><a href="asteroids.html#cb182-8"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb182-9"><a href="asteroids.html#cb182-9"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb182-10"><a href="asteroids.html#cb182-10"></a></span>
<span id="cb182-11"><a href="asteroids.html#cb182-11"></a><span class="kw">class</span> OpenGLWindow;</span>
<span id="cb182-12"><a href="asteroids.html#cb182-12"></a></span>
<span id="cb182-13"><a href="asteroids.html#cb182-13"></a><span class="kw">class</span> StarLayers {</span>
<span id="cb182-14"><a href="asteroids.html#cb182-14"></a> <span class="kw">public</span>:</span>
<span id="cb182-15"><a href="asteroids.html#cb182-15"></a>  <span class="dt">void</span> initializeGL(GLuint program, <span class="dt">int</span> quantity);</span>
<span id="cb182-16"><a href="asteroids.html#cb182-16"></a>  <span class="dt">void</span> paintGL();</span>
<span id="cb182-17"><a href="asteroids.html#cb182-17"></a>  <span class="dt">void</span> terminateGL();</span>
<span id="cb182-18"><a href="asteroids.html#cb182-18"></a></span>
<span id="cb182-19"><a href="asteroids.html#cb182-19"></a>  <span class="dt">void</span> update(<span class="at">const</span> Ship &amp;ship, <span class="dt">float</span> deltaTime);</span>
<span id="cb182-20"><a href="asteroids.html#cb182-20"></a></span>
<span id="cb182-21"><a href="asteroids.html#cb182-21"></a> <span class="kw">private</span>:</span>
<span id="cb182-22"><a href="asteroids.html#cb182-22"></a>  <span class="kw">friend</span> OpenGLWindow;</span>
<span id="cb182-23"><a href="asteroids.html#cb182-23"></a></span>
<span id="cb182-24"><a href="asteroids.html#cb182-24"></a>  GLuint <span class="va">m_program</span>{};</span>
<span id="cb182-25"><a href="asteroids.html#cb182-25"></a>  GLint <span class="va">m_pointSizeLoc</span>{};</span>
<span id="cb182-26"><a href="asteroids.html#cb182-26"></a>  GLint <span class="va">m_translationLoc</span>{};</span>
<span id="cb182-27"><a href="asteroids.html#cb182-27"></a></span>
<span id="cb182-28"><a href="asteroids.html#cb182-28"></a>  <span class="kw">struct</span> StarLayer {</span>
<span id="cb182-29"><a href="asteroids.html#cb182-29"></a>    GLuint <span class="va">m_vao</span>{};</span>
<span id="cb182-30"><a href="asteroids.html#cb182-30"></a>    GLuint <span class="va">m_vbo</span>{};</span>
<span id="cb182-31"><a href="asteroids.html#cb182-31"></a></span>
<span id="cb182-32"><a href="asteroids.html#cb182-32"></a>    <span class="dt">float</span> <span class="va">m_pointSize</span>{};</span>
<span id="cb182-33"><a href="asteroids.html#cb182-33"></a>    <span class="dt">int</span> <span class="va">m_quantity</span>{};</span>
<span id="cb182-34"><a href="asteroids.html#cb182-34"></a>    glm::vec2 <span class="va">m_translation</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb182-35"><a href="asteroids.html#cb182-35"></a>  };</span>
<span id="cb182-36"><a href="asteroids.html#cb182-36"></a></span>
<span id="cb182-37"><a href="asteroids.html#cb182-37"></a>  <span class="bu">std::</span>array&lt;StarLayer, <span class="dv">5</span>&gt; <span class="va">m_starLayers</span>;</span>
<span id="cb182-38"><a href="asteroids.html#cb182-38"></a></span>
<span id="cb182-39"><a href="asteroids.html#cb182-39"></a>  <span class="bu">std::</span>default_random_engine <span class="va">m_randomEngine</span>;</span>
<span id="cb182-40"><a href="asteroids.html#cb182-40"></a>};</span>
<span id="cb182-41"><a href="asteroids.html#cb182-41"></a></span>
<span id="cb182-42"><a href="asteroids.html#cb182-42"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Nas linhas 28 a 35 é definida <code>StarLayer</code>. A estrutura contém o VBO e VAO dos pontos que formam uma camada de estrelas, o tamanho (<code>m_pointSize</code>) e quantidade (<code>m_quantity</code>) de pontos, e um fator de translação (<code>m_translation</code>) utilizado para deslocar todos os pontos da camada (isto é, todos os vértices do VBO).</p>
<p>Na linha 37 é definido um arranjo de cinco instâncias de <code>StarLayer</code>, pois renderizaremos cinco camadas de estrelas.</p>
</div>
<div id="starlayers.cpp" class="section level4 unnumbered">
<h4>starlayers.cpp</h4>
<p>O arquivo começa com a definição de <code>StarLayers::initializeGL</code>:</p>
<div class="sourceCode" id="cb183" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb183-1"><a href="asteroids.html#cb183-1"></a><span class="pp">#include </span><span class="im">&quot;starlayers.hpp&quot;</span></span>
<span id="cb183-2"><a href="asteroids.html#cb183-2"></a></span>
<span id="cb183-3"><a href="asteroids.html#cb183-3"></a><span class="pp">#include </span><span class="im">&lt;cppitertools/itertools.hpp&gt;</span></span>
<span id="cb183-4"><a href="asteroids.html#cb183-4"></a></span>
<span id="cb183-5"><a href="asteroids.html#cb183-5"></a><span class="dt">void</span> StarLayers::initializeGL(GLuint program, <span class="dt">int</span> quantity) {</span>
<span id="cb183-6"><a href="asteroids.html#cb183-6"></a>  terminateGL();</span>
<span id="cb183-7"><a href="asteroids.html#cb183-7"></a></span>
<span id="cb183-8"><a href="asteroids.html#cb183-8"></a>  <span class="co">// Start pseudo-random number generator</span></span>
<span id="cb183-9"><a href="asteroids.html#cb183-9"></a>  <span class="va">m_randomEngine</span>.seed(</span>
<span id="cb183-10"><a href="asteroids.html#cb183-10"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now().time_since_epoch().count());</span>
<span id="cb183-11"><a href="asteroids.html#cb183-11"></a></span>
<span id="cb183-12"><a href="asteroids.html#cb183-12"></a>  <span class="va">m_program</span> = program;</span>
<span id="cb183-13"><a href="asteroids.html#cb183-13"></a>  <span class="va">m_pointSizeLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;pointSize&quot;</span>);</span>
<span id="cb183-14"><a href="asteroids.html#cb183-14"></a>  <span class="va">m_translationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;translation&quot;</span>);</span>
<span id="cb183-15"><a href="asteroids.html#cb183-15"></a></span>
<span id="cb183-16"><a href="asteroids.html#cb183-16"></a>  <span class="kw">auto</span> &amp;re{<span class="va">m_randomEngine</span>};</span>
<span id="cb183-17"><a href="asteroids.html#cb183-17"></a>  <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; distPos(-<span class="fl">1.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>);</span>
<span id="cb183-18"><a href="asteroids.html#cb183-18"></a>  <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; distIntensity(<span class="fl">0.5</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>);</span>
<span id="cb183-19"><a href="asteroids.html#cb183-19"></a></span>
<span id="cb183-20"><a href="asteroids.html#cb183-20"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;&amp;[index, layer] : iter::enumerate(<span class="va">m_starLayers</span>)) {</span>
<span id="cb183-21"><a href="asteroids.html#cb183-21"></a>    layer.<span class="va">m_pointSize</span> = <span class="fl">10.0</span><span class="bu">f</span> / (<span class="fl">1.0</span><span class="bu">f</span> + index);</span>
<span id="cb183-22"><a href="asteroids.html#cb183-22"></a>    layer.<span class="va">m_quantity</span> = quantity * (<span class="kw">static_cast</span>&lt;<span class="dt">int</span>&gt;(index) + <span class="dv">1</span>);</span>
<span id="cb183-23"><a href="asteroids.html#cb183-23"></a>    layer.<span class="va">m_translation</span> = glm::vec2(<span class="dv">0</span>);</span>
<span id="cb183-24"><a href="asteroids.html#cb183-24"></a></span>
<span id="cb183-25"><a href="asteroids.html#cb183-25"></a>    <span class="bu">std::</span>vector&lt;glm::vec3&gt; data(<span class="dv">0</span>);</span>
<span id="cb183-26"><a href="asteroids.html#cb183-26"></a>    <span class="cf">for</span> ([[<span class="at">maybe_unused</span>]] <span class="kw">auto</span> i : iter::range(<span class="dv">0</span>, layer.<span class="va">m_quantity</span>)) {</span>
<span id="cb183-27"><a href="asteroids.html#cb183-27"></a>      data.emplace_back(distPos(re), distPos(re), <span class="dv">0</span>);</span>
<span id="cb183-28"><a href="asteroids.html#cb183-28"></a>      data.push_back(glm::vec3(<span class="dv">1</span>) * distIntensity(re));</span>
<span id="cb183-29"><a href="asteroids.html#cb183-29"></a>    }</span>
<span id="cb183-30"><a href="asteroids.html#cb183-30"></a></span>
<span id="cb183-31"><a href="asteroids.html#cb183-31"></a>    <span class="co">// Generate VBO</span></span>
<span id="cb183-32"><a href="asteroids.html#cb183-32"></a>    abcg::glGenBuffers(<span class="dv">1</span>, &amp;layer.<span class="va">m_vbo</span>);</span>
<span id="cb183-33"><a href="asteroids.html#cb183-33"></a>    abcg::glBindBuffer(GL_ARRAY_BUFFER, layer.<span class="va">m_vbo</span>);</span>
<span id="cb183-34"><a href="asteroids.html#cb183-34"></a>    abcg::glBufferData(GL_ARRAY_BUFFER, data.size() * <span class="kw">sizeof</span>(glm::vec3),</span>
<span id="cb183-35"><a href="asteroids.html#cb183-35"></a>                       data.data(), GL_STATIC_DRAW);</span>
<span id="cb183-36"><a href="asteroids.html#cb183-36"></a>    abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb183-37"><a href="asteroids.html#cb183-37"></a></span>
<span id="cb183-38"><a href="asteroids.html#cb183-38"></a>    <span class="co">// Get location of attributes in the program</span></span>
<span id="cb183-39"><a href="asteroids.html#cb183-39"></a>    GLint positionAttribute{abcg::glGetAttribLocation(<span class="va">m_program</span>, <span class="st">&quot;inPosition&quot;</span>)};</span>
<span id="cb183-40"><a href="asteroids.html#cb183-40"></a>    GLint colorAttribute{abcg::glGetAttribLocation(<span class="va">m_program</span>, <span class="st">&quot;inColor&quot;</span>)};</span>
<span id="cb183-41"><a href="asteroids.html#cb183-41"></a></span>
<span id="cb183-42"><a href="asteroids.html#cb183-42"></a>    <span class="co">// Create VAO</span></span>
<span id="cb183-43"><a href="asteroids.html#cb183-43"></a>    abcg::glGenVertexArrays(<span class="dv">1</span>, &amp;layer.<span class="va">m_vao</span>);</span>
<span id="cb183-44"><a href="asteroids.html#cb183-44"></a></span>
<span id="cb183-45"><a href="asteroids.html#cb183-45"></a>    <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb183-46"><a href="asteroids.html#cb183-46"></a>    abcg::glBindVertexArray(layer.<span class="va">m_vao</span>);</span>
<span id="cb183-47"><a href="asteroids.html#cb183-47"></a></span>
<span id="cb183-48"><a href="asteroids.html#cb183-48"></a>    abcg::glBindBuffer(GL_ARRAY_BUFFER, layer.<span class="va">m_vbo</span>);</span>
<span id="cb183-49"><a href="asteroids.html#cb183-49"></a>    abcg::glEnableVertexAttribArray(positionAttribute);</span>
<span id="cb183-50"><a href="asteroids.html#cb183-50"></a>    abcg::glVertexAttribPointer(positionAttribute, <span class="dv">2</span>, GL_FLOAT, GL_FALSE,</span>
<span id="cb183-51"><a href="asteroids.html#cb183-51"></a>                                <span class="kw">sizeof</span>(glm::vec3) * <span class="dv">2</span>, <span class="kw">nullptr</span>);</span>
<span id="cb183-52"><a href="asteroids.html#cb183-52"></a>    abcg::glEnableVertexAttribArray(colorAttribute);</span>
<span id="cb183-53"><a href="asteroids.html#cb183-53"></a>    abcg::glVertexAttribPointer(colorAttribute, <span class="dv">3</span>, GL_FLOAT, GL_FALSE,</span>
<span id="cb183-54"><a href="asteroids.html#cb183-54"></a>                                <span class="kw">sizeof</span>(glm::vec3) * <span class="dv">2</span>,</span>
<span id="cb183-55"><a href="asteroids.html#cb183-55"></a>                                <span class="kw">reinterpret_cast</span>&lt;<span class="dt">void</span> *&gt;(<span class="kw">sizeof</span>(glm::vec3)));</span>
<span id="cb183-56"><a href="asteroids.html#cb183-56"></a>    abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb183-57"><a href="asteroids.html#cb183-57"></a></span>
<span id="cb183-58"><a href="asteroids.html#cb183-58"></a>    <span class="co">// End of binding to current VAO</span></span>
<span id="cb183-59"><a href="asteroids.html#cb183-59"></a>    abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb183-60"><a href="asteroids.html#cb183-60"></a>  }</span>
<span id="cb183-61"><a href="asteroids.html#cb183-61"></a>}</span></code></pre></div>
<p>O laço da linha 20 itera sobre cada elemento de <code>m_starLayers</code>. A expressão na linha 21 faz com que os pontos tenham tamanho <code>10</code> na 1ª camada, <code>5</code> na 2ª camada, <code>2.5</code> na 3ª camada, e assim sucessivamente. Na linha 22, a quantidade de pontos é dobrada a cada camada.</p>
<p>Na linha 25 é criado um arranjo <code>data</code> com dados dos pontos da camada. Os dados ficarão intercalados no formato <span class="math inline">\(\{x,y,0,r,g,b,x,y,0,r,g,b,\dots\}\)</span>, onde <span class="math inline">\((x,y,0)\)</span> é a posição do ponto, e <span class="math inline">\((r,g,b)\)</span> é a cor do ponto. Dentro do laço, as coordenadas <span class="math inline">\(x\)</span> e <span class="math inline">\(y\)</span> de cada ponto são escolhidas de forma aleatória dentro do intervalo <span class="math inline">\([-1,1]\)</span>. A cor de cada ponto é um tom de cinza escolhido aleatoriamente do intervalo <span class="math inline">\([0.5,1]\)</span>.</p>
<p>Os dados de <code>data</code> são copiados para o VBO através de <code>glBufferData</code> na linha 34.</p>
<p>Observe nas linhas 48 a 56 como é feito o mapeamento do VBO com os atributos <code>inPosition</code> (do tipo <code>vec2</code>) e <code>inColor</code> (do tipo <code>vec4</code>) do vertex shader. O stride do VBO é <code>sizeof(glm::vec3) * 2</code> (isto é, dois <code>vec3</code>). Na linha 55, o deslocamento no início do VBO é <code>sizeof(glm::vec3)</code> (isto é, apenas um <code>vec3</code>). O <em>cast</em> de tipo é necessário porque o parâmetro de deslocamento é do tipo <code>const void *</code> (é assim por razões históricas).</p>
<p>A definição de <code>StarLayers::paintGL</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb184" startFrom="63"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 62;"><span id="cb184-63"><a href="asteroids.html#cb184-63"></a><span class="dt">void</span> StarLayers::paintGL() {</span>
<span id="cb184-64"><a href="asteroids.html#cb184-64"></a>  abcg::glUseProgram(<span class="va">m_program</span>);</span>
<span id="cb184-65"><a href="asteroids.html#cb184-65"></a></span>
<span id="cb184-66"><a href="asteroids.html#cb184-66"></a>  abcg::glEnable(GL_BLEND);</span>
<span id="cb184-67"><a href="asteroids.html#cb184-67"></a>  abcg::glBlendFunc(GL_ONE, GL_ONE);</span>
<span id="cb184-68"><a href="asteroids.html#cb184-68"></a></span>
<span id="cb184-69"><a href="asteroids.html#cb184-69"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;layer : <span class="va">m_starLayers</span>) {</span>
<span id="cb184-70"><a href="asteroids.html#cb184-70"></a>    abcg::glBindVertexArray(layer.<span class="va">m_vao</span>);</span>
<span id="cb184-71"><a href="asteroids.html#cb184-71"></a>    abcg::glUniform1f(<span class="va">m_pointSizeLoc</span>, layer.<span class="va">m_pointSize</span>);</span>
<span id="cb184-72"><a href="asteroids.html#cb184-72"></a></span>
<span id="cb184-73"><a href="asteroids.html#cb184-73"></a>    <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> i : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb184-74"><a href="asteroids.html#cb184-74"></a>      <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> j : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb184-75"><a href="asteroids.html#cb184-75"></a>        abcg::glUniform2f(<span class="va">m_translationLoc</span>, layer.<span class="va">m_translation</span>.x + j,</span>
<span id="cb184-76"><a href="asteroids.html#cb184-76"></a>                          layer.<span class="va">m_translation</span>.y + i);</span>
<span id="cb184-77"><a href="asteroids.html#cb184-77"></a></span>
<span id="cb184-78"><a href="asteroids.html#cb184-78"></a>        abcg::glDrawArrays(GL_POINTS, <span class="dv">0</span>, layer.<span class="va">m_quantity</span>);</span>
<span id="cb184-79"><a href="asteroids.html#cb184-79"></a>      }</span>
<span id="cb184-80"><a href="asteroids.html#cb184-80"></a>    }</span>
<span id="cb184-81"><a href="asteroids.html#cb184-81"></a></span>
<span id="cb184-82"><a href="asteroids.html#cb184-82"></a>    abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb184-83"><a href="asteroids.html#cb184-83"></a>  }</span>
<span id="cb184-84"><a href="asteroids.html#cb184-84"></a></span>
<span id="cb184-85"><a href="asteroids.html#cb184-85"></a>  abcg::glDisable(GL_BLEND);</span>
<span id="cb184-86"><a href="asteroids.html#cb184-86"></a></span>
<span id="cb184-87"><a href="asteroids.html#cb184-87"></a>  abcg::glUseProgram(<span class="dv">0</span>);</span>
<span id="cb184-88"><a href="asteroids.html#cb184-88"></a>}</span></code></pre></div>
<p>Observe que os pontos são desenhados com o modo de mistura de cor habilitado. Na linha 67, a definição da função de mistura com fatores <code>GL_ONE</code> faz com que as cores produzidas pelo fragment shader sejam somadas com as cores atuais do framebuffer. Isso produz um efeito cumulativo de intensidade da luz quando estrelas de camadas diferentes são renderizadas na mesma posição.</p>
<p>Os laços aninhados nas linhas 73 e 74 produzem índices <code>i</code> e <code>j</code> que são usados em <code>layer.m_translation</code> para replicar o desenho das estrelas em uma grade 3x3 em torno da região visível do NDC, como vimos no início da seção.</p>
<p>Na linha 85, o modo de mistura de cor é desabilitado para não afetar a renderização dos outros objetos de cena que são totalmente opacos.</p>
<p>Em <code>StarLayers::terminateGL</code> são liberados os VBOs e VAOs de todas as instâncias de <code>StarLayer</code>:</p>
<div class="sourceCode" id="cb185" startFrom="90"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 89;"><span id="cb185-90"><a href="asteroids.html#cb185-90"></a><span class="dt">void</span> StarLayers::terminateGL() {</span>
<span id="cb185-91"><a href="asteroids.html#cb185-91"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;layer : <span class="va">m_starLayers</span>) {</span>
<span id="cb185-92"><a href="asteroids.html#cb185-92"></a>    abcg::glDeleteBuffers(<span class="dv">1</span>, &amp;layer.<span class="va">m_vbo</span>);</span>
<span id="cb185-93"><a href="asteroids.html#cb185-93"></a>    abcg::glDeleteVertexArrays(<span class="dv">1</span>, &amp;layer.<span class="va">m_vao</span>);</span>
<span id="cb185-94"><a href="asteroids.html#cb185-94"></a>  }</span>
<span id="cb185-95"><a href="asteroids.html#cb185-95"></a>}</span></code></pre></div>
<p>Em <code>StarLayers::update</code>, a translação (<code>m_translation</code>) de cada camada é atualizada de acordo com a velocidade da nave. Se a nave está indo para a frente, então a camada de estrelas deve ir para trás: por isso a subtração de <code>ship.m_velocity</code>. A velocidade é multiplicada por um fator de escala <code>layerSpeedScale</code> para fazer com que a primeira camada seja mais rápida que a segunda, e assim sucessivamente para produzir o efeito de paralaxe.</p>
<p>Nas linhas 103 a 106 há uma série de condicionais que testam se os pontos saíram dos limites da região visível do NDC. Se sim, são deslocados para o lado oposto.</p>
<div class="sourceCode" id="cb186" startFrom="97"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 96;"><span id="cb186-97"><a href="asteroids.html#cb186-97"></a><span class="dt">void</span> StarLayers::update(<span class="at">const</span> Ship &amp;ship, <span class="dt">float</span> deltaTime) {</span>
<span id="cb186-98"><a href="asteroids.html#cb186-98"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;&amp;[index, layer] : iter::enumerate(<span class="va">m_starLayers</span>)) {</span>
<span id="cb186-99"><a href="asteroids.html#cb186-99"></a>    <span class="at">const</span> <span class="kw">auto</span> layerSpeedScale{<span class="fl">1.0</span><span class="bu">f</span> / (index + <span class="fl">2.0</span><span class="bu">f</span>)};</span>
<span id="cb186-100"><a href="asteroids.html#cb186-100"></a>    layer.<span class="va">m_translation</span> -= ship.<span class="va">m_velocity</span> * deltaTime * layerSpeedScale;</span>
<span id="cb186-101"><a href="asteroids.html#cb186-101"></a></span>
<span id="cb186-102"><a href="asteroids.html#cb186-102"></a>    <span class="co">// Wrap-around</span></span>
<span id="cb186-103"><a href="asteroids.html#cb186-103"></a>    <span class="cf">if</span> (layer.<span class="va">m_translation</span>.x &lt; -<span class="fl">1.0</span><span class="bu">f</span>) layer.<span class="va">m_translation</span>.x += <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb186-104"><a href="asteroids.html#cb186-104"></a>    <span class="cf">if</span> (layer.<span class="va">m_translation</span>.x &gt; +<span class="fl">1.0</span><span class="bu">f</span>) layer.<span class="va">m_translation</span>.x -= <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb186-105"><a href="asteroids.html#cb186-105"></a>    <span class="cf">if</span> (layer.<span class="va">m_translation</span>.y &lt; -<span class="fl">1.0</span><span class="bu">f</span>) layer.<span class="va">m_translation</span>.y += <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb186-106"><a href="asteroids.html#cb186-106"></a>    <span class="cf">if</span> (layer.<span class="va">m_translation</span>.y &gt; +<span class="fl">1.0</span><span class="bu">f</span>) layer.<span class="va">m_translation</span>.y -= <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb186-107"><a href="asteroids.html#cb186-107"></a>  }</span>
<span id="cb186-108"><a href="asteroids.html#cb186-108"></a>}</span></code></pre></div>
<p>Nesse momento, o jogo ficará como a seguir (<a href="https://hbatagelo.github.io/abcgapps/asteroids2/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids2/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids2.zip">deste link</a>.</p>
</div>
</div>
<div id="asteroides" class="section level3 unnumbered">
<h3>Asteroides</h3>
<p>Para incluir a implementação dos asteroides, vamos primeiramente atualizar <code>OpenGLWindow</code>.</p>
<div id="atualizando-openglwindow.hpp-1" class="section level4 unnumbered">
<h4>Atualizando openglwindow.hpp</h4>
<p>Adicione a definição de <code>m_asteroids</code> junto às definições dos outros objetos (<code>m_ship</code> e <code>m_starLayers</code>), assim:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb187-1"><a href="asteroids.html#cb187-1" aria-hidden="true" tabindex="-1"></a>Asteroids <span class="va">m_asteroids</span>;</span>
<span id="cb187-2"><a href="asteroids.html#cb187-2" aria-hidden="true" tabindex="-1"></a>Ship <span class="va">m_ship</span>;</span>
<span id="cb187-3"><a href="asteroids.html#cb187-3" aria-hidden="true" tabindex="-1"></a>StarLayers <span class="va">m_starLayers</span>;</span></code></pre></div>
</div>
<div id="atualizando-openglwindow.cpp-1" class="section level4 unnumbered">
<h4>Atualizando openglwindow.cpp</h4>
<ul>
<li><p>Em <code>OpenGLWindow::restart</code>, chame o <code>initializeGL</code> de <code>m_asteroids</code> junto com a chamada de <code>initializeGL</code> dos objetos anteriores:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb188-1"><a href="asteroids.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.initializeGL(<span class="va">m_starsProgram</span>, <span class="dv">25</span>);</span>
<span id="cb188-2"><a href="asteroids.html#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.initializeGL(<span class="va">m_objectsProgram</span>);</span>
<span id="cb188-3"><a href="asteroids.html#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.initializeGL(<span class="va">m_objectsProgram</span>, <span class="dv">3</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::update</code>, chame o <code>update</code> de <code>m_asteroids</code> após o <code>update</code> de <code>m_ship</code>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb189-1"><a href="asteroids.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.update(<span class="va">m_gameData</span>, deltaTime);</span>
<span id="cb189-2"><a href="asteroids.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.update(<span class="va">m_ship</span>, deltaTime);</span>
<span id="cb189-3"><a href="asteroids.html#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.update(<span class="va">m_ship</span>, deltaTime);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::paintGL</code>, chame o <code>paintGL</code> de <code>m_asteroids</code> logo após o <code>paintGL</code> de <code>m_starLayers</code>:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb190-1"><a href="asteroids.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.paintGL();</span>
<span id="cb190-2"><a href="asteroids.html#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.paintGL();</span>
<span id="cb190-3"><a href="asteroids.html#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.paintGL(<span class="va">m_gameData</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::terminateGL</code>, chame o <code>terminateGL</code> de <code>m_asteroids</code> junto com o <code>terminateGL</code> dos outros objetos:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb191-1"><a href="asteroids.html#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.terminateGL();</span>
<span id="cb191-2"><a href="asteroids.html#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.terminateGL();</span>
<span id="cb191-3"><a href="asteroids.html#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.terminateGL();</span></code></pre></div></li>
</ul>
<div class="infobox">
<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1.4em;width:1.4em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#555;overflow:visible;position:relative;"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>
<div class="infoboxtitle">
Observação
</div>
<p>A ordem em que a função <code>paintGL</code> de cada objeto é chamada é importante porque o objeto renderizado por último será desenhado sobre os anteriores que já foram desenhados antes no framebuffer.</p>
<p>Essa forma de renderizar os objetos na ordem do mais distante para o mais próximo é chamada de “algoritmo do pintor” pois é similar ao modo como um pintor desenha sobre uma tela: primeiro é desenhado o fundo (elemento mais distante) e então sobre ele são desenhados os elementos mais próximos.</p>
</div>
</div>
<div id="asteroids.hpp" class="section level4 unnumbered">
<h4>asteroids.hpp</h4>
<p>A definição da classe <code>Asteroids</code> ficará assim:</p>
<div class="sourceCode" id="cb192" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb192-1"><a href="asteroids.html#cb192-1"></a><span class="pp">#ifndef ASTEROIDS_HPP_</span></span>
<span id="cb192-2"><a href="asteroids.html#cb192-2"></a><span class="pp">#define ASTEROIDS_HPP_</span></span>
<span id="cb192-3"><a href="asteroids.html#cb192-3"></a></span>
<span id="cb192-4"><a href="asteroids.html#cb192-4"></a><span class="pp">#include </span><span class="im">&lt;list&gt;</span></span>
<span id="cb192-5"><a href="asteroids.html#cb192-5"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb192-6"><a href="asteroids.html#cb192-6"></a></span>
<span id="cb192-7"><a href="asteroids.html#cb192-7"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb192-8"><a href="asteroids.html#cb192-8"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb192-9"><a href="asteroids.html#cb192-9"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb192-10"><a href="asteroids.html#cb192-10"></a></span>
<span id="cb192-11"><a href="asteroids.html#cb192-11"></a><span class="kw">class</span> OpenGLWindow;</span>
<span id="cb192-12"><a href="asteroids.html#cb192-12"></a></span>
<span id="cb192-13"><a href="asteroids.html#cb192-13"></a><span class="kw">class</span> Asteroids {</span>
<span id="cb192-14"><a href="asteroids.html#cb192-14"></a> <span class="kw">public</span>:</span>
<span id="cb192-15"><a href="asteroids.html#cb192-15"></a>  <span class="dt">void</span> initializeGL(GLuint program, <span class="dt">int</span> quantity);</span>
<span id="cb192-16"><a href="asteroids.html#cb192-16"></a>  <span class="dt">void</span> paintGL();</span>
<span id="cb192-17"><a href="asteroids.html#cb192-17"></a>  <span class="dt">void</span> terminateGL();</span>
<span id="cb192-18"><a href="asteroids.html#cb192-18"></a></span>
<span id="cb192-19"><a href="asteroids.html#cb192-19"></a>  <span class="dt">void</span> update(<span class="at">const</span> Ship &amp;ship, <span class="dt">float</span> deltaTime);</span>
<span id="cb192-20"><a href="asteroids.html#cb192-20"></a></span>
<span id="cb192-21"><a href="asteroids.html#cb192-21"></a> <span class="kw">private</span>:</span>
<span id="cb192-22"><a href="asteroids.html#cb192-22"></a>  <span class="kw">friend</span> OpenGLWindow;</span>
<span id="cb192-23"><a href="asteroids.html#cb192-23"></a></span>
<span id="cb192-24"><a href="asteroids.html#cb192-24"></a>  GLuint <span class="va">m_program</span>{};</span>
<span id="cb192-25"><a href="asteroids.html#cb192-25"></a>  GLint <span class="va">m_colorLoc</span>{};</span>
<span id="cb192-26"><a href="asteroids.html#cb192-26"></a>  GLint <span class="va">m_rotationLoc</span>{};</span>
<span id="cb192-27"><a href="asteroids.html#cb192-27"></a>  GLint <span class="va">m_translationLoc</span>{};</span>
<span id="cb192-28"><a href="asteroids.html#cb192-28"></a>  GLint <span class="va">m_scaleLoc</span>{};</span>
<span id="cb192-29"><a href="asteroids.html#cb192-29"></a></span>
<span id="cb192-30"><a href="asteroids.html#cb192-30"></a>  <span class="kw">struct</span> Asteroid {</span>
<span id="cb192-31"><a href="asteroids.html#cb192-31"></a>    GLuint <span class="va">m_vao</span>{};</span>
<span id="cb192-32"><a href="asteroids.html#cb192-32"></a>    GLuint <span class="va">m_vbo</span>{};</span>
<span id="cb192-33"><a href="asteroids.html#cb192-33"></a></span>
<span id="cb192-34"><a href="asteroids.html#cb192-34"></a>    <span class="dt">float</span> <span class="va">m_angularVelocity</span>{};</span>
<span id="cb192-35"><a href="asteroids.html#cb192-35"></a>    glm::vec4 <span class="va">m_color</span>{<span class="dv">1</span>};</span>
<span id="cb192-36"><a href="asteroids.html#cb192-36"></a>    <span class="dt">bool</span> <span class="va">m_hit</span>{<span class="kw">false</span>};</span>
<span id="cb192-37"><a href="asteroids.html#cb192-37"></a>    <span class="dt">int</span> <span class="va">m_polygonSides</span>{};</span>
<span id="cb192-38"><a href="asteroids.html#cb192-38"></a>    <span class="dt">float</span> <span class="va">m_rotation</span>{};</span>
<span id="cb192-39"><a href="asteroids.html#cb192-39"></a>    <span class="dt">float</span> <span class="va">m_scale</span>{};</span>
<span id="cb192-40"><a href="asteroids.html#cb192-40"></a>    glm::vec2 <span class="va">m_translation</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb192-41"><a href="asteroids.html#cb192-41"></a>    glm::vec2 <span class="va">m_velocity</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb192-42"><a href="asteroids.html#cb192-42"></a>  };</span>
<span id="cb192-43"><a href="asteroids.html#cb192-43"></a></span>
<span id="cb192-44"><a href="asteroids.html#cb192-44"></a>  <span class="bu">std::</span>list&lt;Asteroid&gt; <span class="va">m_asteroids</span>;</span>
<span id="cb192-45"><a href="asteroids.html#cb192-45"></a></span>
<span id="cb192-46"><a href="asteroids.html#cb192-46"></a>  <span class="bu">std::</span>default_random_engine <span class="va">m_randomEngine</span>;</span>
<span id="cb192-47"><a href="asteroids.html#cb192-47"></a>  <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; <span class="va">m_randomDist</span>{-<span class="fl">1.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>};</span>
<span id="cb192-48"><a href="asteroids.html#cb192-48"></a></span>
<span id="cb192-49"><a href="asteroids.html#cb192-49"></a>  Asteroids::Asteroid createAsteroid(glm::vec2 translation = glm::vec2(<span class="dv">0</span>),</span>
<span id="cb192-50"><a href="asteroids.html#cb192-50"></a>                                     <span class="dt">float</span> scale = <span class="fl">0.25</span><span class="bu">f</span>);</span>
<span id="cb192-51"><a href="asteroids.html#cb192-51"></a>};</span>
<span id="cb192-52"><a href="asteroids.html#cb192-52"></a></span>
<span id="cb192-53"><a href="asteroids.html#cb192-53"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Entre as linhas 30 a 42 é definida a estrutura <code>Asteroid</code>. Cada asteroide tem seu próprio VAO e VBO. Além disso possui uma velocidade angular, uma cor, número de lados, ângulo de rotação, escala, translação, vetor de velocidade, e um flag <code>m_hit</code> que indica se o asteroide foi acertado por um tiro.</p>
<p>Na linha 44 é definida uma lista de <code>Asteroid</code>. O número de elementos dessa lista será modificado de acordo com os asteroides que forem acertados pelos tiros. Cada vez que um asteroide for acertado, ele será retirado da lista. Entretanto, se o asteroide for grande, simularemos que ele foi quebrado em vários pedaços e então asteroides menores serão inseridos na lista.</p>
<p>A função membro <code>createAsteroid</code> declarada nas linhas 49 e 50 será utilizada para criar um novo asteroide para ser inserido na lista <code>m_asteroids</code>. O fator de escala (parâmetro <code>scale</code>) permitirá configurar o tamanho do novo asteroide.</p>
</div>
<div id="asteroids.cpp" class="section level4 unnumbered">
<h4>asteroids.cpp</h4>
<p>O arquivo começa com a definição de <code>Asteroids::initializeGL</code>:</p>
<div class="sourceCode" id="cb193" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb193-1"><a href="asteroids.html#cb193-1"></a><span class="pp">#include </span><span class="im">&quot;asteroids.hpp&quot;</span></span>
<span id="cb193-2"><a href="asteroids.html#cb193-2"></a></span>
<span id="cb193-3"><a href="asteroids.html#cb193-3"></a><span class="pp">#include </span><span class="im">&lt;cppitertools/itertools.hpp&gt;</span></span>
<span id="cb193-4"><a href="asteroids.html#cb193-4"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/fast_trigonometry.hpp&gt;</span></span>
<span id="cb193-5"><a href="asteroids.html#cb193-5"></a></span>
<span id="cb193-6"><a href="asteroids.html#cb193-6"></a><span class="dt">void</span> Asteroids::initializeGL(GLuint program, <span class="dt">int</span> quantity) {</span>
<span id="cb193-7"><a href="asteroids.html#cb193-7"></a>  terminateGL();</span>
<span id="cb193-8"><a href="asteroids.html#cb193-8"></a></span>
<span id="cb193-9"><a href="asteroids.html#cb193-9"></a>  <span class="co">// Start pseudo-random number generator</span></span>
<span id="cb193-10"><a href="asteroids.html#cb193-10"></a>  <span class="va">m_randomEngine</span>.seed(</span>
<span id="cb193-11"><a href="asteroids.html#cb193-11"></a>      <span class="bu">std::</span>chrono<span class="bu">::</span>steady_clock<span class="bu">::</span>now().time_since_epoch().count());</span>
<span id="cb193-12"><a href="asteroids.html#cb193-12"></a></span>
<span id="cb193-13"><a href="asteroids.html#cb193-13"></a>  <span class="va">m_program</span> = program;</span>
<span id="cb193-14"><a href="asteroids.html#cb193-14"></a>  <span class="va">m_colorLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;color&quot;</span>);</span>
<span id="cb193-15"><a href="asteroids.html#cb193-15"></a>  <span class="va">m_rotationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;rotation&quot;</span>);</span>
<span id="cb193-16"><a href="asteroids.html#cb193-16"></a>  <span class="va">m_scaleLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;scale&quot;</span>);</span>
<span id="cb193-17"><a href="asteroids.html#cb193-17"></a>  <span class="va">m_translationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;translation&quot;</span>);</span>
<span id="cb193-18"><a href="asteroids.html#cb193-18"></a></span>
<span id="cb193-19"><a href="asteroids.html#cb193-19"></a>  <span class="co">// Create asteroids</span></span>
<span id="cb193-20"><a href="asteroids.html#cb193-20"></a>  <span class="va">m_asteroids</span>.clear();</span>
<span id="cb193-21"><a href="asteroids.html#cb193-21"></a>  <span class="va">m_asteroids</span>.resize(quantity);</span>
<span id="cb193-22"><a href="asteroids.html#cb193-22"></a></span>
<span id="cb193-23"><a href="asteroids.html#cb193-23"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>) {</span>
<span id="cb193-24"><a href="asteroids.html#cb193-24"></a>    asteroid = createAsteroid();</span>
<span id="cb193-25"><a href="asteroids.html#cb193-25"></a></span>
<span id="cb193-26"><a href="asteroids.html#cb193-26"></a>    <span class="co">// Make sure the asteroid won&#39;t collide with the ship</span></span>
<span id="cb193-27"><a href="asteroids.html#cb193-27"></a>    <span class="cf">do</span> {</span>
<span id="cb193-28"><a href="asteroids.html#cb193-28"></a>      asteroid.<span class="va">m_translation</span> = {<span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>),</span>
<span id="cb193-29"><a href="asteroids.html#cb193-29"></a>                                <span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>)};</span>
<span id="cb193-30"><a href="asteroids.html#cb193-30"></a>    } <span class="cf">while</span> (glm::length(asteroid.<span class="va">m_translation</span>) &lt; <span class="fl">0.5</span><span class="bu">f</span>);</span>
<span id="cb193-31"><a href="asteroids.html#cb193-31"></a>  }</span>
<span id="cb193-32"><a href="asteroids.html#cb193-32"></a>}</span></code></pre></div>
<p>Na linha 21, a lista de asteroides é iniciada com uma quantidade <code>quantity</code> de objetos do tipo <code>Asteroid</code>. Essa lista é então iterada no laço das linhas 23 a 31 e o conteúdo de cada asteroide é modificado por <code>Asteroids::createAsteroid</code>. No laço da linha 27 é escolhida uma posição aleatória para o asteroide, mas que esteja longe o suficiente da nave: não queremos que o jogo comece com o asteroide colidindo com a nave!</p>
<p>A definição de <code>Asteroids::paintGL</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb194" startFrom="34"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 33;"><span id="cb194-34"><a href="asteroids.html#cb194-34"></a><span class="dt">void</span> Asteroids::paintGL() {</span>
<span id="cb194-35"><a href="asteroids.html#cb194-35"></a>  abcg::glUseProgram(<span class="va">m_program</span>);</span>
<span id="cb194-36"><a href="asteroids.html#cb194-36"></a></span>
<span id="cb194-37"><a href="asteroids.html#cb194-37"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>) {</span>
<span id="cb194-38"><a href="asteroids.html#cb194-38"></a>    abcg::glBindVertexArray(asteroid.<span class="va">m_vao</span>);</span>
<span id="cb194-39"><a href="asteroids.html#cb194-39"></a></span>
<span id="cb194-40"><a href="asteroids.html#cb194-40"></a>    abcg::glUniform4fv(<span class="va">m_colorLoc</span>, <span class="dv">1</span>, &amp;asteroid.<span class="va">m_color</span>.r);</span>
<span id="cb194-41"><a href="asteroids.html#cb194-41"></a>    abcg::glUniform1f(<span class="va">m_scaleLoc</span>, asteroid.<span class="va">m_scale</span>);</span>
<span id="cb194-42"><a href="asteroids.html#cb194-42"></a>    abcg::glUniform1f(<span class="va">m_rotationLoc</span>, asteroid.<span class="va">m_rotation</span>);</span>
<span id="cb194-43"><a href="asteroids.html#cb194-43"></a></span>
<span id="cb194-44"><a href="asteroids.html#cb194-44"></a>    <span class="cf">for</span> (<span class="kw">auto</span> i : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb194-45"><a href="asteroids.html#cb194-45"></a>      <span class="cf">for</span> (<span class="kw">auto</span> j : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb194-46"><a href="asteroids.html#cb194-46"></a>        abcg::glUniform2f(<span class="va">m_translationLoc</span>, asteroid.<span class="va">m_translation</span>.x + j,</span>
<span id="cb194-47"><a href="asteroids.html#cb194-47"></a>                          asteroid.<span class="va">m_translation</span>.y + i);</span>
<span id="cb194-48"><a href="asteroids.html#cb194-48"></a></span>
<span id="cb194-49"><a href="asteroids.html#cb194-49"></a>        abcg::glDrawArrays(GL_TRIANGLE_FAN, <span class="dv">0</span>, asteroid.<span class="va">m_polygonSides</span> + <span class="dv">2</span>);</span>
<span id="cb194-50"><a href="asteroids.html#cb194-50"></a>      }</span>
<span id="cb194-51"><a href="asteroids.html#cb194-51"></a>    }</span>
<span id="cb194-52"><a href="asteroids.html#cb194-52"></a></span>
<span id="cb194-53"><a href="asteroids.html#cb194-53"></a>    abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb194-54"><a href="asteroids.html#cb194-54"></a>  }</span>
<span id="cb194-55"><a href="asteroids.html#cb194-55"></a></span>
<span id="cb194-56"><a href="asteroids.html#cb194-56"></a>  abcg::glUseProgram(<span class="dv">0</span>);</span>
<span id="cb194-57"><a href="asteroids.html#cb194-57"></a>}</span></code></pre></div>
<p>A lista <code>m_asteroids</code> é iterada e cada asteroide é renderizado 9 vezes (em uma grade 3x3), como fizemos com as estrelas.</p>
<p>Em <code>Asteroids::terminateGL</code> são liberados os VBOs e VAOs dos asteroides:</p>
<div class="sourceCode" id="cb195" startFrom="59"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 58;"><span id="cb195-59"><a href="asteroids.html#cb195-59"></a><span class="dt">void</span> Asteroids::terminateGL() {</span>
<span id="cb195-60"><a href="asteroids.html#cb195-60"></a>  <span class="cf">for</span> (<span class="kw">auto</span> asteroid : <span class="va">m_asteroids</span>) {</span>
<span id="cb195-61"><a href="asteroids.html#cb195-61"></a>    abcg::glDeleteBuffers(<span class="dv">1</span>, &amp;asteroid.<span class="va">m_vbo</span>);</span>
<span id="cb195-62"><a href="asteroids.html#cb195-62"></a>    abcg::glDeleteVertexArrays(<span class="dv">1</span>, &amp;asteroid.<span class="va">m_vao</span>);</span>
<span id="cb195-63"><a href="asteroids.html#cb195-63"></a>  }</span>
<span id="cb195-64"><a href="asteroids.html#cb195-64"></a>}</span></code></pre></div>
<p>Vamos agora à definição de <code>Asteroids::update</code>:</p>
<div class="sourceCode" id="cb196" startFrom="66"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 65;"><span id="cb196-66"><a href="asteroids.html#cb196-66"></a><span class="dt">void</span> Asteroids::update(<span class="at">const</span> Ship &amp;ship, <span class="dt">float</span> deltaTime) {</span>
<span id="cb196-67"><a href="asteroids.html#cb196-67"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>) {</span>
<span id="cb196-68"><a href="asteroids.html#cb196-68"></a>    asteroid.<span class="va">m_translation</span> -= ship.<span class="va">m_velocity</span> * deltaTime;</span>
<span id="cb196-69"><a href="asteroids.html#cb196-69"></a>    asteroid.<span class="va">m_rotation</span> = glm::wrapAngle(</span>
<span id="cb196-70"><a href="asteroids.html#cb196-70"></a>        asteroid.<span class="va">m_rotation</span> + asteroid.<span class="va">m_angularVelocity</span> * deltaTime);</span>
<span id="cb196-71"><a href="asteroids.html#cb196-71"></a>    asteroid.<span class="va">m_translation</span> += asteroid.<span class="va">m_velocity</span> * deltaTime;</span>
<span id="cb196-72"><a href="asteroids.html#cb196-72"></a></span>
<span id="cb196-73"><a href="asteroids.html#cb196-73"></a>    <span class="co">// Wrap-around</span></span>
<span id="cb196-74"><a href="asteroids.html#cb196-74"></a>    <span class="cf">if</span> (asteroid.<span class="va">m_translation</span>.x &lt; -<span class="fl">1.0</span><span class="bu">f</span>) asteroid.<span class="va">m_translation</span>.x += <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb196-75"><a href="asteroids.html#cb196-75"></a>    <span class="cf">if</span> (asteroid.<span class="va">m_translation</span>.x &gt; +<span class="fl">1.0</span><span class="bu">f</span>) asteroid.<span class="va">m_translation</span>.x -= <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb196-76"><a href="asteroids.html#cb196-76"></a>    <span class="cf">if</span> (asteroid.<span class="va">m_translation</span>.y &lt; -<span class="fl">1.0</span><span class="bu">f</span>) asteroid.<span class="va">m_translation</span>.y += <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb196-77"><a href="asteroids.html#cb196-77"></a>    <span class="cf">if</span> (asteroid.<span class="va">m_translation</span>.y &gt; +<span class="fl">1.0</span><span class="bu">f</span>) asteroid.<span class="va">m_translation</span>.y -= <span class="fl">2.0</span><span class="bu">f</span>;</span>
<span id="cb196-78"><a href="asteroids.html#cb196-78"></a>  }</span>
<span id="cb196-79"><a href="asteroids.html#cb196-79"></a>}</span></code></pre></div>
<p>Na linha 68, a translação (<code>m_translation</code>) de cada asteroide é modificada pelo vetor de velocidade da nave, como fizemos com as estrelas. Na linha 69, a rotação é atualizada de acordo com a velocidade angular. Na linha 71, a translação do asteroide é modificada novamente, mas agora considerando a velocidade do próprio asteroide.</p>
<p>As condicionais das linhas 74 a 77 fazem com que as coordenadas de <code>m_translation</code> permaneçam no intervalo circular de -1 a 1.</p>
<p>Em <code>Asteroids::createAsteroid</code> é criada uma nova instância de <code>Asteroid</code>:</p>
<div class="sourceCode" id="cb197" startFrom="81"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 80;"><span id="cb197-81"><a href="asteroids.html#cb197-81"></a>Asteroids::Asteroid Asteroids::createAsteroid(glm::vec2 translation,</span>
<span id="cb197-82"><a href="asteroids.html#cb197-82"></a>                                              <span class="dt">float</span> scale) {</span>
<span id="cb197-83"><a href="asteroids.html#cb197-83"></a>  Asteroid asteroid;</span>
<span id="cb197-84"><a href="asteroids.html#cb197-84"></a></span>
<span id="cb197-85"><a href="asteroids.html#cb197-85"></a>  <span class="kw">auto</span> &amp;re{<span class="va">m_randomEngine</span>};  <span class="co">// Shortcut</span></span>
<span id="cb197-86"><a href="asteroids.html#cb197-86"></a></span>
<span id="cb197-87"><a href="asteroids.html#cb197-87"></a>  <span class="co">// Randomly choose the number of sides</span></span>
<span id="cb197-88"><a href="asteroids.html#cb197-88"></a>  <span class="bu">std::</span>uniform_int_distribution&lt;<span class="dt">int</span>&gt; randomSides(<span class="dv">6</span>, <span class="dv">20</span>);</span>
<span id="cb197-89"><a href="asteroids.html#cb197-89"></a>  asteroid.<span class="va">m_polygonSides</span> = randomSides(re);</span>
<span id="cb197-90"><a href="asteroids.html#cb197-90"></a></span>
<span id="cb197-91"><a href="asteroids.html#cb197-91"></a>  <span class="co">// Choose a random color (actually, a grayscale)</span></span>
<span id="cb197-92"><a href="asteroids.html#cb197-92"></a>  <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; randomIntensity(<span class="fl">0.5</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>);</span>
<span id="cb197-93"><a href="asteroids.html#cb197-93"></a>  asteroid.<span class="va">m_color</span> = glm::vec4(<span class="dv">1</span>) * randomIntensity(re);</span>
<span id="cb197-94"><a href="asteroids.html#cb197-94"></a></span>
<span id="cb197-95"><a href="asteroids.html#cb197-95"></a>  asteroid.<span class="va">m_color</span>.a = <span class="fl">1.0</span><span class="bu">f</span>;</span>
<span id="cb197-96"><a href="asteroids.html#cb197-96"></a>  asteroid.<span class="va">m_rotation</span> = <span class="fl">0.0</span><span class="bu">f</span>;</span>
<span id="cb197-97"><a href="asteroids.html#cb197-97"></a>  asteroid.<span class="va">m_scale</span> = scale;</span>
<span id="cb197-98"><a href="asteroids.html#cb197-98"></a>  asteroid.<span class="va">m_translation</span> = translation;</span>
<span id="cb197-99"><a href="asteroids.html#cb197-99"></a></span>
<span id="cb197-100"><a href="asteroids.html#cb197-100"></a>  <span class="co">// Choose a random angular velocity</span></span>
<span id="cb197-101"><a href="asteroids.html#cb197-101"></a>  asteroid.<span class="va">m_angularVelocity</span> = <span class="va">m_randomDist</span>(re);</span>
<span id="cb197-102"><a href="asteroids.html#cb197-102"></a></span>
<span id="cb197-103"><a href="asteroids.html#cb197-103"></a>  <span class="co">// Choose a random direction</span></span>
<span id="cb197-104"><a href="asteroids.html#cb197-104"></a>  glm::vec2 direction{<span class="va">m_randomDist</span>(re), <span class="va">m_randomDist</span>(re)};</span>
<span id="cb197-105"><a href="asteroids.html#cb197-105"></a>  asteroid.<span class="va">m_velocity</span> = glm::normalize(direction) / <span class="fl">7.0</span><span class="bu">f</span>;</span>
<span id="cb197-106"><a href="asteroids.html#cb197-106"></a></span>
<span id="cb197-107"><a href="asteroids.html#cb197-107"></a>  <span class="co">// Create geometry</span></span>
<span id="cb197-108"><a href="asteroids.html#cb197-108"></a>  <span class="bu">std::</span>vector&lt;glm::vec2&gt; positions(<span class="dv">0</span>);</span>
<span id="cb197-109"><a href="asteroids.html#cb197-109"></a>  positions.emplace_back(<span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="cb197-110"><a href="asteroids.html#cb197-110"></a>  <span class="at">const</span> <span class="kw">auto</span> step{M_PI * <span class="dv">2</span> / asteroid.<span class="va">m_polygonSides</span>};</span>
<span id="cb197-111"><a href="asteroids.html#cb197-111"></a>  <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; randomRadius(<span class="fl">0.8</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>);</span>
<span id="cb197-112"><a href="asteroids.html#cb197-112"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> angle : iter::range(<span class="fl">0.0</span>, M_PI * <span class="dv">2</span>, step)) {</span>
<span id="cb197-113"><a href="asteroids.html#cb197-113"></a>    <span class="at">const</span> <span class="kw">auto</span> radius{randomRadius(re)};</span>
<span id="cb197-114"><a href="asteroids.html#cb197-114"></a>    positions.emplace_back(radius * <span class="bu">std::</span>cos(angle), radius * <span class="bu">std::</span>sin(angle));</span>
<span id="cb197-115"><a href="asteroids.html#cb197-115"></a>  }</span>
<span id="cb197-116"><a href="asteroids.html#cb197-116"></a>  positions.push_back(positions.at(<span class="dv">1</span>));</span>
<span id="cb197-117"><a href="asteroids.html#cb197-117"></a></span>
<span id="cb197-118"><a href="asteroids.html#cb197-118"></a>  <span class="co">// Generate VBO</span></span>
<span id="cb197-119"><a href="asteroids.html#cb197-119"></a>  abcg::glGenBuffers(<span class="dv">1</span>, &amp;asteroid.<span class="va">m_vbo</span>);</span>
<span id="cb197-120"><a href="asteroids.html#cb197-120"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, asteroid.<span class="va">m_vbo</span>);</span>
<span id="cb197-121"><a href="asteroids.html#cb197-121"></a>  abcg::glBufferData(GL_ARRAY_BUFFER, positions.size() * <span class="kw">sizeof</span>(glm::vec2),</span>
<span id="cb197-122"><a href="asteroids.html#cb197-122"></a>                     positions.data(), GL_STATIC_DRAW);</span>
<span id="cb197-123"><a href="asteroids.html#cb197-123"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb197-124"><a href="asteroids.html#cb197-124"></a></span>
<span id="cb197-125"><a href="asteroids.html#cb197-125"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb197-126"><a href="asteroids.html#cb197-126"></a>  GLint positionAttribute{abcg::glGetAttribLocation(<span class="va">m_program</span>, <span class="st">&quot;inPosition&quot;</span>)};</span>
<span id="cb197-127"><a href="asteroids.html#cb197-127"></a></span>
<span id="cb197-128"><a href="asteroids.html#cb197-128"></a>  <span class="co">// Create VAO</span></span>
<span id="cb197-129"><a href="asteroids.html#cb197-129"></a>  abcg::glGenVertexArrays(<span class="dv">1</span>, &amp;asteroid.<span class="va">m_vao</span>);</span>
<span id="cb197-130"><a href="asteroids.html#cb197-130"></a></span>
<span id="cb197-131"><a href="asteroids.html#cb197-131"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb197-132"><a href="asteroids.html#cb197-132"></a>  abcg::glBindVertexArray(asteroid.<span class="va">m_vao</span>);</span>
<span id="cb197-133"><a href="asteroids.html#cb197-133"></a></span>
<span id="cb197-134"><a href="asteroids.html#cb197-134"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, asteroid.<span class="va">m_vbo</span>);</span>
<span id="cb197-135"><a href="asteroids.html#cb197-135"></a>  abcg::glEnableVertexAttribArray(positionAttribute);</span>
<span id="cb197-136"><a href="asteroids.html#cb197-136"></a>  abcg::glVertexAttribPointer(positionAttribute, <span class="dv">2</span>, GL_FLOAT, GL_FALSE, <span class="dv">0</span>,</span>
<span id="cb197-137"><a href="asteroids.html#cb197-137"></a>                              <span class="kw">nullptr</span>);</span>
<span id="cb197-138"><a href="asteroids.html#cb197-138"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb197-139"><a href="asteroids.html#cb197-139"></a></span>
<span id="cb197-140"><a href="asteroids.html#cb197-140"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb197-141"><a href="asteroids.html#cb197-141"></a>  abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb197-142"><a href="asteroids.html#cb197-142"></a></span>
<span id="cb197-143"><a href="asteroids.html#cb197-143"></a>  <span class="cf">return</span> asteroid;</span>
<span id="cb197-144"><a href="asteroids.html#cb197-144"></a>}</span></code></pre></div>
<p>Na linha 101 é escolhida uma velocidade angular aleatória do intervalo <span class="math inline">\([-1, 1]\)</span> (em radianos por segundo).</p>
<p>Na linha 105 é escolhido um vetor unitário aleatório para definir a velocidade do asteroide. As componentes do vetor são divididas por 7 de modo que cada asteroide inicie com uma velocidade de 1/7 unidades de espaço por segundo.</p>
<p>O restante do código cria a geometria do asteroide. O código é bem parecido com o que foi utilizado para criar o polígono regular no projeto <code>regularpolygons</code>. A diferença é que agora usamos a equação paramétrica do círculo com raio <span class="math inline">\(r\)</span></p>
<p><span class="math display">\[
\begin{eqnarray}
x&amp;=&amp;r cos(t),\\
y&amp;=&amp;r sin(t),
\end{eqnarray}
\]</span></p>
<p>e selecionamos um <span class="math inline">\(r\)</span> aleatório do intervalo <span class="math inline">\([0.8, 1]\)</span> para cada vértice do polígono.</p>
<p>Nesse momento, o jogo ficará como a seguir (<a href="https://hbatagelo.github.io/abcgapps/asteroids3/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids3/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="635"
  ></iframe>
<p>O código pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids3.zip">deste link</a>.</p>
</div>
</div>
<div id="tiros-e-colisões" class="section level3 unnumbered">
<h3>Tiros e colisões</h3>
<p>Neste momento o jogo ainda não tem detecção de colisões e tiros. É isso que implementaremos agora.</p>
<div id="atualizando-openglwindow.hpp-2" class="section level4 unnumbered">
<h4>Atualizando openglwindow.hpp</h4>
<p>Adicione a definição de <code>m_bullets</code> junto à definição dos outros objetos:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb198-1"><a href="asteroids.html#cb198-1" aria-hidden="true" tabindex="-1"></a>Asteroids <span class="va">m_asteroids</span>;</span>
<span id="cb198-2"><a href="asteroids.html#cb198-2" aria-hidden="true" tabindex="-1"></a>Bullets <span class="va">m_bullets</span>;</span>
<span id="cb198-3"><a href="asteroids.html#cb198-3" aria-hidden="true" tabindex="-1"></a>Ship <span class="va">m_ship</span>;</span>
<span id="cb198-4"><a href="asteroids.html#cb198-4" aria-hidden="true" tabindex="-1"></a>StarLayers <span class="va">m_starLayers</span>;</span></code></pre></div>
<p>Adicione também a declaração das seguintes funções membro adicionais de <code>OpenGLWindow</code>:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb199-1"><a href="asteroids.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> checkCollisions();</span>
<span id="cb199-2"><a href="asteroids.html#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> checkWinCondition();</span></code></pre></div>
<ul>
<li><code>checkCollisions</code> será utilizada para verificar as colisões;</li>
<li><code>checkWinCondition</code> será utilizada para verificar se o jogador ganhou (isto é, se não há mais asteroides).</li>
</ul>
</div>
<div id="atualizando-openglwindow.cpp-2" class="section level4 unnumbered">
<h4>Atualizando openglwindow.cpp</h4>
<ul>
<li><p>Em <code>OpenGLWindow::restart</code>, inclua a chamada à função <code>initializeGL</code> de <code>m_bullets</code> junto com <code>initializeGL</code> dos objetos anteriores, assim:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb200-1"><a href="asteroids.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.initializeGL(<span class="va">m_starsProgram</span>, <span class="dv">25</span>);</span>
<span id="cb200-2"><a href="asteroids.html#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.initializeGL(<span class="va">m_objectsProgram</span>);</span>
<span id="cb200-3"><a href="asteroids.html#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.initializeGL(<span class="va">m_objectsProgram</span>, <span class="dv">3</span>);</span>
<span id="cb200-4"><a href="asteroids.html#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span>.initializeGL(<span class="va">m_objectsProgram</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::update</code>, chame <code>update</code> de <code>m_bullets</code> em qualquer lugar após a chamada de <code>update</code> de <code>m_ship</code>. Por exemplo:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb201-1"><a href="asteroids.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.update(<span class="va">m_gameData</span>, deltaTime);</span>
<span id="cb201-2"><a href="asteroids.html#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.update(<span class="va">m_ship</span>, deltaTime);</span>
<span id="cb201-3"><a href="asteroids.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.update(<span class="va">m_ship</span>, deltaTime);</span>
<span id="cb201-4"><a href="asteroids.html#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span>.update(<span class="va">m_ship</span>, <span class="va">m_gameData</span>, deltaTime);</span></code></pre></div>
<p>Além disso, inclua a seguinte condicional após os <code>update</code>s para calcular as colisões e verificar a condição de vitória:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb202-1"><a href="asteroids.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="va">m_gameData</span>.<span class="va">m_state</span> == State::Playing) {</span>
<span id="cb202-2"><a href="asteroids.html#cb202-2" aria-hidden="true" tabindex="-1"></a>  checkCollisions();</span>
<span id="cb202-3"><a href="asteroids.html#cb202-3" aria-hidden="true" tabindex="-1"></a>  checkWinCondition();</span>
<span id="cb202-4"><a href="asteroids.html#cb202-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::paintGL</code>, chame <code>paintGL</code> de <code>m_bullets</code> logo após a chamada de <code>paintGL</code> de <code>m_asteroids</code>:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb203-1"><a href="asteroids.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.paintGL();</span>
<span id="cb203-2"><a href="asteroids.html#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.paintGL();</span>
<span id="cb203-3"><a href="asteroids.html#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span>.paintGL();</span>
<span id="cb203-4"><a href="asteroids.html#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.paintGL(<span class="va">m_gameData</span>);</span></code></pre></div></li>
<li><p>Em <code>OpenGLWindow::terminateGL</code>, chame <code>terminateGL</code> de <code>m_bullets</code> junto com <code>terminateGL</code> dos outros objetos:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb204-1"><a href="asteroids.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="va">m_asteroids</span>.terminateGL();</span>
<span id="cb204-2"><a href="asteroids.html#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="va">m_bullets</span>.terminateGL();    </span>
<span id="cb204-3"><a href="asteroids.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="va">m_ship</span>.terminateGL();</span>
<span id="cb204-4"><a href="asteroids.html#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="va">m_starLayers</span>.terminateGL();</span></code></pre></div></li>
</ul>
<p>Vamos agora definir <code>OpenGLWindow::checkCollisions</code> como a seguir:</p>
<div class="sourceCode" id="cb205" startFrom="172"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 171;"><span id="cb205-172"><a href="asteroids.html#cb205-172"></a><span class="dt">void</span> OpenGLWindow::checkCollisions() {</span>
<span id="cb205-173"><a href="asteroids.html#cb205-173"></a>  <span class="co">// Check collision between ship and asteroids</span></span>
<span id="cb205-174"><a href="asteroids.html#cb205-174"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb205-175"><a href="asteroids.html#cb205-175"></a>    <span class="at">const</span> <span class="kw">auto</span> asteroidTranslation{asteroid.<span class="va">m_translation</span>};</span>
<span id="cb205-176"><a href="asteroids.html#cb205-176"></a>    <span class="at">const</span> <span class="kw">auto</span> distance{</span>
<span id="cb205-177"><a href="asteroids.html#cb205-177"></a>        glm::distance(<span class="va">m_ship</span>.<span class="va">m_translation</span>, asteroidTranslation)};</span>
<span id="cb205-178"><a href="asteroids.html#cb205-178"></a></span>
<span id="cb205-179"><a href="asteroids.html#cb205-179"></a>    <span class="cf">if</span> (distance &lt; <span class="va">m_ship</span>.<span class="va">m_scale</span> * <span class="fl">0.9</span><span class="bu">f</span> + asteroid.<span class="va">m_scale</span> * <span class="fl">0.85</span><span class="bu">f</span>) {</span>
<span id="cb205-180"><a href="asteroids.html#cb205-180"></a>      <span class="va">m_gameData</span>.<span class="va">m_state</span> = State::GameOver;</span>
<span id="cb205-181"><a href="asteroids.html#cb205-181"></a>      <span class="va">m_restartWaitTimer</span>.restart();</span>
<span id="cb205-182"><a href="asteroids.html#cb205-182"></a>    }</span>
<span id="cb205-183"><a href="asteroids.html#cb205-183"></a>  }</span>
<span id="cb205-184"><a href="asteroids.html#cb205-184"></a></span>
<span id="cb205-185"><a href="asteroids.html#cb205-185"></a>  <span class="co">// Check collision between bullets and asteroids</span></span>
<span id="cb205-186"><a href="asteroids.html#cb205-186"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;bullet : <span class="va">m_bullets</span>.<span class="va">m_bullets</span>) {</span>
<span id="cb205-187"><a href="asteroids.html#cb205-187"></a>    <span class="cf">if</span> (bullet.<span class="va">m_dead</span>) <span class="cf">continue</span>;</span>
<span id="cb205-188"><a href="asteroids.html#cb205-188"></a></span>
<span id="cb205-189"><a href="asteroids.html#cb205-189"></a>    <span class="cf">for</span> (<span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb205-190"><a href="asteroids.html#cb205-190"></a>      <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> i : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb205-191"><a href="asteroids.html#cb205-191"></a>        <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> j : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb205-192"><a href="asteroids.html#cb205-192"></a>          <span class="at">const</span> <span class="kw">auto</span> asteroidTranslation{asteroid.<span class="va">m_translation</span> +</span>
<span id="cb205-193"><a href="asteroids.html#cb205-193"></a>                                         glm::vec2(i, j)};</span>
<span id="cb205-194"><a href="asteroids.html#cb205-194"></a>          <span class="at">const</span> <span class="kw">auto</span> distance{</span>
<span id="cb205-195"><a href="asteroids.html#cb205-195"></a>              glm::distance(bullet.<span class="va">m_translation</span>, asteroidTranslation)};</span>
<span id="cb205-196"><a href="asteroids.html#cb205-196"></a></span>
<span id="cb205-197"><a href="asteroids.html#cb205-197"></a>          <span class="cf">if</span> (distance &lt; <span class="va">m_bullets</span>.<span class="va">m_scale</span> + asteroid.<span class="va">m_scale</span> * <span class="fl">0.85</span><span class="bu">f</span>) {</span>
<span id="cb205-198"><a href="asteroids.html#cb205-198"></a>            asteroid.<span class="va">m_hit</span> = <span class="kw">true</span>;</span>
<span id="cb205-199"><a href="asteroids.html#cb205-199"></a>            bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb205-200"><a href="asteroids.html#cb205-200"></a>          }</span>
<span id="cb205-201"><a href="asteroids.html#cb205-201"></a>        }</span>
<span id="cb205-202"><a href="asteroids.html#cb205-202"></a>      }</span>
<span id="cb205-203"><a href="asteroids.html#cb205-203"></a>    }</span>
<span id="cb205-204"><a href="asteroids.html#cb205-204"></a></span>
<span id="cb205-205"><a href="asteroids.html#cb205-205"></a>    <span class="co">// Break asteroids marked as hit</span></span>
<span id="cb205-206"><a href="asteroids.html#cb205-206"></a>    <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb205-207"><a href="asteroids.html#cb205-207"></a>      <span class="cf">if</span> (asteroid.<span class="va">m_hit</span> &amp;&amp; asteroid.<span class="va">m_scale</span> &gt; <span class="fl">0.10</span><span class="bu">f</span>) {</span>
<span id="cb205-208"><a href="asteroids.html#cb205-208"></a>        <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; <span class="va">m_randomDist</span>{-<span class="fl">1.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>};</span>
<span id="cb205-209"><a href="asteroids.html#cb205-209"></a>        <span class="bu">std::</span>generate_n(<span class="bu">std::</span>back_inserter(<span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>), <span class="dv">3</span>, [&amp;]() {</span>
<span id="cb205-210"><a href="asteroids.html#cb205-210"></a>          <span class="at">const</span> glm::vec2 offset{<span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>),</span>
<span id="cb205-211"><a href="asteroids.html#cb205-211"></a>                                 <span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>)};</span>
<span id="cb205-212"><a href="asteroids.html#cb205-212"></a>          <span class="cf">return</span> <span class="va">m_asteroids</span>.createAsteroid(</span>
<span id="cb205-213"><a href="asteroids.html#cb205-213"></a>              asteroid.<span class="va">m_translation</span> + offset * asteroid.<span class="va">m_scale</span> * <span class="fl">0.5</span><span class="bu">f</span>,</span>
<span id="cb205-214"><a href="asteroids.html#cb205-214"></a>              asteroid.<span class="va">m_scale</span> * <span class="fl">0.5</span><span class="bu">f</span>);</span>
<span id="cb205-215"><a href="asteroids.html#cb205-215"></a>        });</span>
<span id="cb205-216"><a href="asteroids.html#cb205-216"></a>      }</span>
<span id="cb205-217"><a href="asteroids.html#cb205-217"></a>    }</span>
<span id="cb205-218"><a href="asteroids.html#cb205-218"></a></span>
<span id="cb205-219"><a href="asteroids.html#cb205-219"></a>    <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>.remove_if(</span>
<span id="cb205-220"><a href="asteroids.html#cb205-220"></a>        [](<span class="at">const</span> Asteroids::Asteroid &amp;a) { <span class="cf">return</span> a.<span class="va">m_hit</span>; });</span>
<span id="cb205-221"><a href="asteroids.html#cb205-221"></a>  }</span>
<span id="cb205-222"><a href="asteroids.html#cb205-222"></a>}</span></code></pre></div>
<p>Nas linhas 173 a 183 é feita a detecção de colisão entre a nave e cada asteroide:</p>
<div class="sourceCode" id="cb206" startFrom="173"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 172;"><span id="cb206-173"><a href="asteroids.html#cb206-173"></a>  <span class="co">// Check collision between ship and asteroids</span></span>
<span id="cb206-174"><a href="asteroids.html#cb206-174"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb206-175"><a href="asteroids.html#cb206-175"></a>    <span class="kw">auto</span> asteroidTranslation{asteroid.<span class="va">m_translation</span>};</span>
<span id="cb206-176"><a href="asteroids.html#cb206-176"></a>    <span class="kw">auto</span> distance{glm::distance(<span class="va">m_ship</span>.<span class="va">m_translation</span>, asteroidTranslation)};</span>
<span id="cb206-177"><a href="asteroids.html#cb206-177"></a></span>
<span id="cb206-178"><a href="asteroids.html#cb206-178"></a>    <span class="cf">if</span> (distance &lt; <span class="va">m_ship</span>.<span class="va">m_scale</span> * <span class="fl">0.9</span><span class="bu">f</span> + asteroid.<span class="va">m_scale</span> * <span class="fl">0.85</span><span class="bu">f</span>) {</span>
<span id="cb206-179"><a href="asteroids.html#cb206-179"></a>      <span class="va">m_gameData</span>.<span class="va">m_state</span> = State::GameOver;</span>
<span id="cb206-180"><a href="asteroids.html#cb206-180"></a>      <span class="va">m_restartWaitTimer</span>.restart();</span>
<span id="cb206-181"><a href="asteroids.html#cb206-181"></a>    }</span>
<span id="cb206-182"><a href="asteroids.html#cb206-182"></a>  }</span></code></pre></div>
<p>A detecção de colisão é feita através da comparação da distância euclidiana (<code>glm::distance</code>) entre as coordenadas de translação dos objetos. Essas coordenadas podem ser consideradas como a posição do centro dos objetos na cena (como ilustrado pelos pontos <span class="math inline">\(P_s\)</span> e <span class="math inline">\(P_a\)</span> na figura <a href="asteroids.html#fig:collision1">5.10</a>:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:collision1"></span>
<img src="images/05_collision1.svg" alt="Detecção de colisão entre nave e asteroide através da comparação de distância entre círculos." width="60%" />
<p class="caption">
Figura 5.10: Detecção de colisão entre nave e asteroide através da comparação de distância entre círculos.
</p>
</div>
<p><span class="math inline">\(P_s\)</span> e <span class="math inline">\(P_a\)</span> também podem ser considerados como centros de círculos. O fator de escala de cada objeto corresponde ao raio do círculo (<span class="math inline">\(r_s\)</span> e <span class="math inline">\(r_a\)</span>). Assim, podemos detectar a colisão através de uma simples comparação da distância <span class="math inline">\(|P_s-P_a|\)</span> com a soma dos fatores de escala. Só há colisão se a distância for menor ou igual a <span class="math inline">\(r_s+r_a\)</span>. Esse tipo de teste é bem mais simples e eficiente (embora menos preciso) do que comparar a interseção entre os triângulos que formam os objetos.</p>
<p>Note, na linha 179, que <span class="math inline">\(r_s\)</span> e <span class="math inline">\(r_a\)</span> são de fato os fatores <code>m_scale</code> de cada objeto, mas multiplicados por <code>0.9f</code> (para a nave) e <code>0.85f</code> (para o asteroide). Isso é feito para diminuir um pouco o raio dos círculos e fazer com que exista uma tolerância de sobreposição antes de ocorrer a colisão. Veja, na figura <a href="asteroids.html#fig:collision1">5.10</a>, que dessa forma os objetos não ficam inscritos nos círculos. Os valores <code>0.9</code> e <code>0.85</code> foram determinados empiricamente.</p>
<p>Nas linhas 185 a 203 é feita a detecção de colisão entre os tiros e os asteroides:</p>
<div class="sourceCode" id="cb207" startFrom="185"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 184;"><span id="cb207-185"><a href="asteroids.html#cb207-185"></a>  <span class="co">// Check collision between bullets and asteroids</span></span>
<span id="cb207-186"><a href="asteroids.html#cb207-186"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;bullet : <span class="va">m_bullets</span>.<span class="va">m_bullets</span>) {</span>
<span id="cb207-187"><a href="asteroids.html#cb207-187"></a>    <span class="cf">if</span> (bullet.<span class="va">m_dead</span>) <span class="cf">continue</span>;</span>
<span id="cb207-188"><a href="asteroids.html#cb207-188"></a></span>
<span id="cb207-189"><a href="asteroids.html#cb207-189"></a>    <span class="cf">for</span> (<span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb207-190"><a href="asteroids.html#cb207-190"></a>      <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> i : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb207-191"><a href="asteroids.html#cb207-191"></a>        <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> j : {-<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>}) {</span>
<span id="cb207-192"><a href="asteroids.html#cb207-192"></a>          <span class="at">const</span> <span class="kw">auto</span> asteroidTranslation{asteroid.<span class="va">m_translation</span> +</span>
<span id="cb207-193"><a href="asteroids.html#cb207-193"></a>                                         glm::vec2(i, j)};</span>
<span id="cb207-194"><a href="asteroids.html#cb207-194"></a>          <span class="at">const</span> <span class="kw">auto</span> distance{</span>
<span id="cb207-195"><a href="asteroids.html#cb207-195"></a>              glm::distance(bullet.<span class="va">m_translation</span>, asteroidTranslation)};</span>
<span id="cb207-196"><a href="asteroids.html#cb207-196"></a></span>
<span id="cb207-197"><a href="asteroids.html#cb207-197"></a>          <span class="cf">if</span> (distance &lt; <span class="va">m_bullets</span>.<span class="va">m_scale</span> + asteroid.<span class="va">m_scale</span> * <span class="fl">0.85</span><span class="bu">f</span>) {</span>
<span id="cb207-198"><a href="asteroids.html#cb207-198"></a>            asteroid.<span class="va">m_hit</span> = <span class="kw">true</span>;</span>
<span id="cb207-199"><a href="asteroids.html#cb207-199"></a>            bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb207-200"><a href="asteroids.html#cb207-200"></a>          }</span>
<span id="cb207-201"><a href="asteroids.html#cb207-201"></a>        }</span>
<span id="cb207-202"><a href="asteroids.html#cb207-202"></a>      }</span>
<span id="cb207-203"><a href="asteroids.html#cb207-203"></a>    }</span></code></pre></div>
<p>A interseção é calculada novamente através da comparação da distância entre círculos. Note que os testes de distância são feitos dentro de laços aninhados parecidos com os que foram utilizados para replicar a renderização dos asteroides na grade 3x3 em torno da região visível do viewport. De fato, o teste de colisão de um tiro com um asteroide precisa considerar essa replicação, pois um asteroide que está saindo à esquerda do viewport pode ser atingido por um tiro no lado oposto, à direita.</p>
<p>Se um tiro acertou um asteroide, o <code>m_hit</code> do asteroide e o <code>m_dead</code> do tiro tornam-se <code>true</code>.</p>
<p>Observe agora as linhas 205 a 217:</p>
<div class="sourceCode" id="cb208" startFrom="205"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 204;"><span id="cb208-205"><a href="asteroids.html#cb208-205"></a>    <span class="co">// Break asteroids marked as hit</span></span>
<span id="cb208-206"><a href="asteroids.html#cb208-206"></a>    <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;asteroid : <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>) {</span>
<span id="cb208-207"><a href="asteroids.html#cb208-207"></a>      <span class="cf">if</span> (asteroid.<span class="va">m_hit</span> &amp;&amp; asteroid.<span class="va">m_scale</span> &gt; <span class="fl">0.10</span><span class="bu">f</span>) {</span>
<span id="cb208-208"><a href="asteroids.html#cb208-208"></a>        <span class="bu">std::</span>uniform_real_distribution&lt;<span class="dt">float</span>&gt; <span class="va">m_randomDist</span>{-<span class="fl">1.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>};</span>
<span id="cb208-209"><a href="asteroids.html#cb208-209"></a>        <span class="bu">std::</span>generate_n(<span class="bu">std::</span>back_inserter(<span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>), <span class="dv">3</span>, [&amp;]() {</span>
<span id="cb208-210"><a href="asteroids.html#cb208-210"></a>          <span class="at">const</span> glm::vec2 offset{<span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>),</span>
<span id="cb208-211"><a href="asteroids.html#cb208-211"></a>                                 <span class="va">m_randomDist</span>(<span class="va">m_randomEngine</span>)};</span>
<span id="cb208-212"><a href="asteroids.html#cb208-212"></a>          <span class="cf">return</span> <span class="va">m_asteroids</span>.createAsteroid(</span>
<span id="cb208-213"><a href="asteroids.html#cb208-213"></a>              asteroid.<span class="va">m_translation</span> + offset * asteroid.<span class="va">m_scale</span> * <span class="fl">0.5</span><span class="bu">f</span>,</span>
<span id="cb208-214"><a href="asteroids.html#cb208-214"></a>              asteroid.<span class="va">m_scale</span> * <span class="fl">0.5</span><span class="bu">f</span>);</span>
<span id="cb208-215"><a href="asteroids.html#cb208-215"></a>        });</span>
<span id="cb208-216"><a href="asteroids.html#cb208-216"></a>      }</span>
<span id="cb208-217"><a href="asteroids.html#cb208-217"></a>    }</span></code></pre></div>
<p>Nesse código, os asteroides com <code>m_hit == true</code> são testados para verificar se são suficientemente grandes (<code>m_scale &gt; 0.10f</code>). Se sim, três novos asteroides menores são criados e inseridos na lista <code>m_asteroids.m_asteroids</code>.</p>
<p>Nas linhas 219 a 220, os asteroides que estavam com <code>m_hit == true</code> são removidos da lista:</p>
<div class="sourceCode" id="cb209" startFrom="219"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 218;"><span id="cb209-219"><a href="asteroids.html#cb209-219"></a>    <span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>.remove_if(</span>
<span id="cb209-220"><a href="asteroids.html#cb209-220"></a>        [](<span class="at">const</span> Asteroids::Asteroid &amp;a) { <span class="cf">return</span> a.<span class="va">m_hit</span>; });</span></code></pre></div>
<p>Isso é tudo para a detecção de colisão. Vamos agora à definição de <code>OpenGLWindow::checkWinCondition</code>, que ficará como a seguir:</p>
<div class="sourceCode" id="cb210" startFrom="224"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 223;"><span id="cb210-224"><a href="asteroids.html#cb210-224"></a><span class="dt">void</span> OpenGLWindow::checkWinCondition() {</span>
<span id="cb210-225"><a href="asteroids.html#cb210-225"></a>  <span class="cf">if</span> (<span class="va">m_asteroids</span>.<span class="va">m_asteroids</span>.empty()) {</span>
<span id="cb210-226"><a href="asteroids.html#cb210-226"></a>    <span class="va">m_gameData</span>.<span class="va">m_state</span> = State::Win;</span>
<span id="cb210-227"><a href="asteroids.html#cb210-227"></a>    <span class="va">m_restartWaitTimer</span>.restart();</span>
<span id="cb210-228"><a href="asteroids.html#cb210-228"></a>  }</span>
<span id="cb210-229"><a href="asteroids.html#cb210-229"></a>}</span></code></pre></div>
<p>A vitória ocorre quando a lista de asteroides está vazia. Nesse caso, o estado do jogo é modificado para <code>State::Win</code> e o temporizador <code>m_restartWaitTimer</code> é reiniciado. Como resultado, o jogo será reiniciado após cinco segundos (essa verificação é feita em <code>OpenGLWindow::update</code>). Enquanto isso, <code>paintUI</code> exibirá o texto de vitória.</p>
</div>
<div id="bullets.hpp" class="section level4 unnumbered">
<h4>bullets.hpp</h4>
<p>A definição da classe <code>Bullets</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb211" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb211-1"><a href="asteroids.html#cb211-1"></a><span class="pp">#ifndef BULLETS_HPP_</span></span>
<span id="cb211-2"><a href="asteroids.html#cb211-2"></a><span class="pp">#define BULLETS_HPP_</span></span>
<span id="cb211-3"><a href="asteroids.html#cb211-3"></a></span>
<span id="cb211-4"><a href="asteroids.html#cb211-4"></a><span class="pp">#include </span><span class="im">&lt;list&gt;</span></span>
<span id="cb211-5"><a href="asteroids.html#cb211-5"></a></span>
<span id="cb211-6"><a href="asteroids.html#cb211-6"></a><span class="pp">#include </span><span class="im">&quot;abcg.hpp&quot;</span></span>
<span id="cb211-7"><a href="asteroids.html#cb211-7"></a><span class="pp">#include </span><span class="im">&quot;gamedata.hpp&quot;</span></span>
<span id="cb211-8"><a href="asteroids.html#cb211-8"></a><span class="pp">#include </span><span class="im">&quot;ship.hpp&quot;</span></span>
<span id="cb211-9"><a href="asteroids.html#cb211-9"></a></span>
<span id="cb211-10"><a href="asteroids.html#cb211-10"></a><span class="kw">class</span> OpenGLWindow;</span>
<span id="cb211-11"><a href="asteroids.html#cb211-11"></a></span>
<span id="cb211-12"><a href="asteroids.html#cb211-12"></a><span class="kw">class</span> Bullets {</span>
<span id="cb211-13"><a href="asteroids.html#cb211-13"></a> <span class="kw">public</span>:</span>
<span id="cb211-14"><a href="asteroids.html#cb211-14"></a>  <span class="dt">void</span> initializeGL(GLuint program);</span>
<span id="cb211-15"><a href="asteroids.html#cb211-15"></a>  <span class="dt">void</span> paintGL();</span>
<span id="cb211-16"><a href="asteroids.html#cb211-16"></a>  <span class="dt">void</span> terminateGL();</span>
<span id="cb211-17"><a href="asteroids.html#cb211-17"></a></span>
<span id="cb211-18"><a href="asteroids.html#cb211-18"></a>  <span class="dt">void</span> update(Ship &amp;ship, <span class="at">const</span> GameData &amp;gameData, <span class="dt">float</span> deltaTime);</span>
<span id="cb211-19"><a href="asteroids.html#cb211-19"></a></span>
<span id="cb211-20"><a href="asteroids.html#cb211-20"></a> <span class="kw">private</span>:</span>
<span id="cb211-21"><a href="asteroids.html#cb211-21"></a>  <span class="kw">friend</span> OpenGLWindow;</span>
<span id="cb211-22"><a href="asteroids.html#cb211-22"></a></span>
<span id="cb211-23"><a href="asteroids.html#cb211-23"></a>  GLuint <span class="va">m_program</span>{};</span>
<span id="cb211-24"><a href="asteroids.html#cb211-24"></a>  GLint <span class="va">m_colorLoc</span>{};</span>
<span id="cb211-25"><a href="asteroids.html#cb211-25"></a>  GLint <span class="va">m_rotationLoc</span>{};</span>
<span id="cb211-26"><a href="asteroids.html#cb211-26"></a>  GLint <span class="va">m_translationLoc</span>{};</span>
<span id="cb211-27"><a href="asteroids.html#cb211-27"></a>  GLint <span class="va">m_scaleLoc</span>{};</span>
<span id="cb211-28"><a href="asteroids.html#cb211-28"></a></span>
<span id="cb211-29"><a href="asteroids.html#cb211-29"></a>  GLuint <span class="va">m_vao</span>{};</span>
<span id="cb211-30"><a href="asteroids.html#cb211-30"></a>  GLuint <span class="va">m_vbo</span>{};</span>
<span id="cb211-31"><a href="asteroids.html#cb211-31"></a></span>
<span id="cb211-32"><a href="asteroids.html#cb211-32"></a>  <span class="kw">struct</span> Bullet {</span>
<span id="cb211-33"><a href="asteroids.html#cb211-33"></a>    <span class="dt">bool</span> <span class="va">m_dead</span>{};</span>
<span id="cb211-34"><a href="asteroids.html#cb211-34"></a>    glm::vec2 <span class="va">m_translation</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb211-35"><a href="asteroids.html#cb211-35"></a>    glm::vec2 <span class="va">m_velocity</span>{glm::vec2(<span class="dv">0</span>)};</span>
<span id="cb211-36"><a href="asteroids.html#cb211-36"></a>  };</span>
<span id="cb211-37"><a href="asteroids.html#cb211-37"></a></span>
<span id="cb211-38"><a href="asteroids.html#cb211-38"></a>  <span class="dt">float</span> <span class="va">m_scale</span>{<span class="fl">0.015</span><span class="bu">f</span>};</span>
<span id="cb211-39"><a href="asteroids.html#cb211-39"></a></span>
<span id="cb211-40"><a href="asteroids.html#cb211-40"></a>  <span class="bu">std::</span>list&lt;Bullet&gt; <span class="va">m_bullets</span>;</span>
<span id="cb211-41"><a href="asteroids.html#cb211-41"></a>};</span>
<span id="cb211-42"><a href="asteroids.html#cb211-42"></a></span>
<span id="cb211-43"><a href="asteroids.html#cb211-43"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Nas linhas 32 a 36 é definida a estrutura <code>Bullet</code>. Observe que o VAO e VBO não está em <code>Bullet</code>, mas em <code>Bullets</code>, pois todos os tiros utilizarão o mesmo VBO.</p>
<p>Na linha 38 é definido o fator de escala de cada tiro, e na linha 40 é definida a lista de tiros atualmente na cena. O número de elementos da lista será alterado de acordo com a quantidade de tiros visíveis.</p>
</div>
<div id="bullets.cpp" class="section level4 unnumbered">
<h4>bullets.cpp</h4>
<p>O arquivo começa com a definição de <code>Bullets::initializeGL</code>:</p>
<div class="sourceCode" id="cb212" startFrom="1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb212-1"><a href="asteroids.html#cb212-1"></a><span class="pp">#include </span><span class="im">&quot;bullets.hpp&quot;</span></span>
<span id="cb212-2"><a href="asteroids.html#cb212-2"></a></span>
<span id="cb212-3"><a href="asteroids.html#cb212-3"></a><span class="pp">#include </span><span class="im">&lt;cppitertools/itertools.hpp&gt;</span></span>
<span id="cb212-4"><a href="asteroids.html#cb212-4"></a><span class="pp">#include </span><span class="im">&lt;glm/gtx/rotate_vector.hpp&gt;</span></span>
<span id="cb212-5"><a href="asteroids.html#cb212-5"></a></span>
<span id="cb212-6"><a href="asteroids.html#cb212-6"></a><span class="dt">void</span> Bullets::initializeGL(GLuint program) {</span>
<span id="cb212-7"><a href="asteroids.html#cb212-7"></a>  terminateGL();</span>
<span id="cb212-8"><a href="asteroids.html#cb212-8"></a></span>
<span id="cb212-9"><a href="asteroids.html#cb212-9"></a>  <span class="va">m_program</span> = program;</span>
<span id="cb212-10"><a href="asteroids.html#cb212-10"></a>  <span class="va">m_colorLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;color&quot;</span>);</span>
<span id="cb212-11"><a href="asteroids.html#cb212-11"></a>  <span class="va">m_rotationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;rotation&quot;</span>);</span>
<span id="cb212-12"><a href="asteroids.html#cb212-12"></a>  <span class="va">m_scaleLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;scale&quot;</span>);</span>
<span id="cb212-13"><a href="asteroids.html#cb212-13"></a>  <span class="va">m_translationLoc</span> = abcg::glGetUniformLocation(<span class="va">m_program</span>, <span class="st">&quot;translation&quot;</span>);</span>
<span id="cb212-14"><a href="asteroids.html#cb212-14"></a></span>
<span id="cb212-15"><a href="asteroids.html#cb212-15"></a>  <span class="va">m_bullets</span>.clear();</span>
<span id="cb212-16"><a href="asteroids.html#cb212-16"></a></span>
<span id="cb212-17"><a href="asteroids.html#cb212-17"></a>  <span class="co">// Create regular polygon</span></span>
<span id="cb212-18"><a href="asteroids.html#cb212-18"></a>  <span class="at">const</span> <span class="kw">auto</span> sides{<span class="dv">10</span>};</span>
<span id="cb212-19"><a href="asteroids.html#cb212-19"></a></span>
<span id="cb212-20"><a href="asteroids.html#cb212-20"></a>  <span class="bu">std::</span>vector&lt;glm::vec2&gt; positions(<span class="dv">0</span>);</span>
<span id="cb212-21"><a href="asteroids.html#cb212-21"></a>  positions.emplace_back(<span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="cb212-22"><a href="asteroids.html#cb212-22"></a>  <span class="at">const</span> <span class="kw">auto</span> step{M_PI * <span class="dv">2</span> / sides};</span>
<span id="cb212-23"><a href="asteroids.html#cb212-23"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> angle : iter::range(<span class="fl">0.0</span>, M_PI * <span class="dv">2</span>, step)) {</span>
<span id="cb212-24"><a href="asteroids.html#cb212-24"></a>    positions.emplace_back(<span class="bu">std::</span>cos(angle), <span class="bu">std::</span>sin(angle));</span>
<span id="cb212-25"><a href="asteroids.html#cb212-25"></a>  }</span>
<span id="cb212-26"><a href="asteroids.html#cb212-26"></a>  positions.push_back(positions.at(<span class="dv">1</span>));</span>
<span id="cb212-27"><a href="asteroids.html#cb212-27"></a></span>
<span id="cb212-28"><a href="asteroids.html#cb212-28"></a>  <span class="co">// Generate VBO of positions</span></span>
<span id="cb212-29"><a href="asteroids.html#cb212-29"></a>  abcg::glGenBuffers(<span class="dv">1</span>, &amp;<span class="va">m_vbo</span>);</span>
<span id="cb212-30"><a href="asteroids.html#cb212-30"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="va">m_vbo</span>);</span>
<span id="cb212-31"><a href="asteroids.html#cb212-31"></a>  abcg::glBufferData(GL_ARRAY_BUFFER, positions.size() * <span class="kw">sizeof</span>(glm::vec2),</span>
<span id="cb212-32"><a href="asteroids.html#cb212-32"></a>                     positions.data(), GL_STATIC_DRAW);</span>
<span id="cb212-33"><a href="asteroids.html#cb212-33"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb212-34"><a href="asteroids.html#cb212-34"></a></span>
<span id="cb212-35"><a href="asteroids.html#cb212-35"></a>  <span class="co">// Get location of attributes in the program</span></span>
<span id="cb212-36"><a href="asteroids.html#cb212-36"></a>  <span class="at">const</span> GLint positionAttribute{</span>
<span id="cb212-37"><a href="asteroids.html#cb212-37"></a>      abcg::glGetAttribLocation(<span class="va">m_program</span>, <span class="st">&quot;inPosition&quot;</span>)};</span>
<span id="cb212-38"><a href="asteroids.html#cb212-38"></a></span>
<span id="cb212-39"><a href="asteroids.html#cb212-39"></a>  <span class="co">// Create VAO</span></span>
<span id="cb212-40"><a href="asteroids.html#cb212-40"></a>  abcg::glGenVertexArrays(<span class="dv">1</span>, &amp;<span class="va">m_vao</span>);</span>
<span id="cb212-41"><a href="asteroids.html#cb212-41"></a></span>
<span id="cb212-42"><a href="asteroids.html#cb212-42"></a>  <span class="co">// Bind vertex attributes to current VAO</span></span>
<span id="cb212-43"><a href="asteroids.html#cb212-43"></a>  abcg::glBindVertexArray(<span class="va">m_vao</span>);</span>
<span id="cb212-44"><a href="asteroids.html#cb212-44"></a></span>
<span id="cb212-45"><a href="asteroids.html#cb212-45"></a>  abcg::glEnableVertexAttribArray(positionAttribute);</span>
<span id="cb212-46"><a href="asteroids.html#cb212-46"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="va">m_vbo</span>);</span>
<span id="cb212-47"><a href="asteroids.html#cb212-47"></a>  abcg::glVertexAttribPointer(positionAttribute, <span class="dv">2</span>, GL_FLOAT, GL_FALSE, <span class="dv">0</span>,</span>
<span id="cb212-48"><a href="asteroids.html#cb212-48"></a>                              <span class="kw">nullptr</span>);</span>
<span id="cb212-49"><a href="asteroids.html#cb212-49"></a>  abcg::glBindBuffer(GL_ARRAY_BUFFER, <span class="dv">0</span>);</span>
<span id="cb212-50"><a href="asteroids.html#cb212-50"></a></span>
<span id="cb212-51"><a href="asteroids.html#cb212-51"></a>  <span class="co">// End of binding to current VAO</span></span>
<span id="cb212-52"><a href="asteroids.html#cb212-52"></a>  abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb212-53"><a href="asteroids.html#cb212-53"></a>}</span></code></pre></div>
<p>A lista de tiros é inicializada como vazia na linha 15. O restante do código é para criar o VBO que será compartilhado por todos os tiros. O VBO contém vértices de um polígono regular de 10 lados e usa o mesmo código que utilizamos no projeto <code>regularpolygons</code>.</p>
<p>A definição de <code>Bullets::paintGL</code> ficará como a seguir:</p>
<div class="sourceCode" id="cb213" startFrom="55"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 54;"><span id="cb213-55"><a href="asteroids.html#cb213-55"></a><span class="dt">void</span> Bullets::paintGL() {</span>
<span id="cb213-56"><a href="asteroids.html#cb213-56"></a>  abcg::glUseProgram(<span class="va">m_program</span>);</span>
<span id="cb213-57"><a href="asteroids.html#cb213-57"></a></span>
<span id="cb213-58"><a href="asteroids.html#cb213-58"></a>  abcg::glBindVertexArray(<span class="va">m_vao</span>);</span>
<span id="cb213-59"><a href="asteroids.html#cb213-59"></a>  abcg::glUniform4f(<span class="va">m_colorLoc</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>);</span>
<span id="cb213-60"><a href="asteroids.html#cb213-60"></a>  abcg::glUniform1f(<span class="va">m_rotationLoc</span>, <span class="dv">0</span>);</span>
<span id="cb213-61"><a href="asteroids.html#cb213-61"></a>  abcg::glUniform1f(<span class="va">m_scaleLoc</span>, <span class="va">m_scale</span>);</span>
<span id="cb213-62"><a href="asteroids.html#cb213-62"></a></span>
<span id="cb213-63"><a href="asteroids.html#cb213-63"></a>  <span class="cf">for</span> (<span class="at">const</span> <span class="kw">auto</span> &amp;bullet : <span class="va">m_bullets</span>) {</span>
<span id="cb213-64"><a href="asteroids.html#cb213-64"></a>    abcg::glUniform2f(<span class="va">m_translationLoc</span>, bullet.<span class="va">m_translation</span>.x,</span>
<span id="cb213-65"><a href="asteroids.html#cb213-65"></a>                      bullet.<span class="va">m_translation</span>.y);</span>
<span id="cb213-66"><a href="asteroids.html#cb213-66"></a></span>
<span id="cb213-67"><a href="asteroids.html#cb213-67"></a>    abcg::glDrawArrays(GL_TRIANGLE_FAN, <span class="dv">0</span>, <span class="dv">12</span>);</span>
<span id="cb213-68"><a href="asteroids.html#cb213-68"></a>  }</span>
<span id="cb213-69"><a href="asteroids.html#cb213-69"></a></span>
<span id="cb213-70"><a href="asteroids.html#cb213-70"></a>  abcg::glBindVertexArray(<span class="dv">0</span>);</span>
<span id="cb213-71"><a href="asteroids.html#cb213-71"></a></span>
<span id="cb213-72"><a href="asteroids.html#cb213-72"></a>  abcg::glUseProgram(<span class="dv">0</span>);</span>
<span id="cb213-73"><a href="asteroids.html#cb213-73"></a>}</span></code></pre></div>
<p>Todos os tiros têm a mesma cor (linha 59), ângulo de rotação (linha 60) e fator de escala (linha 61). A lista de tiros é iterada no laço das linhas 63 a 68. Cada tiro é renderizado como um <code>GL_TRIANGLE_FAN</code>.</p>
<p>Em <code>Bullets::terminateGL</code> é liberado o VBO e VAO:</p>
<div class="sourceCode" id="cb214" startFrom="75"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 74;"><span id="cb214-75"><a href="asteroids.html#cb214-75"></a><span class="dt">void</span> Bullets::terminateGL() {</span>
<span id="cb214-76"><a href="asteroids.html#cb214-76"></a>  abcg::glDeleteBuffers(<span class="dv">1</span>, &amp;<span class="va">m_vbo</span>);</span>
<span id="cb214-77"><a href="asteroids.html#cb214-77"></a>  abcg::glDeleteVertexArrays(<span class="dv">1</span>, &amp;<span class="va">m_vao</span>);</span>
<span id="cb214-78"><a href="asteroids.html#cb214-78"></a>}</span></code></pre></div>
<p>Vamos agora à definição de <code>Bullets::update</code>:</p>
<div class="sourceCode" id="cb215" startFrom="80"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 79;"><span id="cb215-80"><a href="asteroids.html#cb215-80"></a><span class="dt">void</span> Bullets::update(Ship &amp;ship, <span class="at">const</span> GameData &amp;gameData, <span class="dt">float</span> deltaTime) {</span>
<span id="cb215-81"><a href="asteroids.html#cb215-81"></a>  <span class="co">// Create a pair of bullets</span></span>
<span id="cb215-82"><a href="asteroids.html#cb215-82"></a>  <span class="cf">if</span> (gameData.<span class="va">m_input</span>[<span class="kw">static_cast</span>&lt;<span class="dt">size_t</span>&gt;(Input::Fire)] &amp;&amp;</span>
<span id="cb215-83"><a href="asteroids.html#cb215-83"></a>      gameData.<span class="va">m_state</span> == State::Playing) {</span>
<span id="cb215-84"><a href="asteroids.html#cb215-84"></a>    <span class="co">// At least 250 ms must have passed since the last bullets</span></span>
<span id="cb215-85"><a href="asteroids.html#cb215-85"></a>    <span class="cf">if</span> (ship.<span class="va">m_bulletCoolDownTimer</span>.elapsed() &gt; <span class="fl">250.0</span> / <span class="fl">1000.0</span>) {</span>
<span id="cb215-86"><a href="asteroids.html#cb215-86"></a>      ship.<span class="va">m_bulletCoolDownTimer</span>.restart();</span>
<span id="cb215-87"><a href="asteroids.html#cb215-87"></a></span>
<span id="cb215-88"><a href="asteroids.html#cb215-88"></a>      <span class="co">// Bullets are shot in the direction of the ship&#39;s forward vector</span></span>
<span id="cb215-89"><a href="asteroids.html#cb215-89"></a>      glm::vec2 forward{glm::rotate(glm::vec2{<span class="fl">0.0</span><span class="bu">f</span>, <span class="fl">1.0</span><span class="bu">f</span>}, ship.<span class="va">m_rotation</span>)};</span>
<span id="cb215-90"><a href="asteroids.html#cb215-90"></a>      glm::vec2 right{glm::rotate(glm::vec2{<span class="fl">1.0</span><span class="bu">f</span>, <span class="fl">0.0</span><span class="bu">f</span>}, ship.<span class="va">m_rotation</span>)};</span>
<span id="cb215-91"><a href="asteroids.html#cb215-91"></a>      <span class="at">const</span> <span class="kw">auto</span> cannonOffset{(<span class="fl">11.0</span><span class="bu">f</span> / <span class="fl">15.5</span><span class="bu">f</span>) * ship.<span class="va">m_scale</span>};</span>
<span id="cb215-92"><a href="asteroids.html#cb215-92"></a>      <span class="at">const</span> <span class="kw">auto</span> bulletSpeed{<span class="fl">2.0</span><span class="bu">f</span>};</span>
<span id="cb215-93"><a href="asteroids.html#cb215-93"></a></span>
<span id="cb215-94"><a href="asteroids.html#cb215-94"></a>      Bullet bullet{.<span class="va">m_dead</span> = <span class="kw">false</span>,</span>
<span id="cb215-95"><a href="asteroids.html#cb215-95"></a>                    .<span class="va">m_translation</span> = ship.<span class="va">m_translation</span> + right * cannonOffset,</span>
<span id="cb215-96"><a href="asteroids.html#cb215-96"></a>                    .<span class="va">m_velocity</span> = ship.<span class="va">m_velocity</span> + forward * bulletSpeed};</span>
<span id="cb215-97"><a href="asteroids.html#cb215-97"></a>      <span class="va">m_bullets</span>.push_back(bullet);</span>
<span id="cb215-98"><a href="asteroids.html#cb215-98"></a></span>
<span id="cb215-99"><a href="asteroids.html#cb215-99"></a>      bullet.<span class="va">m_translation</span> = ship.<span class="va">m_translation</span> - right * cannonOffset;</span>
<span id="cb215-100"><a href="asteroids.html#cb215-100"></a>      <span class="va">m_bullets</span>.push_back(bullet);</span>
<span id="cb215-101"><a href="asteroids.html#cb215-101"></a></span>
<span id="cb215-102"><a href="asteroids.html#cb215-102"></a>      <span class="co">// Moves ship in the opposite direction</span></span>
<span id="cb215-103"><a href="asteroids.html#cb215-103"></a>      ship.<span class="va">m_velocity</span> -= forward * <span class="fl">0.1</span><span class="bu">f</span>;</span>
<span id="cb215-104"><a href="asteroids.html#cb215-104"></a>    }</span>
<span id="cb215-105"><a href="asteroids.html#cb215-105"></a>  }</span>
<span id="cb215-106"><a href="asteroids.html#cb215-106"></a></span>
<span id="cb215-107"><a href="asteroids.html#cb215-107"></a>  <span class="cf">for</span> (<span class="kw">auto</span> &amp;bullet : <span class="va">m_bullets</span>) {</span>
<span id="cb215-108"><a href="asteroids.html#cb215-108"></a>    bullet.<span class="va">m_translation</span> -= ship.<span class="va">m_velocity</span> * deltaTime;</span>
<span id="cb215-109"><a href="asteroids.html#cb215-109"></a>    bullet.<span class="va">m_translation</span> += bullet.<span class="va">m_velocity</span> * deltaTime;</span>
<span id="cb215-110"><a href="asteroids.html#cb215-110"></a></span>
<span id="cb215-111"><a href="asteroids.html#cb215-111"></a>    <span class="co">// Kill bullet if it goes off screen</span></span>
<span id="cb215-112"><a href="asteroids.html#cb215-112"></a>    <span class="cf">if</span> (bullet.<span class="va">m_translation</span>.x &lt; -<span class="fl">1.1</span><span class="bu">f</span>) bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb215-113"><a href="asteroids.html#cb215-113"></a>    <span class="cf">if</span> (bullet.<span class="va">m_translation</span>.x &gt; +<span class="fl">1.1</span><span class="bu">f</span>) bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb215-114"><a href="asteroids.html#cb215-114"></a>    <span class="cf">if</span> (bullet.<span class="va">m_translation</span>.y &lt; -<span class="fl">1.1</span><span class="bu">f</span>) bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb215-115"><a href="asteroids.html#cb215-115"></a>    <span class="cf">if</span> (bullet.<span class="va">m_translation</span>.y &gt; +<span class="fl">1.1</span><span class="bu">f</span>) bullet.<span class="va">m_dead</span> = <span class="kw">true</span>;</span>
<span id="cb215-116"><a href="asteroids.html#cb215-116"></a>  }</span>
<span id="cb215-117"><a href="asteroids.html#cb215-117"></a></span>
<span id="cb215-118"><a href="asteroids.html#cb215-118"></a>  <span class="co">// Remove dead bullets</span></span>
<span id="cb215-119"><a href="asteroids.html#cb215-119"></a>  <span class="va">m_bullets</span>.remove_if([](<span class="at">const</span> Bullet &amp;p) { <span class="cf">return</span> p.<span class="va">m_dead</span>; });</span>
<span id="cb215-120"><a href="asteroids.html#cb215-120"></a>}</span></code></pre></div>
<p>Um par de tiros é criado a cada disparo. O temporizador <code>m_bulletCoolDownTimer</code> é utilizado para fazer com que os disparos ocorram em intervalos de no mínimo 250 milissegundos.</p>
<p>Observe, na linha 103, que subtraímos da velocidade da nave o vetor de direção dos tiros. Isso produz um efeito de recuo da nave. Quanto mais tiros são disparados, mais a nave será deslocada para trás.</p>
<p>Nas linhas 107 a 116 são atualizadas as coordenadas de translação de cada tiro.</p>
<p>Nas linhas 108 e 109, os tiros são atualizados de acordo com a velocidade da nave e a velocidade do próprio tiro.</p>
<p>Nas linhas 111 a 115, verifica-se se o tiro saiu da tela. Se sim, o flag <code>m_dead</code> torna-se <code>true</code>. A comparação é feita com <code>-1.1f</code>/<code>+1.1f</code> no lugar de <code>-1.0f</code>/<code>+1.0f</code> para ter certeza que todo o polígono do tiro saiu da tela.</p>
<p>Na linha 119, todos os tiros com <code>m_dead == true</code> são removidos da lista.</p>
<p>Isso é tudo! Eis o jogo completo (<a href="https://hbatagelo.github.io/abcgapps/asteroids/index.html">link original</a>):</p>
<iframe
  src="https://hbatagelo.github.io/abcgapps/asteroids/index.html"
  allow="gamepad" frameborder="0" allowfullscreen="true" allowtransparency="true" emscriptenheight="740"
  ></iframe>
<p>O código do projeto completo pode ser baixado <a href="https://hbatagelo.github.io/abcgapps/src/asteroids4.zip">deste link</a>.</p>

</div>
</div>
</div>
<!-- </div> -->
<div class="footnotes">
<hr />
<ol start="24">
<li id="fn24"><p>As estrelas das camadas superiores se moverão mais rapidamente do que as estrelas das camadas inferiores, dando a sensação de profundidade do espaço.<a href="asteroids.html#fnref24" class="footnote-back">↩︎</a></p></li>
<li id="fn25"><p>As declarações antecipadas são utilizadas no lugar do <code>#include</code> para evitar inclusões recursivas. Por exemplo, <code>openglwindow.hpp</code> inclui <code>ship.hpp</code>, então <code>ship.hpp</code> não pode incluir <code>openglwindow.hpp</code>.<a href="asteroids.html#fnref25" class="footnote-back">↩︎</a></p></li>
<li id="fn26"><p>O vetor é <span class="math inline">\([0\; 1]\)</span> pois a nave está alinhada ao eixo <span class="math inline">\(y\)</span> positivo em sua orientação original.<a href="asteroids.html#fnref26" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="regularpolygons.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="geometry.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toc_float": true,
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
